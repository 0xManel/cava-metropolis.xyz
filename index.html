<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cava Metropolis">
    <meta name="theme-color" content="#08080b">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Cava Metropolis</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- PALETA HIGH-CLASS --- */
        :root {
            --bg-color: #08080b;
            --glass-bg: rgba(35, 35, 40, 0.8);
            --glass-border: rgba(212, 175, 55, 0.25);
            --text-main: #FDFBF7;
            --text-muted: #B8B0A0;
            --gold-accent: #D4AF37;
            --gold-light: #F3E5AB;
            --price-bg: rgba(46, 125, 50, 0.15);
            --price-color: #57C25B;
            --minicard-bg: rgba(255, 255, 255, 0.05);
            --transition-bounce: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --transition-smooth: all 0.4s ease;
        }

        body.light-mode {
            --bg-color: #FDFBF7;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(212, 175, 55, 0.4);
            --text-main: #1A1A1A;
            --text-muted: #666156;
            --gold-accent: #B8860B;
            --gold-light: #D4AF37;
            --price-bg: rgba(46, 125, 50, 0.1);
            --price-color: #2E7D32;
            --minicard-bg: rgba(0, 0, 0, 0.02);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            transition: background-color 0.8s ease, color 0.8s ease;
            min-height: 100dvh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 22dvh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Entrance animation */
        @keyframes fadeSlideUp {
            0% { opacity: 0; transform: translateY(40px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        header { animation: fadeSlideUp 0.8s ease-out both; }
        .search-container { animation: fadeSlideUp 0.8s ease-out 0.15s both; }
        .theme-toggle { animation: fadeSlideUp 0.5s ease-out 0.3s both; }

        /* --- GOLDEN PARTICLES (CANVAS) --- */
        #particleCanvas {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 0;
            pointer-events: none;
        }

        /* --- HEADER --- */
        header {
            margin-top: 0;
            margin-bottom: 2rem;
            text-align: center;
            z-index: 10;
        }

        .title-cava {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            font-size: 2.5rem;
            color: var(--gold-accent);
            line-height: 0.8;
            font-weight: 700;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            transition: var(--transition-smooth);
        }

        .title-metropolis {
            font-family: 'Montserrat', sans-serif;
            font-size: 10vw;
            letter-spacing: 0.5vw;
            font-weight: 600;
            color: var(--text-main);
            padding: 0 5vw;
            text-shadow:
                0 0 5px rgba(255, 255, 255, 0.6),
                0 0 15px var(--gold-accent),
                0 0 30px rgba(212, 175, 55, 0.4);
        }

        /* --- SEARCH BAR (GLASSMORPHISM) --- */
        .search-container {
            width: 90%;
            max-width: 600px;
            position: relative;
            z-index: 20;
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
        }

        .search-input-wrapper {
            position: relative;
            width: 100%;
        }

        .search-icon {
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px; height: 20px;
            fill: var(--text-muted);
        }

        #searchInput {
            width: 100%;
            padding: 1.2rem 1rem 1.2rem 2rem;
            font-size: 1.3rem;
            font-family: 'Montserrat', sans-serif;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            color: var(--text-main);
            outline: none;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: var(--transition-smooth);
        }

        #searchInput:focus {
            border-color: var(--gold-accent);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        #searchInput::placeholder { color: var(--text-muted); font-weight: 300; }

        .ref-count {
            text-align: center;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            letter-spacing: 1px;
            font-weight: 300;
            order: -1;
        }
        .ref-count span { color: var(--gold-accent); font-weight: 700; }

        /* --- FILTER BAR --- */
        .filter-bar {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            margin-top: 0.6rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-pill {
            padding: 0.35rem 0.7rem;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-muted);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.8px;
            cursor: pointer;
            transition: all 0.25s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            white-space: nowrap;
        }

        .filter-pill:active { transform: scale(0.95); }

        .filter-pill.active {
            background: var(--gold-accent);
            color: #111;
            border-color: var(--gold-accent);
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
        }

        .sort-toggle {
            padding: 0.35rem 0.7rem;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--gold-accent);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.8px;
            cursor: pointer;
            transition: all 0.25s ease;
            margin-left: auto;
        }
        .sort-toggle:active { transform: scale(0.95); }

        /* --- DROPDOWN RESULTS --- */
        #searchResults {
            position: absolute;
            top: 100%;
            left: 0; right: 0;
            background: transparent;
            max-height: 60vh;
            overflow-y: auto;
            display: none;
            z-index: 9999;
        }

        .search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.55rem 1rem;
            margin-bottom: 0.3rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.15s ease, background 0.2s ease;
        }
        .search-item:first-child { margin-top: 2mm; }

        @media (hover: hover) {
            .search-item:hover {
                background: rgba(212, 175, 55, 0.12);
                border-color: var(--gold-accent);
            }
        }
        .search-item:active {
            background: rgba(212, 175, 55, 0.18);
            transform: scale(0.98);
        }

        .item-info { display: flex; flex-direction: column; gap: 0.18rem; flex: 1; min-width: 0; }

        .item-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- GRAPE TAG FAMILIES --- */
        .grape-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.1rem;
        }

        .grape-tag {
            display: inline-block;
            padding: 0.18rem 0.45rem;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            cursor: default;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .grape-tag.iberica-tinta { background: linear-gradient(135deg, #E53935 0%, #D32626 100%); }
        .grape-tag.iberica-tinta.s2 { background: linear-gradient(135deg, #F44336 0%, #E53935 100%); }
        .grape-tag.iberica-tinta.s3 { background: linear-gradient(135deg, #FF6F6F 0%, #F44336 100%); }

        .grape-tag.burgundy { background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%); }
        .grape-tag.burgundy.s2 { background: linear-gradient(135deg, #9333EA 0%, #7C3AED 100%); }
        .grape-tag.burgundy.s3 { background: linear-gradient(135deg, #A855F7 0%, #9333EA 100%); }

        .grape-tag.italiana { background: linear-gradient(135deg, #C23030 0%, #B71C1C 100%); }
        .grape-tag.italiana.s2 { background: linear-gradient(135deg, #D32626 0%, #C23030 100%); }
        .grape-tag.italiana.s3 { background: linear-gradient(135deg, #E53935 0%, #D32626 100%); }

        .grape-tag.aromatico { background: linear-gradient(135deg, #F9A825 0%, #F57F17 100%); }
        .grape-tag.aromatico.s2 { background: linear-gradient(135deg, #FBC02D 0%, #F9A825 100%); }
        .grape-tag.aromatico.s3 { background: linear-gradient(135deg, #FDD835 0%, #FBC02D 100%); }

        .grape-tag.novamundo { background: linear-gradient(135deg, #8B1538 0%, #5F0F1D 100%); }
        .grape-tag.novamundo.s2 { background: linear-gradient(135deg, #A91D3A 0%, #8B1538 100%); }
        .grape-tag.novamundo.s3 { background: linear-gradient(135deg, #C81E4E 0%, #A91D3A 100%); }

        .grape-tag.espumoso { background: linear-gradient(135deg, #EC407A 0%, #D81B60 100%); }
        .grape-tag.espumoso.s2 { background: linear-gradient(135deg, #F06292 0%, #EC407A 100%); }
        .grape-tag.espumoso.s3 { background: linear-gradient(135deg, #F48FB1 0%, #F06292 100%); }

        .badge-row { display: flex; gap: 0.35rem; align-items: center; margin-top: 0.05rem; }

        .badge {
            font-size: 0.58rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 0.18rem 0.45rem;
            border-radius: 4px;
            letter-spacing: 0.8px;
            color: #111;
        }

        .item-region { font-size: 0.72rem; color: var(--text-muted); }

        .item-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.3rem;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .item-price {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            color: var(--price-color);
            font-size: 1.05rem;
            letter-spacing: 0.5px;
        }

        .item-location {
            font-size: 0.75rem;
            color: var(--text-main);
            font-weight: 700;
            letter-spacing: 1.5px;
            font-family: 'Montserrat', monospace;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(180, 135, 25, 0.2));
            border: 1px solid var(--gold-accent);
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            display: inline-block;
            box-shadow: 0 2px 6px rgba(212, 175, 55, 0.15);
            white-space: nowrap;
        }

        .item-format {
            font-size: 0.6rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .modal-overlay.active { display: flex; opacity: 1; }

        .modal-card {
            width: 90%;
            max-width: 500px;
            background: var(--bg-color);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            position: relative;
            transform: translateY(30px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            max-height: 90dvh;
            overflow-y: auto;
        }

        .modal-overlay.active .modal-card { transform: translateY(0) scale(1); }

        .btn-close {
            position: absolute;
            top: 1.5rem; right: 1.5rem;
            background: none; border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        .btn-close:hover { color: var(--gold-accent); transform: scale(1.1); }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            line-height: 1.3;
            color: var(--text-main);
            margin: 1rem 0 0.5rem 0;
            padding-right: 20px;
        }

        .modal-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .modal-grapes {
            margin-bottom: 1rem;
        }
        .modal-grapes .grape-tag {
            font-size: 0.7rem;
            padding: 0.3rem 0.5rem;
        }

        /* Details grid for D.O., Country, Year, Format */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1.2rem;
        }

        .detail-box {
            background: var(--minicard-bg);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 12px;
            padding: 0.8rem;
            text-align: center;
        }

        .detail-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 0.2rem;
        }

        .detail-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            color: var(--text-main);
            font-weight: 600;
        }

        /* Establishment pricing table */
        .est-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.2rem;
        }

        .est-table th {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gold-accent);
            padding: 0.5rem 0.3rem;
            border-bottom: 1px solid var(--glass-border);
            text-align: center;
        }

        .est-table td {
            font-size: 0.85rem;
            color: var(--text-main);
            padding: 0.4rem 0.3rem;
            text-align: center;
            border-bottom: 1px solid rgba(212, 175, 55, 0.08);
        }

        .est-table .row-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: left;
            font-weight: 600;
        }

        .est-table .pvp-cell {
            font-weight: 900;
            color: var(--price-color);
            font-size: 1rem;
        }

        .est-table .loc-cell {
            font-family: 'Montserrat', monospace;
            font-weight: 700;
            letter-spacing: 1px;
            font-size: 0.8rem;
        }

        /* --- THEME TOGGLE --- */
        .theme-toggle {
            position: fixed;
            top: 20px; right: 20px;
            width: 80px; height: 40px;
            border-radius: 20px;
            background: transparent;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            overflow: hidden;
            padding: 0;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
            transform: scale(1.05);
        }

        #toggleCanvas { width: 100%; height: 100%; display: block; }

        /* --- LANGUAGE SELECTOR --- */
        .lang-container {
            position: fixed;
            top: 20px; left: 20px;
            z-index: 99;
            font-family: 'Montserrat', sans-serif;
        }

        .lang-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            width: 80px; height: 40px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center; gap: 4px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .lang-btn:hover {
            border-color: var(--gold-accent);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
        }

        .lang-dropdown {
            position: absolute;
            top: 120%; left: 0;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            overflow: hidden;
            opacity: 0; visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition-smooth);
            backdrop-filter: blur(15px);
            min-width: 100px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .lang-container:hover .lang-dropdown {
            opacity: 1; visibility: visible;
            transform: translateY(0);
        }

        .lang-option {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 20px;
            color: var(--text-main);
            text-decoration: none;
            font-size: 0.9rem;
            transition: background 0.3s;
            cursor: pointer;
        }
        .lang-option:hover { background: rgba(212, 175, 55, 0.1); }

        /* Badge colors */
        .b-tinto { background: #800020; color: #FFF; }
        .b-branco { background: #E5C158; }
        .b-rosado { background: #E08D79; }
        .b-espumoso { background: #D4AF37; }
        .b-generoso { background: #C97B1A; color: #FFF; }
        .b-dulce { background: #8B6914; color: #FFF; }

        /* Edit form */
        .edit-form { display: none; margin-top: 1rem; }
        .edit-form.visible { display: block; }

        .edit-field {
            padding: 0.7rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--minicard-bg);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            width: 100%;
        }
        .edit-field:focus { outline: none; border-color: var(--gold-accent); }

        .edit-section-title {
            font-size: 0.65rem;
            color: var(--gold-accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 0.8rem;
            margin-bottom: 0.3rem;
            font-weight: 700;
        }

        .edit-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .edit-row .edit-field { flex: 1; }

        .edit-actions {
            display: flex;
            gap: 0.6rem;
            justify-content: flex-end;
            margin-top: 0.8rem;
        }

        .btn-cancel {
            padding: 0.6rem 0.9rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .btn-save {
            padding: 0.6rem 0.9rem;
            border-radius: 8px;
            border: none;
            background: var(--gold-accent);
            color: #111;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .btn-edit {
            padding: 0.6rem 0.9rem;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-main);
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        @media (max-width: 600px) {
            .title-cava { font-size: 2rem; }
            .title-metropolis { font-size: 11vw; letter-spacing: 1px; padding: 0 20px; }
            .modal-card { padding: 1.5rem; max-height: 85dvh; }
            .modal-title { font-size: 1.5rem; }
            #searchInput { font-size: 1rem; padding: 1rem 1rem 1rem 2rem; }
            body { padding-top: 18dvh; }
            .lang-container { top: 15px; left: 15px; }
        }

        body.keyboard-open { padding-top: 2dvh; }
        body.keyboard-open header { display: none; }
    </style>
</head>
<body>

    <canvas id="particleCanvas"></canvas>

    <!-- Theme Toggle -->
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle Theme">
        <canvas id="toggleCanvas"></canvas>
    </button>

    <!-- Language Selector -->
    <div class="lang-container">
        <button class="lang-btn" id="currentLangBtn">ES</button>
        <div class="lang-dropdown">
            <div class="lang-option" onclick="setLanguage('es')"><span>ðŸ‡ªðŸ‡¸</span> EspaÃ±ol</div>
            <div class="lang-option" onclick="setLanguage('en')"><span>ðŸ‡¬ðŸ‡§</span> English</div>
            <div class="lang-option" onclick="setLanguage('pt')"><span>ðŸ‡§ðŸ‡·</span> PortuguÃªs</div>
        </div>
    </div>

    <header>
        <div class="title-cava">Cava</div>
        <div class="title-metropolis">METROPOLIS</div>
    </header>

    <div class="search-container">
        <div class="ref-count"><span id="totalRef">0</span> <span data-translate="refs">referencias disponibles</span></div>

        <div class="search-input-wrapper">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="searchInput" placeholder="" autocomplete="off">
        </div>

        <!-- Filter Pills + Sort Toggle -->
        <div class="filter-bar">
            <button class="filter-pill active" data-filter="todos">TODOS</button>
            <button class="filter-pill" data-filter="spa">SPA</button>
            <button class="filter-pill" data-filter="tasca_fina">TASCA FINA</button>
            <button class="filter-pill" data-filter="victoria">VICTORIA</button>
            <button class="sort-toggle" id="sortToggle">ABC</button>
        </div>

        <div id="searchResults"></div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="wineModal">
        <div class="modal-card">
            <button class="btn-close" id="btnClose">âœ•</button>

            <span class="badge" id="modalBadge">TINTO</span>
            <h2 class="modal-title" id="modalName">â€”</h2>
            <div class="modal-subtitle" id="modalSubtitle">â€”</div>

            <div class="modal-grapes" id="modalGrapes"></div>

            <div class="details-grid">
                <div class="detail-box">
                    <div class="detail-label">D.O. / <span data-translate="region">RegiÃ³n</span></div>
                    <div class="detail-value" id="modalRegion">â€”</div>
                </div>
                <div class="detail-box">
                    <div class="detail-label" data-translate="country">PaÃ­s</div>
                    <div class="detail-value" id="modalCountry">â€”</div>
                </div>
                <div class="detail-box">
                    <div class="detail-label" data-translate="year">AÃ±o</div>
                    <div class="detail-value" id="modalYear">â€”</div>
                </div>
                <div class="detail-box">
                    <div class="detail-label" data-translate="format">Formato</div>
                    <div class="detail-value" id="modalFormat" style="font-size:0.8rem;">â€”</div>
                </div>
            </div>

            <!-- Establishment Pricing Table -->
            <table class="est-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>SPA</th>
                        <th>TASCA FINA</th>
                        <th>VICTORIA</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label">PVP</td>
                        <td class="pvp-cell" id="estSpaPvp">â€”</td>
                        <td class="pvp-cell" id="estTascaPvp">â€”</td>
                        <td class="pvp-cell" id="estVictoriaPvp">â€”</td>
                    </tr>
                    <tr>
                        <td class="row-label">Stock</td>
                        <td id="estSpaStock">â€”</td>
                        <td id="estTascaStock">â€”</td>
                        <td id="estVictoriaStock">â€”</td>
                    </tr>
                    <tr>
                        <td class="row-label loc-cell">Ubic.</td>
                        <td class="loc-cell" id="estSpaLoc">â€”</td>
                        <td class="loc-cell" id="estTascaLoc">â€”</td>
                        <td class="loc-cell" id="estVictoriaLoc">â€”</td>
                    </tr>
                </tbody>
            </table>

            <!-- Edit button -->
            <div style="display:flex;justify-content:flex-end;">
                <button class="btn-edit" id="btnEditWine">Editar</button>
            </div>

            <!-- Edit form -->
            <div class="edit-form" id="editForm">
                <div style="display:flex;flex-direction:column;gap:0.4rem;">
                    <input class="edit-field" id="editDesc" type="text" placeholder="Nombre / DescripciÃ³n">
                    <input class="edit-field" id="editRegion" type="text" placeholder="RegiÃ³n / D.O.">
                    <input class="edit-field" id="editUvas" type="text" placeholder="Uvas (separadas por coma)">

                    <div class="edit-section-title">SPA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editSpaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editSpaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editSpaLoc" type="text" placeholder="Ubic." style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-section-title">TASCA FINA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editTascaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editTascaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editTascaLoc" type="text" placeholder="Ubic." style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-section-title">VICTORIA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editVictoriaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editVictoriaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editVictoriaLoc" type="text" placeholder="Ubic." style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-actions">
                        <button class="btn-cancel" id="btnCancelEdit">Cancelar</button>
                        <button class="btn-save" id="btnSaveEdit">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ==========================================================
           CAVA METROPOLIS â€” Multi-Establishment Wine Management
           ========================================================== */

        // --- CONSTANTS ---
        const EST_KEYS = ['spa', 'tasca_fina', 'victoria'];
        // galeria exists in data but is NOT rendered (Phase 3)
        const EST_LABELS = { spa: 'SPA', tasca_fina: 'TASCA FINA', victoria: 'VICTORIA' };

        const TIPO_MAP = {
            'TO':  { cls: 'b-tinto',    es: 'TINTO',    en: 'RED',       pt: 'TINTO' },
            'BL':  { cls: 'b-branco',   es: 'BLANCO',   en: 'WHITE',     pt: 'BRANCO' },
            'ROS': { cls: 'b-rosado',   es: 'ROSADO',   en: 'ROSÃ‰',      pt: 'ROSADO' },
            'ESP': { cls: 'b-espumoso', es: 'ESPUMOSO', en: 'SPARKLING', pt: 'ESPUMOSO' },
            'GEN': { cls: 'b-generoso', es: 'GENEROSO', en: 'FORTIFIED', pt: 'GENEROSO' },
            'DU':  { cls: 'b-dulce',    es: 'DULCE',    en: 'SWEET',     pt: 'DOCE' }
        };

        const GRAPE_FAMILIES = {
            'Tempranillo': 'iberica-tinta', 'Garnacha': 'iberica-tinta s2', 'Monastrell': 'iberica-tinta s3',
            'Bobal': 'iberica-tinta', 'MencÃ­a': 'iberica-tinta s2', 'CariÃ±ena': 'iberica-tinta s3',
            'Graciano': 'iberica-tinta', 'Carignan': 'iberica-tinta s2', 'Prieto Picudo': 'iberica-tinta s3',
            'Tinta de Toro': 'iberica-tinta', 'Garnacha Tintorera': 'iberica-tinta s2',
            'Pinot Noir': 'burgundy', 'Pinot Meunier': 'burgundy s2', 'Chardonnay': 'burgundy s3',
            'Sauvignon Blanc': 'burgundy', 'AligotÃ©': 'burgundy s2', 'Gamay': 'burgundy s3',
            'Sangiovese': 'italiana', 'Nebbiolo': 'italiana s2', 'Barbera': 'italiana s3',
            'Dolcetto': 'italiana', 'Montepulciano': 'italiana s2', 'Aglianico': 'italiana s3',
            "Nero d'Avola": 'italiana', 'Corvina': 'italiana s2', 'Primitivo': 'italiana s3',
            'Riesling': 'aromatico', 'AlbariÃ±o': 'aromatico s2', 'Verdejo': 'aromatico s3',
            'Moscato': 'aromatico', 'GewÃ¼rztraminer': 'aromatico s2', 'Viognier': 'aromatico s3',
            'Vermentino': 'aromatico', 'Godello': 'aromatico s2', 'Fiano': 'aromatico s3',
            'Greco': 'aromatico', 'Falanghina': 'aromatico s2', 'Malvasia': 'aromatico s3',
            'Furmint': 'aromatico', 'Savagnin': 'aromatico s2', 'Timorasso': 'aromatico s3',
            'Verdicchio': 'aromatico', 'Chenin Blanc': 'aromatico s2', 'GrÃ¼ner Veltliner': 'aromatico s3',
            'Garnacha Blanca': 'aromatico', 'Viura': 'aromatico s2', 'Macabeo': 'aromatico s3',
            'CarmenÃ¨re': 'novamundo', 'Malbec': 'novamundo s2', 'Cabernet Sauvignon': 'novamundo s3',
            'Cabernet Franc': 'novamundo', 'Syrah': 'novamundo s2', 'Shiraz': 'novamundo s3',
            'Petit Verdot': 'novamundo', 'Zinfandel': 'novamundo s2', 'Tannat': 'novamundo s3',
            'Negroamaro': 'novamundo', 'Pinotage': 'novamundo s2', 'Merlot': 'novamundo s3',
            'Touriga Nacional': 'novamundo', 'Tinta Roriz': 'novamundo s2',
            'Prosecco': 'espumoso', 'Lambrusco': 'espumoso s2', 'Cava': 'espumoso s3',
            'Champagne': 'espumoso', 'Xarel.lo': 'espumoso s2', 'Parellada': 'espumoso s3',
            'Glera': 'espumoso',
        };

        // --- STATE ---
        let refs = [];            // Full dataset from JSON
        let searchIndex = [];     // Pre-computed search strings
        let pvpMedio = {};        // Average PVP per pod
        let subsets = {};         // Indices per establishment
        let currentFilter = 'todos';
        let currentSort = 'abc';
        let currentEditPod = null;
        let currentLang = 'es';

        // Typewriter state
        let typeWriterTimeout, charIndex = 0, isDeleting = false, currentPhrase = '', phraseQueue = [];

        // --- TRANSLATIONS ---
        const translations = {
            es: {
                placeholders: [
                    "Encuentra la botella", "Â¿Una copa? Â¿Una Botella?",
                    "Tempranillo, Garnacha, MencÃ­a", "AlbariÃ±o, Godello, Verdejo",
                    "Tinto, Blanco, Rosado, Espumoso", "Â¿QuÃ© tal la cata de hoy?",
                    "Â¿Cliente muy Especial?", "Buscar vino...",
                    "Â¿Rioja, Ribeira, Rueda?", "Â¿Alguno internacional?",
                    "QuizÃ¡s un vino francÃ©s"
                ],
                refs: "referencias disponibles", region: "RegiÃ³n", country: "PaÃ­s",
                year: "AÃ±o", format: "Formato", btnLabel: "ðŸ‡ªðŸ‡¸ ES"
            },
            en: {
                placeholders: [
                    "Find the bottle", "A glass? A bottle?",
                    "Tempranillo, Garnacha, MencÃ­a", "AlbariÃ±o, Godello, Verdejo",
                    "Red, White, RosÃ©, Sparkling", "How's the tasting today?",
                    "Very Special Client?", "Search wine...",
                    "Rioja, Ribeira, Rueda?", "Any international one?",
                    "Maybe a French wine"
                ],
                refs: "references available", region: "Region", country: "Country",
                year: "Year", format: "Format", btnLabel: "ðŸ‡¬ðŸ‡§ EN"
            },
            pt: {
                placeholders: [
                    "Encontre a garrafa", "Uma taÃ§a? Uma garrafa?",
                    "Tempranillo, Garnacha, MencÃ­a", "AlbariÃ±o, Godello, Verdejo",
                    "Tinto, Branco, RosÃ©, Espumante", "Que tal a degustaÃ§Ã£o hoje?",
                    "Cliente muito especial?", "Buscar vinho...",
                    "Rioja, Ribeira, Rueda?", "Algum internacional?",
                    "Talvez um vinho francÃªs"
                ],
                refs: "referÃªncias disponÃ­veis", region: "RegiÃ£o", country: "PaÃ­s",
                year: "Ano", format: "Formato", btnLabel: "ðŸ‡§ðŸ‡· PT"
            }
        };

        // --- UTILITY ---
        function removeAccents(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function fmt(val) {
            return val != null ? val : 'â€”';
        }

        function fmtPrice(val) {
            return val != null ? val + 'â‚¬' : 'â€”';
        }

        function getGrapeColor(name) {
            return GRAPE_FAMILIES[name] || 'burgundy s3';
        }

        function renderGrapeTags(uvasArr) {
            if (!uvasArr || !uvasArr.length) return '';
            return '<div class="grape-tags">' +
                uvasArr.map(g => `<span class="grape-tag ${getGrapeColor(g)}">${g}</span>`).join('') +
                '</div>';
        }

        function getTipoBadge(tipo) {
            const code = tipo?.codigo || '';
            const info = TIPO_MAP[code] || TIPO_MAP['TO'];
            return { cls: info.cls, label: info[currentLang] || info.es };
        }

        // --- DATA LOADING ---
        // TODO: [SYNC] Replace fetch with real-time API subscription
        fetch('data/bodega_webapp.json')
            .then(r => r.json())
            .then(data => {
                // Filter out garbage entries (no pod or no descripcion)
                refs = data.filter(r => r.pod && r.descripcion);
                applyLocalEdits();
                preProcess();
                updateRefCount();
                console.log(`âœ“ Loaded ${refs.length} references (filtered ${data.length - refs.length} incomplete)`);
            })
            .catch(err => {
                console.error('Error loading data:', err);
                refs = [];
            });

        // --- LOCAL EDIT PERSISTENCE ---
        // TODO: [SYNC] Replace localStorage with API POST for edits
        function applyLocalEdits() {
            try {
                const edits = JSON.parse(localStorage.getItem('cava_edits') || '[]');
                edits.forEach(edit => {
                    const ref = refs.find(r => r.pod === edit.pod);
                    if (!ref) return;
                    setNestedValue(ref, edit.path, edit.value);
                });
                if (edits.length) console.log(`âœ“ Applied ${edits.length} local edits`);
            } catch (e) { /* ignore parse errors */ }
        }

        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            let cur = obj;
            for (let i = 0; i < keys.length - 1; i++) {
                if (!cur[keys[i]]) cur[keys[i]] = {};
                cur = cur[keys[i]];
            }
            cur[keys[keys.length - 1]] = value;
        }

        function saveEdit(pod, path, value) {
            try {
                const edits = JSON.parse(localStorage.getItem('cava_edits') || '[]');
                // Upsert: replace existing edit for same pod+path
                const idx = edits.findIndex(e => e.pod === pod && e.path === path);
                if (idx >= 0) edits[idx].value = value;
                else edits.push({ pod, path, value });
                localStorage.setItem('cava_edits', JSON.stringify(edits));
                // TODO: [SYNC] Send edit to server via WebSocket/API
            } catch (e) { /* ignore */ }
        }

        // --- PRE-PROCESSING ---
        function preProcess() {
            searchIndex = [];
            pvpMedio = {};
            subsets = { spa: new Set(), tasca_fina: new Set(), victoria: new Set() };

            refs.forEach((ref, i) => {
                // Build searchable string
                const parts = [
                    ref.descripcion, ref.region, ref.pais, ref.bodega,
                    ref.tipo?.nombre, ...(ref.uvas || []),
                    ref.ano ? String(ref.ano) : '', ref.pod
                ].filter(Boolean).join(' ');

                searchIndex.push({ idx: i, str: removeAccents(parts.toLowerCase()) });

                // Compute average PVP across visible establishments
                let prices = [];
                EST_KEYS.forEach(k => {
                    const est = ref.establecimientos?.[k];
                    if (est && est.pvp != null) {
                        prices.push(est.pvp);
                        subsets[k].add(i);
                    }
                });
                pvpMedio[ref.pod] = prices.length > 0
                    ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length)
                    : null;
            });
        }

        function updateRefCount() {
            let count = refs.length;
            if (currentFilter !== 'todos') {
                count = subsets[currentFilter]?.size || 0;
            }
            document.getElementById('totalRef').textContent = count;
        }

        // --- FILTER & SORT ---
        document.querySelectorAll('.filter-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.filter-pill.active').classList.remove('active');
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                updateRefCount();
                triggerSearch();
            });
        });

        document.getElementById('sortToggle').addEventListener('click', function() {
            currentSort = currentSort === 'abc' ? 'pvp' : 'abc';
            this.textContent = currentSort.toUpperCase();
            triggerSearch();
        });

        // --- SEARCH ---
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');

        let debounceTimer;
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => triggerSearch(), 150);
        });

        function triggerSearch() {
            const query = removeAccents(searchInput.value.toLowerCase().trim());
            searchResults.innerHTML = '';

            if (!query) {
                searchResults.style.display = 'none';
                return;
            }

            // Filter by search query
            let results = searchIndex.filter(item => item.str.includes(query));

            // Apply establishment filter
            if (currentFilter !== 'todos') {
                results = results.filter(item => subsets[currentFilter].has(item.idx));
            }

            // Apply sort
            if (currentSort === 'abc') {
                results.sort((a, b) => (refs[a.idx].descripcion || '').localeCompare(refs[b.idx].descripcion || ''));
            } else {
                results.sort((a, b) => {
                    const pa = getDisplayPrice(refs[a.idx]);
                    const pb = getDisplayPrice(refs[b.idx]);
                    return (pa ?? Infinity) - (pb ?? Infinity);
                });
            }

            if (results.length > 0) {
                results.forEach(item => {
                    const ref = refs[item.idx];
                    const el = document.createElement('div');
                    el.className = 'search-item';

                    const badge = getTipoBadge(ref.tipo);
                    const price = getDisplayPrice(ref);
                    const loc = getDisplayLocation(ref);
                    const formatLabel = ref.formato?.etiqueta && ref.formato.etiqueta !== 'Botella (75cl)'
                        ? ref.formato.etiqueta : '';

                    el.innerHTML = `
                        <div class="item-info">
                            <div class="item-title">${ref.descripcion || 'â€”'}</div>
                            ${renderGrapeTags(ref.uvas)}
                            <div class="badge-row">
                                <span class="badge ${badge.cls}">${badge.label}</span>
                                <span class="item-region">${fmt(ref.region)}</span>
                                ${formatLabel ? `<span class="item-format">${formatLabel}</span>` : ''}
                            </div>
                        </div>
                        <div class="item-right">
                            <div class="item-price">${fmtPrice(price)}</div>
                            ${loc ? `<div class="item-location">${loc}</div>` : ''}
                        </div>
                    `;

                    el.addEventListener('click', () => openModal(ref));
                    searchResults.appendChild(el);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        }

        function getDisplayPrice(ref) {
            if (currentFilter !== 'todos') {
                return ref.establecimientos?.[currentFilter]?.pvp ?? null;
            }
            return pvpMedio[ref.pod] ?? null;
        }

        function getDisplayLocation(ref) {
            if (currentFilter !== 'todos') {
                return ref.establecimientos?.[currentFilter]?.localizacion || null;
            }
            return null; // No location in TODOS mode (varies by establishment)
        }

        // --- MODAL ---
        const wineModal = document.getElementById('wineModal');

        function openModal(ref) {
            currentEditPod = ref.pod;
            const badge = getTipoBadge(ref.tipo);

            document.getElementById('modalBadge').className = `badge ${badge.cls}`;
            document.getElementById('modalBadge').textContent = badge.label;
            document.getElementById('modalName').textContent = ref.descripcion || 'â€”';

            // Subtitle: Bodega | Year | Format
            const parts = [ref.bodega, ref.ano, ref.formato?.etiqueta].filter(Boolean);
            document.getElementById('modalSubtitle').textContent = parts.join(' Â· ') || 'â€”';

            // Grapes
            document.getElementById('modalGrapes').innerHTML = renderGrapeTags(ref.uvas);

            // Detail boxes
            document.getElementById('modalRegion').textContent = fmt(ref.region);
            document.getElementById('modalCountry').textContent = fmt(ref.pais);
            document.getElementById('modalYear').textContent = fmt(ref.ano);
            document.getElementById('modalFormat').textContent = fmt(ref.formato?.etiqueta);

            // Establishment table
            EST_KEYS.forEach(k => {
                const est = ref.establecimientos?.[k];
                const prefix = k === 'spa' ? 'Spa' : k === 'tasca_fina' ? 'Tasca' : 'Victoria';
                document.getElementById(`est${prefix}Pvp`).textContent = fmtPrice(est?.pvp);
                document.getElementById(`est${prefix}Stock`).textContent = fmt(est?.unidades);
                document.getElementById(`est${prefix}Loc`).textContent = fmt(est?.localizacion);
            });

            // Reset edit form
            document.getElementById('editForm').classList.remove('visible');
            document.getElementById('btnEditWine').style.display = 'inline-block';

            searchResults.style.display = 'none';
            searchInput.blur();
            wineModal.classList.add('active');
        }

        function closeModal() {
            wineModal.classList.remove('active');
            searchInput.value = '';
        }

        document.getElementById('btnClose').addEventListener('click', closeModal);
        wineModal.addEventListener('click', e => { if (e.target === wineModal) closeModal(); });

        // --- EDIT ---
        document.getElementById('btnEditWine').addEventListener('click', () => {
            if (!currentEditPod) return;
            const ref = refs.find(r => r.pod === currentEditPod);
            if (!ref) return;

            document.getElementById('editDesc').value = ref.descripcion || '';
            document.getElementById('editRegion').value = ref.region || '';
            document.getElementById('editUvas').value = (ref.uvas || []).join(', ');

            EST_KEYS.forEach(k => {
                const est = ref.establecimientos?.[k] || {};
                const prefix = k === 'spa' ? 'Spa' : k === 'tasca_fina' ? 'Tasca' : 'Victoria';
                document.getElementById(`edit${prefix}Pvp`).value = est.pvp != null ? est.pvp : '';
                document.getElementById(`edit${prefix}Stock`).value = est.unidades != null ? est.unidades : '';
                document.getElementById(`edit${prefix}Loc`).value = est.localizacion || '';
            });

            document.getElementById('editForm').classList.add('visible');
            document.getElementById('btnEditWine').style.display = 'none';
        });

        document.getElementById('btnCancelEdit').addEventListener('click', () => {
            document.getElementById('editForm').classList.remove('visible');
            document.getElementById('btnEditWine').style.display = 'inline-block';
        });

        document.getElementById('btnSaveEdit').addEventListener('click', () => {
            if (!currentEditPod) return;
            const ref = refs.find(r => r.pod === currentEditPod);
            if (!ref) return;

            // Save descripcion
            const desc = document.getElementById('editDesc').value.trim();
            if (desc && desc !== ref.descripcion) {
                ref.descripcion = desc;
                saveEdit(currentEditPod, 'descripcion', desc);
            }

            // Save region
            const region = document.getElementById('editRegion').value.trim();
            if (region !== (ref.region || '')) {
                ref.region = region || null;
                saveEdit(currentEditPod, 'region', region || null);
            }

            // Save uvas
            const uvasStr = document.getElementById('editUvas').value.trim();
            const uvasArr = uvasStr ? uvasStr.split(',').map(u => u.trim()).filter(Boolean) : [];
            ref.uvas = uvasArr;
            saveEdit(currentEditPod, 'uvas', uvasArr);

            // Save per-establishment fields
            EST_KEYS.forEach(k => {
                if (!ref.establecimientos) ref.establecimientos = {};
                if (!ref.establecimientos[k]) ref.establecimientos[k] = { pvp: null, unidades: null, localizacion: null };
                const est = ref.establecimientos[k];
                const prefix = k === 'spa' ? 'Spa' : k === 'tasca_fina' ? 'Tasca' : 'Victoria';

                const pvpVal = document.getElementById(`edit${prefix}Pvp`).value;
                const pvp = pvpVal !== '' ? Number(pvpVal) : null;
                if (pvp !== est.pvp) { est.pvp = pvp; saveEdit(currentEditPod, `establecimientos.${k}.pvp`, pvp); }

                const stockVal = document.getElementById(`edit${prefix}Stock`).value;
                const stock = stockVal !== '' ? Number(stockVal) : null;
                if (stock !== est.unidades) { est.unidades = stock; saveEdit(currentEditPod, `establecimientos.${k}.unidades`, stock); }

                const loc = document.getElementById(`edit${prefix}Loc`).value.trim().toUpperCase() || null;
                if (loc !== est.localizacion) { est.localizacion = loc; saveEdit(currentEditPod, `establecimientos.${k}.localizacion`, loc); }
            });

            // Recompute indexes
            preProcess();
            updateRefCount();

            // Refresh modal
            openModal(ref);
        });

        // --- LANGUAGE ---
        function getNextPhrase() {
            if (phraseQueue.length === 0) {
                phraseQueue = [...translations[currentLang].placeholders];
                for (let i = phraseQueue.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [phraseQueue[i], phraseQueue[j]] = [phraseQueue[j], phraseQueue[i]];
                }
                if (phraseQueue[0] === currentPhrase && phraseQueue.length > 1) {
                    phraseQueue.push(phraseQueue.shift());
                }
            }
            return phraseQueue.pop();
        }

        function startTypeWriter() {
            const input = document.getElementById('searchInput');
            if (!input) return;

            if (!currentPhrase) currentPhrase = getNextPhrase();

            if (isDeleting) {
                input.placeholder = currentPhrase.substring(0, charIndex - 1);
                charIndex--;
            } else {
                input.placeholder = currentPhrase.substring(0, charIndex + 1);
                charIndex++;
            }

            let speed = isDeleting ? 20 : 50;

            if (!isDeleting && charIndex === currentPhrase.length) {
                speed = 2000;
                isDeleting = true;
            } else if (isDeleting && charIndex === 0) {
                isDeleting = false;
                currentPhrase = getNextPhrase();
                speed = 500;
            }

            clearTimeout(typeWriterTimeout);
            typeWriterTimeout = setTimeout(startTypeWriter, speed);
        }

        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            document.getElementById('currentLangBtn').textContent = t.btnLabel;

            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (t[key] && el.tagName !== 'INPUT') el.textContent = t[key];
            });

            phraseQueue = [];
            currentPhrase = '';
            charIndex = 0;
            isDeleting = false;
            clearTimeout(typeWriterTimeout);
            startTypeWriter();

            // Refresh search results if visible
            triggerSearch();
        }

        // --- DARK/LIGHT MODE TOGGLE (CANVAS) ---
        const themeToggle = document.getElementById('themeToggle');
        const toggleCanvas = document.getElementById('toggleCanvas');
        const tCtx = toggleCanvas.getContext('2d');
        toggleCanvas.width = 80;
        toggleCanvas.height = 40;

        let isDark = true;
        let toggleProgress = 1;
        const lerp = (a, b, t) => a + (b - a) * t;

        function drawToggle() {
            const w = toggleCanvas.width, h = toggleCanvas.height;
            tCtx.clearRect(0, 0, w, h);

            const r = lerp(96, 30, toggleProgress);
            const g = lerp(165, 27, toggleProgress);
            const b = lerp(250, 75, toggleProgress);
            tCtx.fillStyle = `rgb(${r},${g},${b})`;
            tCtx.beginPath();
            tCtx.roundRect(0, 0, w, h, 20);
            tCtx.fill();

            if (toggleProgress > 0.1) {
                tCtx.fillStyle = `rgba(255,255,255,${toggleProgress})`;
                [{x:20,y:10},{x:40,y:30},{x:15,y:30},{x:50,y:10}].forEach(s => {
                    tCtx.beginPath(); tCtx.arc(s.x, s.y, 1.5, 0, Math.PI*2); tCtx.fill();
                });
            }

            const cloudOp = Math.max(0, 1 - toggleProgress * 2);
            if (cloudOp > 0) {
                tCtx.fillStyle = `rgba(255,255,255,${cloudOp * 0.8})`;
                tCtx.beginPath();
                tCtx.arc(50,30,8,0,Math.PI*2); tCtx.arc(60,35,10,0,Math.PI*2); tCtx.arc(70,30,8,0,Math.PI*2);
                tCtx.fill();
            }

            const cx = lerp(20, w-20, toggleProgress), cy = h/2, rad = 14;
            const ar = lerp(251,226,toggleProgress), ag = lerp(191,232,toggleProgress), ab = lerp(36,240,toggleProgress);
            tCtx.fillStyle = `rgb(${ar},${ag},${ab})`;
            tCtx.shadowBlur = 10;
            tCtx.shadowColor = `rgba(${ar},${ag},${ab},0.5)`;
            tCtx.beginPath(); tCtx.arc(cx, cy, rad, 0, Math.PI*2); tCtx.fill();
            tCtx.shadowBlur = 0;

            if (toggleProgress > 0.1) {
                const maskOff = lerp(rad*2, 6, toggleProgress);
                tCtx.fillStyle = `rgb(${r},${g},${b})`;
                tCtx.beginPath(); tCtx.arc(cx - maskOff, cy - 2, rad, 0, Math.PI*2); tCtx.fill();
            }

            const rayOp = Math.max(0, 1 - toggleProgress * 3);
            if (rayOp > 0) {
                tCtx.strokeStyle = `rgba(251,191,36,${rayOp})`;
                tCtx.lineWidth = 2; tCtx.lineCap = 'round';
                for (let i = 0; i < 6; i++) {
                    const angle = (i * Math.PI * 2) / 6 + (toggleProgress * 2);
                    tCtx.beginPath();
                    tCtx.moveTo(cx + Math.cos(angle)*(rad+3), cy + Math.sin(angle)*(rad+3));
                    tCtx.lineTo(cx + Math.cos(angle)*(rad+7), cy + Math.sin(angle)*(rad+7));
                    tCtx.stroke();
                }
            }

            const target = isDark ? 1 : 0;
            if (Math.abs(toggleProgress - target) > 0.001) {
                toggleProgress += (target - toggleProgress) * 0.1;
                requestAnimationFrame(drawToggle);
            }
        }

        themeToggle.addEventListener('click', () => {
            isDark = !isDark;
            document.body.classList.toggle('light-mode');
            drawToggle();
        });

        // --- GOLD PARTICLES ---
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        let particlesArray = [];

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initParticles();
        });

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speedX = Math.random() * 0.5 - 0.25;
                this.speedY = Math.random() * 0.5 - 0.25;
                this.opacity = Math.random() * 0.5 + 0.1;
            }
            update() {
                this.x += this.speedX;
                this.y -= this.speedY;
                if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                if (this.y < 0) this.y = canvas.height;
                if (this.y > canvas.height) this.y = 0;
            }
            draw() {
                ctx.fillStyle = `rgba(212,175,55,${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particlesArray = [];
            const n = Math.round((canvas.width * canvas.height) / 5500 * 2.0);
            for (let i = 0; i < n; i++) particlesArray.push(new Particle());
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particlesArray.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateParticles);
        }

        initParticles();
        animateParticles();
        drawToggle();
        startTypeWriter();

        // --- MOBILE KEYBOARD ---
        const initialVH = window.innerHeight;
        if ('visualViewport' in window) {
            window.visualViewport.addEventListener('resize', () => {
                if (window.visualViewport.height / initialVH < 0.75) {
                    document.body.classList.add('keyboard-open');
                } else {
                    document.body.classList.remove('keyboard-open');
                }
            });
        }

        // Prevent iOS double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', e => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
        }, false);

        // --- PWA ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }

        // TODO: [SYNC] Add WebSocket connection for real-time data updates
        // TODO: [SYNC] Implement optimistic UI updates with server reconciliation
        // TODO: [SYNC] Add conflict resolution for concurrent edits across devices
    </script>
</body>
</html>
