<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    
    <!-- Build: 2026-02-24-GALICIA-DO -->
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="STOCK Cava">
    <meta name="theme-color" content="#08080b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Carta de vinos premium ‚Äî STOCK Cava Metropolis. Descubre nuestra selecci√≥n exclusiva de vinos de alta gama.">
    <meta name="keywords" content="vinos, cava, stock cava, carta de vinos, metropolis, vinos premium, bodega">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://stockcava.com/">
    <meta property="og:title" content="STOCK Cava Metropolis">
    <meta property="og:description" content="Carta de vinos premium ‚Äî Descubre nuestra selecci√≥n exclusiva.">
    <meta property="og:image" content="https://stockcava.com/imgs/icon-512.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://stockcava.com/">
    <meta property="twitter:title" content="STOCK Cava Metropolis">
    <meta property="twitter:description" content="Carta de vinos premium ‚Äî Descubre nuestra selecci√≥n exclusiva.">
    <meta property="twitter:image" content="https://stockcava.com/imgs/icon-512.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="canonical" href="https://stockcava.com/">
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="imgs/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="imgs/favicon-16x16.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="imgs/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="imgs/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="167x167" href="imgs/apple-touch-icon-ipad.png">
    
    <title>STOCK Cava Metropolis ‚Äî Carta de Vinos Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- PALETA HIGH-CLASS --- */
        :root {
            --bg-color: #08080b;
            --glass-bg: rgba(35, 35, 40, 0.8);
            --glass-border: rgba(212, 175, 55, 0.25);
            --text-main: #FDFBF7;
            --text-muted: #B8B0A0;
            --gold-accent: #D4AF37;
            --gold-light: #F3E5AB;
            --price-bg: rgba(46, 125, 50, 0.15);
            --price-color: #57C25B;
            --minicard-bg: rgba(255, 255, 255, 0.05);
            --transition-bounce: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --transition-smooth: all 0.4s ease;
        }

        body.light-mode {
            --bg-color: #FDFBF7;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(212, 175, 55, 0.4);
            --text-main: #1A1A1A;
            --text-muted: #666156;
            --gold-accent: #B8860B;
            --gold-light: #D4AF37;
            --price-bg: rgba(46, 125, 50, 0.1);
            --price-color: #2E7D32;
            --minicard-bg: rgba(0, 0, 0, 0.02);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            transition: background-color 0.8s ease, color 0.8s ease;
            min-height: 100dvh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 22dvh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Entrance animation */
        @keyframes fadeSlideUp {
            0% { opacity: 0; transform: translateY(40px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        header { animation: fadeSlideUp 0.8s ease-out both; }
        .search-container { animation: fadeSlideUp 0.8s ease-out 0.15s both; }
        .theme-toggle { animation: fadeSlideUp 0.5s ease-out 0.3s both; }

        /* --- GOLDEN PARTICLES (CANVAS) --- */
        #particleCanvas {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 0;
            pointer-events: none;
        }

        /* --- HEADER --- */
        header {
            margin-top: 0;
            margin-bottom: 2rem;
            text-align: center;
            z-index: 10;
        }

        .title-cava {
            color: var(--gold-accent);
            line-height: 1;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            transition: var(--transition-smooth);
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.8vw;
            margin-bottom: -0.5rem;
        }

        .stock-text {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 7vw;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .cava-text {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            font-weight: 400;
            font-size: 7vw;
        }

        .title-metropolis {
            font-family: 'Montserrat', sans-serif;
            font-size: 10vw;
            letter-spacing: 0.5vw;
            font-weight: 600;
            color: var(--text-main);
            padding: 0 5vw;
            text-shadow:
                0 0 5px rgba(255, 255, 255, 0.6),
                0 0 15px var(--gold-accent),
                0 0 30px rgba(212, 175, 55, 0.4);
        }

        /* --- SEARCH BAR (GLASSMORPHISM) --- */
        .search-container {
            width: 90%;
            max-width: 600px;
            position: relative;
            z-index: 20;
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
        }

        .search-input-wrapper {
            position: relative;
            width: 100%;
        }

        .search-icon {
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px; height: 20px;
            fill: var(--text-muted);
        }

        #searchInput {
            width: 100%;
            padding: 1.2rem 1rem 1.2rem 2rem;
            font-size: 1.3rem;
            font-family: 'Montserrat', sans-serif;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            color: var(--text-main);
            outline: none;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: var(--transition-smooth);
        }

        #searchInput:focus {
            border-color: var(--gold-accent);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        #searchInput::placeholder { color: var(--text-muted); font-weight: 300; }

        .ref-count {
            text-align: center;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            letter-spacing: 1px;
            font-weight: 300;
            order: -1;
        }
        .ref-count span { color: var(--gold-accent); font-weight: 700; }

        /* --- FILTER BAR --- */
        .filter-bar {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            margin-top: 0.6rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-pill {
            padding: 0.35rem 0.7rem;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-muted);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.8px;
            cursor: pointer;
            transition: all 0.25s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            white-space: nowrap;
        }

        .filter-pill:active { transform: scale(0.95); }

        .filter-pill.active {
            background: var(--gold-accent);
            color: #111;
            border-color: var(--gold-accent);
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
        }

        .sort-toggle {
            padding: 0.35rem 0.7rem;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--gold-accent);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.8px;
            cursor: pointer;
            transition: all 0.25s ease;
            margin-left: auto;
        }
        .sort-toggle:active { transform: scale(0.95); }

        /* --- DROPDOWN RESULTS --- */
        #searchResults {
            position: absolute;
            top: 100%;
            left: 0; right: 0;
            background: transparent;
            max-height: 60vh;
            overflow-y: auto;
            display: none;
            z-index: 9999;
        }

        .search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.55rem 1rem;
            margin-bottom: 0.3rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.15s ease, background 0.2s ease;
        }
        .search-item:first-child { margin-top: 2mm; }

        @media (hover: hover) {
            .search-item:hover {
                background: rgba(212, 175, 55, 0.12);
                border-color: var(--gold-accent);
            }
        }
        .search-item:active {
            background: rgba(212, 175, 55, 0.18);
            transform: scale(0.98);
        }

        .item-info { display: flex; flex-direction: column; gap: 0.18rem; flex: 1; min-width: 0; }

        .item-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- GRAPE TAG FAMILIES --- */
        .grape-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.1rem;
        }

        .grape-tag {
            display: inline-block;
            padding: 0.18rem 0.45rem;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            cursor: default;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .grape-tag.iberica-tinta { background: linear-gradient(135deg, #E53935 0%, #D32626 100%); }
        .grape-tag.iberica-tinta.s2 { background: linear-gradient(135deg, #F44336 0%, #E53935 100%); }
        .grape-tag.iberica-tinta.s3 { background: linear-gradient(135deg, #FF6F6F 0%, #F44336 100%); }

        .grape-tag.burgundy { background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%); }
        .grape-tag.burgundy.s2 { background: linear-gradient(135deg, #9333EA 0%, #7C3AED 100%); }
        .grape-tag.burgundy.s3 { background: linear-gradient(135deg, #A855F7 0%, #9333EA 100%); }

        .grape-tag.italiana { background: linear-gradient(135deg, #C23030 0%, #B71C1C 100%); }
        .grape-tag.italiana.s2 { background: linear-gradient(135deg, #D32626 0%, #C23030 100%); }
        .grape-tag.italiana.s3 { background: linear-gradient(135deg, #E53935 0%, #D32626 100%); }

        .grape-tag.aromatico { background: linear-gradient(135deg, #F9A825 0%, #F57F17 100%); }
        .grape-tag.aromatico.s2 { background: linear-gradient(135deg, #FBC02D 0%, #F9A825 100%); }
        .grape-tag.aromatico.s3 { background: linear-gradient(135deg, #FDD835 0%, #FBC02D 100%); }

        .grape-tag.novamundo { background: linear-gradient(135deg, #8B1538 0%, #5F0F1D 100%); }
        .grape-tag.novamundo.s2 { background: linear-gradient(135deg, #A91D3A 0%, #8B1538 100%); }
        .grape-tag.novamundo.s3 { background: linear-gradient(135deg, #C81E4E 0%, #A91D3A 100%); }

        .grape-tag.espumoso { background: linear-gradient(135deg, #EC407A 0%, #D81B60 100%); }
        .grape-tag.espumoso.s2 { background: linear-gradient(135deg, #F06292 0%, #EC407A 100%); }
        .grape-tag.espumoso.s3 { background: linear-gradient(135deg, #F48FB1 0%, #F06292 100%); }

        .badge-row { display: flex; gap: 0.35rem; align-items: center; margin-top: 0.05rem; }

        .badge {
            font-size: 0.58rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 0.18rem 0.45rem;
            border-radius: 4px;
            letter-spacing: 0.8px;
            color: #111;
        }

        .item-region { font-size: 0.72rem; color: var(--text-muted); }

        .item-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.3rem;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .item-price {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            color: var(--price-color);
            font-size: 1.05rem;
            letter-spacing: 0.5px;
        }

        .item-location {
            font-size: 0.75rem;
            color: var(--text-main);
            font-weight: 700;
            letter-spacing: 1.5px;
            font-family: 'Montserrat', monospace;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(180, 135, 25, 0.2));
            border: 1px solid var(--gold-accent);
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            display: inline-block;
            box-shadow: 0 2px 6px rgba(212, 175, 55, 0.15);
            white-space: nowrap;
        }

        .item-pod {
            font-size: 0.55rem;
            color: var(--text-muted);
            font-family: 'Montserrat', monospace;
            opacity: 0.6;
            letter-spacing: 0.5px;
        }

        .item-format {
            font-size: 0.6rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .modal-overlay.active { display: flex; opacity: 1; }

        .modal-card {
            width: 90%;
            max-width: 500px;
            background: var(--bg-color);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            position: relative;
            transform: translateY(30px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            max-height: 90dvh;
            overflow-y: auto;
        }

        .modal-overlay.active .modal-card { transform: translateY(0) scale(1); }

        .btn-close {
            position: absolute;
            top: 1.5rem; right: 1.5rem;
            background: none; border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        .btn-close:hover { color: var(--gold-accent); transform: scale(1.1); }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            line-height: 1.3;
            color: var(--text-main);
            margin: 1rem 0 0.5rem 0;
            padding-right: 20px;
        }

        .modal-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .modal-grapes {
            margin-bottom: 1rem;
        }
        .modal-grapes .grape-tag {
            font-size: 0.7rem;
            padding: 0.3rem 0.5rem;
        }

        /* Details grid for D.O., Country, Year, Format */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1.2rem;
        }

        .detail-box {
            background: var(--minicard-bg);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 12px;
            padding: 0.8rem;
            text-align: center;
        }

        .detail-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 0.2rem;
        }

        .detail-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            color: var(--text-main);
            font-weight: 600;
        }

        /* Terroir section (Clima & Suelo) */
        .terroir-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1.2rem;
        }

        .terroir-label {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--gold-accent);
            opacity: 0.7;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .terroir-box {
            background: linear-gradient(135deg, rgba(100,180,255,0.04), var(--minicard-bg));
            border: 1px solid rgba(100, 180, 255, 0.12);
            border-radius: 12px;
            padding: 0.8rem;
            text-align: center;
        }

        .terroir-box .detail-value {
            font-size: 0.82rem;
            line-height: 1.3;
        }

        /* Establishment pricing table */
        .est-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.2rem;
        }

        .est-table th {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gold-accent);
            padding: 0.5rem 0.3rem;
            border-bottom: 1px solid var(--glass-border);
            text-align: center;
        }

        .est-table td {
            font-size: 0.85rem;
            color: var(--text-main);
            padding: 0.4rem 0.3rem;
            text-align: center;
            border-bottom: 1px solid rgba(212, 175, 55, 0.08);
        }

        .est-table .row-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: left;
            font-weight: 600;
        }

        .est-table .pvp-cell {
            font-weight: 900;
            color: var(--price-color);
            font-size: 1rem;
        }

        .est-table .loc-cell {
            font-family: 'Montserrat', monospace;
            font-weight: 700;
            letter-spacing: 1px;
            font-size: 0.8rem;
        }

        /* --- THEME TOGGLE --- */
        .top-actions {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 7px;
            align-items: flex-end;
        }

        @keyframes dropToPlace {
            0% { transform: translateY(-26px) scale(0.96); }
            60% { transform: translateY(2px) scale(1.005); }
            100% { transform: translateY(0) scale(1); }
        }

        @keyframes slideFromRight {
            0% { transform: translateX(28px) scale(0.97); }
            70% { transform: translateX(-1px) scale(1.002); }
            100% { transform: translateX(0) scale(1); }
        }

        @keyframes riseFromBottom {
            0% { transform: translateY(18px) scale(0.965); }
            65% { transform: translateY(-1px) scale(1.002); }
            100% { transform: translateY(0) scale(1); }
        }

        .theme-toggle {
            width: 60px; height: 30px;
            border-radius: 15px;
            background: transparent;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            overflow: hidden;
            padding: 0;
            transition: all 0.3s ease;
            animation: dropToPlace 730ms cubic-bezier(0.22, 0.78, 0.28, 1) both;
        }

        .theme-toggle:hover {
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
            transform: scale(1.05);
        }

        #toggleCanvas { width: 100%; height: 100%; display: block; }

        /* --- LANGUAGE SELECTOR --- */
        .lang-container {
            position: relative;
            z-index: 2;
            font-family: 'Montserrat', sans-serif;
            animation: slideFromRight 700ms cubic-bezier(0.22, 0.78, 0.28, 1) 125ms both;
        }

        .app-signature {
            position: fixed;
            left: 50%;
            bottom: max(10px, env(safe-area-inset-bottom));
            transform: translateX(-50%);
            z-index: 1;
            pointer-events: none;
            user-select: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            font-size: clamp(0.62rem, 1.6vw, 0.78rem);
            letter-spacing: 0.16em;
            color: var(--text-muted);
            opacity: 0.24;
            text-transform: lowercase;
            white-space: nowrap;
            text-shadow: 0 0 14px rgba(212, 175, 55, 0.12);
        }
        .logout-btn,
        .admin-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            width: 60px;
            height: 30px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.62rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            padding: 0;
            backdrop-filter: blur(10px);
            transition: all 0.28s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1;
            font-family: 'Montserrat', sans-serif;
        }
        .admin-btn {
            animation: riseFromBottom 700ms cubic-bezier(0.22, 0.78, 0.28, 1) 190ms both;
        }
        .logout-btn {
            animation: riseFromBottom 700ms cubic-bezier(0.22, 0.78, 0.28, 1) 250ms both;
        }
        .logout-btn:hover,
        .admin-btn:hover {
            border-color: var(--gold-accent);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
        }

        .lang-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            width: 60px; height: 30px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.68rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center; gap: 4px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .lang-btn:hover {
            border-color: var(--gold-accent);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
        }

        .lang-dropdown {
            position: absolute;
            top: 120%; right: 0;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            overflow: hidden;
            opacity: 0; visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition-smooth);
            backdrop-filter: blur(15px);
            min-width: 100px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .lang-container:hover .lang-dropdown {
            opacity: 1; visibility: visible;
            transform: translateY(0);
        }

        .lang-option {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 20px;
            color: var(--text-main);
            text-decoration: none;
            font-size: 0.9rem;
            transition: background 0.3s;
            cursor: pointer;
        }
        .lang-option:hover { background: rgba(212, 175, 55, 0.1); }

        /* Badge colors */
        .b-tinto { background: #800020; color: #FFF; }
        .b-branco { background: #E5C158; }
        .b-rosado { background: #E08D79; }
        .b-espumoso { background: #D4AF37; }
        .b-generoso { background: #C97B1A; color: #FFF; }
        .b-dulce { background: #8B6914; color: #FFF; }

        /* Edit form */
        .edit-form { display: none; margin-top: 1rem; }
        .edit-form.visible { display: block; }

        .edit-field {
            padding: 0.7rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--minicard-bg);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            width: 100%;
        }
        .edit-field:focus { outline: none; border-color: var(--gold-accent); }

        .edit-section-title {
            font-size: 0.65rem;
            color: var(--gold-accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 0.8rem;
            margin-bottom: 0.3rem;
            font-weight: 700;
        }

        .edit-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .edit-row .edit-field { flex: 1; }

        .edit-actions {
            display: flex;
            gap: 0.6rem;
            justify-content: flex-end;
            margin-top: 0.8rem;
        }

        .btn-cancel {
            padding: 0.6rem 0.9rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .btn-save {
            padding: 0.6rem 0.9rem;
            border-radius: 8px;
            border: none;
            background: var(--gold-accent);
            color: #111;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .btn-edit {
            padding: 0.6rem 0.9rem;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-main);
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .modal-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.7rem;
            margin-top: 0.35rem;
        }

        .consume-actions {
            display: flex;
            align-items: center;
            gap: 0.45rem;
        }

        .consume-qty {
            height: 36px;
            min-width: 62px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            padding: 0 8px;
            outline: none;
            cursor: pointer;
        }

        .btn-consume {
            width: 44px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid rgba(255, 84, 84, 0.45);
            background: rgba(168, 19, 19, 0.22);
            color: #ff5d5d;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.25s ease;
            box-shadow: 0 4px 14px rgba(120, 10, 10, 0.28);
        }

        .btn-consume:hover {
            background: rgba(186, 27, 27, 0.36);
            border-color: rgba(255, 111, 111, 0.55);
            box-shadow: 0 6px 18px rgba(120, 10, 10, 0.38);
        }

        .consume-feedback {
            margin-top: 0.5rem;
            min-height: 1.1rem;
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        @media (max-width: 600px) {
            .title-cava { gap: 1vw; margin-bottom: -0.3rem; }
            .stock-text { font-size: 7.5vw; letter-spacing: 0.05em; }
            .cava-text { font-size: 7.5vw; }
            .title-metropolis { font-size: 11vw; letter-spacing: 1px; padding: 0 20px; }
            .modal-card { padding: 1.5rem; max-height: 85dvh; }
            .modal-title { font-size: 1.5rem; }
            #searchInput { font-size: 1rem; padding: 1rem 1rem 1rem 2rem; }
            body { padding-top: 18dvh; }
            .top-actions { top: 15px; right: 15px; gap: 7px; }
        }

        body.keyboard-open { padding-top: 2dvh; }
        body.keyboard-open header { display: none; }
    </style>
</head>
<body>

    <script>
        (() => {
            try {
                const userRegistryKey = 'cava_user_registry_v1';
                const EST_KEYS = ['spa', 'tasca_fina', 'victoria'];
                const normalizeUsername = (value) => (value || '').trim().toLowerCase();
                const normalizeEstablishment = (value) => {
                    const normalized = (value || '').trim().toLowerCase();
                    return EST_KEYS.includes(normalized) ? normalized : null;
                };
                const normalizeScope = (value) => {
                    const normalized = (value || '').trim().toLowerCase();
                    return EST_KEYS.includes(normalized) || normalized === 'all' ? normalized : null;
                };
                const normalizeRole = (value) => {
                    const normalized = (value || '').trim().toLowerCase();
                    return ['user', 'admin', 'adminmaster'].includes(normalized) ? normalized : null;
                };
                const inferProfile = (username, establishment) => {
                    const normalized = normalizeUsername(username);
                    if (normalized === '0xmanel') {
                        return { role: 'adminmaster', scope: 'all' };
                    }

                    try {
                        const raw = localStorage.getItem(userRegistryKey);
                        const parsed = raw ? JSON.parse(raw) : [];
                        if (Array.isArray(parsed)) {
                            const match = parsed.find((user) => normalizeUsername(user.username) === normalized);
                            if (match) {
                                const matchRole = normalizeRole(match.role) || 'user';
                                const safeRole = matchRole === 'adminmaster' ? 'admin' : matchRole;
                                const matchScope = normalizeScope(match.scope) || normalizeEstablishment(establishment) || 'spa';
                                return {
                                    role: safeRole,
                                    scope: matchScope === 'all' ? (normalizeEstablishment(establishment) || 'spa') : matchScope
                                };
                            }
                        }
                    } catch {
                        // ignore parse failures and fallback to user
                    }

                    return null;
                };

                const sessionFlag = sessionStorage.getItem('cava_login_demo') === 'ok';
                const persistentFlag = localStorage.getItem('cava_login_persistent_access') === '1';

                if (!sessionFlag && !persistentFlag) {
                    window.location.replace('login.html');
                    return;
                }

                if (!sessionFlag && persistentFlag) {
                    const persistentUser = localStorage.getItem('cava_login_persistent_user') || '';
                    const persistentIsOwner = normalizeUsername(persistentUser) === '0xmanel';
                    const persistentEstablishment = normalizeEstablishment(localStorage.getItem('cava_login_persistent_establishment')) || 'spa';
                    const inferred = inferProfile(persistentUser, persistentEstablishment);
                    if (!inferred && !persistentIsOwner) {
                        localStorage.removeItem('cava_login_persistent_access');
                        localStorage.removeItem('cava_login_persistent_user');
                        localStorage.removeItem('cava_login_persistent_establishment');
                        localStorage.removeItem('cava_login_persistent_role');
                        localStorage.removeItem('cava_login_persistent_scope');
                        window.location.replace('login.html');
                        return;
                    }
                    const persistentRole = persistentIsOwner ? 'adminmaster' : inferred.role;
                    const persistentScope = persistentIsOwner ? 'all' : inferred.scope;
                    const establishmentToUse = persistentIsOwner
                        ? 'spa'
                        : (EST_KEYS.includes(persistentScope) ? persistentScope : persistentEstablishment);

                    localStorage.setItem('cava_login_persistent_role', persistentRole);
                    localStorage.setItem('cava_login_persistent_scope', persistentScope);

                    if (localStorage.getItem('cava_login_persistent_establishment') !== establishmentToUse) {
                        localStorage.setItem('cava_login_persistent_establishment', establishmentToUse);
                    }

                    sessionStorage.setItem('cava_login_demo', 'ok');
                    sessionStorage.setItem('cava_login_user', persistentUser);
                    sessionStorage.setItem('cava_login_establishment', establishmentToUse);
                    sessionStorage.setItem('cava_login_role', persistentRole);
                    sessionStorage.setItem('cava_login_scope', persistentScope);
                }

                const sessionUser = sessionStorage.getItem('cava_login_user') || localStorage.getItem('cava_login_persistent_user') || '';
                const isOwner = normalizeUsername(sessionUser) === '0xmanel';
                const sessionEstablishment = normalizeEstablishment(
                    sessionStorage.getItem('cava_login_establishment') || localStorage.getItem('cava_login_persistent_establishment')
                ) || 'spa';
                const inferred = inferProfile(sessionUser, sessionEstablishment);
                if (!inferred && !isOwner) {
                    sessionStorage.removeItem('cava_login_demo');
                    sessionStorage.removeItem('cava_login_user');
                    sessionStorage.removeItem('cava_login_establishment');
                    sessionStorage.removeItem('cava_login_role');
                    sessionStorage.removeItem('cava_login_scope');
                    window.location.replace('login.html');
                    return;
                }
                const roleToUse = isOwner ? 'adminmaster' : inferred.role;
                const scopeToUse = isOwner ? 'all' : inferred.scope;
                const establishmentToUse = isOwner ? 'spa' : (EST_KEYS.includes(scopeToUse) ? scopeToUse : sessionEstablishment);
                sessionStorage.setItem('cava_login_role', roleToUse);
                sessionStorage.setItem('cava_login_scope', scopeToUse);
                sessionStorage.setItem('cava_login_establishment', establishmentToUse);

                if (persistentFlag) {
                    localStorage.setItem('cava_login_persistent_role', roleToUse);
                    localStorage.setItem('cava_login_persistent_scope', scopeToUse);
                    if (localStorage.getItem('cava_login_persistent_establishment') !== establishmentToUse) {
                        localStorage.setItem('cava_login_persistent_establishment', establishmentToUse);
                    }
                }
            } catch {
                window.location.replace('login.html');
            }
        })();
    </script>

    <canvas id="particleCanvas"></canvas>

    <div class="app-signature" aria-hidden="true">stockcava@2026</div>

    <div class="top-actions">
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle Theme">
            <canvas id="toggleCanvas"></canvas>
        </button>

        <div class="lang-container">
            <button class="lang-btn" id="currentLangBtn">ES</button>
            <div class="lang-dropdown">
                <div class="lang-option" onclick="setLanguage('es')"><span>üá™üá∏</span> Espa√±ol</div>
                <div class="lang-option" onclick="setLanguage('en')"><span>üá¨üáß</span> English</div>
                <div class="lang-option" onclick="setLanguage('pt')"><span>üáßüá∑</span> Portugu√™s</div>
            </div>
        </div>

        <button class="admin-btn" id="adminBtn" data-translate="admin">Admin</button>
    </div>

    <header>
        <div class="title-cava">
            <span class="stock-text">STOCK</span>
            <span class="cava-text">Cava</span>
        </div>
        <div class="title-metropolis">METROPOLIS</div>
    </header>

    <div class="search-container">
        <div class="ref-count"><span id="totalRef">0</span> <span data-translate="refs">referencias disponibles</span></div>

        <div class="search-input-wrapper">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="searchInput" placeholder="" autocomplete="off">
        </div>

        <!-- Filter Pills + Sort Toggle -->
        <div class="filter-bar">
            <button class="filter-pill active" data-filter="todos">TODOS</button>
            <button class="filter-pill" data-filter="spa">SPA</button>
            <button class="filter-pill" data-filter="tasca_fina">TASCA FINA</button>
            <button class="filter-pill" data-filter="victoria">VICTORIA</button>
            <button class="sort-toggle" id="sortToggle">ABC</button>
        </div>

        <div id="searchResults"></div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="wineModal">
        <div class="modal-card">
            <button class="btn-close" id="btnClose">‚úï</button>

            <span class="badge" id="modalBadge">TINTO</span>
            <h2 class="modal-title" id="modalName">‚Äî</h2>
            <div class="modal-subtitle" id="modalSubtitle">‚Äî</div>

            <div class="modal-grapes" id="modalGrapes"></div>

            <div class="details-grid">
                <div class="detail-box">
                    <div class="detail-label">D.O. / <span data-translate="region">Regi√≥n</span></div>
                    <div class="detail-value" id="modalRegion">‚Äî</div>
                </div>
                <div class="detail-box">
                    <div class="detail-label" data-translate="country">Pa√≠s</div>
                    <div class="detail-value" id="modalCountry">‚Äî</div>
                </div>
                <div class="detail-box">
                    <div class="detail-label" data-translate="year">A√±o</div>
                    <div class="detail-value" id="modalYear">‚Äî</div>
                </div>
                <div class="detail-box">
                    <div class="detail-label" data-translate="format">Formato</div>
                    <div class="detail-value" id="modalFormat" style="font-size:0.8rem;">‚Äî</div>
                </div>
            </div>

            <!-- Terroir: Clima & Suelo -->
            <div class="terroir-label">‚òÅ <span data-translate="terroir">Terroir</span></div>
            <div class="terroir-grid">
                <div class="terroir-box">
                    <div class="detail-label">‚òÅ <span data-translate="climate">Clima</span></div>
                    <div class="detail-value" id="modalClima">‚Äî</div>
                </div>
                <div class="terroir-box">
                    <div class="detail-label">‚õ∞ <span data-translate="soil">Suelo</span></div>
                    <div class="detail-value" id="modalSuelo">‚Äî</div>
                </div>
            </div>

            <!-- Establishment Pricing Table -->
            <table class="est-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>SPA</th>
                        <th>TASCA FINA</th>
                        <th>VICTORIA</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label">PVP</td>
                        <td class="pvp-cell" id="estSpaPvp">‚Äî</td>
                        <td class="pvp-cell" id="estTascaPvp">‚Äî</td>
                        <td class="pvp-cell" id="estVictoriaPvp">‚Äî</td>
                    </tr>
                    <tr>
                        <td class="row-label">Stock</td>
                        <td id="estSpaStock">‚Äî</td>
                        <td id="estTascaStock">‚Äî</td>
                        <td id="estVictoriaStock">‚Äî</td>
                    </tr>
                    <tr>
                        <td class="row-label loc-cell">Ubic.</td>
                        <td class="loc-cell" id="estSpaLoc">‚Äî</td>
                        <td class="loc-cell" id="estTascaLoc">‚Äî</td>
                        <td class="loc-cell" id="estVictoriaLoc">‚Äî</td>
                    </tr>
                </tbody>
            </table>

            <div class="modal-actions">
                <div class="consume-actions">
                    <button class="btn-consume" id="btnConsume" aria-label="Registrar salida">‚ûú</button>
                    <select class="consume-qty" id="consumeQty" aria-label="Cantidad">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>

                <button class="btn-edit" id="btnEditWine">Editar</button>
            </div>

            <div class="consume-feedback" id="consumeFeedback"></div>

            <!-- Edit form -->
            <div class="edit-form" id="editForm">
                <div style="display:flex;flex-direction:column;gap:0.4rem;">
                    <input class="edit-field" id="editDesc" type="text" placeholder="Nombre / Descripci√≥n">
                    <input class="edit-field" id="editRegion" type="text" placeholder="Regi√≥n / D.O.">
                    <input class="edit-field" id="editUvas" type="text" placeholder="Uvas (separadas por coma)">

                    <div class="edit-section-title">SPA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editSpaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editSpaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editSpaLoc" type="text" placeholder="Ubic." style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-section-title">TASCA FINA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editTascaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editTascaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editTascaLoc" type="text" placeholder="Ubic." style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-section-title">VICTORIA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editVictoriaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editVictoriaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editVictoriaLoc" type="text" placeholder="Ubic." style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-actions">
                        <button class="btn-cancel" id="btnCancelEdit">Cancelar</button>
                        <button class="btn-save" id="btnSaveEdit">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ==========================================================
           CAVA METROPOLIS ‚Äî Multi-Establishment Wine Management
           ========================================================== */

        const AUTH_KEYS = {
            sessionFlag: 'cava_login_demo',
            sessionUser: 'cava_login_user',
            sessionEstablishment: 'cava_login_establishment',
            sessionRole: 'cava_login_role',
            sessionScope: 'cava_login_scope',
            persistentFlag: 'cava_login_persistent_access',
            persistentUser: 'cava_login_persistent_user',
            persistentEstablishment: 'cava_login_persistent_establishment',
            persistentRole: 'cava_login_persistent_role',
            persistentScope: 'cava_login_persistent_scope'
        };

        // --- CONSTANTS ---
        const EST_KEYS = ['spa', 'tasca_fina', 'victoria'];
        // galeria exists in data but is NOT rendered (Phase 3)
        const EST_LABELS = { spa: 'SPA', tasca_fina: 'TASCA FINA', victoria: 'VICTORIA' };

        const TIPO_MAP = {
            'TO':  { cls: 'b-tinto',    es: 'TINTO',    en: 'RED',       pt: 'TINTO' },
            'BL':  { cls: 'b-branco',   es: 'BLANCO',   en: 'WHITE',     pt: 'BRANCO' },
            'ROS': { cls: 'b-rosado',   es: 'ROSADO',   en: 'ROS√â',      pt: 'ROSADO' },
            'ESP': { cls: 'b-espumoso', es: 'ESPUMOSO', en: 'SPARKLING', pt: 'ESPUMOSO' },
            'GEN': { cls: 'b-generoso', es: 'GENEROSO', en: 'FORTIFIED', pt: 'GENEROSO' },
            'DU':  { cls: 'b-dulce',    es: 'DULCE',    en: 'SWEET',     pt: 'DOCE' }
        };

        const GRAPE_FAMILIES = {
            'Tempranillo': 'iberica-tinta', 'Garnacha': 'iberica-tinta s2', 'Monastrell': 'iberica-tinta s3',
            'Bobal': 'iberica-tinta', 'Menc√≠a': 'iberica-tinta s2', 'Cari√±ena': 'iberica-tinta s3',
            'Graciano': 'iberica-tinta', 'Carignan': 'iberica-tinta s2', 'Prieto Picudo': 'iberica-tinta s3',
            'Tinta de Toro': 'iberica-tinta', 'Garnacha Tintorera': 'iberica-tinta s2',
            'Pinot Noir': 'burgundy', 'Pinot Meunier': 'burgundy s2', 'Chardonnay': 'burgundy s3',
            'Sauvignon Blanc': 'burgundy', 'Aligot√©': 'burgundy s2', 'Gamay': 'burgundy s3',
            'Sangiovese': 'italiana', 'Nebbiolo': 'italiana s2', 'Barbera': 'italiana s3',
            'Dolcetto': 'italiana', 'Montepulciano': 'italiana s2', 'Aglianico': 'italiana s3',
            "Nero d'Avola": 'italiana', 'Corvina': 'italiana s2', 'Primitivo': 'italiana s3',
            'Riesling': 'aromatico', 'Albari√±o': 'aromatico s2', 'Verdejo': 'aromatico s3',
            'Moscato': 'aromatico', 'Gew√ºrztraminer': 'aromatico s2', 'Viognier': 'aromatico s3',
            'Vermentino': 'aromatico', 'Godello': 'aromatico s2', 'Fiano': 'aromatico s3',
            'Greco': 'aromatico', 'Falanghina': 'aromatico s2', 'Malvasia': 'aromatico s3',
            'Furmint': 'aromatico', 'Savagnin': 'aromatico s2', 'Timorasso': 'aromatico s3',
            'Verdicchio': 'aromatico', 'Chenin Blanc': 'aromatico s2', 'Gr√ºner Veltliner': 'aromatico s3',
            'Garnacha Blanca': 'aromatico', 'Viura': 'aromatico s2', 'Macabeo': 'aromatico s3',
            'Carmen√®re': 'novamundo', 'Malbec': 'novamundo s2', 'Cabernet Sauvignon': 'novamundo s3',
            'Cabernet Franc': 'novamundo', 'Syrah': 'novamundo s2', 'Shiraz': 'novamundo s3',
            'Petit Verdot': 'novamundo', 'Zinfandel': 'novamundo s2', 'Tannat': 'novamundo s3',
            'Negroamaro': 'novamundo', 'Pinotage': 'novamundo s2', 'Merlot': 'novamundo s3',
            'Touriga Nacional': 'novamundo', 'Tinta Roriz': 'novamundo s2',
            'Prosecco': 'espumoso', 'Lambrusco': 'espumoso s2', 'Cava': 'espumoso s3',
            'Champagne': 'espumoso', 'Xarel.lo': 'espumoso s2', 'Parellada': 'espumoso s3',
            'Glera': 'espumoso',
        };

        // --- STATE ---
        let refs = [];            // Full dataset from JSON
        let searchIndex = [];     // Pre-computed search strings
        let pvpMedio = {};        // Average PVP per pod
        let subsets = {};         // Indices per establishment
        let currentFilter = 'todos';
        let currentSort = 'abc';
        let currentEditPod = null;
        let currentLang = 'es';
        const currentUserName = sessionStorage.getItem(AUTH_KEYS.sessionUser) || localStorage.getItem(AUTH_KEYS.persistentUser) || 'unknown';
        const currentUserNormalized = (currentUserName || '').trim().toLowerCase();
        const normalizeEstablishment = (value) => {
            const normalized = (value || '').trim().toLowerCase();
            return EST_KEYS.includes(normalized) ? normalized : null;
        };
        const normalizeScope = (value) => {
            const normalized = (value || '').trim().toLowerCase();
            return EST_KEYS.includes(normalized) || normalized === 'all' ? normalized : null;
        };
        const normalizeRole = (value) => {
            const normalized = (value || '').trim().toLowerCase();
            return ['user', 'admin', 'adminmaster'].includes(normalized) ? normalized : null;
        };
        const storedRole = normalizeRole(sessionStorage.getItem(AUTH_KEYS.sessionRole))
            || normalizeRole(localStorage.getItem(AUTH_KEYS.persistentRole));
        const storedScope = normalizeScope(sessionStorage.getItem(AUTH_KEYS.sessionScope))
            || normalizeScope(localStorage.getItem(AUTH_KEYS.persistentScope));
        const baseEstablishment = normalizeEstablishment(sessionStorage.getItem(AUTH_KEYS.sessionEstablishment))
            || normalizeEstablishment(localStorage.getItem(AUTH_KEYS.persistentEstablishment))
            || 'spa';
        const isOwnerUser = currentUserNormalized === '0xmanel';
        const currentUserRole = isOwnerUser
            ? 'adminmaster'
            : ((storedRole === 'adminmaster' ? 'admin' : storedRole) || 'user');
        const currentUserScope = isOwnerUser
            ? 'all'
            : ((storedScope === 'all' ? baseEstablishment : storedScope) || baseEstablishment);
        const currentUserEstablishment = isOwnerUser
            ? 'spa'
            : (baseEstablishment || (EST_KEYS.includes(currentUserScope) ? currentUserScope : 'spa'));

        function hasAdminAccess() {
            return currentUserRole === 'admin' || currentUserRole === 'adminmaster';
        }

        function hasEditAccess() {
            return hasAdminAccess();
        }

        // Typewriter state
        let typeWriterTimeout, charIndex = 0, isDeleting = false, currentPhrase = '', phraseQueue = [];

        // --- TRANSLATIONS ---
        const translations = {
            es: {
                placeholders: [
                    "Encuentra la botella", "¬øUna copa? ¬øUna Botella?",
                    "Tempranillo, Garnacha, Menc√≠a", "Albari√±o, Godello, Verdejo",
                    "Tinto, Blanco, Rosado, Espumoso", "¬øQu√© tal la cata de hoy?",
                    "¬øCliente muy Especial?", "Buscar vino...",
                    "¬øRioja, Ribeira, Rueda?", "¬øAlguno internacional?",
                    "Quiz√°s un vino franc√©s"
                ],
                refs: "referencias disponibles", region: "Regi√≥n", country: "Pa√≠s",
                year: "A√±o", format: "Formato", climate: "Clima", soil: "Suelo", terroir: "Terroir", admin: "Admin", consumeNeedFilter: "Selecciona SPA/TASCA/VICTORIA para registrar salida.", consumeDone: "Salida registrada.", consumeNoStock: "Sin stock num√©rico para descontar, pero salida anotada.", btnLabel: "üá™üá∏ ES"
            },
            en: {
                placeholders: [
                    "Find the bottle", "A glass? A bottle?",
                    "Tempranillo, Garnacha, Menc√≠a", "Albari√±o, Godello, Verdejo",
                    "Red, White, Ros√©, Sparkling", "How's the tasting today?",
                    "Very Special Client?", "Search wine...",
                    "Rioja, Ribeira, Rueda?", "Any international one?",
                    "Maybe a French wine"
                ],
                refs: "references available", region: "Region", country: "Country",
                year: "Year", format: "Format", climate: "Climate", soil: "Soil", terroir: "Terroir", admin: "Admin", consumeNeedFilter: "Select SPA/TASCA/VICTORIA to register output.", consumeDone: "Output registered.", consumeNoStock: "No numeric stock to decrement, but output was logged.", btnLabel: "üá¨üáß EN"
            },
            pt: {
                placeholders: [
                    "Encontre a garrafa", "Uma ta√ßa? Uma garrafa?",
                    "Tempranillo, Garnacha, Menc√≠a", "Albari√±o, Godello, Verdejo",
                    "Tinto, Branco, Ros√©, Espumante", "Que tal a degusta√ß√£o hoje?",
                    "Cliente muito especial?", "Buscar vinho...",
                    "Rioja, Ribeira, Rueda?", "Algum internacional?",
                    "Talvez um vinho franc√™s"
                ],
                refs: "refer√™ncias dispon√≠veis", region: "Regi√£o", country: "Pa√≠s",
                year: "Ano", format: "Formato", climate: "Clima", soil: "Solo", terroir: "Terroir", admin: "Admin", consumeNeedFilter: "Selecione SPA/TASCA/VICTORIA para registrar retirada.", consumeDone: "Retirada registrada.", consumeNoStock: "Sem estoque num√©rico para baixar, mas a retirada foi anotada.", btnLabel: "üáßüá∑ PT"
            }
        };

        // --- UTILITY ---
        function removeAccents(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function fmt(val) {
            return val != null ? val : '‚Äî';
        }

        function fmtPrice(val) {
            return val != null ? val + '‚Ç¨' : '‚Äî';
        }

        function getGrapeColor(name) {
            return GRAPE_FAMILIES[name] || 'burgundy s3';
        }

        function renderGrapeTags(uvasArr) {
            if (!uvasArr || !uvasArr.length) return '';

            // Suporta novo formato com propor√ß√µes: {nome, pct, confianza}
            // E formato antigo: string simples
            const processedUvas = uvasArr.map(u => {
                if (typeof u === 'string') {
                    return { nome: u, pct: null };
                }
                return u;
            });

            // Ordenar por percentual descrescente (se dispon√≠vel)
            processedUvas.sort((a, b) => {
                const pctA = a.pct || 0;
                const pctB = b.pct || 0;
                return pctB - pctA;
            });

            return '<div class="grape-tags">' +
                processedUvas.map(g => {
                    const label = g.pct ? `${g.pct}% ${g.nome}` : g.nome;
                    return `<span class="grape-tag ${getGrapeColor(g.nome)}">${label}</span>`;
                }).join('') +
                '</div>';
        }

        function getTipoBadge(tipo) {
            const code = tipo?.codigo || '';
            const info = TIPO_MAP[code] || TIPO_MAP['TO'];
            return { cls: info.cls, label: info[currentLang] || info.es };
        }

        // --- DATA LOADING ---
        // TODO: [SYNC] Replace fetch with real-time API subscription
        fetch('data/bodega_webapp.json')
            .then(r => r.json())
            .then(data => {
                // Filter out garbage entries (no pod, no descripcion, or Excel errors like #N/D)
                refs = data.filter(r => r.pod && r.descripcion && !r.descripcion.startsWith('#'));
                applyLocalEdits();
                preProcess();
                updateRefCount();
                console.log(`‚úì Loaded ${refs.length} references (filtered ${data.length - refs.length} incomplete)`);
            })
            .catch(err => {
                console.error('Error loading data:', err);
                refs = [];
            });

        // --- LOCAL EDIT PERSISTENCE ---
        // TODO: [SYNC] Replace localStorage with API POST for edits
        function applyLocalEdits() {
            try {
                const edits = JSON.parse(localStorage.getItem('cava_edits') || '[]');
                edits.forEach(edit => {
                    const ref = refs.find(r => r.pod === edit.pod);
                    if (!ref) return;
                    setNestedValue(ref, edit.path, edit.value);
                });
                if (edits.length) console.log(`‚úì Applied ${edits.length} local edits`);
            } catch (e) { /* ignore parse errors */ }
        }

        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            let cur = obj;
            for (let i = 0; i < keys.length - 1; i++) {
                if (!cur[keys[i]]) cur[keys[i]] = {};
                cur = cur[keys[i]];
            }
            cur[keys[keys.length - 1]] = value;
        }

        function saveEdit(pod, path, value) {
            try {
                const edits = JSON.parse(localStorage.getItem('cava_edits') || '[]');
                // Upsert: replace existing edit for same pod+path
                const idx = edits.findIndex(e => e.pod === pod && e.path === path);
                if (idx >= 0) edits[idx].value = value;
                else edits.push({ pod, path, value });
                localStorage.setItem('cava_edits', JSON.stringify(edits));
                // TODO: [SYNC] Send edit to server via WebSocket/API
            } catch (e) { /* ignore */ }
        }

        // --- PRE-PROCESSING ---
        function preProcess() {
            searchIndex = [];
            pvpMedio = {};
            subsets = { todos: new Set(), spa: new Set(), tasca_fina: new Set(), victoria: new Set() };

            refs.forEach((ref, i) => {
                // Build searchable string
                const parts = [
                    ref.descripcion, ref.region, ref.pais, ref.bodega,
                    ref.tipo?.nombre, ...(ref.uvas || []),
                    ref.ano ? String(ref.ano) : '', ref.pod
                ].filter(Boolean).join(' ');

                searchIndex.push({ idx: i, str: removeAccents(parts.toLowerCase()) });
                subsets.todos.add(i);

                // Compute average PVP across visible establishments
                let prices = [];
                EST_KEYS.forEach(k => {
                    const est = ref.establecimientos?.[k];
                    if (est && est.pvp != null) {
                        prices.push(est.pvp);
                        subsets[k].add(i);
                    }
                });
                pvpMedio[ref.pod] = prices.length > 0
                    ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length)
                    : null;
            });
        }

        function updateRefCount() {
            let count = refs.length;
            if (currentFilter !== 'todos') {
                count = subsets[currentFilter]?.size || 0;
            }
            document.getElementById('totalRef').textContent = count;
        }

        // --- FILTER & SORT ---
        document.querySelectorAll('.filter-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.filter-pill.active').classList.remove('active');
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                updateRefCount();
                triggerSearch();
            });
        });

        document.getElementById('sortToggle').addEventListener('click', function() {
            currentSort = currentSort === 'abc' ? 'pvp' : 'abc';
            this.textContent = currentSort.toUpperCase();
            triggerSearch();
        });

        // --- SEARCH ---
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');

        let debounceTimer;
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => triggerSearch(), 150);
        });

        function triggerSearch() {
            const query = removeAccents(searchInput.value.toLowerCase().trim());
            searchResults.innerHTML = '';

            if (!query) {
                searchResults.style.display = 'none';
                return;
            }

            // Filter by search query
            let results = searchIndex.filter(item => item.str.includes(query));

            // Apply establishment filter
            if (currentFilter !== 'todos') {
                results = results.filter(item => subsets[currentFilter].has(item.idx));
            }

            // Apply sort
            if (currentSort === 'abc') {
                results.sort((a, b) => (refs[a.idx].descripcion || '').localeCompare(refs[b.idx].descripcion || ''));
            } else {
                results.sort((a, b) => {
                    const pa = getDisplayPrice(refs[a.idx]);
                    const pb = getDisplayPrice(refs[b.idx]);
                    return (pa ?? Infinity) - (pb ?? Infinity);
                });
            }

            if (results.length > 0) {
                results.forEach(item => {
                    const ref = refs[item.idx];
                    const el = document.createElement('div');
                    el.className = 'search-item';

                    const badge = getTipoBadge(ref.tipo);
                    const price = getDisplayPrice(ref);
                    const loc = getDisplayLocation(ref);
                    const formatLabel = ref.formato?.etiqueta && ref.formato.etiqueta !== 'Botella (75cl)'
                        ? ref.formato.etiqueta : '';

                    el.innerHTML = `
                        <div class="item-info">
                            <div class="item-title">${ref.descripcion || '‚Äî'}</div>
                            ${renderGrapeTags(ref.uvas)}
                            <div class="badge-row">
                                <span class="badge ${badge.cls}">${badge.label}</span>
                                <span class="item-region">${fmt(ref.region)}</span>
                                <span class="item-pod">${ref.pod}</span>
                                ${formatLabel ? `<span class="item-format">${formatLabel}</span>` : ''}
                            </div>
                        </div>
                        <div class="item-right">
                            <div class="item-price">${fmtPrice(price)}</div>
                            ${loc ? `<div class="item-location">${loc}</div>` : ''}
                        </div>
                    `;

                    el.addEventListener('click', () => openModal(ref));
                    searchResults.appendChild(el);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        }

        function getDisplayPrice(ref) {
            if (currentFilter !== 'todos') {
                return ref.establecimientos?.[currentFilter]?.pvp ?? null;
            }
            return pvpMedio[ref.pod] ?? null;
        }

        function getDisplayLocation(ref) {
            if (currentFilter !== 'todos') {
                return ref.establecimientos?.[currentFilter]?.localizacion || null;
            }
            return null; // No location in TODOS mode (varies by establishment)
        }

        // --- TERROIR LOOKUP ---
        function getTerroirInfo(region, pais) {
            const r = (region || '').toLowerCase();
            const p = (pais || '').toLowerCase();
            // ‚îÄ‚îÄ ESPA√ëA ‚îÄ‚îÄ
            if (r.includes('ribera del duero')) return { clima: 'Continental extremo', suelo: 'Caliza y arcilla' };
            if (r.includes('rioja alta')) return { clima: 'Mediterr√°neo-atl√°ntico', suelo: 'Arcilla y caliza' };
            if (r.includes('rioja alavesa')) return { clima: 'Atl√°ntico-mediterr√°neo', suelo: 'Arcilla caliza' };
            if (r.includes('rioja baja') || r.includes('rioja oriental')) return { clima: 'Mediterr√°neo c√°lido', suelo: 'Arcillo-ferroso' };
            if (r.includes('rioja')) return { clima: 'Mediterr√°neo-atl√°ntico', suelo: 'Arcilla, caliza y arena' };
            if (r.includes('priorat') || r.includes('priorato')) return { clima: 'Mediterr√°neo seco', suelo: 'Llicorella (pizarra)' };
            if (r.includes('r√≠as baixas')) return { clima: 'Oce√°nico h√∫medo', suelo: 'Gran√≠tico' };
            if (r.includes('ribeira sacra')) return { clima: 'Oce√°nico-continental', suelo: 'Pizarra y granito' };
            if (r.includes('valdeorras')) return { clima: 'Oce√°nico-continental', suelo: 'Pizarra y arcilla' };
            if (r.includes('rueda')) return { clima: 'Continental seco', suelo: 'Arenas y limos' };
            if (r.includes('toro')) return { clima: 'Continental extremo', suelo: 'Arenas finas' };
            if (r.includes('bierzo')) return { clima: 'Oce√°nico-continental', suelo: 'Pizarra y arcilla' };
            if (r.includes('galicia')) return { clima: 'Oce√°nico h√∫medo', suelo: 'Gran√≠tico y pizarroso' };
            if (r.includes('madrid') || r.includes('gredos')) return { clima: 'Continental de monta√±a', suelo: 'Gran√≠tico' };
            if (r.includes('jerez') || r.includes('sherry') || r.includes('manzanilla') || r.includes('sanl√∫car')) return { clima: 'Mediterr√°neo c√°lido', suelo: 'Albariza (caliza)' };
            if (r.includes('pened√®s') || r.includes('penedes')) return { clima: 'Mediterr√°neo', suelo: 'Caliza y arenas' };
            if (r.includes('somontano')) return { clima: 'Continental mediterr√°neo', suelo: 'Caliza y arcilla' };
            if (r.includes('navarra')) return { clima: 'Continental-mediterr√°neo', suelo: 'Caliza y arcilla' };
            if (r.includes('arag√≥n') || r.includes('aragon') || r.includes('campo de borja') || r.includes('cari√±ena') || r.includes('calatayud')) return { clima: 'Continental mediterr√°neo', suelo: 'Caliza y arcilla' };
            if (r.includes('la mancha') || r.includes('valdepe√±as') || r.includes('castilla-la mancha')) return { clima: 'Continental extremo', suelo: 'Arcilla y caliza' };
            if (r.includes('jumilla') || r.includes('yecla') || r.includes('alicante') || r.includes('murcia')) return { clima: 'Mediterr√°neo semi√°rido', suelo: 'Caliza y arcilla' };
            if (r.includes('comunidad valenciana') || r.includes('utiel') || r.includes('valencia')) return { clima: 'Mediterr√°neo', suelo: 'Caliza y arcilla' };
            if (r.includes('montsant') || r.includes('terra alta')) return { clima: 'Mediterr√°neo seco', suelo: 'Caliza y arcilla' };
            if (r.includes('empord√†')) return { clima: 'Mediterr√°neo ventoso', suelo: 'Granito y pizarra' };
            if (r.includes('catalu√±a') || r.includes('cataluna') || r.includes('catalunya')) return { clima: 'Mediterr√°neo', suelo: 'Caliza y arcilla' };
            if (r.includes('txakoli') || r.includes('getariako') || r.includes('bizkaiko')) return { clima: 'Oce√°nico-atl√°ntico', suelo: 'Caliza y arenisca' };
            if (r.includes('pa√≠s vasco') || r.includes('pais vasco') || r.includes('euskadi')) return { clima: 'Oce√°nico-atl√°ntico', suelo: 'Caliza y arenisca' };
            if (r.includes('canarias') || r.includes('lanzarote') || r.includes('tenerife') || r.includes('gran canaria') || r.includes('la palma')) return { clima: 'Subtropical oce√°nico', suelo: 'Volc√°nico (lapilli/pic√≥n)' };
            if (r.includes('baleares') || r.includes('mallorca') || r.includes('binissalem')) return { clima: 'Mediterr√°neo', suelo: 'Caliza y arcilla roja' };
            if (r.includes('extremadura') || r.includes('ribera del guadiana')) return { clima: 'Mediterr√°neo continental', suelo: 'Arcilla y granito' };
            if (r.includes('castilla y le√≥n') || r.includes('castilla leon')) return { clima: 'Continental', suelo: 'Caliza, arcilla y arena' };
            if (r.includes('andaluc') || r.includes('m√°laga') || r.includes('condado de huelva')) return { clima: 'Mediterr√°neo c√°lido', suelo: 'Caliza y arcilla' };
            if (r.includes('cava')) return { clima: 'Mediterr√°neo', suelo: 'Caliza y arenas' };
            // ‚îÄ‚îÄ FRANCIA ‚îÄ‚îÄ
            if (r.includes('burdeos') || r.includes('bordeaux') || r.includes('m√©doc') || r.includes('medoc') || r.includes('pomerol') || r.includes('saint-√©milion') || r.includes('saint-emilion') || r.includes('graves') || r.includes('sauternes') || r.includes('pessac')) return { clima: 'Oce√°nico templado', suelo: 'Gravas y arcilla' };
            if (r.includes('borgo√±a') || r.includes('bourgogne') || r.includes('burgundy') || r.includes('chablis') || r.includes('gevrey') || r.includes('chambolle') || r.includes('vosne') || r.includes('nuits-saint') || r.includes('pommard') || r.includes('puligny') || r.includes('meursault') || r.includes('montrachet') || r.includes('beaune') || r.includes('santenay') || r.includes('m√¢con') || r.includes('macon') || r.includes('pouilly-fuiss√©') || r.includes('chassagne')) return { clima: 'Continental', suelo: 'Caliza y marga' };
            if (r.includes('champagne') || r.includes('reims') || r.includes('√©pernay') || r.includes('epernay')) return { clima: 'Oce√°nico fr√≠o', suelo: 'Creta y caliza' };
            if (r.includes('alsace') || r.includes('alsacia')) return { clima: 'Continental semi√°rido', suelo: 'Granito, caliza y pizarra' };
            if (r.includes('c√¥te-r√¥tie') || r.includes('cote rotie') || r.includes('condrieu') || r.includes('hermitage') || r.includes('crozes') || r.includes('saint-joseph') || r.includes('cornas') || r.includes('saint-p√©ray')) return { clima: 'Continental-mediterr√°neo', suelo: 'Granito y gneis' };
            if (r.includes('ch√¢teauneuf') || r.includes('chateauneuf') || r.includes('gigondas') || r.includes('vacqueyras') || r.includes('tavel') || r.includes('lirac')) return { clima: 'Mediterr√°neo c√°lido', suelo: 'Cantos rodados (galets)' };
            if (r.includes('r√≥dano') || r.includes('rodano') || r.includes('rh√¥ne') || r.includes('rhone')) return { clima: 'Mediterr√°neo-continental', suelo: 'Granito, caliza y galets' };
            if (r.includes('loira') || r.includes('loire') || r.includes('pouilly-fum√©') || r.includes('sancerre') || r.includes('chinon') || r.includes('vouvray') || r.includes('bourgueil') || r.includes('saumur') || r.includes('anjou') || r.includes('muscadet')) return { clima: 'Oce√°nico', suelo: 'S√≠lex, tuffeau y granito' };
            if (r.includes('provence') || r.includes('provenza') || r.includes('bandol')) return { clima: 'Mediterr√°neo', suelo: 'Caliza y esquisto' };
            if (r.includes('languedoc') || r.includes('lenguadoc') || r.includes('roussillon') || r.includes('fitou') || r.includes('corbi√®res') || r.includes('minervois')) return { clima: 'Mediterr√°neo c√°lido', suelo: 'Caliza, pizarra y gneis' };
            if (r.includes('beaujolais') || r.includes('moulin-√†-vent') || r.includes('fleurie') || r.includes('morgon')) return { clima: 'Continental-templado', suelo: 'Granito y arcilla' };
            if (r.includes('jura')) return { clima: 'Continental fr√≠o', suelo: 'Marga y caliza azul' };
            if (r.includes('savoie') || r.includes('saboya')) return { clima: 'Alpino-continental', suelo: 'Caliza y morrena glaciar' };
            if (r.includes('gascogne') || r.includes('gascu√±a') || r.includes('juran√ßon') || r.includes('iroul√©guy')) return { clima: 'Oce√°nico-pirenaico', suelo: 'Arcilla, caliza y gravas' };
            // ‚îÄ‚îÄ ITALIA ‚îÄ‚îÄ
            if (r.includes('piamonte') || r.includes('piemonte') || r.includes('piedmont') || r.includes('barolo') || r.includes('barbaresco') || r.includes('barbera') || r.includes('dolcetto') || r.includes('langhe') || r.includes('monferrato') || r.includes('asti')) return { clima: 'Continental-mediterr√°neo', suelo: 'Marga calc√°rea (tufo)' };
            if (r.includes('toscana') || r.includes('tuscany') || r.includes('chianti') || r.includes('brunello') || r.includes('montalcino') || r.includes('montepulciano') || r.includes('maremma') || r.includes('bolgheri')) return { clima: 'Mediterr√°neo continental', suelo: 'Caliza, arcilla y galestro' };
            if (r.includes('v√©neto') || r.includes('veneto') || r.includes('amarone') || r.includes('valpolicella') || r.includes('soave') || r.includes('prosecco')) return { clima: 'Continental-mediterr√°neo', suelo: 'Caliza y arcilla' };
            if (r.includes('friuli') || r.includes('friaul')) return { clima: 'Continental', suelo: 'Ponca (marga y arenisca)' };
            if (r.includes('etna') || r.includes('sicilia') || r.includes('sicily')) return { clima: 'Mediterr√°neo c√°lido', suelo: 'Volc√°nico (basalto) / Caliza' };
            if (r.includes('alto adige') || r.includes('s√ºdtirol') || r.includes('trentino')) return { clima: 'Alpino-mediterr√°neo', suelo: 'Caliza, pizarra y p√≥rfido' };
            if (r.includes('campania')) return { clima: 'Mediterr√°neo', suelo: 'Volc√°nico y caliza' };
            if (r.includes('puglia') || r.includes('apulia')) return { clima: 'Mediterr√°neo √°rido', suelo: 'Caliza y arcilla roja' };
            if (r.includes('umbria') || r.includes('umbr√≠a')) return { clima: 'Mediterr√°neo continental', suelo: 'Arcilla y tiza' };
            if (r.includes('abruzzo') || r.includes('abruzos')) return { clima: 'Mediterr√°neo-continental', suelo: 'Arcilla y caliza' };
            if (r.includes('lombardia') || r.includes('lombard√≠a') || r.includes('franciacorta')) return { clima: 'Continental', suelo: 'Morrena glaciar y arcilla' };
            // ‚îÄ‚îÄ PORTUGAL ‚îÄ‚îÄ
            if (r.includes('douro') || r.includes('oporto')) return { clima: 'Continental seco', suelo: 'Xisto (pizarra)' };
            if (r.includes('alentejo')) return { clima: 'Mediterr√°neo √°rido', suelo: 'Granito y esquisto' };
            if (r.includes('vinho verde') || r.includes('minho')) return { clima: 'Oce√°nico h√∫medo', suelo: 'Gran√≠tico' };
            if (r.includes('d√£o') || r.includes('dao')) return { clima: 'Continental', suelo: 'Granito y pizarroso' };
            if (r.includes('bairrada')) return { clima: 'Oce√°nico', suelo: 'Arcilla y caliza' };
            if (r.includes('madeira') || r.includes('madera')) return { clima: 'Oce√°nico subtropical', suelo: 'Volc√°nico (basalto)' };
            if (r.includes('azores') || r.includes('a√ßores')) return { clima: 'Oce√°nico subtropical', suelo: 'Volc√°nico (basalto)' };
            if (r.includes('norte') || r.includes('centro') || r.includes('tejo') || r.includes('lisboa')) return { clima: 'Mediterr√°neo-atl√°ntico', suelo: 'Arcilla, granito y caliza' };
            // ‚îÄ‚îÄ ALEMANIA / AUSTRIA ‚îÄ‚îÄ
            if (r.includes('mosel') || r.includes('moselle')) return { clima: 'Continental fr√≠o', suelo: 'Pizarra azul (dev√≥nica)' };
            if (r.includes('rheingau') || r.includes('rheinhessen') || r.includes('hesse') || r.includes('nahe') || r.includes('ahr') || r.includes('renania') || r.includes('pfalz') || r.includes('palatinado') || r.includes('w√ºrttemberg') || r.includes('franken') || r.includes('franconia')) return { clima: 'Continental fr√≠o', suelo: 'Pizarra, cuarzo y caliza' };
            if (r.includes('wachau') || r.includes('kamptal') || r.includes('kremstal') || r.includes('burgenland') || p.includes('austria') || p.includes('√∂sterreich')) return { clima: 'Continental-pan√≥nico', suelo: 'Loess, gneis y pizarra' };
            if (p.includes('alemania') || p.includes('germany') || p.includes('deutschland')) return { clima: 'Continental fr√≠o', suelo: 'Pizarra y caliza' };
            // ‚îÄ‚îÄ HUNGR√çA / OTROS EUROPEOS ‚îÄ‚îÄ
            if (r.includes('tokaj') || r.includes('tokay') || r.includes('hegyalja') || p.includes('hungr√≠a') || p.includes('hungria') || p.includes('hungary')) return { clima: 'Continental pan√≥nico', suelo: 'Arcilla volc√°nica y caliza' };
            if (p.includes('georgia') || r.includes('kakheti')) return { clima: 'Continental c√°lido', suelo: 'Arcilla y suelo aluvial' };
            if (p.includes('grecia') || p.includes('greece')) return { clima: 'Mediterr√°neo', suelo: 'Caliza y arcilla' };
            // ‚îÄ‚îÄ AM√âRICAS ‚îÄ‚îÄ
            if (r.includes('napa') || r.includes('sonoma') || r.includes('paso robles') || r.includes('santa barbara') || r.includes('california')) return { clima: 'Mediterr√°neo', suelo: 'Variable (volc√°nico, arcilla)' };
            if (r.includes('willamette') || r.includes('oreg√≥n') || r.includes('oregon')) return { clima: 'Oce√°nico templado', suelo: 'Arcilla volc√°nica (Jory)' };
            if (r.includes('washington') || r.includes('columbia valley') || r.includes('walla walla')) return { clima: 'Continental semi√°rido', suelo: 'Limo e√≥lico y basalto' };
            if (r.includes('mendoza') || r.includes('luj√°n de cuyo') || r.includes('maip√∫') || r.includes('valle de uco')) return { clima: 'Continental √°rido', suelo: 'Aluvial y arenoso' };
            if (r.includes('salta') || r.includes('cafayate') || r.includes('patagonia') || r.includes('neuqu√©n') || r.includes('r√≠o negro')) return { clima: 'Continental de altitud', suelo: 'Arenoso y pedregoso' };
            if (r.includes('maipo') || r.includes('colchagua') || r.includes('casablanca') || r.includes('aconcagua') || r.includes('cachapoal') || r.includes('itata') || p.includes('chile')) return { clima: 'Mediterr√°neo', suelo: 'Aluvial y arcillo-gran√≠tico' };
            // ‚îÄ‚îÄ AUSTRALIA / NZ / SUD√ÅFRICA ‚îÄ‚îÄ
            if (r.includes('barossa') || r.includes('mclaren vale') || r.includes('coonawarra') || r.includes('eden valley') || r.includes('south australia') || r.includes('australia meridional')) return { clima: 'Mediterr√°neo', suelo: 'Terra rossa y arcilla' };
            if (r.includes('yarra') || r.includes('mornington') || r.includes('margaret river') || p.includes('australia')) return { clima: 'Oce√°nico-mediterr√°neo', suelo: 'Arcilla y arenisca' };
            if (r.includes('marlborough') || r.includes('central otago') || r.includes('hawke') || r.includes('isla norte') || r.includes('isla sur') || r.includes('auckland') || p.includes('nueva zelanda') || p.includes('new zealand')) return { clima: 'Oce√°nico fr√≠o', suelo: 'Gravas, limo y arcilla' };
            if (r.includes('stellenbosch') || r.includes('franschhoek') || r.includes('hemel') || r.includes('swartland') || r.includes('cape') || r.includes('western cape') || r.includes('coastal') || p.includes('sud√°frica') || p.includes('south africa')) return { clima: 'Mediterr√°neo', suelo: 'Granito y esquisto' };
            return { clima: '‚Äî', suelo: '‚Äî' };
        }

        // --- MODAL ---
        const wineModal = document.getElementById('wineModal');
        const editButton = document.getElementById('btnEditWine');
        const adminButton = document.getElementById('adminBtn');
        const consumeButton = document.getElementById('btnConsume');
        const consumeQtySelect = document.getElementById('consumeQty');
        const consumeFeedback = document.getElementById('consumeFeedback');

        if (adminButton) {
            adminButton.style.display = hasAdminAccess() ? 'inline-flex' : 'none';
            adminButton.addEventListener('click', () => {
                window.location.href = 'admin.html';
            });
        }

        const movementLogKey = 'cava_daily_movements_v1';

        function setConsumeFeedback(message) {
            if (!consumeFeedback) return;
            consumeFeedback.textContent = message || '';
        }

        function resolveMovementEstablishment() {
            if (EST_KEYS.includes(currentUserScope)) return currentUserScope;
            if (currentFilter !== 'todos') return currentFilter;
            if (EST_KEYS.includes(currentUserEstablishment)) return currentUserEstablishment;
            return null;
        }

        function appendMovementLog(entry) {
            try {
                const today = new Date().toISOString().slice(0, 10);
                const raw = localStorage.getItem(movementLogKey);
                const parsed = raw ? JSON.parse(raw) : {};
                if (!Array.isArray(parsed[today])) parsed[today] = [];
                parsed[today].push(entry);
                localStorage.setItem(movementLogKey, JSON.stringify(parsed));
            } catch {
                return;
            }
        }

        if (consumeButton) {
            consumeButton.addEventListener('click', () => {
                if (!currentEditPod) return;
                const ref = refs.find(r => r.pod === currentEditPod);
                if (!ref) return;

                const estKey = resolveMovementEstablishment();
                if (!estKey) {
                    setConsumeFeedback(translations[currentLang].consumeNeedFilter || 'Selecione uma planta para registrar retirada.');
                    return;
                }

                if (!ref.establecimientos) ref.establecimientos = {};
                if (!ref.establecimientos[estKey]) ref.establecimientos[estKey] = { pvp: null, unidades: null, localizacion: null };

                const quantity = Number(consumeQtySelect?.value || '1');
                const est = ref.establecimientos[estKey];
                const before = typeof est.unidades === 'number' ? est.unidades : null;

                if (typeof est.unidades === 'number') {
                    const nextValue = Math.max(est.unidades - quantity, 0);
                    est.unidades = nextValue;
                    saveEdit(currentEditPod, `establecimientos.${estKey}.unidades`, nextValue);
                    setConsumeFeedback(translations[currentLang].consumeDone || 'Retirada registrada.');
                } else {
                    setConsumeFeedback(translations[currentLang].consumeNoStock || 'Sem estoque num√©rico para baixar, mas retirada anotada.');
                }

                appendMovementLog({
                    at: new Date().toISOString(),
                    user: currentUserName,
                    role: currentUserRole,
                    scope: currentUserScope,
                    establishment: estKey,
                    pod: ref.pod,
                    wine: ref.descripcion || '‚Äî',
                    qty: quantity,
                    before,
                    after: typeof ref.establecimientos[estKey].unidades === 'number' ? ref.establecimientos[estKey].unidades : null
                });

                preProcess();
                updateRefCount();
                openModal(ref);
            });
        }

        function openModal(ref) {
            currentEditPod = ref.pod;
            const badge = getTipoBadge(ref.tipo);

            document.getElementById('modalBadge').className = `badge ${badge.cls}`;
            document.getElementById('modalBadge').textContent = badge.label;
            document.getElementById('modalName').textContent = ref.descripcion || '‚Äî';

            // Subtitle: Bodega | Year | Format | POD
            const parts = [ref.bodega, ref.ano, ref.formato?.etiqueta, ref.pod].filter(Boolean);
            document.getElementById('modalSubtitle').textContent = parts.join(' ¬∑ ') || '‚Äî';

            // Grapes
            document.getElementById('modalGrapes').innerHTML = renderGrapeTags(ref.uvas);

            // Detail boxes
            document.getElementById('modalRegion').textContent = fmt(ref.region);
            document.getElementById('modalCountry').textContent = fmt(ref.pais);
            document.getElementById('modalYear').textContent = fmt(ref.ano);
            document.getElementById('modalFormat').textContent = fmt(ref.formato?.etiqueta);

            // Terroir cards
            const terroir = getTerroirInfo(ref.region, ref.pais);
            document.getElementById('modalClima').textContent = terroir.clima;
            document.getElementById('modalSuelo').textContent = terroir.suelo;

            // Establishment table
            EST_KEYS.forEach(k => {
                const est = ref.establecimientos?.[k];
                const prefix = k === 'spa' ? 'Spa' : k === 'tasca_fina' ? 'Tasca' : 'Victoria';
                document.getElementById(`est${prefix}Pvp`).textContent = fmtPrice(est?.pvp);
                document.getElementById(`est${prefix}Stock`).textContent = fmt(est?.unidades);
                document.getElementById(`est${prefix}Loc`).textContent = fmt(est?.localizacion);
            });

            // Reset edit form
            document.getElementById('editForm').classList.remove('visible');
            if (editButton) {
                editButton.style.display = hasEditAccess() ? 'inline-block' : 'none';
            }
            if (consumeQtySelect) consumeQtySelect.value = '1';
            setConsumeFeedback('');

            searchResults.style.display = 'none';
            searchInput.blur();
            wineModal.classList.add('active');
        }

        function closeModal() {
            wineModal.classList.remove('active');
            searchInput.value = '';
        }

        document.getElementById('btnClose').addEventListener('click', closeModal);
        wineModal.addEventListener('click', e => { if (e.target === wineModal) closeModal(); });

        // --- EDIT ---
        document.getElementById('btnEditWine').addEventListener('click', () => {
            if (!hasEditAccess()) return;
            if (!currentEditPod) return;
            const ref = refs.find(r => r.pod === currentEditPod);
            if (!ref) return;

            document.getElementById('editDesc').value = ref.descripcion || '';
            document.getElementById('editRegion').value = ref.region || '';
            document.getElementById('editUvas').value = (ref.uvas || []).join(', ');

            EST_KEYS.forEach(k => {
                const est = ref.establecimientos?.[k] || {};
                const prefix = k === 'spa' ? 'Spa' : k === 'tasca_fina' ? 'Tasca' : 'Victoria';
                document.getElementById(`edit${prefix}Pvp`).value = est.pvp != null ? est.pvp : '';
                document.getElementById(`edit${prefix}Stock`).value = est.unidades != null ? est.unidades : '';
                document.getElementById(`edit${prefix}Loc`).value = est.localizacion || '';
            });

            document.getElementById('editForm').classList.add('visible');
            document.getElementById('btnEditWine').style.display = 'none';
        });

        document.getElementById('btnCancelEdit').addEventListener('click', () => {
            document.getElementById('editForm').classList.remove('visible');
            document.getElementById('btnEditWine').style.display = hasEditAccess() ? 'inline-block' : 'none';
        });

        document.getElementById('btnSaveEdit').addEventListener('click', () => {
            if (!hasEditAccess()) return;
            if (!currentEditPod) return;
            const ref = refs.find(r => r.pod === currentEditPod);
            if (!ref) return;

            // Save descripcion
            const desc = document.getElementById('editDesc').value.trim();
            if (desc && desc !== ref.descripcion) {
                ref.descripcion = desc;
                saveEdit(currentEditPod, 'descripcion', desc);
            }

            // Save region
            const region = document.getElementById('editRegion').value.trim();
            if (region !== (ref.region || '')) {
                ref.region = region || null;
                saveEdit(currentEditPod, 'region', region || null);
            }

            // Save uvas
            const uvasStr = document.getElementById('editUvas').value.trim();
            const uvasArr = uvasStr ? uvasStr.split(',').map(u => u.trim()).filter(Boolean) : [];
            ref.uvas = uvasArr;
            saveEdit(currentEditPod, 'uvas', uvasArr);

            // Save per-establishment fields
            EST_KEYS.forEach(k => {
                if (!ref.establecimientos) ref.establecimientos = {};
                if (!ref.establecimientos[k]) ref.establecimientos[k] = { pvp: null, unidades: null, localizacion: null };
                const est = ref.establecimientos[k];
                const prefix = k === 'spa' ? 'Spa' : k === 'tasca_fina' ? 'Tasca' : 'Victoria';

                const pvpVal = document.getElementById(`edit${prefix}Pvp`).value;
                const pvp = pvpVal !== '' ? Number(pvpVal) : null;
                if (pvp !== est.pvp) { est.pvp = pvp; saveEdit(currentEditPod, `establecimientos.${k}.pvp`, pvp); }

                const stockVal = document.getElementById(`edit${prefix}Stock`).value;
                const stock = stockVal !== '' ? Number(stockVal) : null;
                if (stock !== est.unidades) { est.unidades = stock; saveEdit(currentEditPod, `establecimientos.${k}.unidades`, stock); }

                const loc = document.getElementById(`edit${prefix}Loc`).value.trim().toUpperCase() || null;
                if (loc !== est.localizacion) { est.localizacion = loc; saveEdit(currentEditPod, `establecimientos.${k}.localizacion`, loc); }
            });

            // Recompute indexes
            preProcess();
            updateRefCount();

            // Refresh modal
            openModal(ref);
        });

        // --- LANGUAGE ---
        function getNextPhrase() {
            if (phraseQueue.length === 0) {
                phraseQueue = [...translations[currentLang].placeholders];
                for (let i = phraseQueue.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [phraseQueue[i], phraseQueue[j]] = [phraseQueue[j], phraseQueue[i]];
                }
                if (phraseQueue[0] === currentPhrase && phraseQueue.length > 1) {
                    phraseQueue.push(phraseQueue.shift());
                }
            }
            return phraseQueue.pop();
        }

        function startTypeWriter() {
            const input = document.getElementById('searchInput');
            if (!input) return;

            if (!currentPhrase) currentPhrase = getNextPhrase();

            if (isDeleting) {
                input.placeholder = currentPhrase.substring(0, charIndex - 1);
                charIndex--;
            } else {
                input.placeholder = currentPhrase.substring(0, charIndex + 1);
                charIndex++;
            }

            let speed = isDeleting ? 20 : 50;

            if (!isDeleting && charIndex === currentPhrase.length) {
                speed = 2000;
                isDeleting = true;
            } else if (isDeleting && charIndex === 0) {
                isDeleting = false;
                currentPhrase = getNextPhrase();
                speed = 500;
            }

            clearTimeout(typeWriterTimeout);
            typeWriterTimeout = setTimeout(startTypeWriter, speed);
        }

        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            document.getElementById('currentLangBtn').textContent = t.btnLabel;

            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (t[key] && el.tagName !== 'INPUT') el.textContent = t[key];
            });

            phraseQueue = [];
            currentPhrase = '';
            charIndex = 0;
            isDeleting = false;
            clearTimeout(typeWriterTimeout);
            startTypeWriter();

            // Refresh search results if visible
            triggerSearch();
        }

        // --- DARK/LIGHT MODE TOGGLE (CANVAS) ---
        const themeToggle = document.getElementById('themeToggle');
        const toggleCanvas = document.getElementById('toggleCanvas');
        const tCtx = toggleCanvas.getContext('2d');
        toggleCanvas.width = 80;
        toggleCanvas.height = 40;

        let isDark = true;
        let toggleProgress = 1;
        const lerp = (a, b, t) => a + (b - a) * t;

        function drawToggle() {
            const w = toggleCanvas.width, h = toggleCanvas.height;
            tCtx.clearRect(0, 0, w, h);

            const r = lerp(96, 30, toggleProgress);
            const g = lerp(165, 27, toggleProgress);
            const b = lerp(250, 75, toggleProgress);
            tCtx.fillStyle = `rgb(${r},${g},${b})`;
            tCtx.beginPath();
            tCtx.roundRect(0, 0, w, h, 20);
            tCtx.fill();

            if (toggleProgress > 0.1) {
                tCtx.fillStyle = `rgba(255,255,255,${toggleProgress})`;
                [{x:20,y:10},{x:40,y:30},{x:15,y:30},{x:50,y:10}].forEach(s => {
                    tCtx.beginPath(); tCtx.arc(s.x, s.y, 1.5, 0, Math.PI*2); tCtx.fill();
                });
            }

            const cloudOp = Math.max(0, 1 - toggleProgress * 2);
            if (cloudOp > 0) {
                tCtx.fillStyle = `rgba(255,255,255,${cloudOp * 0.8})`;
                tCtx.beginPath();
                tCtx.arc(50,30,8,0,Math.PI*2); tCtx.arc(60,35,10,0,Math.PI*2); tCtx.arc(70,30,8,0,Math.PI*2);
                tCtx.fill();
            }

            const cx = lerp(20, w-20, toggleProgress), cy = h/2, rad = 14;
            const ar = lerp(251,226,toggleProgress), ag = lerp(191,232,toggleProgress), ab = lerp(36,240,toggleProgress);
            tCtx.fillStyle = `rgb(${ar},${ag},${ab})`;
            tCtx.shadowBlur = 10;
            tCtx.shadowColor = `rgba(${ar},${ag},${ab},0.5)`;
            tCtx.beginPath(); tCtx.arc(cx, cy, rad, 0, Math.PI*2); tCtx.fill();
            tCtx.shadowBlur = 0;

            if (toggleProgress > 0.1) {
                const maskOff = lerp(rad*2, 6, toggleProgress);
                tCtx.fillStyle = `rgb(${r},${g},${b})`;
                tCtx.beginPath(); tCtx.arc(cx - maskOff, cy - 2, rad, 0, Math.PI*2); tCtx.fill();
            }

            const rayOp = Math.max(0, 1 - toggleProgress * 3);
            if (rayOp > 0) {
                tCtx.strokeStyle = `rgba(251,191,36,${rayOp})`;
                tCtx.lineWidth = 2; tCtx.lineCap = 'round';
                for (let i = 0; i < 6; i++) {
                    const angle = (i * Math.PI * 2) / 6 + (toggleProgress * 2);
                    tCtx.beginPath();
                    tCtx.moveTo(cx + Math.cos(angle)*(rad+3), cy + Math.sin(angle)*(rad+3));
                    tCtx.lineTo(cx + Math.cos(angle)*(rad+7), cy + Math.sin(angle)*(rad+7));
                    tCtx.stroke();
                }
            }

            const target = isDark ? 1 : 0;
            if (Math.abs(toggleProgress - target) > 0.001) {
                toggleProgress += (target - toggleProgress) * 0.1;
                requestAnimationFrame(drawToggle);
            }
        }

        themeToggle.addEventListener('click', () => {
            isDark = !isDark;
            document.body.classList.toggle('light-mode');
            drawToggle();
        });

        // --- GOLD PARTICLES ---
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        let particlesArray = [];

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initParticles();
        });

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speedX = Math.random() * 0.5 - 0.25;
                this.speedY = Math.random() * 0.5 - 0.25;
                this.opacity = Math.random() * 0.5 + 0.1;
            }
            update() {
                this.x += this.speedX;
                this.y -= this.speedY;
                if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                if (this.y < 0) this.y = canvas.height;
                if (this.y > canvas.height) this.y = 0;
            }
            draw() {
                ctx.fillStyle = `rgba(212,175,55,${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particlesArray = [];
            const n = Math.round((canvas.width * canvas.height) / 5500 * 2.0);
            for (let i = 0; i < n; i++) particlesArray.push(new Particle());
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particlesArray.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateParticles);
        }

        initParticles();
        animateParticles();
        drawToggle();
        startTypeWriter();

        // --- MOBILE KEYBOARD ---
        const initialVH = window.innerHeight;
        if ('visualViewport' in window) {
            window.visualViewport.addEventListener('resize', () => {
                if (window.visualViewport.height / initialVH < 0.75) {
                    document.body.classList.add('keyboard-open');
                } else {
                    document.body.classList.remove('keyboard-open');
                }
            });
        }

        // Prevent iOS double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', e => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
        }, false);

        // --- PWA ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }

        // TODO: [SYNC] Add WebSocket connection for real-time data updates
        // TODO: [SYNC] Implement optimistic UI updates with server reconciliation
        // TODO: [SYNC] Add conflict resolution for concurrent edits across devices
    </script>
</body>
</html>
