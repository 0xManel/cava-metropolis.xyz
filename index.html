<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    
    <!-- Build: 2026-02-24-GALICIA-DO -->
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="STOCK Cava">
    <meta name="theme-color" content="#08080b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Carta de vinos premium — STOCK Cava Metropolis. Descubre nuestra selección exclusiva de vinos de alta gama.">
    <meta name="keywords" content="vinos, cava, stock cava, carta de vinos, metropolis, vinos premium, bodega">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://stockcava.com/">
    <meta property="og:title" content="STOCK Cava Metropolis">
    <meta property="og:description" content="Carta de vinos premium — Descubre nuestra selección exclusiva.">
    <meta property="og:image" content="https://stockcava.com/imgs/icon-512.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://stockcava.com/">
    <meta property="twitter:title" content="STOCK Cava Metropolis">
    <meta property="twitter:description" content="Carta de vinos premium — Descubre nuestra selección exclusiva.">
    <meta property="twitter:image" content="https://stockcava.com/imgs/icon-512.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="canonical" href="https://stockcava.com/">
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="imgs/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="imgs/favicon-16x16.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="imgs/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="imgs/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="167x167" href="imgs/apple-touch-icon-ipad.png">
    
    <title>STOCK Cava Metropolis — Carta de Vinos Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- PALETA HIGH-CLASS --- */
        :root {
            --bg-color: #08080b;
            --glass-bg: rgba(35, 35, 40, 0.8);
            --glass-border: rgba(212, 175, 55, 0.25);
            --text-main: #FDFBF7;
            --text-muted: #C8BEAE;
            --gold-accent: #D4AF37;
            --gold-light: #F3E5AB;
            --price-bg: rgba(46, 125, 50, 0.15);
            --price-color: #57C25B;
            --minicard-bg: rgba(255, 255, 255, 0.05);
            --field-bg: rgba(255, 255, 255, 0.1);
            --field-border: rgba(255, 255, 255, 0.22);
            --field-border-strong: rgba(255, 255, 255, 0.34);
            --field-focus-ring: rgba(212, 175, 55, 0.28);
            --field-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
            --transition-bounce: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --transition-smooth: all 0.4s ease;
            --ui-entry-duration: 700ms;
            --ui-entry-delay: 120ms;
            --ui-entry-ease: cubic-bezier(0.22, 0.78, 0.28, 1);
        }

        body.light-mode {
            --bg-color: #FDFBF7;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(212, 175, 55, 0.4);
            --text-main: #1A1A1A;
            --text-muted: #5B554A;
            --gold-accent: #B8860B;
            --gold-light: #D4AF37;
            --price-bg: rgba(46, 125, 50, 0.1);
            --price-color: #2E7D32;
            --minicard-bg: rgba(0, 0, 0, 0.02);
            --field-bg: rgba(244, 239, 228, 0.95);
            --field-border: rgba(131, 99, 24, 0.38);
            --field-border-strong: rgba(131, 99, 24, 0.55);
            --field-focus-ring: rgba(184, 134, 11, 0.26);
            --field-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.72);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scrollbar-gutter: stable both-edges;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            transition: background-color 0.8s ease, color 0.8s ease;
            line-height: 1.4;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            min-height: 100dvh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 22dvh;
            overflow-x: hidden;
            overflow-y: scroll;
        }

        input, button, select, textarea {
            font-family: 'Montserrat', sans-serif;
        }

        /* Entrance animation */
        @keyframes fadeSlideUp {
            0% { opacity: 0; transform: translateY(40px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        header { animation: fadeSlideUp 0.8s ease-out both; }
        .search-container { animation: fadeSlideUp 0.8s ease-out 0.15s both; }
        .theme-toggle { animation: fadeSlideUp 0.5s ease-out 0.3s both; }
        header,
        .search-container,
        .theme-toggle,
        .lang-container,
        .admin-btn,
        .logout-btn,
        .session-user-card {
            will-change: transform, opacity;
        }

        /* --- GOLDEN PARTICLES (CANVAS) --- */
        #particleCanvas {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 0;
            pointer-events: none;
        }

        /* --- HEADER --- */
        header {
            margin-top: 0;
            margin-bottom: 2rem;
            text-align: center;
            z-index: 10;
        }

        .title-cava {
            color: var(--gold-accent);
            line-height: 1;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            transition: var(--transition-smooth);
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.8vw;
            margin-bottom: -0.5rem;
        }

        .stock-text {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 7vw;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .cava-text {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            font-weight: 400;
            font-size: 7vw;
        }

        .title-metropolis {
            font-family: 'Montserrat', sans-serif;
            font-size: 10vw;
            letter-spacing: 0.5vw;
            font-weight: 600;
            color: var(--text-main);
            padding: 0 5vw;
            text-shadow:
                0 0 5px rgba(255, 255, 255, 0.6),
                0 0 15px var(--gold-accent),
                0 0 30px rgba(212, 175, 55, 0.4);
        }

        /* --- SEARCH BAR (GLASSMORPHISM) --- */
        .search-container {
            width: 90%;
            max-width: 600px;
            position: relative;
            z-index: 20;
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
        }

        .search-input-wrapper {
            position: relative;
            width: 100%;
        }

        .search-icon {
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px; height: 20px;
            fill: var(--text-muted);
        }

        #searchInput {
            width: 100%;
            padding: 1.2rem 1rem 1.2rem 2rem;
            font-size: 1.3rem;
            font-family: 'Montserrat', sans-serif;
            background: var(--field-bg);
            border: 1px solid var(--field-border);
            border-radius: 30px;
            color: var(--text-main);
            outline: none;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), var(--field-shadow);
            transition: var(--transition-smooth);
        }

        #searchInput:hover {
            border-color: var(--field-border-strong);
        }

        #searchInput:focus {
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 3px var(--field-focus-ring), 0 0 20px rgba(212, 175, 55, 0.18), var(--field-shadow);
        }

        #searchInput:focus-visible {
            outline: none;
        }

        #searchInput::placeholder { color: var(--text-muted); font-weight: 300; }

        .ref-count {
            text-align: center;
            margin-bottom: 0.8rem;
            font-size: 0.92rem;
            color: var(--text-muted);
            letter-spacing: 0.8px;
            font-weight: 400;
            order: -1;
        }
        .ref-count span { color: var(--gold-accent); font-weight: 700; }
        .ref-count.ref-count-located {
            margin-top: -0.45rem;
            margin-bottom: 0.65rem;
            font-size: 0.84rem;
            letter-spacing: 0.7px;
        }
        .ref-count.ref-count-located span {
            color: #53d66f;
            font-weight: 700;
        }

        /* --- FILTER BAR --- */
        .filter-bar {
            width: 100%;
            margin-top: 0.6rem;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .filter-restaurant-row {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 0.32rem;
            align-items: center;
        }

        .filter-sort-row {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .filter-pill {
            width: 100%;
            height: 38px;
            padding: 0 0.45rem;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-muted);
            font-family: 'Montserrat', sans-serif;
            font-size: clamp(0.62rem, 2.2vw, 1rem);
            font-weight: 700;
            letter-spacing: 0.012em;
            line-height: 1.14;
            cursor: pointer;
            transition: all 0.25s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            text-align: center;
        }

        .filter-pill:active { transform: scale(0.95); }

        .filter-pill.active {
            background: var(--gold-accent);
            color: #111;
            border-color: var(--gold-accent);
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
        }

        .sort-toggle {
            height: 38px;
            min-width: 90px;
            padding: 0 0.9rem;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--gold-accent);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.88rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            cursor: pointer;
            transition: all 0.25s ease;
            text-transform: uppercase;
        }
        .sort-toggle:active { transform: scale(0.95); }
        .modal-actions::-webkit-scrollbar,
        .consume-actions::-webkit-scrollbar,
        .edit-actions::-webkit-scrollbar { display: none; }

        /* --- DROPDOWN RESULTS --- */
        #searchResults {
            position: absolute;
            top: 100%;
            left: 0; right: 0;
            background: transparent;
            max-height: 60vh;
            overflow-y: auto;
            display: none;
            z-index: 9999;
        }

        .search-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.68rem 1.02rem;
            margin-bottom: 0.36rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            cursor: pointer;
            transition: transform 0.18s ease, background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .search-item:first-child { margin-top: 2mm; }

        @media (hover: hover) {
            .search-item:hover {
                background: rgba(212, 175, 55, 0.12);
                border-color: var(--gold-accent);
                box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2);
                transform: translateY(-1px);
            }
        }
        .search-item:active {
            background: rgba(212, 175, 55, 0.18);
            transform: scale(0.98);
        }

        .item-info { display: flex; flex-direction: column; gap: 0.24rem; flex: 1; min-width: 0; }

        .item-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.02rem;
            font-weight: 650;
            color: var(--text-main);
            line-height: 1.28;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* --- GRAPE TAG FAMILIES --- */
        .grape-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.1rem;
        }

        .grape-tag {
            display: inline-block;
            padding: 0.18rem 0.45rem;
            border-radius: 8px;
            font-size: 0.68rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            cursor: default;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .grape-tag.iberica-tinta { background: linear-gradient(135deg, #E53935 0%, #D32626 100%); }
        .grape-tag.iberica-tinta.s2 { background: linear-gradient(135deg, #F44336 0%, #E53935 100%); }
        .grape-tag.iberica-tinta.s3 { background: linear-gradient(135deg, #FF6F6F 0%, #F44336 100%); }

        .grape-tag.burgundy { background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%); }
        .grape-tag.burgundy.s2 { background: linear-gradient(135deg, #9333EA 0%, #7C3AED 100%); }
        .grape-tag.burgundy.s3 { background: linear-gradient(135deg, #A855F7 0%, #9333EA 100%); }

        .grape-tag.italiana { background: linear-gradient(135deg, #C23030 0%, #B71C1C 100%); }
        .grape-tag.italiana.s2 { background: linear-gradient(135deg, #D32626 0%, #C23030 100%); }
        .grape-tag.italiana.s3 { background: linear-gradient(135deg, #E53935 0%, #D32626 100%); }

        .grape-tag.aromatico { background: linear-gradient(135deg, #F9A825 0%, #F57F17 100%); }
        .grape-tag.aromatico.s2 { background: linear-gradient(135deg, #FBC02D 0%, #F9A825 100%); }
        .grape-tag.aromatico.s3 { background: linear-gradient(135deg, #FDD835 0%, #FBC02D 100%); }

        .grape-tag.novamundo { background: linear-gradient(135deg, #8B1538 0%, #5F0F1D 100%); }
        .grape-tag.novamundo.s2 { background: linear-gradient(135deg, #A91D3A 0%, #8B1538 100%); }
        .grape-tag.novamundo.s3 { background: linear-gradient(135deg, #C81E4E 0%, #A91D3A 100%); }

        .grape-tag.espumoso { background: linear-gradient(135deg, #EC407A 0%, #D81B60 100%); }
        .grape-tag.espumoso.s2 { background: linear-gradient(135deg, #F06292 0%, #EC407A 100%); }
        .grape-tag.espumoso.s3 { background: linear-gradient(135deg, #F48FB1 0%, #F06292 100%); }

        .badge-row { display: flex; gap: 0.35rem; align-items: center; margin-top: 0.05rem; }

        .badge {
            font-size: 0.62rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 0.18rem 0.45rem;
            border-radius: 4px;
            letter-spacing: 0.8px;
            color: #111;
        }

        .item-region { font-size: 0.78rem; color: var(--text-muted); }

        .item-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.3rem;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .item-price {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            color: var(--price-color);
            font-size: 1.12rem;
            letter-spacing: 0.5px;
            line-height: 1;
        }

        .item-location {
            font-size: 0.82rem;
            color: var(--text-main);
            font-weight: 700;
            letter-spacing: 0.08em;
            font-family: 'Montserrat', monospace;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(180, 135, 25, 0.2));
            border: 1px solid var(--gold-accent);
            padding: 0.22rem 0.52rem;
            border-radius: 6px;
            display: inline-block;
            box-shadow: 0 2px 6px rgba(212, 175, 55, 0.15);
            white-space: nowrap;
        }

        .item-pod {
            font-size: 0.64rem;
            color: var(--text-muted);
            font-family: 'Montserrat', monospace;
            opacity: 0.75;
            letter-spacing: 0.5px;
        }

        .item-format {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.25s ease, visibility 0s linear 0.25s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transition: opacity 0.25s ease;
        }

        .modal-card {
            width: 90%;
            max-width: 540px;
            background: var(--bg-color);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 1.9rem;
            position: relative;
            isolation: isolate;
            transform: translateY(18px) scale(0.985);
            opacity: 0;
            transition: transform 0.26s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.22s ease;
            box-shadow:
                0 20px 50px rgba(0,0,0,0.5),
                inset 0 0 0 1px rgba(212, 175, 55, 0.08);
            max-height: 90dvh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .modal-card::before {
            content: '';
            position: absolute;
            inset: 9px 9px 11px;
            border-radius: 16px;
            border: 1px solid rgba(212, 175, 55, 0.12);
            opacity: 0.78;
            pointer-events: none;
            z-index: 0;
        }

        .modal-card > * {
            position: relative;
            z-index: 1;
        }

        .modal-overlay.active .modal-card {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .btn-close {
            position: absolute;
            top: 1.5rem; right: 1.5rem;
            background: none; border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition-smooth);
            z-index: 2;
        }
        .btn-close:hover { color: var(--gold-accent); transform: scale(1.1); }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            line-height: 1.3;
            color: var(--text-main);
            margin: 1rem 0 0.5rem 0;
            padding-right: 20px;
        }

        .modal-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .modal-grapes {
            margin-bottom: 1rem;
        }
        .modal-grapes .grape-tag {
            font-size: 0.74rem;
            padding: 0.3rem 0.5rem;
        }

        /* Details grid for D.O., Country, Year, Format */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1.2rem;
        }

        .detail-box {
            background: var(--minicard-bg);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 12px;
            padding: 0.8rem;
            text-align: center;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
        }

        .detail-label {
            font-size: 0.72rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.3px;
            margin-bottom: 0.24rem;
        }

        .detail-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.03rem;
            color: var(--text-main);
            font-weight: 600;
            overflow-wrap: anywhere;
            word-break: break-word;
            line-height: 1.24;
        }

        /* Terroir section (Clima & Suelo) */
        .terroir-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1.2rem;
        }

        .terroir-label {
            font-size: 0.66rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--gold-accent);
            opacity: 0.7;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .terroir-box {
            background: linear-gradient(135deg, rgba(100,180,255,0.04), var(--minicard-bg));
            border: 1px solid rgba(100, 180, 255, 0.12);
            border-radius: 12px;
            padding: 0.8rem;
            text-align: center;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
        }

        .terroir-box .detail-value {
            font-size: 0.9rem;
            line-height: 1.42;
            white-space: pre-line;
            text-align: left;
        }

        .cata-block {
            margin-bottom: 1.08rem;
        }

        .cata-label {
            font-size: 0.66rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.4px;
            color: var(--gold-accent);
            opacity: 0.75;
            margin-bottom: 0.52rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .cata-box {
            background: linear-gradient(140deg, rgba(212, 175, 55, 0.09), var(--minicard-bg));
            border: 1px solid rgba(212, 175, 55, 0.16);
            border-radius: 12px;
            padding: 0.78rem 0.74rem;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
        }

        .cata-value {
            font-size: 0.87rem;
            line-height: 1.42;
            color: var(--text-main);
            font-weight: 520;
            white-space: pre-line;
        }

        .cata-mini-label {
            margin-top: 0.62rem;
            margin-bottom: 0.34rem;
            font-size: 0.58rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-muted);
            opacity: 0.9;
        }

        .cata-guide-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.34rem;
        }

        .guide-pill {
            border-radius: 999px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            background: rgba(212, 175, 55, 0.08);
            padding: 0.24rem 0.52rem;
            font-size: 0.66rem;
            font-weight: 600;
            color: var(--text-main);
            line-height: 1.2;
            text-align: center;
        }

        .cata-points {
            display: grid;
            gap: 0.32rem;
        }

        .cata-point {
            border-radius: 9px;
            border: 1px solid rgba(212, 175, 55, 0.14);
            background: rgba(0, 0, 0, 0.16);
            padding: 0.42rem 0.5rem;
            font-size: 0.72rem;
            line-height: 1.26;
            color: var(--text-main);
        }

        .cata-critics {
            margin-top: 0.62rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.34rem;
        }

        .critic-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.2rem 0.46rem;
            border-radius: 999px;
            font-size: 0.66rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            color: #131313;
            background: linear-gradient(135deg, rgba(237, 201, 94, 0.98), rgba(212, 175, 55, 0.95));
            border: 1px solid rgba(255, 245, 209, 0.45);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.22);
        }

        .critics-expanded {
            margin-top: 0.46rem;
            display: grid;
            gap: 0.26rem;
        }

        .critic-row {
            border-radius: 9px;
            padding: 0.36rem 0.48rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            border: 1px solid rgba(212, 175, 55, 0.14);
            background: rgba(0, 0, 0, 0.18);
        }

        .critic-row.is-na {
            opacity: 0.78;
        }

        .critic-name {
            font-size: 0.67rem;
            letter-spacing: 0.07em;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
        }

        .critic-value {
            font-size: 0.76rem;
            font-weight: 700;
            color: var(--text-main);
            text-align: right;
        }

        /* Establishment pricing table */
        .est-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.2rem;
            table-layout: fixed;
        }

        .est-table th {
            font-size: 0.64rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gold-accent);
            padding: 0.5rem 0.3rem;
            border-bottom: 1px solid var(--glass-border);
            text-align: center;
        }

        .est-table td {
            font-size: 0.93rem;
            color: var(--text-main);
            padding: 0.5rem 0.32rem;
            text-align: center;
            border-bottom: 1px solid rgba(212, 175, 55, 0.08);
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
            line-height: 1.2;
        }

        .est-table .row-label {
            font-size: 0.69rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: left;
            font-weight: 600;
        }

        .est-table .pvp-cell {
            font-weight: 900;
            color: var(--price-color);
            font-size: 1.08rem;
        }

        .est-table .loc-cell {
            font-family: 'Montserrat', monospace;
            font-weight: 700;
            letter-spacing: 0.04em;
            font-size: 0.9rem;
        }

        .est-mobile-grid {
            display: none;
            margin-bottom: 1.2rem;
            gap: 0.42rem;
        }

        .est-mobile-item {
            display: grid;
            grid-template-columns: minmax(82px, 0.92fr) repeat(2, minmax(0, 1fr));
            grid-template-areas:
                "name pvp stock"
                "name loc loc";
            gap: 0.36rem;
            align-items: stretch;
            border: 1px solid rgba(212, 175, 55, 0.12);
            border-radius: 11px;
            padding: 0.42rem;
            background: rgba(0, 0, 0, 0.16);
        }

        .est-mobile-name {
            grid-area: name;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9px;
            border: 1px solid rgba(212, 175, 55, 0.15);
            background: rgba(212, 175, 55, 0.08);
            color: var(--gold-accent);
            font-size: 0.68rem;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            padding: 0 0.34rem;
            text-align: center;
            line-height: 1.16;
        }

        .est-mobile-field {
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.09);
            background: var(--minicard-bg);
            padding: 0.4rem 0.36rem 0.36rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 0;
            min-height: 46px;
        }

        .est-mobile-field--pvp { grid-area: pvp; }
        .est-mobile-field--stock { grid-area: stock; }
        .est-mobile-field--location { grid-area: loc; }

        .est-mobile-field-label {
            font-size: 0.56rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-muted);
            line-height: 1.1;
            margin-bottom: 3px;
        }

        .est-mobile-field-value {
            font-size: 0.78rem;
            color: var(--text-main);
            font-weight: 700;
            line-height: 1.2;
            white-space: nowrap;
            overflow: visible;
            text-overflow: clip;
            text-align: center;
            max-width: 100%;
        }

        .est-mobile-field-value.is-price {
            color: var(--price-color);
            font-size: 0.88rem;
            font-weight: 800;
        }

        .est-mobile-field-value.is-location {
            font-family: 'Montserrat', monospace;
            letter-spacing: 0.03em;
            line-height: 1.14;
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
            font-size: 0.72rem;
        }

        /* --- THEME TOGGLE --- */
        .top-actions {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 7px;
            align-items: flex-end;
        }

        .top-left-actions {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 7px;
            align-items: flex-start;
        }

        @keyframes dropToPlace {
            0% { transform: translateY(-26px) scale(0.96); }
            60% { transform: translateY(2px) scale(1.005); }
            100% { transform: translateY(0) scale(1); }
        }

        @keyframes slideFromRight {
            0% { transform: translateX(28px) scale(0.97); }
            70% { transform: translateX(-1px) scale(1.002); }
            100% { transform: translateX(0) scale(1); }
        }

        @keyframes slideFromLeft {
            0% { opacity: 0; transform: translateX(-28px) scale(0.97); }
            70% { opacity: 1; transform: translateX(1px) scale(1.002); }
            100% { opacity: 1; transform: translateX(0) scale(1); }
        }

        @keyframes riseFromBottom {
            0% { transform: translateY(18px) scale(0.965); }
            65% { transform: translateY(-1px) scale(1.002); }
            100% { transform: translateY(0) scale(1); }
        }

        @keyframes dropFromTopCard {
            0% { opacity: 0; transform: translate(-50%, -26px) scale(0.97); }
            70% { opacity: 1; transform: translate(-50%, 1px) scale(1.002); }
            100% { opacity: 1; transform: translate(-50%, 0) scale(1); }
        }

        .theme-toggle {
            width: 60px; height: 30px;
            border-radius: 15px;
            background: transparent;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            overflow: hidden;
            padding: 0;
            transition: all 0.28s ease;
            animation: dropToPlace var(--ui-entry-duration) var(--ui-entry-ease) var(--ui-entry-delay) both;
        }

        .theme-toggle:hover {
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
            transform: scale(1.05);
        }

        #toggleCanvas { width: 100%; height: 100%; display: block; }

        /* --- LANGUAGE SELECTOR --- */
        .lang-container {
            position: relative;
            z-index: 2;
            font-family: 'Montserrat', sans-serif;
            animation: slideFromRight var(--ui-entry-duration) var(--ui-entry-ease) var(--ui-entry-delay) both;
        }

        .app-signature {
            position: fixed;
            left: 50%;
            bottom: max(10px, env(safe-area-inset-bottom));
            transform: translateX(-50%);
            z-index: 1;
            pointer-events: none;
            user-select: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            font-size: clamp(0.62rem, 1.6vw, 0.78rem);
            letter-spacing: 0.16em;
            color: var(--text-muted);
            opacity: 0.24;
            text-transform: lowercase;
            white-space: nowrap;
            text-shadow: 0 0 14px rgba(212, 175, 55, 0.12);
        }

        .session-user-card {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 110;
            width: max-content;
            min-width: 0;
            max-width: min(88vw, 420px);
            padding: 8px 14px;
            border-radius: 14px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.82rem;
            font-weight: 600;
            letter-spacing: 0.03em;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 16px rgba(0,0,0,0.24);
            pointer-events: none;
            animation: dropFromTopCard var(--ui-entry-duration) var(--ui-entry-ease) var(--ui-entry-delay) both;
        }
        .logout-btn,
        .admin-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            width: 60px;
            height: 30px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.68rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            padding: 0;
            backdrop-filter: blur(10px);
            transition: all 0.28s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1;
            font-family: 'Montserrat', sans-serif;
        }
        .admin-btn {
            animation: riseFromBottom var(--ui-entry-duration) var(--ui-entry-ease) var(--ui-entry-delay) both;
        }
        .logout-btn {
            animation: slideFromLeft var(--ui-entry-duration) var(--ui-entry-ease) var(--ui-entry-delay) both;
        }
        .logout-btn:hover,
        .admin-btn:hover {
            border-color: var(--gold-accent);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
        }

        .lang-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            width: 60px; height: 30px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.72rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center; gap: 4px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .lang-btn:hover {
            border-color: var(--gold-accent);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
        }

        .lang-dropdown {
            position: absolute;
            top: 120%; right: 0;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            overflow: hidden;
            opacity: 0; visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition-smooth);
            backdrop-filter: blur(15px);
            min-width: 100px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .lang-container:hover .lang-dropdown {
            opacity: 1; visibility: visible;
            transform: translateY(0);
        }

        .lang-option {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 20px;
            color: var(--text-main);
            text-decoration: none;
            font-size: 0.9rem;
            transition: background 0.3s;
            cursor: pointer;
        }
        .lang-option:hover { background: rgba(212, 175, 55, 0.1); }

        .theme-toggle:focus-visible,
        .lang-btn:focus-visible,
        .logout-btn:focus-visible,
        .admin-btn:focus-visible,
        .sort-toggle:focus-visible,
        .filter-pill:focus-visible,
        .btn-edit:focus-visible,
        .btn-consume:focus-visible,
        .btn-save:focus-visible,
        .btn-cancel:focus-visible,
        .btn-close:focus-visible {
            outline: none;
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 3px var(--field-focus-ring), 0 0 20px rgba(212, 175, 55, 0.2);
        }

        @media (prefers-reduced-motion: reduce) {
            .search-item,
            .theme-toggle,
            .lang-btn,
            .logout-btn,
            .admin-btn,
            .btn-edit,
            .btn-consume,
            .btn-save,
            .btn-cancel,
            .btn-close,
            .modal-overlay,
            .modal-card {
                transition: none !important;
            }
            .theme-toggle,
            .lang-container,
            .admin-btn,
            .logout-btn,
            .session-user-card {
                animation: none !important;
            }
        }

        /* Badge colors */
        .b-tinto { background: #800020; color: #FFF; }
        .b-branco { background: #E5C158; }
        .b-rosado { background: #E08D79; }
        .b-espumoso { background: #D4AF37; }
        .b-generoso { background: #C97B1A; color: #FFF; }
        .b-dulce { background: #8B6914; color: #FFF; }

        /* Edit form */
        .edit-form { display: none; margin-top: 1rem; }
        .edit-form.visible { display: block; }

        .edit-field {
            padding: 0.7rem;
            border-radius: 8px;
            border: 1px solid var(--field-border);
            background: var(--field-bg);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            width: 100%;
            box-shadow: var(--field-shadow);
        }
        .edit-field:hover { border-color: var(--field-border-strong); }
        .edit-field:focus {
            outline: none;
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 3px var(--field-focus-ring), var(--field-shadow);
        }
        .edit-field:focus-visible { outline: none; }

        .edit-section-title {
            font-size: 0.69rem;
            color: var(--gold-accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 0.8rem;
            margin-bottom: 0.3rem;
            font-weight: 700;
        }

        .edit-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .edit-row .edit-field { flex: 1; }

        .edit-actions {
            display: flex;
            gap: 0.6rem;
            justify-content: flex-end;
            margin-top: 0.8rem;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .btn-cancel {
            padding: 0.6rem 0.9rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .btn-save {
            padding: 0.6rem 0.9rem;
            border-radius: 8px;
            border: none;
            background: var(--gold-accent);
            color: #111;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .btn-edit {
            padding: 0.6rem 0.9rem;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-main);
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .modal-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.7rem;
            margin-top: 0.35rem;
            flex-wrap: wrap;
            overflow: visible;
        }

        .consume-actions {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            flex-wrap: nowrap;
            flex: 1 1 auto;
            min-width: 0;
            overflow: visible;
        }

        .consume-qty {
            height: 36px;
            min-width: 62px;
            border-radius: 10px;
            border: 1px solid var(--field-border);
            background: var(--field-bg);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            padding: 0 8px;
            outline: none;
            cursor: pointer;
            box-shadow: var(--field-shadow);
            transition: var(--transition-smooth);
            flex: 0 0 auto;
        }

        .consume-qty:hover {
            border-color: var(--field-border-strong);
        }

        .consume-qty:focus {
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 3px var(--field-focus-ring), var(--field-shadow);
        }

        .consume-qty:focus-visible {
            outline: none;
        }

        .btn-consume {
            min-width: 78px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid rgba(255, 84, 84, 0.45);
            background: rgba(168, 19, 19, 0.22);
            color: #ff5d5d;
            cursor: pointer;
            font-size: 0.84rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            padding: 0 10px;
            transition: all 0.25s ease;
            box-shadow: 0 4px 14px rgba(120, 10, 10, 0.28);
            flex: 0 0 auto;
        }

        .btn-consume.btn-consume-cava:hover {
            background: rgba(186, 27, 27, 0.36);
            border-color: rgba(255, 111, 111, 0.55);
            box-shadow: 0 6px 18px rgba(120, 10, 10, 0.38);
        }

        .btn-consume.btn-consume-bodega {
            border-color: rgba(240, 178, 42, 0.52);
            background: rgba(181, 116, 15, 0.26);
            color: #f8c04f;
            box-shadow: 0 4px 14px rgba(126, 79, 8, 0.3);
        }

        .btn-consume.btn-consume-bodega:hover {
            background: rgba(201, 133, 20, 0.37);
            border-color: rgba(255, 201, 88, 0.62);
            box-shadow: 0 6px 18px rgba(126, 79, 8, 0.4);
        }

        .consume-feedback {
            margin-top: 0.5rem;
            min-height: 1.1rem;
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .sync-toast {
            position: fixed;
            left: 50%;
            bottom: max(18px, env(safe-area-inset-bottom));
            transform: translate(-50%, 120%);
            z-index: 1300;
            min-width: 200px;
            max-width: min(92vw, 420px);
            padding: 11px 16px;
            border-radius: 12px;
            border: 1px solid rgba(95, 218, 134, 0.5);
            background: rgba(20, 112, 53, 0.95);
            color: #e9fff1;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.88rem;
            font-weight: 700;
            text-align: center;
            letter-spacing: 0.02em;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.32);
            backdrop-filter: blur(8px);
            opacity: 0;
            pointer-events: none;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .sync-toast.show {
            transform: translate(-50%, 0);
            opacity: 1;
        }

        @media (max-width: 600px) {
            .title-cava { gap: 1vw; margin-bottom: -0.3rem; }
            .stock-text { font-size: 7.5vw; letter-spacing: 0.05em; }
            .cava-text { font-size: 7.5vw; }
            .title-metropolis { font-size: 11vw; letter-spacing: 1px; padding: 0 20px; }
            .modal-card {
                width: 95%;
                max-height: 92dvh;
                padding: 1.08rem 0.92rem 1rem;
                border-radius: 20px;
            }
            .modal-card::before { inset: 6px 6px 8px; border-radius: 14px; }
            .modal-title { font-size: clamp(1.18rem, 5.3vw, 1.45rem); margin: 0.72rem 0 0.34rem 0; }
            .modal-subtitle { font-size: 0.76rem; margin-bottom: 0.75rem; }
            .modal-grapes { margin-bottom: 0.75rem; }
            .details-grid,
            .terroir-grid {
                gap: 0.48rem;
                margin-bottom: 0.84rem;
            }
            .detail-box,
            .terroir-box {
                padding: 0.58rem 0.52rem;
            }
            .detail-label {
                font-size: 0.58rem;
                letter-spacing: 1px;
            }
            .detail-value {
                font-size: 0.82rem;
            }
            .terroir-label { margin-bottom: 0.46rem; }
            .terroir-box .detail-value {
                font-size: 0.74rem;
                line-height: 1.24;
            }
            .cata-label { font-size: 0.6rem; margin-bottom: 0.4rem; }
            .cata-box { padding: 0.62rem 0.58rem; }
            .cata-value { font-size: 0.78rem; line-height: 1.32; }
            .cata-mini-label { font-size: 0.54rem; margin-top: 0.5rem; margin-bottom: 0.3rem; }
            .cata-guide-grid { grid-template-columns: 1fr; gap: 0.28rem; }
            .guide-pill { font-size: 0.62rem; }
            .cata-point { font-size: 0.68rem; padding: 0.38rem 0.44rem; }
            .critic-chip { font-size: 0.6rem; padding: 0.16rem 0.38rem; }
            .critic-name { font-size: 0.6rem; }
            .critic-value { font-size: 0.7rem; }
            .est-table { display: none; }
            .est-mobile-grid { display: grid; }
            #searchInput { font-size: 1rem; padding: 1rem 1rem 1rem 2rem; }
            body { padding-top: 18dvh; }
            .top-left-actions { top: 15px; left: 15px; gap: 7px; }
            .top-actions { top: 15px; right: 15px; gap: 7px; }
            .session-user-card { top: 15px; }
            .filter-restaurant-row {
                gap: 0.22rem;
            }
            .filter-pill {
                height: 36px;
                border-radius: 16px;
                padding: 0 0.2rem;
                font-size: clamp(0.6rem, 2.35vw, 0.9rem);
                letter-spacing: 0.01em;
            }
            .sort-toggle {
                height: 36px;
                min-width: 80px;
                border-radius: 16px;
                font-size: 0.78rem;
                padding: 0 0.8rem;
            }

            .modal-actions {
                display: grid;
                grid-template-columns: 1fr;
                align-items: stretch;
                gap: 0.45rem;
            }

            .consume-actions {
                width: 100%;
                display: grid;
                grid-template-columns: 56px minmax(0, 1fr) minmax(0, 1fr);
                align-items: center;
                justify-content: stretch;
                gap: 0.34rem;
            }

            .consume-qty,
            .btn-consume,
            .btn-edit {
                width: 100%;
                min-width: 0;
            }

            .btn-edit {
                align-self: stretch;
                height: 35px;
                padding: 0 0.68rem;
                font-size: 0.84rem;
            }
        }

        @media (max-width: 420px) {
            .filter-restaurant-row {
                gap: 0.18rem;
            }
            .filter-pill {
                height: 34px;
                border-radius: 14px;
                padding: 0 0.15rem;
                font-size: clamp(0.58rem, 2.9vw, 0.82rem);
                letter-spacing: 0;
            }
            .sort-toggle {
                height: 34px;
                min-width: 72px;
                border-radius: 14px;
                padding: 0 0.65rem;
                font-size: 0.74rem;
            }
            .modal-card {
                width: 94%;
                padding: 0.98rem 0.82rem 0.9rem;
            }

            .consume-qty {
                min-width: 54px;
                height: 34px;
                font-size: 0.84rem;
                padding: 0 4px;
            }

            .btn-consume {
                min-width: 0;
                height: 34px;
                font-size: 0.79rem;
                padding: 0 7px;
                letter-spacing: 0.02em;
            }

            .consume-actions {
                grid-template-columns: 52px minmax(0, 1fr) minmax(0, 1fr);
            }

            .est-mobile-item {
                grid-template-columns: minmax(72px, 0.88fr) repeat(2, minmax(0, 1fr));
                gap: 0.3rem;
                padding: 0.36rem;
            }

            .est-mobile-name {
                font-size: 0.62rem;
            }

            .est-mobile-field-label {
                font-size: 0.52rem;
            }

            .est-mobile-field-value {
                font-size: 0.72rem;
            }

            .est-mobile-field-value.is-price {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 360px) {
            .modal-card {
                padding: 0.92rem 0.76rem 0.84rem;
            }

            .consume-actions {
                gap: 0.22rem;
                grid-template-columns: 49px minmax(0, 1fr) minmax(0, 1fr);
            }

            .consume-qty {
                min-width: 0;
                font-size: 0.82rem;
            }

            .btn-consume {
                min-width: 0;
                font-size: 0.74rem;
                padding: 0 6px;
            }
        }

        @media (max-height: 740px) and (max-width: 600px) {
            .modal-card {
                max-height: 94dvh;
                padding: 0.9rem 0.8rem 0.82rem;
            }

            .modal-title { margin-top: 0.62rem; }
            .details-grid,
            .terroir-grid { margin-bottom: 0.72rem; }
            .terroir-box .detail-value { line-height: 1.18; }
            .consume-feedback { margin-top: 0.34rem; }
        }

        body.keyboard-open { padding-top: 2dvh; }
        body.keyboard-open header { display: none; }
    </style>
</head>
<body>

    <script>
        (() => {
            try {
                const EST_KEYS = ['bodega', 'spa', 'tasca_fina', 'victoria', 'galeria'];
                const AUTH_KEYS = {
                    sessionFlag: 'cava_login_demo',
                    sessionUser: 'cava_login_user',
                    sessionEstablishment: 'cava_login_establishment',
                    sessionRole: 'cava_login_role',
                    sessionScope: 'cava_login_scope',
                    persistentFlag: 'cava_login_persistent_access',
                    persistentUser: 'cava_login_persistent_user',
                    persistentEstablishment: 'cava_login_persistent_establishment',
                    persistentRole: 'cava_login_persistent_role',
                    persistentScope: 'cava_login_persistent_scope'
                };
                const normalizeUsername = (value) => (value || '').trim().toLowerCase();
                const normalizeEstablishment = (value) => {
                    const normalized = (value || '').trim().toLowerCase();
                    return EST_KEYS.includes(normalized) ? normalized : null;
                };
                const normalizeScope = (value) => {
                    const normalized = (value || '').trim().toLowerCase();
                    return EST_KEYS.includes(normalized) || normalized === 'all' ? normalized : null;
                };
                const normalizeRole = (value) => {
                    const normalized = (value || '').trim().toLowerCase();
                    return ['user', 'admin', 'adminmaster'].includes(normalized) ? normalized : null;
                };
                const clearAuthState = () => {
                    sessionStorage.removeItem(AUTH_KEYS.sessionFlag);
                    sessionStorage.removeItem(AUTH_KEYS.sessionUser);
                    sessionStorage.removeItem(AUTH_KEYS.sessionEstablishment);
                    sessionStorage.removeItem(AUTH_KEYS.sessionRole);
                    sessionStorage.removeItem(AUTH_KEYS.sessionScope);
                    localStorage.removeItem(AUTH_KEYS.persistentFlag);
                    localStorage.removeItem(AUTH_KEYS.persistentUser);
                    localStorage.removeItem(AUTH_KEYS.persistentEstablishment);
                    localStorage.removeItem(AUTH_KEYS.persistentRole);
                    localStorage.removeItem(AUTH_KEYS.persistentScope);
                };
                const hasLocalSession = () => {
                    const sessionUser = String(sessionStorage.getItem(AUTH_KEYS.sessionUser) || '').trim();
                    const sessionFlag = sessionStorage.getItem(AUTH_KEYS.sessionFlag) === 'ok';
                    if (sessionFlag && sessionUser) return true;
                    const persistentFlag = localStorage.getItem(AUTH_KEYS.persistentFlag) === '1';
                    const persistentUser = String(localStorage.getItem(AUTH_KEYS.persistentUser) || '').trim();
                    return persistentFlag && Boolean(persistentUser);
                };

                const xhr = new XMLHttpRequest();
                xhr.open('GET', '/api/auth-session', false);
                xhr.setRequestHeader('Accept', 'application/json');
                xhr.send(null);
                if (xhr.status !== 200) {
                    const unauthorized = xhr.status === 401 || xhr.status === 403;
                    if (unauthorized || !hasLocalSession()) {
                        clearAuthState();
                        window.location.replace('login.html');
                    }
                    return;
                }

                const payload = JSON.parse(xhr.responseText || '{}');
                if (!payload?.ok || !payload?.user) {
                    if (!hasLocalSession()) {
                        clearAuthState();
                        window.location.replace('login.html');
                    }
                    return;
                }

                const user = payload.user;
                const username = String(user.username || '').trim();
                const role = normalizeRole(user.role) || 'user';
                const scope = normalizeScope(user.scope) || 'spa';
                const savedEstablishment = normalizeEstablishment(localStorage.getItem(AUTH_KEYS.persistentEstablishment)) || 'spa';
                const establishment = scope === 'all'
                    ? 'spa'
                    : (EST_KEYS.includes(scope) ? scope : savedEstablishment);

                sessionStorage.setItem(AUTH_KEYS.sessionFlag, 'ok');
                sessionStorage.setItem(AUTH_KEYS.sessionUser, username);
                sessionStorage.setItem(AUTH_KEYS.sessionEstablishment, establishment);
                sessionStorage.setItem(AUTH_KEYS.sessionRole, role);
                sessionStorage.setItem(AUTH_KEYS.sessionScope, scope);

                if (localStorage.getItem(AUTH_KEYS.persistentFlag) === '1') {
                    localStorage.setItem(AUTH_KEYS.persistentUser, username);
                    localStorage.setItem(AUTH_KEYS.persistentEstablishment, establishment);
                    localStorage.setItem(AUTH_KEYS.persistentRole, role);
                    localStorage.setItem(AUTH_KEYS.persistentScope, scope);
                }
            } catch {
                const sessionUser = String(sessionStorage.getItem('cava_login_user') || '').trim();
                const sessionFlag = sessionStorage.getItem('cava_login_demo') === 'ok';
                const persistentFlag = localStorage.getItem('cava_login_persistent_access') === '1';
                const persistentUser = String(localStorage.getItem('cava_login_persistent_user') || '').trim();
                if ((sessionFlag && sessionUser) || (persistentFlag && persistentUser)) {
                    return;
                }
                sessionStorage.removeItem('cava_login_demo');
                sessionStorage.removeItem('cava_login_user');
                sessionStorage.removeItem('cava_login_establishment');
                sessionStorage.removeItem('cava_login_role');
                sessionStorage.removeItem('cava_login_scope');
                localStorage.removeItem('cava_login_persistent_access');
                localStorage.removeItem('cava_login_persistent_user');
                localStorage.removeItem('cava_login_persistent_establishment');
                localStorage.removeItem('cava_login_persistent_role');
                localStorage.removeItem('cava_login_persistent_scope');
                window.location.replace('login.html');
            }
        })();
    </script>

    <canvas id="particleCanvas"></canvas>

    <div class="app-signature" aria-hidden="true">stockcava@2026</div>
    <div class="session-user-card" id="sessionUserCard">--</div>
    <div class="sync-toast" id="syncToast">Cava Atualizada</div>
    <div class="top-left-actions">
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <div class="top-actions">
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle Theme">
            <canvas id="toggleCanvas"></canvas>
        </button>

        <div class="lang-container">
            <button class="lang-btn" id="currentLangBtn">ES</button>
            <div class="lang-dropdown">
                <div class="lang-option" onclick="setLanguage('es')"><span>🇪🇸</span> Español</div>
                <div class="lang-option" onclick="setLanguage('en')"><span>🇬🇧</span> English</div>
                <div class="lang-option" onclick="setLanguage('pt')"><span>🇧🇷</span> Português</div>
            </div>
        </div>

        <button class="admin-btn" id="adminBtn" data-translate="admin">Admin</button>
    </div>

    <header>
        <div class="title-cava">
            <span class="stock-text">STOCK</span>
            <span class="cava-text">Cava</span>
        </div>
        <div class="title-metropolis">METROPOLIS</div>
    </header>

    <div class="search-container">
        <div class="ref-count"><span id="totalRef">0</span> <span data-translate="refs">referencias disponibles</span></div>
        <div class="ref-count ref-count-located"><span id="locatedRef">0</span> <span data-translate="refsLocated">referencias localizadas</span></div>

        <div class="search-input-wrapper">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="searchInput" placeholder="" autocomplete="off">
        </div>

        <!-- Filter Pills + Sort Toggle -->
        <div class="filter-bar">
            <div class="filter-restaurant-row">
                <button class="filter-pill active" data-filter="bodega">BODEGA</button>
                <button class="filter-pill" data-filter="spa">SPA</button>
                <button class="filter-pill" data-filter="tasca_fina">TASCA</button>
                <button class="filter-pill" data-filter="victoria">VICTORIA</button>
                <button class="filter-pill" data-filter="galeria">GALERIA</button>
            </div>
            <div class="filter-sort-row">
                <button class="sort-toggle" id="sortToggle">ABC</button>
            </div>
        </div>

        <div id="searchResults"></div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="wineModal">
        <div class="modal-card">
            <button class="btn-close" id="btnClose">✕</button>

            <span class="badge" id="modalBadge">TINTO</span>
            <h2 class="modal-title" id="modalName">—</h2>
            <div class="modal-subtitle" id="modalSubtitle">—</div>

            <div class="modal-grapes" id="modalGrapes"></div>

            <div class="details-grid">
                <div class="detail-box">
                    <div class="detail-label">D.O. / <span data-translate="region">Región</span></div>
                    <div class="detail-value" id="modalRegion">—</div>
                </div>
                <div class="detail-box">
                    <div class="detail-label" data-translate="country">País</div>
                    <div class="detail-value" id="modalCountry">—</div>
                </div>
                <div class="detail-box">
                    <div class="detail-label" data-translate="year">Año</div>
                    <div class="detail-value" id="modalYear">—</div>
                </div>
                <div class="detail-box">
                    <div class="detail-label" data-translate="format">Formato</div>
                    <div class="detail-value" id="modalFormat" style="font-size:0.8rem;">—</div>
                </div>
            </div>

            <!-- Terroir: Clima & Suelo -->
            <div class="terroir-label">☁ <span data-translate="terroir">Terroir</span></div>
            <div class="terroir-grid">
                <div class="terroir-box">
                    <div class="detail-label">☁ <span data-translate="climate">Clima</span></div>
                    <div class="detail-value" id="modalClima">—</div>
                </div>
                <div class="terroir-box">
                    <div class="detail-label">⛰ <span data-translate="soil">Suelo</span></div>
                    <div class="detail-value" id="modalSuelo">—</div>
                </div>
            </div>

            <div class="cata-block">
                <div class="cata-label">🍷 <span data-translate="tastingSummary">Cata resumida</span></div>
                <div class="cata-box">
                    <div class="cata-value" id="modalCata">—</div>
                    <div class="cata-mini-label" data-translate="quickGuide">Guía rápida</div>
                    <div class="cata-guide-grid" id="modalQuickGuide"></div>
                    <div class="cata-mini-label" data-translate="keyPoints">Puntos clave</div>
                    <div class="cata-points" id="modalCataPoints"></div>
                    <div class="cata-critics" id="modalCritics"></div>
                    <div class="cata-mini-label" data-translate="criticsCard">Card críticos</div>
                    <div class="critics-expanded" id="modalCriticsExpanded"></div>
                </div>
            </div>

            <!-- Establishment Pricing Table -->
            <table class="est-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>BODEGA -2</th>
                        <th>SPA</th>
                        <th>TASCA FINA</th>
                        <th>VICTORIA</th>
                        <th>GALERIA</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label" data-translate="pvpLabel">PVP</td>
                        <td class="pvp-cell" id="estBodegaPvp">—</td>
                        <td class="pvp-cell" id="estSpaPvp">—</td>
                        <td class="pvp-cell" id="estTascaPvp">—</td>
                        <td class="pvp-cell" id="estVictoriaPvp">—</td>
                        <td class="pvp-cell" id="estGaleriaPvp">—</td>
                    </tr>
                    <tr>
                        <td class="row-label" data-translate="stockLabel">Stock</td>
                        <td id="estBodegaStock">—</td>
                        <td id="estSpaStock">—</td>
                        <td id="estTascaStock">—</td>
                        <td id="estVictoriaStock">—</td>
                        <td id="estGaleriaStock">—</td>
                    </tr>
                    <tr>
                        <td class="row-label loc-cell" data-translate="locationShort">Ubic.</td>
                        <td class="loc-cell" id="estBodegaLoc">—</td>
                        <td class="loc-cell" id="estSpaLoc">—</td>
                        <td class="loc-cell" id="estTascaLoc">—</td>
                        <td class="loc-cell" id="estVictoriaLoc">—</td>
                        <td class="loc-cell" id="estGaleriaLoc">—</td>
                    </tr>
                </tbody>
            </table>
            <div class="est-mobile-grid" id="estMobileGrid"></div>

            <div class="modal-actions">
                <div class="consume-actions">
                    <select class="consume-qty" id="consumeQty" aria-label="Cantidad">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                    <button class="btn-consume btn-consume-cava" id="btnConsumeCava" aria-label="Registrar salida de cava">Cava</button>
                    <button class="btn-consume btn-consume-bodega" id="btnConsumeBodega" aria-label="Registrar salida de BODEGA -2">BODEGA -2</button>
                </div>

                <button class="btn-edit" id="btnEditWine" data-translate="editBtn">Editar</button>
            </div>

            <div class="consume-feedback" id="consumeFeedback"></div>

            <!-- Edit form -->
            <div class="edit-form" id="editForm">
                <div style="display:flex;flex-direction:column;gap:0.4rem;">
                    <div class="edit-section-title">SPA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editSpaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editSpaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editSpaLoc" type="text" placeholder="0·0·POS" style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-section-title">TASCA FINA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editTascaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editTascaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editTascaLoc" type="text" placeholder="0·0·POS" style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-section-title">VICTORIA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editVictoriaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editVictoriaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editVictoriaLoc" type="text" placeholder="A-2-IZQ-L2" style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-section-title">GALERIA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editGaleriaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editGaleriaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editGaleriaLoc" type="text" placeholder="0·0·POS" style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-actions">
                        <button class="btn-cancel" id="btnCancelEdit" data-translate="cancelBtn">Cancelar</button>
                        <button class="btn-save" id="btnSaveEdit" data-translate="saveBtn">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ==========================================================
           CAVA METROPOLIS — Multi-Establishment Wine Management
           ========================================================== */

        const AUTH_KEYS = {
            sessionFlag: 'cava_login_demo',
            sessionUser: 'cava_login_user',
            sessionEstablishment: 'cava_login_establishment',
            sessionRole: 'cava_login_role',
            sessionScope: 'cava_login_scope',
            persistentFlag: 'cava_login_persistent_access',
            persistentUser: 'cava_login_persistent_user',
            persistentEstablishment: 'cava_login_persistent_establishment',
            persistentRole: 'cava_login_persistent_role',
            persistentScope: 'cava_login_persistent_scope'
        };

        // --- CONSTANTS ---
        const EST_KEYS = ['bodega', 'spa', 'tasca_fina', 'victoria', 'galeria'];
        const EDITABLE_EST_KEYS = ['spa', 'tasca_fina', 'victoria', 'galeria'];
        const EDIT_PREFIX_MAP = { spa: 'Spa', tasca_fina: 'Tasca', victoria: 'Victoria', galeria: 'Galeria' };
        const EST_LABELS = { bodega: 'BODEGA -2', spa: 'SPA', tasca_fina: 'TASCA FINA', victoria: 'VICTORIA', galeria: 'GALERIA' };
        const EST_MOBILE_LABELS = { bodega: 'BODEGA -2', spa: 'SPA', tasca_fina: 'TASCA', victoria: 'VICTORIA', galeria: 'GALERIA' };

        const TIPO_MAP = {
            'TO':  { cls: 'b-tinto',    es: 'TINTO',    en: 'RED',       pt: 'TINTO' },
            'BL':  { cls: 'b-branco',   es: 'BLANCO',   en: 'WHITE',     pt: 'BRANCO' },
            'ROS': { cls: 'b-rosado',   es: 'ROSADO',   en: 'ROSÉ',      pt: 'ROSADO' },
            'ESP': { cls: 'b-espumoso', es: 'ESPUMOSO', en: 'SPARKLING', pt: 'ESPUMOSO' },
            'GEN': { cls: 'b-generoso', es: 'GENEROSO', en: 'FORTIFIED', pt: 'GENEROSO' },
            'DU':  { cls: 'b-dulce',    es: 'DULCE',    en: 'SWEET',     pt: 'DOCE' }
        };

        const GRAPE_FAMILIES = {
            'Tempranillo': 'iberica-tinta', 'Garnacha': 'iberica-tinta s2', 'Monastrell': 'iberica-tinta s3',
            'Bobal': 'iberica-tinta', 'Mencía': 'iberica-tinta s2', 'Cariñena': 'iberica-tinta s3',
            'Graciano': 'iberica-tinta', 'Carignan': 'iberica-tinta s2', 'Prieto Picudo': 'iberica-tinta s3',
            'Tinta de Toro': 'iberica-tinta', 'Garnacha Tintorera': 'iberica-tinta s2',
            'Pinot Noir': 'burgundy', 'Pinot Meunier': 'burgundy s2', 'Chardonnay': 'burgundy s3',
            'Sauvignon Blanc': 'burgundy', 'Aligoté': 'burgundy s2', 'Gamay': 'burgundy s3',
            'Sangiovese': 'italiana', 'Nebbiolo': 'italiana s2', 'Barbera': 'italiana s3',
            'Dolcetto': 'italiana', 'Montepulciano': 'italiana s2', 'Aglianico': 'italiana s3',
            "Nero d'Avola": 'italiana', 'Corvina': 'italiana s2', 'Primitivo': 'italiana s3',
            'Riesling': 'aromatico', 'Albariño': 'aromatico s2', 'Verdejo': 'aromatico s3',
            'Moscato': 'aromatico', 'Gewürztraminer': 'aromatico s2', 'Viognier': 'aromatico s3',
            'Vermentino': 'aromatico', 'Godello': 'aromatico s2', 'Fiano': 'aromatico s3',
            'Greco': 'aromatico', 'Falanghina': 'aromatico s2', 'Malvasia': 'aromatico s3',
            'Furmint': 'aromatico', 'Savagnin': 'aromatico s2', 'Timorasso': 'aromatico s3',
            'Verdicchio': 'aromatico', 'Chenin Blanc': 'aromatico s2', 'Grüner Veltliner': 'aromatico s3',
            'Garnacha Blanca': 'aromatico', 'Viura': 'aromatico s2', 'Macabeo': 'aromatico s3',
            'Carmenère': 'novamundo', 'Malbec': 'novamundo s2', 'Cabernet Sauvignon': 'novamundo s3',
            'Cabernet Franc': 'novamundo', 'Syrah': 'novamundo s2', 'Shiraz': 'novamundo s3',
            'Petit Verdot': 'novamundo', 'Zinfandel': 'novamundo s2', 'Tannat': 'novamundo s3',
            'Negroamaro': 'novamundo', 'Pinotage': 'novamundo s2', 'Merlot': 'novamundo s3',
            'Touriga Nacional': 'novamundo', 'Tinta Roriz': 'novamundo s2',
            'Prosecco': 'espumoso', 'Lambrusco': 'espumoso s2', 'Cava': 'espumoso s3',
            'Champagne': 'espumoso', 'Xarel.lo': 'espumoso s2', 'Parellada': 'espumoso s3',
            'Glera': 'espumoso',
        };

        // --- STATE ---
        let refs = [];            // Full dataset from JSON
        let baseRefs = [];        // Immutable snapshot from JSON
        let searchIndex = [];     // Pre-computed search strings
        let pvpMedio = {};        // Average PVP per pod
        let subsets = {};         // Indices per establishment
        let currentFilter = 'bodega';
        let currentSort = 'abc';
        let currentEditPod = null;
        let currentLang = 'es';
        let syncTimer = null;
        let syncInFlight = false;
        let syncDisabled = false;
        const EDITS_KEY = 'cava_edits';
        const MOVEMENTS_KEY = 'cava_daily_movements_v1';
        const SYNC_PENDING_KEY = 'cava_sync_pending_v1';
        const SYNC_REVISION_KEY = 'cava_sync_revision_v1';
        const SYNC_CLIENT_KEY = 'cava_sync_client_id_v1';
        const SYNC_INTERVAL_MS = 30000;
        const SYNC_ENDPOINT = '/api/stock-sync';
        let syncClientId = sessionStorage.getItem(SYNC_CLIENT_KEY);
        if (!syncClientId) {
            syncClientId = `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 10)}`;
            sessionStorage.setItem(SYNC_CLIENT_KEY, syncClientId);
        }
        const currentUserName = sessionStorage.getItem(AUTH_KEYS.sessionUser) || localStorage.getItem(AUTH_KEYS.persistentUser) || '';
        const sessionUserCard = document.getElementById('sessionUserCard');
        const normalizeEstablishment = (value) => {
            const normalized = (value || '').trim().toLowerCase();
            return EST_KEYS.includes(normalized) ? normalized : null;
        };
        const normalizeScope = (value) => {
            const normalized = (value || '').trim().toLowerCase();
            return EST_KEYS.includes(normalized) || normalized === 'all' ? normalized : null;
        };
        const normalizeRole = (value) => {
            const normalized = (value || '').trim().toLowerCase();
            return ['user', 'admin', 'adminmaster'].includes(normalized) ? normalized : null;
        };
        const storedRole = normalizeRole(sessionStorage.getItem(AUTH_KEYS.sessionRole))
            || normalizeRole(localStorage.getItem(AUTH_KEYS.persistentRole));
        const storedScope = normalizeScope(sessionStorage.getItem(AUTH_KEYS.sessionScope))
            || normalizeScope(localStorage.getItem(AUTH_KEYS.persistentScope));
        const baseEstablishment = normalizeEstablishment(sessionStorage.getItem(AUTH_KEYS.sessionEstablishment))
            || normalizeEstablishment(localStorage.getItem(AUTH_KEYS.persistentEstablishment))
            || 'spa';
        const currentUserRole = storedRole || 'user';
        const currentUserScope = storedScope || baseEstablishment;
        const currentUserEstablishment = currentUserScope === 'all'
            ? (baseEstablishment || 'spa')
            : (EST_KEYS.includes(currentUserScope) ? currentUserScope : (baseEstablishment || 'spa'));

        if (sessionUserCard) {
            const cardUser = (currentUserName || '').trim() || 'No logado';
            sessionUserCard.textContent = cardUser;
        }

        function hasAdminAccess() {
            return currentUserRole === 'admin' || currentUserRole === 'adminmaster';
        }

        function getEditableEstablishmentKeys() {
            if (currentUserRole === 'adminmaster' || currentUserScope === 'all') {
                return [...EDITABLE_EST_KEYS];
            }
            if (EDITABLE_EST_KEYS.includes(currentUserScope)) {
                return [currentUserScope];
            }
            if (EDITABLE_EST_KEYS.includes(currentUserEstablishment)) {
                return [currentUserEstablishment];
            }
            return [];
        }

        function hasEditAccess() {
            return getEditableEstablishmentKeys().length > 0;
        }

        function canOpenReportPage() {
            return ['user', 'admin', 'adminmaster'].includes(currentUserRole);
        }

        function getEstablishmentFromPath(path) {
            const match = String(path || '').match(/^establecimientos\.(bodega|spa|tasca_fina|victoria|galeria)\./);
            return match ? match[1] : null;
        }

        function normalizeLocationPosToken(rawToken) {
            const token = String(rawToken || '').toUpperCase().replace(/[^A-Z]/g, '');
            if (!token) return null;
            if ('IZQ'.startsWith(token)) return token.length >= 3 ? 'IZQ' : token;
            if ('DER'.startsWith(token)) return token.length >= 3 ? 'DER' : token;
            if ('CEN'.startsWith(token) || token.startsWith('CENT')) return token.length >= 3 ? 'CEN' : token.slice(0, 3);
            if ('EXP'.startsWith(token)) return token.length >= 3 ? 'EXP' : token;
            if ('JAM'.startsWith(token) || token.startsWith('JAMON')) return token.length >= 3 ? 'JAM' : token.slice(0, 3);
            return token.slice(0, 3);
        }

        function normalizeVictoriaDoorToken(rawToken) {
            const token = String(rawToken || '').toUpperCase().replace(/[^A-Z]/g, '');
            if (!token) return null;
            if (token.startsWith('IZQ') || token.startsWith('IZQUI')) return 'IZQ';
            if (token.startsWith('DER') || token.startsWith('DERE')) return 'DER';
            if (token.startsWith('CEN') || token.startsWith('CENT')) return 'CEN';
            return null;
        }

        function normalizeVictoriaLineToken(rawToken) {
            const token = String(rawToken || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (!token) return null;
            const ordMap = { PRIMERA: 1, SEGUNDA: 2, TERCERA: 3, CUARTA: 4, QUINTA: 5 };
            if (ordMap[token]) return `L${ordMap[token]}`;
            const lineMatch = token.match(/^L(?:INEA)?(\d{1,2})$/);
            if (lineMatch) return `L${lineMatch[1]}`;
            if (/^\d{1,2}$/.test(token)) return `L${token}`;
            return null;
        }

        function normalizeVictoriaLocationValue(normalized) {
            const text = String(normalized || '').toUpperCase();
            if (!text) return null;
            const compactText = text
                .replace(/[•·]/g, ' ')
                .replace(/[-_]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();

            const compact = compactText.match(/^([A-Z0-9]{1,3})\s+(\d{1,2})(?:\s+([A-Z]{2,4}))?(?:\s+(L?\d{1,2}|PRIMERA|SEGUNDA|TERCERA|CUARTA|QUINTA))?$/);
            if (compact) {
                const door = normalizeVictoriaDoorToken(compact[3]);
                const line = normalizeVictoriaLineToken(compact[4]);
                return `${compact[1]}·${compact[2]}${door ? `·${door}` : ''}${line ? `·${line}` : ''}`;
            }

            const cavaMatch = text.match(/\bCAVA\s*([A-Z0-9]{1,3})\b/);
            const baldaMatch = text.match(/\bBALDA\s*(\d{1,2})\b/);
            const doorMatch = normalizeVictoriaDoorToken(text);
            const lineMatchWord = text.match(/\b(PRIMERA|SEGUNDA|TERCERA|CUARTA|QUINTA)\s+LINEA\b/);
            const lineMatchNumber = text.match(/\bLINEA\s*(\d{1,2})\b/);

            const cava = cavaMatch?.[1] || null;
            const balda = baldaMatch?.[1] || null;
            const line = lineMatchWord
                ? normalizeVictoriaLineToken(lineMatchWord[1])
                : (lineMatchNumber ? normalizeVictoriaLineToken(lineMatchNumber[1]) : null);

            if (cava && balda) {
                return `${cava}·${balda}${doorMatch ? `·${doorMatch}` : ''}${line ? `·${line}` : ''}`;
            }

            return null;
        }

        function formatVictoriaLocationCompact(value) {
            const parts = String(value || '').split('·').map((p) => p.trim()).filter(Boolean);
            if (!parts.length) return null;
            return parts.join('-');
        }

        function normalizeLocationValue(value, establishment = null) {
            const raw = value == null ? '' : String(value);
            if (raw.includes('/')) {
                const parts = raw
                    .split('/')
                    .map((segment) => normalizeLocationValue(segment, establishment))
                    .filter(Boolean);
                return parts.length ? parts.join(' / ') : null;
            }
            const normalized = raw
                .toUpperCase()
                .replace(/[•·]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            if (!normalized) return null;

            if (establishment === 'victoria') {
                const victoriaNormalized = normalizeVictoriaLocationValue(normalized);
                if (victoriaNormalized) return victoriaNormalized;
            }

            const directCompact = normalized.match(/^(\d{1,2})\s+(\d{1,2})(?:\s+(IZQ|DER|CEN|EXP|JAM))?$/);
            if (directCompact) {
                const pos = directCompact[3] ? `·${directCompact[3]}` : '';
                return `${directCompact[1]}·${directCompact[2]}${pos}`;
            }

            const spaCompact = normalized.match(/^(\d{1,2})([A-Z])([A-Z])$/);
            if (spaCompact) {
                return `${spaCompact[1]}·${spaCompact[2]}·${spaCompact[3]}`;
            }

            const spaTwoToken = normalized.match(/^(\d{1,2})\s+([A-Z]{2})$/);
            if (spaTwoToken) {
                return `${spaTwoToken[1]}·${spaTwoToken[2][0]}·${spaTwoToken[2][1]}`;
            }

            const compactTokens = normalized.match(/^([A-Z0-9]{1,2})\s+([A-Z0-9]{1,2})(?:\s+([A-Z]{1,10}))?$/);
            if (compactTokens) {
                const posToken = normalizeLocationPosToken(compactTokens[3] || '');
                return `${compactTokens[1]}·${compactTokens[2]}${posToken ? `·${posToken}` : ''}`;
            }

            const cavaMatch = normalized.match(/\bCAVA\s*[-:]?\s*(\d{1,2})\b/);
            const baldaMatch = normalized.match(/\bBALDA\s*[-:]?\s*(\d{1,2})\b/);

            let pos = null;
            if (/\bIZQ\b/.test(normalized)) pos = 'IZQ';
            else if (/\bDER\b/.test(normalized)) pos = 'DER';
            else if (/\bCEN\b/.test(normalized)) pos = 'CEN';
            else if (/\bEXP\b/.test(normalized)) pos = 'EXP';
            else if (/\bJAMONES\b|\bJAMON\b|\bJAM\b/.test(normalized)) pos = 'JAM';

            const cavaNum = cavaMatch?.[1] || null;
            const baldaNum = baldaMatch?.[1] || null;
            if (cavaNum && baldaNum) {
                if (!pos) {
                    const afterBalda = normalized.replace(/^.*\bBALDA\s*[-:]?\s*\d{1,2}\b/, '').trim();
                    if (afterBalda) {
                        const rawPosToken = afterBalda.split(' ')[0].replace(/[^A-Z0-9]/g, '');
                        pos = normalizeLocationPosToken(rawPosToken) || rawPosToken.slice(0, 3) || null;
                    }
                }
                return `${cavaNum}·${baldaNum}${pos ? `·${pos}` : ''}`;
            }

            return normalized;
        }

        function formatLocationForUi(establishment, value) {
            const normalized = normalizeLocationValue(value, establishment);
            if (!normalized) return { compact: null, detail: null, text: null };
            if (establishment !== 'victoria') return { compact: normalized, detail: null, text: normalized };
            const locations = String(normalized)
                .split('/')
                .map((segment) => segment.trim())
                .filter(Boolean);
            const formatted = locations
                .map((segment) => formatVictoriaLocationCompact(segment))
                .filter(Boolean);
            if (!formatted.length) return { compact: normalized, detail: null, text: normalized };
            return {
                compact: formatted[0],
                detail: null,
                text: formatted.join(' / ')
            };
        }

        function formatLocationInputValue(rawValue, options = {}) {
            const preserveTrailingSeparator = options && options.preserveTrailingSeparator === true;
            const establishment = options && options.establishment ? options.establishment : null;
            const raw = rawValue == null ? '' : String(rawValue);
            const hasTrailingSeparator = /[·•\s]$/.test(raw);
            const verboseNormalized = normalizeLocationValue(raw, establishment);
            if (/^[A-Z0-9]{1,2}·[A-Z0-9]{1,2}(?:·[A-Z]{1,3})?(?:·L\d{1,2})?$/.test(verboseNormalized || '')) {
                if (preserveTrailingSeparator && hasTrailingSeparator) {
                    const parts = String(verboseNormalized).split('·');
                    if (parts.length === 1) return `${parts[0]}·`;
                    if (parts.length === 2) return `${parts[0]}·${parts[1]}·`;
                    if (parts.length === 3 && establishment === 'victoria') return `${parts[0]}·${parts[1]}·${parts[2]}·`;
                }
                return verboseNormalized;
            }

            const normalized = raw
                .toUpperCase()
                .replace(/[•·.,;:/\\_-]/g, ' ')
                .replace(/[^A-Z0-9\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            if (!normalized) return '';

            let tokens = normalized.split(' ');
            if (establishment === 'victoria') {
                if (tokens[0] === 'CAVA' && tokens[1]) tokens = tokens.slice(1);
                if (tokens[1] === 'BALDA' && tokens[2]) tokens.splice(1, 1);
                if (tokens.length === 1) {
                    const compactVictoria = tokens[0].match(/^([A-Z0-9]{1})(\d{1,2})(IZQ|DER|CEN)?(L\d{1,2})?$/);
                    if (compactVictoria) {
                        tokens = [compactVictoria[1], compactVictoria[2]];
                        if (compactVictoria[3]) tokens.push(compactVictoria[3]);
                        if (compactVictoria[4]) tokens.push(compactVictoria[4]);
                    }
                }
            }
            if (tokens.length === 1 && /^\d{2}$/.test(tokens[0])) {
                tokens = [tokens[0][0], tokens[0][1]];
            }

            const part1 = (tokens[0] || '').replace(/[^A-Z0-9]/g, '').slice(0, establishment === 'victoria' ? 1 : 2);
            const part2 = (tokens[1] || '').replace(/[^A-Z0-9]/g, '').slice(0, 2);
            const part3Raw = tokens.length > 2 ? tokens[2] : '';
            const part4Raw = tokens.length > 3 ? tokens[3] : '';

            const part3 = establishment === 'victoria'
                ? (normalizeVictoriaDoorToken(part3Raw) || String(part3Raw || '').replace(/[^A-Z]/g, '').slice(0, 3) || null)
                : normalizeLocationPosToken(tokens.length > 2 ? tokens.slice(2).join('') : '');
            const part4 = establishment === 'victoria'
                ? normalizeVictoriaLineToken(part4Raw)
                : null;

            if (!part1) return '';
            if (!part2) return preserveTrailingSeparator && hasTrailingSeparator ? `${part1}·` : part1;
            if (!part3) return `${part1}·${part2}${preserveTrailingSeparator && hasTrailingSeparator ? '·' : ''}`;
            if (!part4) {
                if (establishment === 'victoria') {
                    return `${part1}·${part2}·${part3}${preserveTrailingSeparator && hasTrailingSeparator ? '·' : ''}`;
                }
                return `${part1}·${part2}·${part3}`;
            }
            return `${part1}·${part2}·${part3}·${part4}`;
        }

        function setupLocationInputsMask() {
            const fieldMap = {
                editSpaLoc: 'spa',
                editTascaLoc: 'tasca_fina',
                editVictoriaLoc: 'victoria',
                editGaleriaLoc: 'galeria'
            };
            Object.entries(fieldMap).forEach(([id, establishment]) => {
                const input = document.getElementById(id);
                if (!input || input.dataset.locationMaskBound === '1') return;
                input.dataset.locationMaskBound = '1';
                input.setAttribute('maxlength', establishment === 'victoria' ? '16' : '10');
                input.setAttribute('autocapitalize', 'characters');
                input.setAttribute('spellcheck', 'false');

                input.addEventListener('keydown', (event) => {
                    if (event.key !== ' ') return;
                    event.preventDefault();
                    const withVirtualSpace = `${input.value || ''} `;
                    const formatted = formatLocationInputValue(withVirtualSpace, { preserveTrailingSeparator: true, establishment });
                    input.value = formatted;
                    const caret = input.value.length;
                    input.setSelectionRange(caret, caret);
                });

                input.addEventListener('beforeinput', (event) => {
                    if (event.inputType !== 'insertText') return;
                    if (event.data !== ' ' && event.data !== '\u00A0') return;
                    event.preventDefault();
                    const withVirtualSpace = `${input.value || ''} `;
                    const formatted = formatLocationInputValue(withVirtualSpace, { preserveTrailingSeparator: true, establishment });
                    input.value = formatted;
                    const caret = input.value.length;
                    input.setSelectionRange(caret, caret);
                });

                input.addEventListener('input', () => {
                    const formatted = formatLocationInputValue(input.value, { preserveTrailingSeparator: true, establishment });
                    if (input.value !== formatted) input.value = formatted;
                });

                input.addEventListener('blur', () => {
                    const normalized = normalizeLocationValue(input.value, establishment) || '';
                    if (establishment === 'victoria' && normalized) {
                        input.value = formatLocationForUi('victoria', normalized).text || '';
                    } else {
                        input.value = normalized;
                    }
                });
            });
        }

        function clearAuthState() {
            sessionStorage.removeItem(AUTH_KEYS.sessionFlag);
            sessionStorage.removeItem(AUTH_KEYS.sessionUser);
            sessionStorage.removeItem(AUTH_KEYS.sessionEstablishment);
            sessionStorage.removeItem(AUTH_KEYS.sessionRole);
            sessionStorage.removeItem(AUTH_KEYS.sessionScope);
            localStorage.removeItem(AUTH_KEYS.persistentFlag);
            localStorage.removeItem(AUTH_KEYS.persistentUser);
            localStorage.removeItem(AUTH_KEYS.persistentEstablishment);
            localStorage.removeItem(AUTH_KEYS.persistentRole);
            localStorage.removeItem(AUTH_KEYS.persistentScope);
        }

        setupLocationInputsMask();

        // Typewriter state
        let typeWriterTimeout, charIndex = 0, isDeleting = false, currentPhrase = '', phraseQueue = [];

        // --- TRANSLATIONS ---
        const translations = {
            es: {
                placeholders: [
                    "¿Hoy tinto o blanco?",
                    "¿Algo para maridar?",
                    "Busca por uva o región",
                    "¿Rioja o Ribera?",
                    "¿Una copa más?",
                    "Burbuja para celebrar",
                    "¿Fruta, madera o mineral?",
                    "¿Ligero o con cuerpo?",
                    "¿Qué abrimos hoy?",
                    "Sugerencia del sumiller",
                    "Tu vino ideal está aquí",
                    "Prueba algo nuevo"
                ],
                refs: "referencias disponibles", refsLocated: "referencias localizadas", region: "Región", country: "País",
                year: "Año", format: "Formato", climate: "Clima", soil: "Suelo", terroir: "Terroir", tastingSummary: "Cata resumida", quickGuide: "Guía rápida", keyPoints: "Puntos clave", criticsCard: "Card críticos", admin: "Admin", report: "Ventas",
                pvpLabel: "PVP", stockLabel: "Stock", locationShort: "Ubic.", editBtn: "Editar", cancelBtn: "Cancelar", saveBtn: "Salvar",
                consumeNeedFilter: "Selecciona SPA/TASCA/VICTORIA para registrar salida.", consumeDone: "Salida registrada.", consumeNoStock: "Sin stock numérico para descontar, pero salida anotada.", consumeToastUpdated: "Cava actualizada", btnLabel: "🇪🇸 ES"
            },
            en: {
                placeholders: [
                    "Red or white today?",
                    "Need a food pairing?",
                    "Search grape or region",
                    "Rioja or Ribera?",
                    "One more glass?",
                    "Bubbles for today",
                    "Fruit, oak or mineral?",
                    "Light or full-bodied?",
                    "What shall we open?",
                    "Sommelier picks",
                    "Your next wine is here",
                    "Try something new"
                ],
                refs: "references available", refsLocated: "located references", region: "Region", country: "Country",
                year: "Year", format: "Format", climate: "Climate", soil: "Soil", terroir: "Terroir", tastingSummary: "Tasting Summary", quickGuide: "Quick guide", keyPoints: "Key points", criticsCard: "Critics card", admin: "Admin", report: "Sales",
                pvpLabel: "PVP", stockLabel: "Stock", locationShort: "Loc.", editBtn: "Edit", cancelBtn: "Cancel", saveBtn: "Save",
                consumeNeedFilter: "Select SPA/TASCA/VICTORIA to register output.", consumeDone: "Output registered.", consumeNoStock: "No numeric stock to decrement, but output was logged.", consumeToastUpdated: "Cellar updated", btnLabel: "🇬🇧 EN"
            },
            pt: {
                placeholders: [
                    "Tinto ou branco hoje?",
                    "Quer algo para harmonizar?",
                    "Busque uva ou região",
                    "Rioja ou Ribera?",
                    "Mais uma taça?",
                    "Bolhas para celebrar",
                    "Fruta, madeira ou mineral?",
                    "Leve ou encorpado?",
                    "O que abrimos hoje?",
                    "Dica do sommelier",
                    "Seu próximo vinho está aqui",
                    "Prove algo novo"
                ],
                refs: "referências disponíveis", refsLocated: "referências localizadas", region: "Região", country: "País",
                year: "Ano", format: "Formato", climate: "Clima", soil: "Solo", terroir: "Terroir", tastingSummary: "Cata resumida", quickGuide: "Guia rápido", keyPoints: "Pontos-chave", criticsCard: "Card críticos", admin: "Admin", report: "Vendas",
                pvpLabel: "PVP", stockLabel: "Estoque", locationShort: "Local", editBtn: "Editar", cancelBtn: "Cancelar", saveBtn: "Salvar",
                consumeNeedFilter: "Selecione SPA/TASCA/VICTORIA para registrar retirada.", consumeDone: "Retirada registrada.", consumeNoStock: "Sem estoque numérico para baixar, mas a retirada foi anotada.", consumeToastUpdated: "Cava Atualizada", btnLabel: "🇧🇷 PT"
            }
        };

        // --- UTILITY ---
        function removeAccents(str) {
            return String(str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function fmt(val) {
            return val != null ? val : '—';
        }

        function fmtPrice(val) {
            return val != null ? val + '€' : '—';
        }

        function normalizeToken(value) {
            return removeAccents(String(value || '').trim().toLowerCase());
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function extractTextValue(value) {
            if (typeof value === 'string') return value.trim();
            if (typeof value === 'number') return String(value);
            if (Array.isArray(value)) {
                for (const item of value) {
                    const found = extractTextValue(item);
                    if (found) return found;
                }
                return '';
            }
            if (value && typeof value === 'object') {
                const preferredKeys = ['nome', 'name', 'grape', 'variety', 'uva', 'label', 'value', 'text'];
                for (const key of preferredKeys) {
                    if (Object.prototype.hasOwnProperty.call(value, key)) {
                        const found = extractTextValue(value[key]);
                        if (found) return found;
                    }
                }
                for (const candidate of Object.values(value)) {
                    const found = extractTextValue(candidate);
                    if (found) return found;
                }
            }
            return '';
        }

        function normalizeGrapeItem(raw) {
            const nome = extractTextValue(raw);
            if (!nome || nome === '[object Object]') return null;
            const pctNumber = Number(raw && typeof raw === 'object' ? (raw.pct ?? raw.percent ?? raw.porcentaje) : NaN);
            return {
                nome,
                pct: Number.isFinite(pctNumber) ? pctNumber : null
            };
        }

        function extractGrapeItems(uvasArr) {
            if (!Array.isArray(uvasArr)) return [];
            return uvasArr.map(normalizeGrapeItem).filter(Boolean);
        }

        function getGrapeSearchTokens(uvasArr) {
            return extractGrapeItems(uvasArr).map((item) => item.nome);
        }

        function getTipoSearchTokens(tipo) {
            const code = String(tipo?.codigo || '').trim().toUpperCase();
            const name = String(tipo?.nombre || '').trim();
            const byCode = {
                TO: ['tinto', 'red', 'rouge'],
                BL: ['blanco', 'white', 'branco'],
                ROS: ['rosado', 'rose', 'rosé'],
                ESP: ['espumoso', 'sparkling', 'espumante', 'cava', 'champagne'],
                GEN: ['generoso', 'fortified', 'jerez', 'sherry'],
                DU: ['dulce', 'sweet', 'doce', 'dessert']
            };
            const extra = byCode[code] || [];
            return [code, name, ...extra].filter(Boolean);
        }

        const GRAPE_FAMILY_NORMALIZED = Object.fromEntries(
            Object.entries(GRAPE_FAMILIES).map(([name, family]) => [normalizeToken(name), family])
        );

        function getGrapeColor(name) {
            const direct = GRAPE_FAMILIES[name];
            if (direct) return direct;
            return GRAPE_FAMILY_NORMALIZED[normalizeToken(name)] || 'burgundy s3';
        }

        const GRAPE_PRIMARY_PALETTE = {
            tempranillo: ['#64061f', '#9d1237'],
            garnacha: ['#7a0d2a', '#b41e45'],
            monastrell: ['#4f0818', '#7a1431'],
            bobal: ['#5e0a22', '#902045'],
            mencia: ['#6d1734', '#a52951'],
            pinotnoir: ['#702133', '#ab3d59'],
            syrah: ['#420817', '#6f1530'],
            shiraz: ['#4a0b1b', '#7b1a39'],
            nebbiolo: ['#8c2d2d', '#bf4f48'],
            sangiovese: ['#6e1119', '#a61f2c'],
            barbera: ['#5f1322', '#92304a'],
            riesling: ['#b39d2f', '#ddc85f'],
            albarino: ['#c79d29', '#efd06a'],
            verdejo: ['#5f8f27', '#8ebf46'],
            godello: ['#a89945', '#d2c36f'],
            chardonnay: ['#b2983d', '#dbc26d'],
            sauvignonblanc: ['#6f9b34', '#9fca5b'],
            gewurztraminer: ['#b17f38', '#d9a565'],
            viognier: ['#bf9a3f', '#e5bf70'],
            glera: ['#d8b85b', '#f0d787'],
            'xarel.lo': ['#c39e45', '#dfbe73'],
            xarello: ['#c39e45', '#dfbe73'],
            parellada: ['#d2b467', '#ead28f'],
            macabeo: ['#c6a44a', '#e2c676'],
            champagne: ['#dac27a', '#efddb0'],
            prosecco: ['#e0c16f', '#f2db9f']
        };

        const WINE_TYPE_PALETTE = {
            TO: ['#6a1329', '#932542'],
            BL: ['#bda660', '#d9c37f'],
            ROS: ['#b64d67', '#d77793'],
            ESP: ['#d5b66a', '#ecd69a'],
            GEN: ['#a76e34', '#c78c48'],
            DU: ['#6f375f', '#965083']
        };

        function pickGrapePalette(name, tipoCode, isPrimary, index) {
            const key = normalizeToken(name).replace(/\s+/g, '').replace(/[^a-z0-9.]/g, '');
            const primary = GRAPE_PRIMARY_PALETTE[key];
            if (primary) return primary;
            const typeBase = WINE_TYPE_PALETTE[String(tipoCode || '').toUpperCase()] || WINE_TYPE_PALETTE.TO;
            if (isPrimary) return typeBase;
            const shift = Math.min(index, 3) * 9;
            return [lightenHex(typeBase[0], shift), lightenHex(typeBase[1], shift + 6)];
        }

        function lightenHex(hex, amount) {
            const value = String(hex || '').replace('#', '');
            if (!/^[0-9a-fA-F]{6}$/.test(value)) return hex;
            const toChannel = (start) => {
                const channel = parseInt(value.slice(start, start + 2), 16);
                return Math.max(0, Math.min(255, channel + amount));
            };
            const r = toChannel(0).toString(16).padStart(2, '0');
            const g = toChannel(2).toString(16).padStart(2, '0');
            const b = toChannel(4).toString(16).padStart(2, '0');
            return `#${r}${g}${b}`;
        }

        function renderGrapeTags(uvasArr, tipoCode = '') {
            const processedUvas = extractGrapeItems(uvasArr);
            if (!processedUvas.length) return '';

            processedUvas.sort((a, b) => {
                const pctA = Number.isFinite(Number(a.pct)) ? Number(a.pct) : -1;
                const pctB = Number.isFinite(Number(b.pct)) ? Number(b.pct) : -1;
                return pctB - pctA;
            });

            return '<div class="grape-tags">' +
                processedUvas.map((g, index) => {
                    const label = g.nome;
                    const [start, end] = pickGrapePalette(g.nome, tipoCode, index === 0, index);
                    const ribColor = lightenHex(start, 30);
                    const shadowColor = lightenHex(end, -35);
                    const style = `background:linear-gradient(135deg, ${start} 0%, ${end} 100%);border:1px solid ${ribColor};box-shadow:0 0 0 1px rgba(255,255,255,0.09) inset,0 2px 9px ${shadowColor};`;
                    return `<span class="grape-tag ${getGrapeColor(g.nome)}" style="${style}">${escapeHtml(label)}</span>`;
                }).join('') +
                '</div>';
        }

        function getTipoBadge(tipo) {
            const code = tipo?.codigo || '';
            const info = TIPO_MAP[code] || TIPO_MAP['TO'];
            return { cls: info.cls, label: info[currentLang] || info.es };
        }

        function initCatalogData(data) {
            if (!Array.isArray(data)) return false;
            baseRefs = data.filter((r) => r.pod && r.descripcion && !r.descripcion.startsWith('#'));
            refs = JSON.parse(JSON.stringify(baseRefs));
            applyLocalEdits();
            preProcess();
            updateRefCount();
            startRealtimeSync();
            console.log(`✓ Loaded ${refs.length} references (filtered ${data.length - baseRefs.length} incomplete)`);
            return true;
        }

        function loadCatalogFromStaticFile() {
            return fetch('/data/bodega_webapp.json', { cache: 'no-store' })
                .then((r) => {
                    if (!r.ok) throw new Error(`catalog_static_failed_${r.status}`);
                    return r.json();
                });
        }

        // --- DATA LOADING ---
        fetch('/api/wines', { cache: 'no-store' })
            .then((r) => {
                if (r.status === 401) {
                    clearAuthState();
                    window.location.replace('login.html');
                    return null;
                }
                if (!r.ok) {
                    if (r.status === 404 || r.status === 405 || r.status === 501 || r.status >= 500) {
                        return loadCatalogFromStaticFile();
                    }
                    throw new Error(`catalog_request_failed_${r.status}`);
                }
                return r.json();
            })
            .then((data) => {
                if (data === null) return;
                if (initCatalogData(data)) return;
                return loadCatalogFromStaticFile().then((fallbackData) => {
                    initCatalogData(fallbackData);
                });
            })
            .catch((err) => {
                console.error('Error loading data:', err);
                loadCatalogFromStaticFile()
                    .then((fallbackData) => {
                        if (!initCatalogData(fallbackData)) {
                            baseRefs = [];
                            refs = [];
                        }
                    })
                    .catch((fallbackErr) => {
                        console.error('Error loading fallback catalog:', fallbackErr);
                        baseRefs = [];
                        refs = [];
                    });
            });

        // --- LOCAL EDIT PERSISTENCE ---
        function parseJsonArray(rawValue) {
            if (!rawValue) return [];
            try {
                const parsed = JSON.parse(rawValue);
                return Array.isArray(parsed) ? parsed : [];
            } catch {
                return [];
            }
        }

        function parseJsonObject(rawValue) {
            if (!rawValue) return {};
            try {
                const parsed = JSON.parse(rawValue);
                if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) return {};
                return parsed;
            } catch {
                return {};
            }
        }

        function createMutationId() {
            return `${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
        }

        function readPendingMutations() {
            return parseJsonArray(localStorage.getItem(SYNC_PENDING_KEY));
        }

        function writePendingMutations(list) {
            localStorage.setItem(SYNC_PENDING_KEY, JSON.stringify(Array.isArray(list) ? list : []));
        }

        function isSupportedEditPath(path) {
            const root = String(path || '').split('.')[0];
            const blockedRoots = new Set(['descripcion', 'region', 'uvas']);
            return root && !blockedRoots.has(root);
        }

        function sanitizeEditsForCurrentUi(editList) {
            if (!Array.isArray(editList)) return [];
            return editList.filter((edit) => edit && edit.pod && edit.path && isSupportedEditPath(edit.path));
        }

        function queuePendingMutation(mutation) {
            const queue = readPendingMutations();
            if (mutation.type === 'edit' && mutation.payload?.pod && mutation.payload?.path) {
                const filtered = queue.filter((item) => {
                    if (item.type !== 'edit') return true;
                    if (!item.payload) return true;
                    return !(item.payload.pod === mutation.payload.pod && item.payload.path === mutation.payload.path);
                });
                filtered.push(mutation);
                if (filtered.length > 2000) filtered.splice(0, filtered.length - 2000);
                writePendingMutations(filtered);
                return;
            }
            queue.push(mutation);
            if (queue.length > 2000) queue.splice(0, queue.length - 2000);
            writePendingMutations(queue);
        }

        function readStoredEdits() {
            const rawEdits = parseJsonArray(localStorage.getItem(EDITS_KEY))
                .filter((edit) => edit && edit.pod && edit.path);
            const sanitized = sanitizeEditsForCurrentUi(rawEdits);
            if (sanitized.length !== rawEdits.length) {
                localStorage.setItem(EDITS_KEY, JSON.stringify(sanitized));
            }
            return sanitized;
        }

        function applyEditsToRefs(editList) {
            editList.forEach((edit) => {
                const ref = refs.find((item) => item.pod === edit.pod);
                if (!ref) return;
                const establishment = getEstablishmentFromPath(edit.path);
                const nextValue = String(edit.path || '').endsWith('.localizacion')
                    ? normalizeLocationValue(edit.value, establishment)
                    : edit.value;
                setNestedValue(ref, edit.path, nextValue);
            });
        }

        function applyLocalEdits() {
            const edits = readStoredEdits();
            applyEditsToRefs(edits);
            if (edits.length) console.log(`✓ Applied ${edits.length} local edits`);
        }

        function rebuildRefsFromLocalSnapshot() {
            if (!baseRefs.length) return;
            refs = JSON.parse(JSON.stringify(baseRefs));
            applyLocalEdits();
            preProcess();
            updateRefCount();

            if (typeof triggerSearch === 'function') {
                triggerSearch();
            }

            const modal = document.getElementById('wineModal');
            if (modal && modal.classList.contains('active') && currentEditPod && typeof openModal === 'function') {
                const liveRef = refs.find((item) => item.pod === currentEditPod);
                if (liveRef) {
                    openModal(liveRef);
                }
            }
        }

        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            let cur = obj;
            for (let i = 0; i < keys.length - 1; i++) {
                if (!cur[keys[i]]) cur[keys[i]] = {};
                cur = cur[keys[i]];
            }
            cur[keys[keys.length - 1]] = value;
        }

        function saveEdit(pod, path, value) {
            const edits = readStoredEdits();
            const editPayload = {
                pod,
                path,
                value,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUserName
            };
            const idx = edits.findIndex((entry) => entry.pod === pod && entry.path === path);
            if (idx >= 0) edits[idx] = editPayload;
            else edits.push(editPayload);
            localStorage.setItem(EDITS_KEY, JSON.stringify(edits));

            queuePendingMutation({
                id: createMutationId(),
                type: 'edit',
                payload: editPayload
            });
            void runRealtimeSyncCycle();
        }

        // --- PRE-PROCESSING ---
        function preProcess() {
            searchIndex = [];
            pvpMedio = {};
            subsets = { todos: new Set(), bodega: new Set(), spa: new Set(), tasca_fina: new Set(), victoria: new Set(), galeria: new Set() };

            refs.forEach((ref, i) => {
                // Build searchable string (nome, uva, região, tipo, etc.)
                const grapeTokens = getGrapeSearchTokens(ref.uvas);
                const tipoTokens = getTipoSearchTokens(ref.tipo);
                const parts = [
                    ref.descripcion, ref.region, ref.pais, ref.bodega,
                    ...tipoTokens,
                    ...grapeTokens,
                    ref.formato?.etiqueta,
                    ref.ano ? String(ref.ano) : '',
                    ref.pod
                ].filter(Boolean).join(' ');

                searchIndex.push({ idx: i, str: removeAccents(parts.toLowerCase()) });
                subsets.todos.add(i);

                // Compute average PVP across visible establishments
                let prices = [];
                EST_KEYS.forEach(k => {
                    const est = ref.establecimientos?.[k];
                    if (est && est.pvp != null) {
                        prices.push(est.pvp);
                        subsets[k].add(i);
                    }
                });
                pvpMedio[ref.pod] = prices.length > 0
                    ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length)
                    : null;
            });
        }

        function updateRefCount() {
            let count = refs.length;
            if (currentFilter !== 'todos') {
                count = subsets[currentFilter]?.size || 0;
            }
            document.getElementById('totalRef').textContent = count;

            let locatedCount = 0;
            if (currentFilter === 'todos') {
                locatedCount = refs.reduce((acc, ref) => {
                    const hasAnyLocation = EST_KEYS.some((k) => normalizeLocationValue(ref.establecimientos?.[k]?.localizacion, k));
                    return acc + (hasAnyLocation ? 1 : 0);
                }, 0);
            } else {
                const subset = subsets[currentFilter] || new Set();
                subset.forEach((idx) => {
                    const ref = refs[idx];
                    if (!ref) return;
                    if (normalizeLocationValue(ref.establecimientos?.[currentFilter]?.localizacion, currentFilter)) {
                        locatedCount += 1;
                    }
                });
            }
            const locatedEl = document.getElementById('locatedRef');
            if (locatedEl) locatedEl.textContent = locatedCount;
        }

        // --- FILTER & SORT ---
        document.querySelectorAll('.filter-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.filter-pill.active').classList.remove('active');
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                updateRefCount();
                triggerSearch();
            });
        });

        document.getElementById('sortToggle').addEventListener('click', function() {
            currentSort = currentSort === 'abc' ? 'pvp' : 'abc';
            this.textContent = currentSort.toUpperCase();
            triggerSearch();
        });

        // --- SEARCH ---
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');

        let debounceTimer;
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => triggerSearch(), 150);
        });

        function triggerSearch() {
            const query = removeAccents(searchInput.value.toLowerCase().trim());
            searchResults.innerHTML = '';

            if (!query) {
                searchResults.style.display = 'none';
                return;
            }

            // Filter by search query
            let results = searchIndex.filter(item => item.str.includes(query));

            // Apply establishment filter
            if (currentFilter !== 'todos') {
                results = results.filter(item => subsets[currentFilter].has(item.idx));
            }

            // Apply sort
            if (currentSort === 'abc') {
                results.sort((a, b) => (refs[a.idx].descripcion || '').localeCompare(refs[b.idx].descripcion || ''));
            } else {
                results.sort((a, b) => {
                    const pa = getDisplayPrice(refs[a.idx]);
                    const pb = getDisplayPrice(refs[b.idx]);
                    return (pa ?? Infinity) - (pb ?? Infinity);
                });
            }

            if (results.length > 0) {
                results.forEach(item => {
                    const ref = refs[item.idx];
                    const el = document.createElement('div');
                    el.className = 'search-item';

                    const badge = getTipoBadge(ref.tipo);
                    const price = getDisplayPrice(ref);
                    const loc = getDisplayLocation(ref);
                    const formatLabel = ref.formato?.etiqueta && ref.formato.etiqueta !== 'Botella (75cl)'
                        ? ref.formato.etiqueta : '';

                    el.innerHTML = `
                        <div class="item-info">
                            <div class="item-title">${ref.descripcion || '—'}</div>
                            ${renderGrapeTags(ref.uvas, ref.tipo?.codigo)}
                            <div class="badge-row">
                                <span class="badge ${badge.cls}">${badge.label}</span>
                                <span class="item-region">${fmt(ref.region)}</span>
                                <span class="item-pod">${ref.pod}</span>
                                ${formatLabel ? `<span class="item-format">${formatLabel}</span>` : ''}
                            </div>
                        </div>
                        <div class="item-right">
                            <div class="item-price">${currentFilter === 'todos' ? 'APROX. ' : ''}${fmtPrice(price)}</div>
                            ${loc ? `<div class="item-location">${loc}</div>` : ''}
                        </div>
                    `;

                    el.addEventListener('click', () => openModal(ref));
                    searchResults.appendChild(el);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        }

        function getDisplayPrice(ref) {
            if (currentFilter !== 'todos') {
                return ref.establecimientos?.[currentFilter]?.pvp ?? null;
            }
            return pvpMedio[ref.pod] ?? null;
        }

        function getDisplayLocation(ref) {
            if (currentFilter !== 'todos') {
                return formatLocationForUi(currentFilter, ref.establecimientos?.[currentFilter]?.localizacion).text;
            }
            return null; // No location in TODOS mode (varies by establishment)
        }

        // --- TERROIR LOOKUP ---
        function getTerroirInfoLegacy(region, pais) {
            const r = (region || '').toLowerCase();
            const p = (pais || '').toLowerCase();
            // ── ESPAÑA ──
            if (r.includes('ribera del duero')) return { clima: 'Continental extremo', suelo: 'Caliza y arcilla' };
            if (r.includes('rioja alta')) return { clima: 'Mediterráneo-atlántico', suelo: 'Arcilla y caliza' };
            if (r.includes('rioja alavesa')) return { clima: 'Atlántico-mediterráneo', suelo: 'Arcilla caliza' };
            if (r.includes('rioja baja') || r.includes('rioja oriental')) return { clima: 'Mediterráneo cálido', suelo: 'Arcillo-ferroso' };
            if (r.includes('rioja')) return { clima: 'Mediterráneo-atlántico', suelo: 'Arcilla, caliza y arena' };
            if (r.includes('priorat') || r.includes('priorato')) return { clima: 'Mediterráneo seco', suelo: 'Llicorella (pizarra)' };
            if (r.includes('rías baixas')) return { clima: 'Oceánico húmedo', suelo: 'Granítico' };
            if (r.includes('ribeira sacra')) return { clima: 'Oceánico-continental', suelo: 'Pizarra y granito' };
            if (r.includes('valdeorras')) return { clima: 'Oceánico-continental', suelo: 'Pizarra y arcilla' };
            if (r.includes('rueda')) return { clima: 'Continental seco', suelo: 'Arenas y limos' };
            if (r.includes('toro')) return { clima: 'Continental extremo', suelo: 'Arenas finas' };
            if (r.includes('bierzo')) return { clima: 'Oceánico-continental', suelo: 'Pizarra y arcilla' };
            if (r.includes('galicia')) return { clima: 'Oceánico húmedo', suelo: 'Granítico y pizarroso' };
            if (r.includes('madrid') || r.includes('gredos')) return { clima: 'Continental de montaña', suelo: 'Granítico' };
            if (r.includes('jerez') || r.includes('sherry') || r.includes('manzanilla') || r.includes('sanlúcar')) return { clima: 'Mediterráneo cálido', suelo: 'Albariza (caliza)' };
            if (r.includes('penedès') || r.includes('penedes')) return { clima: 'Mediterráneo', suelo: 'Caliza y arenas' };
            if (r.includes('somontano')) return { clima: 'Continental mediterráneo', suelo: 'Caliza y arcilla' };
            if (r.includes('navarra')) return { clima: 'Continental-mediterráneo', suelo: 'Caliza y arcilla' };
            if (r.includes('aragón') || r.includes('aragon') || r.includes('campo de borja') || r.includes('cariñena') || r.includes('calatayud')) return { clima: 'Continental mediterráneo', suelo: 'Caliza y arcilla' };
            if (r.includes('la mancha') || r.includes('valdepeñas') || r.includes('castilla-la mancha')) return { clima: 'Continental extremo', suelo: 'Arcilla y caliza' };
            if (r.includes('jumilla') || r.includes('yecla') || r.includes('alicante') || r.includes('murcia')) return { clima: 'Mediterráneo semiárido', suelo: 'Caliza y arcilla' };
            if (r.includes('comunidad valenciana') || r.includes('utiel') || r.includes('valencia')) return { clima: 'Mediterráneo', suelo: 'Caliza y arcilla' };
            if (r.includes('montsant') || r.includes('terra alta')) return { clima: 'Mediterráneo seco', suelo: 'Caliza y arcilla' };
            if (r.includes('empordà')) return { clima: 'Mediterráneo ventoso', suelo: 'Granito y pizarra' };
            if (r.includes('cataluña') || r.includes('cataluna') || r.includes('catalunya')) return { clima: 'Mediterráneo', suelo: 'Caliza y arcilla' };
            if (r.includes('txakoli') || r.includes('getariako') || r.includes('bizkaiko')) return { clima: 'Oceánico-atlántico', suelo: 'Caliza y arenisca' };
            if (r.includes('país vasco') || r.includes('pais vasco') || r.includes('euskadi')) return { clima: 'Oceánico-atlántico', suelo: 'Caliza y arenisca' };
            if (r.includes('canarias') || r.includes('lanzarote') || r.includes('tenerife') || r.includes('gran canaria') || r.includes('la palma')) return { clima: 'Subtropical oceánico', suelo: 'Volcánico (lapilli/picón)' };
            if (r.includes('baleares') || r.includes('mallorca') || r.includes('binissalem')) return { clima: 'Mediterráneo', suelo: 'Caliza y arcilla roja' };
            if (r.includes('extremadura') || r.includes('ribera del guadiana')) return { clima: 'Mediterráneo continental', suelo: 'Arcilla y granito' };
            if (r.includes('castilla y león') || r.includes('castilla leon')) return { clima: 'Continental', suelo: 'Caliza, arcilla y arena' };
            if (r.includes('andaluc') || r.includes('málaga') || r.includes('condado de huelva')) return { clima: 'Mediterráneo cálido', suelo: 'Caliza y arcilla' };
            if (r.includes('cava')) return { clima: 'Mediterráneo', suelo: 'Caliza y arenas' };
            // ── FRANCIA ──
            if (r.includes('burdeos') || r.includes('bordeaux') || r.includes('médoc') || r.includes('medoc') || r.includes('pomerol') || r.includes('saint-émilion') || r.includes('saint-emilion') || r.includes('graves') || r.includes('sauternes') || r.includes('pessac')) return { clima: 'Oceánico templado', suelo: 'Gravas y arcilla' };
            if (r.includes('borgoña') || r.includes('bourgogne') || r.includes('burgundy') || r.includes('chablis') || r.includes('gevrey') || r.includes('chambolle') || r.includes('vosne') || r.includes('nuits-saint') || r.includes('pommard') || r.includes('puligny') || r.includes('meursault') || r.includes('montrachet') || r.includes('beaune') || r.includes('santenay') || r.includes('mâcon') || r.includes('macon') || r.includes('pouilly-fuissé') || r.includes('chassagne')) return { clima: 'Continental', suelo: 'Caliza y marga' };
            if (r.includes('champagne') || r.includes('reims') || r.includes('épernay') || r.includes('epernay')) return { clima: 'Oceánico frío', suelo: 'Creta y caliza' };
            if (r.includes('alsace') || r.includes('alsacia')) return { clima: 'Continental semiárido', suelo: 'Granito, caliza y pizarra' };
            if (r.includes('côte-rôtie') || r.includes('cote rotie') || r.includes('condrieu') || r.includes('hermitage') || r.includes('crozes') || r.includes('saint-joseph') || r.includes('cornas') || r.includes('saint-péray')) return { clima: 'Continental-mediterráneo', suelo: 'Granito y gneis' };
            if (r.includes('châteauneuf') || r.includes('chateauneuf') || r.includes('gigondas') || r.includes('vacqueyras') || r.includes('tavel') || r.includes('lirac')) return { clima: 'Mediterráneo cálido', suelo: 'Cantos rodados (galets)' };
            if (r.includes('ródano') || r.includes('rodano') || r.includes('rhône') || r.includes('rhone')) return { clima: 'Mediterráneo-continental', suelo: 'Granito, caliza y galets' };
            if (r.includes('loira') || r.includes('loire') || r.includes('pouilly-fumé') || r.includes('sancerre') || r.includes('chinon') || r.includes('vouvray') || r.includes('bourgueil') || r.includes('saumur') || r.includes('anjou') || r.includes('muscadet')) return { clima: 'Oceánico', suelo: 'Sílex, tuffeau y granito' };
            if (r.includes('provence') || r.includes('provenza') || r.includes('bandol')) return { clima: 'Mediterráneo', suelo: 'Caliza y esquisto' };
            if (r.includes('languedoc') || r.includes('lenguadoc') || r.includes('roussillon') || r.includes('fitou') || r.includes('corbières') || r.includes('minervois')) return { clima: 'Mediterráneo cálido', suelo: 'Caliza, pizarra y gneis' };
            if (r.includes('beaujolais') || r.includes('moulin-à-vent') || r.includes('fleurie') || r.includes('morgon')) return { clima: 'Continental-templado', suelo: 'Granito y arcilla' };
            if (r.includes('jura')) return { clima: 'Continental frío', suelo: 'Marga y caliza azul' };
            if (r.includes('savoie') || r.includes('saboya')) return { clima: 'Alpino-continental', suelo: 'Caliza y morrena glaciar' };
            if (r.includes('gascogne') || r.includes('gascuña') || r.includes('jurançon') || r.includes('irouléguy')) return { clima: 'Oceánico-pirenaico', suelo: 'Arcilla, caliza y gravas' };
            // ── ITALIA ──
            if (r.includes('piamonte') || r.includes('piemonte') || r.includes('piedmont') || r.includes('barolo') || r.includes('barbaresco') || r.includes('barbera') || r.includes('dolcetto') || r.includes('langhe') || r.includes('monferrato') || r.includes('asti')) return { clima: 'Continental-mediterráneo', suelo: 'Marga calcárea (tufo)' };
            if (r.includes('toscana') || r.includes('tuscany') || r.includes('chianti') || r.includes('brunello') || r.includes('montalcino') || r.includes('montepulciano') || r.includes('maremma') || r.includes('bolgheri')) return { clima: 'Mediterráneo continental', suelo: 'Caliza, arcilla y galestro' };
            if (r.includes('véneto') || r.includes('veneto') || r.includes('amarone') || r.includes('valpolicella') || r.includes('soave') || r.includes('prosecco')) return { clima: 'Continental-mediterráneo', suelo: 'Caliza y arcilla' };
            if (r.includes('friuli') || r.includes('friaul')) return { clima: 'Continental', suelo: 'Ponca (marga y arenisca)' };
            if (r.includes('etna') || r.includes('sicilia') || r.includes('sicily')) return { clima: 'Mediterráneo cálido', suelo: 'Volcánico (basalto) / Caliza' };
            if (r.includes('alto adige') || r.includes('südtirol') || r.includes('trentino')) return { clima: 'Alpino-mediterráneo', suelo: 'Caliza, pizarra y pórfido' };
            if (r.includes('campania')) return { clima: 'Mediterráneo', suelo: 'Volcánico y caliza' };
            if (r.includes('puglia') || r.includes('apulia')) return { clima: 'Mediterráneo árido', suelo: 'Caliza y arcilla roja' };
            if (r.includes('umbria') || r.includes('umbría')) return { clima: 'Mediterráneo continental', suelo: 'Arcilla y tiza' };
            if (r.includes('abruzzo') || r.includes('abruzos')) return { clima: 'Mediterráneo-continental', suelo: 'Arcilla y caliza' };
            if (r.includes('lombardia') || r.includes('lombardía') || r.includes('franciacorta')) return { clima: 'Continental', suelo: 'Morrena glaciar y arcilla' };
            // ── PORTUGAL ──
            if (r.includes('douro') || r.includes('oporto')) return { clima: 'Continental seco', suelo: 'Xisto (pizarra)' };
            if (r.includes('alentejo')) return { clima: 'Mediterráneo árido', suelo: 'Granito y esquisto' };
            if (r.includes('vinho verde') || r.includes('minho')) return { clima: 'Oceánico húmedo', suelo: 'Granítico' };
            if (r.includes('dão') || r.includes('dao')) return { clima: 'Continental', suelo: 'Granito y pizarroso' };
            if (r.includes('bairrada')) return { clima: 'Oceánico', suelo: 'Arcilla y caliza' };
            if (r.includes('madeira') || r.includes('madera')) return { clima: 'Oceánico subtropical', suelo: 'Volcánico (basalto)' };
            if (r.includes('azores') || r.includes('açores')) return { clima: 'Oceánico subtropical', suelo: 'Volcánico (basalto)' };
            if (r.includes('norte') || r.includes('centro') || r.includes('tejo') || r.includes('lisboa')) return { clima: 'Mediterráneo-atlántico', suelo: 'Arcilla, granito y caliza' };
            // ── ALEMANIA / AUSTRIA ──
            if (r.includes('mosel') || r.includes('moselle')) return { clima: 'Continental frío', suelo: 'Pizarra azul (devónica)' };
            if (r.includes('rheingau') || r.includes('rheinhessen') || r.includes('hesse') || r.includes('nahe') || r.includes('ahr') || r.includes('renania') || r.includes('pfalz') || r.includes('palatinado') || r.includes('württemberg') || r.includes('franken') || r.includes('franconia')) return { clima: 'Continental frío', suelo: 'Pizarra, cuarzo y caliza' };
            if (r.includes('wachau') || r.includes('kamptal') || r.includes('kremstal') || r.includes('burgenland') || p.includes('austria') || p.includes('österreich')) return { clima: 'Continental-panónico', suelo: 'Loess, gneis y pizarra' };
            if (p.includes('alemania') || p.includes('germany') || p.includes('deutschland')) return { clima: 'Continental frío', suelo: 'Pizarra y caliza' };
            // ── HUNGRÍA / OTROS EUROPEOS ──
            if (r.includes('tokaj') || r.includes('tokay') || r.includes('hegyalja') || p.includes('hungría') || p.includes('hungria') || p.includes('hungary')) return { clima: 'Continental panónico', suelo: 'Arcilla volcánica y caliza' };
            if (p.includes('georgia') || r.includes('kakheti')) return { clima: 'Continental cálido', suelo: 'Arcilla y suelo aluvial' };
            if (p.includes('grecia') || p.includes('greece')) return { clima: 'Mediterráneo', suelo: 'Caliza y arcilla' };
            // ── AMÉRICAS ──
            if (r.includes('napa') || r.includes('sonoma') || r.includes('paso robles') || r.includes('santa barbara') || r.includes('california')) return { clima: 'Mediterráneo', suelo: 'Variable (volcánico, arcilla)' };
            if (r.includes('willamette') || r.includes('oregón') || r.includes('oregon')) return { clima: 'Oceánico templado', suelo: 'Arcilla volcánica (Jory)' };
            if (r.includes('washington') || r.includes('columbia valley') || r.includes('walla walla')) return { clima: 'Continental semiárido', suelo: 'Limo eólico y basalto' };
            if (r.includes('mendoza') || r.includes('luján de cuyo') || r.includes('maipú') || r.includes('valle de uco')) return { clima: 'Continental árido', suelo: 'Aluvial y arenoso' };
            if (r.includes('salta') || r.includes('cafayate') || r.includes('patagonia') || r.includes('neuquén') || r.includes('río negro')) return { clima: 'Continental de altitud', suelo: 'Arenoso y pedregoso' };
            if (r.includes('maipo') || r.includes('colchagua') || r.includes('casablanca') || r.includes('aconcagua') || r.includes('cachapoal') || r.includes('itata') || p.includes('chile')) return { clima: 'Mediterráneo', suelo: 'Aluvial y arcillo-granítico' };
            // ── AUSTRALIA / NZ / SUDÁFRICA ──
            if (r.includes('barossa') || r.includes('mclaren vale') || r.includes('coonawarra') || r.includes('eden valley') || r.includes('south australia') || r.includes('australia meridional')) return { clima: 'Mediterráneo', suelo: 'Terra rossa y arcilla' };
            if (r.includes('yarra') || r.includes('mornington') || r.includes('margaret river') || p.includes('australia')) return { clima: 'Oceánico-mediterráneo', suelo: 'Arcilla y arenisca' };
            if (r.includes('marlborough') || r.includes('central otago') || r.includes('hawke') || r.includes('isla norte') || r.includes('isla sur') || r.includes('auckland') || p.includes('nueva zelanda') || p.includes('new zealand')) return { clima: 'Oceánico frío', suelo: 'Gravas, limo y arcilla' };
            if (r.includes('stellenbosch') || r.includes('franschhoek') || r.includes('hemel') || r.includes('swartland') || r.includes('cape') || r.includes('western cape') || r.includes('coastal') || p.includes('sudáfrica') || p.includes('south africa')) return { clima: 'Mediterráneo', suelo: 'Granito y esquisto' };
            return { clima: '—', suelo: '—' };
        }

        const REGION_TERRIOR_PRECISE = {
            'abruzzo': { clima: 'Mediterráneo con influencia de Apeninos y Adriático; veranos cálidos e inviernos suaves.', suelo: 'Arcillo-calcáreo, marga y focos volcánicos.' },
            'alentejo': { clima: 'Mediterráneo continental muy cálido y seco; noches relativamente frescas.', suelo: 'Xisto, arcilla, mármol, granito y caliza.' },
            'alsacia': { clima: 'Continental seco por efecto de sombra de lluvia de los Vosgos.', suelo: 'Granito, caliza, marga, pizarra, arenisca y suelos volcánicos.' },
            'aragon': { clima: 'Continental extremo con viento Cierzo y baja pluviometría.', suelo: 'Caliza, arcilla, pedregoso y aluvial del valle del Ebro.' },
            'atacama': { clima: 'Desértico hiperárido con gran amplitud térmica.', suelo: 'Calcáreo salino, arenoso y muy mineral.' },
            'auckland': { clima: 'Marítimo templado cálido y húmedo.', suelo: 'Volcánico-arcilloso y arcillas densas.' },
            'azores': { clima: 'Oceánico subtropical húmedo, ventoso y estable.', suelo: 'Basalto y ceniza volcánica, muy pobre en materia orgánica.' },
            'baleares': { clima: 'Mediterráneo subtropical con fuerte influencia marítima.', suelo: 'Caliza y arcilla de baja fertilidad.' },
            'beaujolais': { clima: 'Semicontinental con influencia mediterránea.', suelo: 'Granito en el norte; arcilla, arenisca y caliza en el sur.' },
            'bierzo': { clima: 'Transición atlántico-continental, húmedo y fresco.', suelo: 'Pizarra, arcilla, cuarzo y arena.' },
            'bizkaiko txakolina': { clima: 'Atlántico muy húmedo con veranos suaves.', suelo: 'Caliza, marga y arcillas ácidas de poca profundidad.' },
            'borgona': { clima: 'Continental con variaciones por ladera y exposición.', suelo: 'Caliza y marga con fósiles marinos.' },
            'burdeos': { clima: 'Oceánico templado con clara influencia atlántica.', suelo: 'Gravas en margen izquierda; arcilla-caliza en margen derecha.' },
            'california': { clima: 'Mediterráneo con fuerte modulación marítima.', suelo: 'Muy diverso: volcánico, aluvial, arcilloso y calcáreo.' },
            'campania': { clima: 'Mediterráneo cálido con brisas marinas.', suelo: 'Volcánico, toba, arcilla y aluvial.' },
            'canarias': { clima: 'Subtropical con alisios y gran variación por altitud.', suelo: 'Volcánico (basalto, ceniza y lapilli).' },
            'cape south coast': { clima: 'Marítimo fresco por influencia de dos océanos.', suelo: 'Granito descompuesto, esquisto y arcilla.' },
            'castilla y leon': { clima: 'Continental extremo con elevada amplitud térmica.', suelo: 'Caliza, arcilla, arena y cantos rodados.' },
            'castilla-la mancha': { clima: 'Continental árido extremo con insolación muy alta.', suelo: 'Arcillo-arenoso calcáreo y pedregoso.' },
            'cava': { clima: 'Mediterráneo con gradiente térmico por altitud.', suelo: 'Caliza, arcilla y arena bien drenada.' },
            'central coast': { clima: 'Marítimo fresco con niebla y viento del Pacífico.', suelo: 'Calcáreo, aluvial y arcilloso.' },
            'centro': { clima: 'Mixto: más fresco en montaña y más cálido en llanura.', suelo: 'Granito, xisto y arcillas.' },
            'champagne': { clima: 'Frío continental-oceánico con maduración lenta.', suelo: 'Giz (chalk), marga y caliza.' },
            'coastal region': { clima: 'Mediterráneo con importante influencia oceánica.', suelo: 'Granito antiguo, arcilla y esquisto.' },
            'comunidad valenciana': { clima: 'Mediterráneo en costa y más continental en interior.', suelo: 'Arcilla, caliza y arena.' },
            'conca de barbera': { clima: 'Mediterráneo continental con noches frescas.', suelo: 'Caliza oscura, arcilla y terrazas fluviales.' },
            'conca del riu anoia': { clima: 'Mediterráneo con componente continental.', suelo: 'Caliza fosilizada de antiguo lecho marino.' },
            'costers del segre': { clima: 'Continental semiárido con alta amplitud térmica.', suelo: 'Arenoso-calcáreo.' },
            'douro': { clima: 'Continental extremo con veranos muy cálidos y secos.', suelo: 'Xisto dominante y granito periférico.' },
            'extremadura': { clima: 'Mediterráneo continental con veranos calurosos.', suelo: 'Arcillo-calcáreo, aluvial arenoso y pedregoso.' },
            'franschhoek': { clima: 'Mediterráneo cálido moderado por montaña.', suelo: 'Granito descompuesto y arcilla.' },
            'friuli-venezia-giulia': { clima: 'Continental-alpino con influencia adriática.', suelo: 'Grava, caliza y depósitos aluviales.' },
            'getariako txakolina': { clima: 'Atlántico muy húmedo y fresco.', suelo: 'Arcillo-calcáreo en laderas costeras.' },
            'hemel-en-aarde': { clima: 'Marítimo fresco con gran influencia oceánica.', suelo: 'Esquisto y arcilla.' },
            'hesse': { clima: 'Continental templado.', suelo: 'Loess, caliza y arcilla.' },
            'isla norte': { clima: 'Marítimo templado cálido.', suelo: 'Volcánico y arcilloso.' },
            'isla sur': { clima: 'Marítimo fresco a continental frío.', suelo: 'Esquisto, grava y aluvial.' },
            'jerez': { clima: 'Mediterráneo cálido y soleado.', suelo: 'Albariza calcárea de alta retención hídrica.' },
            'jura': { clima: 'Continental fresco.', suelo: 'Marga y caliza con presencia de esquisto.' },
            'languedoc-roussillon': { clima: 'Mediterráneo cálido y seco.', suelo: 'Arcilla, caliza y gravas.' },
            'loira': { clima: 'Oceánico en oeste y más continental en este.', suelo: 'Sílex, toba calcárea y arcilla.' },
            'madrid': { clima: 'Continental mediterráneo de altitud con noches frescas.', suelo: 'Granítico y calcáreo.' },
            'manzanilla': { clima: 'Mediterráneo más húmedo por influencia marina.', suelo: 'Albariza calcárea.' },
            'mendoza': { clima: 'Desértico de altitud con noches muy frías.', suelo: 'Aluvial pedregoso.' },
            'montilla-moriles': { clima: 'Continental cálido extremo.', suelo: 'Albariza calcárea.' },
            'montsant': { clima: 'Mediterráneo seco.', suelo: 'Pizarra (llicorella), caliza y arcilla.' },
            'mosela': { clima: 'Continental frío.', suelo: 'Pizarra en laderas pronunciadas.' },
            'murcia': { clima: 'Mediterráneo continental cálido.', suelo: 'Calcáreo pedregoso.' },
            'malaga': { clima: 'Mediterráneo cálido.', suelo: 'Caliza y arcilla.' },
            'navarra': { clima: 'Continental mediterráneo.', suelo: 'Caliza, arcilla y gravas.' },
            'norte': { clima: 'Atlántico fresco y húmedo.', suelo: 'Granítico.' },
            'oregon': { clima: 'Marítimo fresco de influencia pacífica.', suelo: 'Volcánico (Jory), aluvial y sedimentario.' },
            'patagonia': { clima: 'Continental frío y seco.', suelo: 'Aluvial y pedregoso.' },
            'penedes': { clima: 'Mediterráneo escalonado por altitud.', suelo: 'Calcáreo y arcilloso.' },
            'piamonte': { clima: 'Continental con nieblas otoñales.', suelo: 'Marga calcárea.' },
            'priorat': { clima: 'Mediterráneo seco y de fuerte estrés hídrico.', suelo: 'Llicorella (pizarra roja y negra).' },
            'provenza': { clima: 'Mediterráneo soleado con influencia del Mistral.', suelo: 'Caliza, arcilla y gravas.' },
            'puglia': { clima: 'Mediterráneo cálido.', suelo: 'Caliza y terra rossa.' },
            'renania-palatinado': { clima: 'Continental templado.', suelo: 'Pizarra, loess y caliza.' },
            'ribeira sacra': { clima: 'Atlántico fresco con componente continental.', suelo: 'Pizarra en bancales.' },
            'ribeiro': { clima: 'Atlántico húmedo.', suelo: 'Granito y arcilla.' },
            'ribera del duero': { clima: 'Continental extremo con alta oscilación térmica.', suelo: 'Caliza, arcilla y arena.' },
            'rioja': { clima: 'Continental con influencias atlántica y mediterránea.', suelo: 'Arcillo-calcáreo, arcillo-ferroso y aluvial.' },
            'rioja alavesa': { clima: 'Más atlántico y fresco que Rioja Oriental.', suelo: 'Arcillo-calcáreo.' },
            'rueda': { clima: 'Continental.', suelo: 'Cascajoso (pedregoso) y arenas calcáreas.' },
            'rias baixas': { clima: 'Atlántico húmedo y templado.', suelo: 'Granítico, arenoso y ácido.' },
            'rodano': { clima: 'Continental en norte y mediterráneo en sur.', suelo: 'Granito (norte) y galets/cantos rodados (sur).' },
            'sicilia': { clima: 'Mediterráneo; más fresco en altitud del Etna.', suelo: 'Volcánico en Etna y calcáreo en zonas bajas.' },
            'somontano': { clima: 'Continental de altitud.', suelo: 'Caliza y gravas.' },
            'south australia': { clima: 'Mediterráneo variable según subzona.', suelo: 'Terra rossa, caliza y arcilla roja.' },
            'stellenbosch': { clima: 'Mediterráneo cálido moderado por brisa oceánica.', suelo: 'Granito antiguo descompuesto y arcilla.' },
            'tokaji-hegyalja': { clima: 'Continental con nieblas favorables a botrytis.', suelo: 'Volcánico, loess y arcilla.' },
            'toro': { clima: 'Continental cálido.', suelo: 'Arenoso con base calcárea.' },
            'toscana': { clima: 'Mediterráneo.', suelo: 'Galestro (arcilla esquistosa) y albarese (caliza).' },
            'traiguen': { clima: 'Fresco y húmedo del sur chileno.', suelo: 'Volcánico y aluvial.' },
            'trentino-alto adige': { clima: 'Alpino continental con gran amplitud térmica.', suelo: 'Grava, caliza y origen volcánico.' },
            'valdeorras': { clima: 'Atlántico de transición.', suelo: 'Pizarra dominante.' },
            'valle central': { clima: 'Mediterráneo clásico.', suelo: 'Aluvial y gravas.' },
            'valle de maipo': { clima: 'Mediterráneo con influencia andina.', suelo: 'Grava aluvial de origen andino.' },
            'victoria': { clima: 'Variable; de fresco a templado-cálido según subzona.', suelo: 'Terra rossa, volcánico y aluvial.' },
            'veneto': { clima: 'Variable entre alpino y mediterráneo.', suelo: 'Volcánico, aluvial y calcáreo.' },
            'western cape': { clima: 'Mediterráneo con brisas oceánicas.', suelo: 'Granito, esquisto y arcilla.' }
        };

        const GRAPE_TERRIOR_PROFILE = {
            tempranillo: { clima: 'madura bien en continental con amplitud térmica.', suelo: 'destaca en arcillo-calcáreo y aluvial pedregoso.' },
            garnacha: { clima: 'tolera calor y sequía mediterránea.', suelo: 'rinde mejor en pizarra, canto rodado y caliza pobre.' },
            monastrell: { clima: 'requiere calor y maduración larga.', suelo: 'encaja en calcáreo pedregoso de baja fertilidad.' },
            bobal: { clima: 'resiste clima continental seco.', suelo: 'funciona en arcilla calcárea con grava.' },
            mencia: { clima: 'expresa frescura en atlántico-continental.', suelo: 'gana finura en pizarra y granito.' },
            pinotnoir: { clima: 'prefiere zonas frescas y maduración lenta.', suelo: 'brilla en caliza/marga y suelos de buen drenaje.' },
            syrah: { clima: 'equilibrio ideal entre calor diurno y noches frescas.', suelo: 'granito, esquisto y cantos rodados aumentan complejidad.' },
            shiraz: { clima: 'admite climas cálidos manteniendo especia.', suelo: 'arcilla roja y terra rossa aportan potencia.' },
            nebbiolo: { clima: 'necesita continental fresco con otoño largo.', suelo: 'marga calcárea para tanino noble.' },
            sangiovese: { clima: 'mediterráneo con amplitud térmica moderada.', suelo: 'galestro y albarese afinan acidez y estructura.' },
            barbera: { clima: 'adapta bien a continental templado.', suelo: 'marga y arcilla conservan su acidez natural.' },
            riesling: { clima: 'excelente en climas fríos a frescos.', suelo: 'pizarra, granito o caliza elevan mineralidad.' },
            albarino: { clima: 'atlántico húmedo y fresco.', suelo: 'granito arenoso mejora perfil salino y cítrico.' },
            verdejo: { clima: 'continental con noches frescas.', suelo: 'cascajoso-calcáreo favorece tensión y aromas herbales.' },
            godello: { clima: 'atlántico de transición.', suelo: 'pizarra y suelos pobres aumentan textura mineral.' },
            chardonnay: { clima: 'muy sensible al mesoclima; ideal en fresco-templado.', suelo: 'caliza y marga definen precisión y longitud.' },
            sauvignonblanc: { clima: 'mejor en climas frescos con buena ventilación.', suelo: 'sílex, caliza y granito acentúan verticalidad.' },
            viognier: { clima: 'prefiere cálido moderado sin exceso térmico.', suelo: 'granito y arcilla drenada preservan perfume.' },
            xarello: { clima: 'mediterráneo con amplitud térmica moderada.', suelo: 'caliza aporta estructura y acidez estable.' },
            macabeo: { clima: 'mediterráneo templado.', suelo: 'caliza y arcilla ligera mantienen frescura.' },
            parellada: { clima: 'mejor en cotas altas y frescas.', suelo: 'calcáreo pobre para tensión ácida.' },
            glera: { clima: 'templado-fresco con influencia montañosa.', suelo: 'margas y arcillas livianas favorecen delicadeza.' },
            furmint: { clima: 'continental con niebla otoñal.', suelo: 'volcánico y loess sostienen acidez y longevidad.' },
            harslevelu: { clima: 'continental con botrytis controlada.', suelo: 'volcánico y arcilloso para concentración aromática.' },
            cabernetsauvignon: { clima: 'mejor en templado-cálido de ciclo largo.', suelo: 'grava/cascajo para drenaje y maduración fenólica.' },
            cabernetfranc: { clima: 'funciona muy bien en fresco-templado.', suelo: 'caliza y arcilla para tanino fino y perfume.' },
            merlot: { clima: 'maduración precoz en templado.', suelo: 'arcilla y caliza favorecen textura redonda.' },
            graciano: { clima: 'requiere insolación alta con noches frescas.', suelo: 'arcillo-calcáreo para color y acidez.' },
            carinena: { clima: 'tolera sequía y calor.', suelo: 'pizarra y caliza pobre generan concentración.' },
            touriganacional: { clima: 'continental cálido con buen contraste térmico.', suelo: 'xisto potencia estructura y aromaticidad floral.' },
            tourigafranca: { clima: 'adaptada a calor seco.', suelo: 'xisto y pendientes bien drenadas.' },
            cheninblanc: { clima: 'muy versátil, destaca en fresco a templado.', suelo: 'esquisto y caliza elevan tensión y guarda.' },
            semillon: { clima: 'oceánico templado.', suelo: 'gravas y arcillas para volumen y textura cerosa.' },
            malbec: { clima: 'óptimo en altura con noches frías.', suelo: 'aluvial pedregoso para concentración con frescura.' },
            carmenere: { clima: 'templado-cálido con otoño largo.', suelo: 'aluvial y arcilla drenada para madurez completa.' },
            nerellomascalese: { clima: 'mediterráneo de altitud.', suelo: 'volcánico para perfil ferrosomineral.' },
            aglianico: { clima: 'prefiere maduración lenta en zonas elevadas.', suelo: 'volcánico y calcáreo para tanino y acidez.' }
        };

        const GRAPE_FAMILY_TERRIOR_PROFILE = {
            'iberica-tinta': { clima: 'suele rendir mejor con días cálidos y noches frescas.', suelo: 'prefiere caliza, arcilla pobre o pizarra de buen drenaje.' },
            'burgundy': { clima: 'normalmente necesita clima fresco o templado fresco.', suelo: 'caliza, marga o suelos pedregosos bien drenados elevan precisión.' },
            'italiana': { clima: 'se expresa bien en mediterráneo con contraste térmico.', suelo: 'marga, caliza y suelos volcánicos moderan estructura.' },
            'aromatico': { clima: 'requiere conservar acidez y fragancia en zonas frescas.', suelo: 'granito, pizarra o calcáreo ligero aportan tensión aromática.' },
            'novamundo': { clima: 'admite mayor insolación sin perder equilibrio si hay ventilación.', suelo: 'aluvial, grava y arcilla drenada ayudan a madurez fenólica.' },
            'espumoso': { clima: 'busca maduración lenta para retener acidez.', suelo: 'calcáreo y margoso favorecen finura y persistencia.' }
        };

        const GRAPE_KEY_ALIASES = {
            aragonez: 'tempranillo',
            tintadetoro: 'tempranillo',
            viura: 'macabeo',
            rolle: 'vermentino',
            gouveio: 'godello',
            mourvedre: 'monastrell',
            shiraz: 'syrah',
            ploussard: 'poulsard',
            xarello: 'xarello',
            xarelolo: 'xarello',
            sargamuskotaly: 'moscatel'
        };

        function canonicalRegionKey(value) {
            return normalizeToken(value).replace(/\s+/g, ' ').trim();
        }

        function canonicalGrapeKey(value) {
            const normalized = normalizeToken(value).replace(/[^a-z0-9]/g, '');
            return GRAPE_KEY_ALIASES[normalized] || normalized;
        }

        function getPredominantGrape(uvasArr) {
            const grapes = extractGrapeItems(uvasArr);
            if (!grapes.length) return null;
            let best = grapes[0];
            let bestPct = Number.isFinite(Number(best.pct)) ? Number(best.pct) : -1;
            for (let i = 1; i < grapes.length; i++) {
                const candidate = grapes[i];
                const candidatePct = Number.isFinite(Number(candidate.pct)) ? Number(candidate.pct) : -1;
                if (candidatePct > bestPct) {
                    best = candidate;
                    bestPct = candidatePct;
                }
            }
            return best;
        }

        function getPreciseRegionTerroir(region) {
            const key = canonicalRegionKey(region);
            if (!key) return null;
            if (REGION_TERRIOR_PRECISE[key]) return REGION_TERRIOR_PRECISE[key];
            const fuzzyMatch = Object.keys(REGION_TERRIOR_PRECISE).find((known) => key.includes(known) || known.includes(key));
            return fuzzyMatch ? REGION_TERRIOR_PRECISE[fuzzyMatch] : null;
        }

        function getGrapeTerroirProfile(grapeName) {
            const key = canonicalGrapeKey(grapeName);
            if (!key) return null;
            if (GRAPE_TERRIOR_PROFILE[key]) return GRAPE_TERRIOR_PROFILE[key];
            const familyClass = String(getGrapeColor(grapeName || '') || '').split(' ')[0];
            return GRAPE_FAMILY_TERRIOR_PROFILE[familyClass] || null;
        }

        const CLIMATE_BASE_TERMS = [
            { re: /\boceanico|\boceanic|atlantic/, label: 'Atlántico fresco' },
            { re: /\bmediterraneo|\bmediterranean/, label: 'Mediterráneo luminoso' },
            { re: /\bcontinental/, label: 'Continental marcado' },
            { re: /\balpino|\bmontana|altitud/, label: 'De altitud' },
            { re: /\bdesertico|arido/, label: 'Seco y de fuerte insolación' },
            { re: /\bsubtropical/, label: 'Subtropical atlántico' }
        ];

        const CLIMATE_TRAITS = [
            { re: /amplitud|termic|noche(s)? fresca/, text: 'gran amplitud térmica' },
            { re: /viento|cierzo|mistral|brisa/, text: 'viento que afina la madurez' },
            { re: /humed|lluvia|pluvio/, text: 'humedad que preserva tensión' },
            { re: /seco|sequ(i|í)a|estres hidr/, text: 'sequía que concentra fruta' },
            { re: /maduraci[oó]n lenta|fresco|frio/, text: 'maduración lenta y perfil fino' },
            { re: /calido|calor/, text: 'madurez franca y boca amplia' }
        ];

        const SOIL_IMPACT_TERMS = [
            { re: /albariza/, text: 'salinidad fina, tacto seco y final muy limpio' },
            { re: /llicorella|pizarra|xisto|esquisto|schist/, text: 'perfil tenso, fruta más precisa y final mineral' },
            { re: /caliza|chalk|creta|albarese/, text: 'acidez vertical, boca nítida y gran sensación de frescura' },
            { re: /marga|ponca/, text: 'textura cremosa y paso de boca más envolvente' },
            { re: /granit|gneis|porfido/, text: 'nariz más definida y paladar lineal, elegante' },
            { re: /volcan|basalto|lapilli|pic[oó]n|tufo/, text: 'trazo ahumado, profundidad y final largo' },
            { re: /arcill|terra rossa|arcillo/, text: 'más volumen en boca, tanino amable y fruta madura' },
            { re: /grava|galets|canto(s)? rodad|aluvial|cascajo/, text: 'madurez franca, centro de boca amplio y final limpio' },
            { re: /arena|arenisc|arenoso/, text: 'tanino más fino y paso ágil' },
            { re: /sil(e|é)x|quartz|cuarzo/, text: 'nota pedregosa sutil y final salino' }
        ];

        const SOIL_TRAITS = [
            { re: /drenaj|pobre|baja fertilidad|pendiente/, text: 'da concentración y mayor longitud en el final' },
            { re: /retencion|retenci[oó]n h(i|í)drica/, text: 'favorece madurez regular y equilibrio de boca' },
            { re: /mineral|ferroso|salin/, text: 'refuerza tensión, salinidad y carácter gastronómico' },
            { re: /tanino|estructura|volumen/, text: 'sostiene estructura y buena evolución en botella' }
        ];

        function uniquePush(list, value, maxItems) {
            if (!value || list.includes(value)) return;
            if (typeof maxItems === 'number' && list.length >= maxItems) return;
            list.push(value);
        }

        function trimSentence(value, max = 96) {
            const clean = String(value || '').replace(/\s+/g, ' ').trim().replace(/[;,.]+$/g, '');
            if (!clean) return '';
            if (clean.length <= max) return `${clean}.`;
            const cut = clean.slice(0, max);
            const lastSpace = cut.lastIndexOf(' ');
            const safe = (lastSpace > 40 ? cut.slice(0, lastSpace) : cut).trim();
            return `${safe}.`;
        }

        function summarizeClimateText(rawText) {
            if (!rawText || rawText === '—') return '';
            const normalized = normalizeToken(rawText);
            const base = CLIMATE_BASE_TERMS.find((item) => item.re.test(normalized))?.label || '';
            const traits = [];
            CLIMATE_TRAITS.forEach((item) => {
                if (item.re.test(normalized)) uniquePush(traits, item.text, 2);
            });

            if (base && traits.length) return trimSentence(`${base}, ${traits.join(' y ')}`);
            if (base) return trimSentence(base);
            if (traits.length) return trimSentence(traits.join(' y '));
            return trimSentence(rawText);
        }

        function summarizeSoilText(rawText) {
            if (!rawText || rawText === '—') return '';
            const normalized = normalizeToken(rawText);
            const impacts = [];
            SOIL_IMPACT_TERMS.forEach((item) => {
                if (item.re.test(normalized)) uniquePush(impacts, item.text, 2);
            });
            const traits = [];
            SOIL_TRAITS.forEach((item) => {
                if (item.re.test(normalized)) uniquePush(traits, item.text, 1);
            });

            if (impacts.length && traits.length) return trimSentence(`${impacts[0]}, ${traits[0]}`);
            if (impacts.length > 1) return trimSentence(`${impacts[0]} y ${impacts[1]}`);
            if (impacts.length) return trimSentence(impacts[0]);
            if (traits.length) return trimSentence(traits[0]);
            return trimSentence('textura definida, acidez integrada y final limpio');
        }

        function buildTerroirBlock(kind, baseText, grapeName, grapeText) {
            const summarize = kind === 'clima' ? summarizeClimateText : summarizeSoilText;
            const baseLine = summarize(baseText);
            if (!baseLine) return '—';
            return baseLine;
        }

        function getTerroirInfo(region, pais, uvasArr) {
            const regionBase = getPreciseRegionTerroir(region) || getTerroirInfoLegacy(region, pais);
            const dominant = getPredominantGrape(uvasArr);
            if (!dominant || !dominant.nome) {
                return {
                    clima: buildTerroirBlock('clima', regionBase.clima),
                    suelo: buildTerroirBlock('suelo', regionBase.suelo)
                };
            }
            const grapeProfile = getGrapeTerroirProfile(dominant.nome);
            if (!grapeProfile) {
                return {
                    clima: buildTerroirBlock('clima', regionBase.clima),
                    suelo: buildTerroirBlock('suelo', regionBase.suelo)
                };
            }
            return {
                clima: buildTerroirBlock('clima', regionBase.clima, dominant.nome, grapeProfile.clima),
                suelo: buildTerroirBlock('suelo', regionBase.suelo, dominant.nome, grapeProfile.suelo)
            };
        }

        const CATA_BASE_BY_TYPE = {
            es: {
                TO: 'Perfil de tinto estructurado, fruta madura y tanino presente pero pulido.',
                BL: 'Perfil de blanco fresco, acidez viva y paso de boca limpio.',
                ROS: 'Perfil de rosado directo, fruta roja fresca y final ágil.',
                ESP: 'Perfil de espumoso vertical, burbuja fina y sensación refrescante.',
                GEN: 'Perfil intenso y gastronómico, con buena persistencia en boca.',
                DU: 'Perfil goloso equilibrado por acidez, final largo y amable.',
                DEFAULT: 'Perfil equilibrado y fácil de leer: fruta limpia, buena frescura y final claro.'
            },
            en: {
                TO: 'Structured red style with ripe fruit and polished tannin.',
                BL: 'Fresh white profile with lively acidity and clean flow on the palate.',
                ROS: 'Direct rosé profile with fresh red fruit and agile finish.',
                ESP: 'Vertical sparkling profile with fine bubbles and refreshing feel.',
                GEN: 'Intense, gastronomic style with solid persistence.',
                DU: 'Sweet profile balanced by acidity, with a long and friendly finish.',
                DEFAULT: 'Balanced and easy-to-read profile: clean fruit, good freshness, clear finish.'
            },
            pt: {
                TO: 'Perfil de tinto estruturado, fruta madura e tanino presente, porém polido.',
                BL: 'Perfil de branco fresco, acidez viva e passagem de boca limpa.',
                ROS: 'Perfil de rosé direto, fruta vermelha fresca e final ágil.',
                ESP: 'Perfil de espumante vertical, bolha fina e sensação refrescante.',
                GEN: 'Perfil intenso e gastronômico, com boa persistência em boca.',
                DU: 'Perfil doce equilibrado por acidez, final longo e agradável.',
                DEFAULT: 'Perfil equilibrado e fácil de entender: fruta limpa, boa frescura e final claro.'
            }
        };

        const CATA_GRAPE_HINTS = {
            riesling: {
                es: 'Suele mostrar tensión cítrica y gran precisión en final.',
                en: 'Usually shows citrus tension and precise finish.',
                pt: 'Costuma mostrar tensão cítrica e final preciso.'
            },
            chardonnay: {
                es: 'Suele combinar volumen de boca con acidez bien integrada.',
                en: 'Usually combines palate volume with integrated acidity.',
                pt: 'Costuma combinar volume de boca com acidez integrada.'
            },
            godello: {
                es: 'Suele dar textura cremosa con perfil mineral nítido.',
                en: 'Usually brings creamy texture with clear mineral profile.',
                pt: 'Costuma dar textura cremosa com perfil mineral nítido.'
            },
            albarino: {
                es: 'Suele destacar por salinidad fina y final refrescante.',
                en: 'Often stands out for subtle salinity and refreshing finish.',
                pt: 'Costuma destacar-se pela salinidade fina e final refrescante.'
            },
            verdejo: {
                es: 'Suele mostrar perfil herbal-cítrico y trago muy fluido.',
                en: 'Usually shows herbal-citrus profile and very fluid sip.',
                pt: 'Costuma mostrar perfil herbal-cítrico e gole fluido.'
            },
            garnachablanca: {
                es: 'Aporta amplitud de boca sin perder frescura.',
                en: 'Adds palate breadth while keeping freshness.',
                pt: 'Aporta amplitude de boca sem perder frescura.'
            },
            sauvignonblanc: {
                es: 'Marca el vino con perfil aromático vivo y acidez incisiva.',
                en: 'Marks the wine with vivid aromatics and incisive acidity.',
                pt: 'Marca o vinho com perfil aromático vivo e acidez incisiva.'
            }
        };

        function getWineTypeCode(ref) {
            const rawCode = String(ref?.tipo?.codigo || '').trim().toUpperCase();
            if (rawCode) return rawCode;
            const normalizedTipo = normalizeToken(ref?.tipo?.nombre || ref?.tipo?.nome || '');
            if (normalizedTipo.includes('blanc') || normalizedTipo.includes('white')) return 'BL';
            if (normalizedTipo.includes('ros')) return 'ROS';
            if (normalizedTipo.includes('espum') || normalizedTipo.includes('spark')) return 'ESP';
            if (normalizedTipo.includes('dulce') || normalizedTipo.includes('sweet')) return 'DU';
            if (normalizedTipo.includes('generos')) return 'GEN';
            return 'TO';
        }

        function extractWineCataText(ref) {
            const keys = [
                'nota_cata', 'notas_cata', 'notasDeCata', 'cata_resumida', 'cata', 'tasting_notes',
                'Notas de Cata (sommelier simples)', 'notas de cata'
            ];
            for (const key of keys) {
                const extracted = extractTextValue(ref?.[key]);
                if (!extracted) continue;
                const clean = extracted.replace(/\s+/g, ' ').trim();
                if (!clean || /^n\/a$/i.test(clean) || /^na$/i.test(clean) || clean === '—') continue;
                return clean;
            }
            return '';
        }

        const DRINKING_HINT_RE = /\b(beba|beber|drink|drinking|tomar|consumir)\b/i;

        function cleanupCataText(text) {
            return normalizeWhitespaceText(text)
                .replace(/\s+([,.;:!?])/g, '$1')
                .replace(/:\s*/g, ': ')
                .replace(/\s{2,}/g, ' ')
                .trim();
        }

        function stripDrinkingGuidance(text) {
            const lines = splitNaturalSentences(text);
            if (!lines.length) return cleanupCataText(text);

            const kept = lines.filter((line) => !DRINKING_HINT_RE.test(normalizeToken(line)));
            if (kept.length) return cleanupCataText(kept.join(' '));

            return cleanupCataText(String(text || '').replace(/\b(Beba|Beber|Drink|Drinking)\b[^.;!?]*/gi, ''));
        }

        const CATA_LOCALIZATION_RULES = {
            es: [
                [/\bHarmoniza[cç][aã]o\b/gi, 'Armonización'],
                [/\bJovem top\b/gi, 'Joven top'],
                [/\bfrutas vermelhas\b/gi, 'frutas rojas'],
                [/\bfrutas escuras\b/gi, 'frutas negras'],
                [/\bfrutas brancas\b/gi, 'frutas blancas'],
                [/\bfrutas maduras\b/gi, 'frutas maduras'],
                [/\bfrutas vermelhas frescas\b/gi, 'frutas rojas frescas'],
                [/\bfrutas brancas maduras\b/gi, 'frutas blancas maduras'],
                [/\bervas finas\b/gi, 'hierbas finas'],
                [/\bervas mediterr[aâ]neas\b/gi, 'hierbas mediterráneas'],
                [/\bervas\b/gi, 'hierbas'],
                [/\bfrutos do mar\b/gi, 'mariscos'],
                [/\bcarnes leves\b/gi, 'carnes ligeras'],
                [/\bcarne vermelha\b/gi, 'carne roja'],
                [/\bcarne premium\b/gi, 'carne premium'],
                [/\bqueijos?\b/gi, 'quesos'],
                [/\bpeixe\b/gi, 'pescado'],
                [/\bassados\b/gi, 'asados'],
                [/\bca[çc]a\b/gi, 'caza'],
                [/\baperitivo\b/gi, 'aperitivo'],
                [/\bluxo m[aá]ximo\b/gi, 'lujo máximo'],
                [/\bícone\b/gi, 'ícono'],
                [/\blend[aá]rio\b/gi, 'legendario'],
                [/\btop\b/gi, 'top'],
                [/\bcom\b/gi, 'con'],
                [/\bsem\b/gi, 'sin'],
                [/\bmais\b/gi, 'más'],
                [/\be\b/gi, 'y']
            ],
            en: [
                [/\bNariz\b/gi, 'Nose'],
                [/\bBoca\b/gi, 'Palate'],
                [/\bHarmoniza[cç][aã]o\b/gi, 'Pairing'],
                [/\bArmonizaci[oó]n\b/gi, 'Pairing'],
                [/\bfrutas vermelhas\b/gi, 'red fruits'],
                [/\bfrutas rojas\b/gi, 'red fruits'],
                [/\bfrutas escuras\b/gi, 'dark fruits'],
                [/\bfrutas negras\b/gi, 'dark fruits'],
                [/\bfrutas brancas\b/gi, 'white fruits'],
                [/\bfrutas blancas\b/gi, 'white fruits'],
                [/\bervas finas\b/gi, 'fine herbs'],
                [/\bhierbas finas\b/gi, 'fine herbs'],
                [/\bervas\b/gi, 'herbs'],
                [/\bhierbas\b/gi, 'herbs'],
                [/\bfrutos do mar\b/gi, 'seafood'],
                [/\bmariscos\b/gi, 'seafood'],
                [/\bcarnes leves\b/gi, 'light meats'],
                [/\bcarnes ligeras\b/gi, 'light meats'],
                [/\bcarne vermelha\b/gi, 'red meat'],
                [/\bcarne roja\b/gi, 'red meat'],
                [/\bqueijos?\b/gi, 'cheeses'],
                [/\bquesos?\b/gi, 'cheeses'],
                [/\bpeixe\b/gi, 'fish'],
                [/\bpescado\b/gi, 'fish'],
                [/\baves\b/gi, 'poultry'],
                [/\bassados\b/gi, 'roasts'],
                [/\basados\b/gi, 'roasts'],
                [/\bca[çc]a\b/gi, 'game'],
                [/\bluxo m[aá]ximo\b/gi, 'maximum luxury'],
                [/\blujo m[aá]ximo\b/gi, 'maximum luxury'],
                [/\bJovem top\b/gi, 'Young standout'],
                [/\bJoven top\b/gi, 'Young standout']
            ]
        };

        function localizeCataText(text) {
            const lang = ['es', 'en', 'pt'].includes(currentLang) ? currentLang : 'es';
            let localized = cleanupCataText(text);
            const rules = CATA_LOCALIZATION_RULES[lang] || [];
            rules.forEach(([pattern, replacement]) => {
                localized = localized.replace(pattern, replacement);
            });
            return cleanupCataText(localized);
        }

        function extractPrimarySensorySentence(text) {
            const sentences = splitNaturalSentences(text);
            if (!sentences.length) return normalizeWhitespaceText(text);
            const filtered = sentences.filter((line) => {
                const token = normalizeToken(line);
                if (!token) return false;
                if (DRINKING_HINT_RE.test(token)) return false;
                if (/(harmoniz|marida|pairing|jovem top|joven top|young standout|icone|ícone|legendario|lendario)/i.test(token)) return false;
                return true;
            });
            return normalizeWhitespaceText((filtered[0] || sentences[0] || text));
        }

        function getDidacticCataSummary(ref) {
            const provided = extractWineCataText(ref);
            if (provided) {
                const cleanedProvided = localizeCataText(stripDrinkingGuidance(provided));
                if (cleanedProvided) return cleanedProvided;
            }

            const lang = ['es', 'en', 'pt'].includes(currentLang) ? currentLang : 'es';
            const typeCode = getWineTypeCode(ref);
            const typeBase = (CATA_BASE_BY_TYPE[lang] || CATA_BASE_BY_TYPE.es)[typeCode]
                || (CATA_BASE_BY_TYPE[lang] || CATA_BASE_BY_TYPE.es).DEFAULT;

            const dominant = getPredominantGrape(ref?.uvas);
            if (!dominant?.nome) return typeBase;

            const grapeKey = canonicalGrapeKey(dominant.nome);
            const grapeHint = CATA_GRAPE_HINTS[grapeKey]?.[lang] || CATA_GRAPE_HINTS[grapeKey]?.es || '';
            if (!grapeHint) return typeBase;

            if (lang === 'en') return `${typeBase} With ${dominant.nome}, ${grapeHint.toLowerCase()}`;
            if (lang === 'pt') return `${typeBase} Com ${dominant.nome}: ${grapeHint}`;
            return `${typeBase} Con ${dominant.nome}: ${grapeHint}`;
        }

        function normalizeCriticLabel(raw) {
            const key = normalizeToken(raw).replace(/[^a-z0-9]/g, '');
            const map = {
                js: 'JS',
                wa: 'WA',
                rp: 'WA',
                robertparker: 'WA',
                ta: 'TA',
                penin: 'Peñín',
                peñin: 'Peñín',
                ws: 'WS',
                vm: 'VM',
                decanter: 'Decanter',
                jebdunnuck: 'Jeb Dunnuck',
                jd: 'Jeb Dunnuck'
            };
            return map[key] || String(raw || '').trim() || 'Crítico';
        }

        function parseCriticsEntries(source) {
            const out = [];
            const seen = new Set();
            const pushEntry = (label, score) => {
                const cleanLabel = normalizeCriticLabel(label);
                const cleanScore = String(score || '').replace(',', '.').trim();
                if (!cleanScore) return;
                const dedupeKey = `${cleanLabel}:${cleanScore}`;
                if (seen.has(dedupeKey)) return;
                seen.add(dedupeKey);
                out.push({ label: cleanLabel, score: cleanScore });
            };

            if (source && typeof source === 'object' && !Array.isArray(source)) {
                Object.entries(source).forEach(([label, value]) => {
                    const text = extractTextValue(value);
                    const numeric = text.match(/(\d{2,3}(?:[.,]\d+)?\+?)/);
                    if (numeric) pushEntry(label, numeric[1]);
                });
                return out;
            }

            const text = extractTextValue(source);
            if (!text) return out;
            const segments = text.split(/[\n|;]+/).map((s) => s.trim()).filter(Boolean);
            segments.forEach((segment) => {
                if (/n\/a|na|sin\s+puntos?|sem\s+pontos?/i.test(segment)) return;
                const match = segment.match(/^\s*([^:]+)\s*:\s*([0-9]{2,3}(?:[.,]\d+)?\+?)/i);
                if (match) {
                    pushEntry(match[1], match[2]);
                }
            });
            return out;
        }

        function normalizeWhitespaceText(value) {
            return String(value || '').replace(/\s+/g, ' ').trim();
        }

        function clipSentence(text, maxLen = 110) {
            const clean = normalizeWhitespaceText(text);
            if (!clean) return '';
            if (clean.length <= maxLen) return clean;
            const cut = clean.slice(0, maxLen);
            const idx = cut.lastIndexOf(' ');
            return `${(idx > 46 ? cut.slice(0, idx) : cut).trim()}...`;
        }

        function splitNaturalSentences(text) {
            const clean = normalizeWhitespaceText(text);
            if (!clean) return [];
            return clean
                .split(/(?<=[.!?])\s+/)
                .map((line) => line.trim())
                .filter(Boolean);
        }

        function getCataSectionLabels() {
            if (currentLang === 'en') return { nose: 'Nose', palate: 'Palate' };
            return { nose: 'Nariz', palate: 'Boca' };
        }

        function stripCataLabelPrefix(text) {
            return normalizeWhitespaceText(text).replace(/^(nariz|nose|boca|palate)\s*:\s*/i, '').trim();
        }

        function formatCataForDisplay(cataText) {
            const clean = localizeCataText(normalizeWhitespaceText(cataText));
            if (!clean) return '—';

            const labels = getCataSectionLabels();
            const noseMatch = clean.match(/\b(nariz|nose)\s*:/i);
            const palateMatch = clean.match(/\b(boca|palate)\s*:/i);

            let noseText = '';
            let palateText = '';

            if (noseMatch && palateMatch) {
                const noseStart = noseMatch.index ?? -1;
                const palateStart = palateMatch.index ?? -1;

                if (noseStart >= 0 && palateStart >= 0) {
                    if (noseStart < palateStart) {
                        const noseRaw = clean.slice(noseStart, palateStart);
                        const palateRaw = clean.slice(palateStart);
                        noseText = localizeCataText(extractPrimarySensorySentence(stripCataLabelPrefix(noseRaw)));
                        palateText = localizeCataText(extractPrimarySensorySentence(stripCataLabelPrefix(palateRaw)));
                    } else {
                        const palateRaw = clean.slice(palateStart, noseStart);
                        const noseRaw = clean.slice(noseStart);
                        palateText = localizeCataText(extractPrimarySensorySentence(stripCataLabelPrefix(palateRaw)));
                        noseText = localizeCataText(extractPrimarySensorySentence(stripCataLabelPrefix(noseRaw)));
                    }
                }
            } else {
                const sentences = splitNaturalSentences(clean);
                if (sentences.length >= 2) {
                    noseText = localizeCataText(extractPrimarySensorySentence(stripCataLabelPrefix(sentences[0])));
                    palateText = localizeCataText(extractPrimarySensorySentence(stripCataLabelPrefix(sentences[1])));
                } else if (sentences.length === 1) {
                    noseText = localizeCataText(extractPrimarySensorySentence(stripCataLabelPrefix(sentences[0])));
                }
            }

            const lines = [];
            if (noseText) lines.push(`· ${labels.nose}: ${noseText}`);
            if (palateText) lines.push(`· ${labels.palate}: ${palateText}`);

            if (!lines.length) return `· ${clean}`;
            return lines.join('\n\n');
        }

        function extractCataKeyPoints(cataText) {
            const normalizedSource = localizeCataText(stripDrinkingGuidance(cataText));
            const lines = splitNaturalSentences(normalizedSource);
            if (!lines.length) return [];

            const picks = [];
            const pushPick = (regex) => {
                const found = lines.find((line) => regex.test(normalizeToken(line)));
                if (found && !picks.includes(found)) picks.push(found);
            };

            pushPick(/\bnariz\b/);
            pushPick(/\bboca\b/);
            pushPick(/\bharmoniz|marida|pairing\b/);

            if (!picks.length) picks.push(lines[0]);
            return picks.slice(0, 3).map((line) => clipSentence(line, 132));
        }

        function getQuickGuidePills(ref, cataText) {
            const pills = [];
            const typeCode = getWineTypeCode(ref);
            const typeMap = {
                es: { TO: 'Tinto', BL: 'Blanco', ROS: 'Rosado', ESP: 'Espumoso', DU: 'Dulce', GEN: 'Generoso' },
                en: { TO: 'Red', BL: 'White', ROS: 'Rosé', ESP: 'Sparkling', DU: 'Sweet', GEN: 'Fortified' },
                pt: { TO: 'Tinto', BL: 'Branco', ROS: 'Rosé', ESP: 'Espumante', DU: 'Doce', GEN: 'Generoso' }
            };
            const dict = typeMap[currentLang] || typeMap.es;
            const dominant = getPredominantGrape(ref?.uvas);
            const baseType = dict[typeCode] || dict.TO;
            pills.push(dominant?.nome ? `${baseType} · ${dominant.nome}` : baseType);

            const normalizedCata = normalizeToken(cataText);
            const styleHints = [];
            if (/\bdenso|potente|encorpado|eterno/.test(normalizedCata)) styleHints.push(currentLang === 'pt' ? 'Estruturado' : (currentLang === 'en' ? 'Structured' : 'Estructurado'));
            if (/\bfresco|vibrante|tenso/.test(normalizedCata)) styleHints.push(currentLang === 'pt' ? 'Fresco' : (currentLang === 'en' ? 'Fresh' : 'Fresco'));
            if (/\belegante|sedoso|fino/.test(normalizedCata)) styleHints.push(currentLang === 'pt' ? 'Elegante' : (currentLang === 'en' ? 'Elegant' : 'Elegante'));
            if (/\bcomplejo|complexo|profundo/.test(normalizedCata)) styleHints.push(currentLang === 'pt' ? 'Complexo' : (currentLang === 'en' ? 'Complex' : 'Complejo'));
            if (styleHints.length) pills.push(styleHints.slice(0, 2).join(' · '));

            return pills.slice(0, 3);
        }

        function parseCriticsDetailedEntries(source) {
            const byLabel = new Map();
            const upsert = (label, value) => {
                const cleanLabel = normalizeCriticLabel(label);
                const cleanValue = normalizeWhitespaceText(value) || 'N/A';
                if (!cleanLabel) return;
                if (!byLabel.has(cleanLabel) || byLabel.get(cleanLabel) === 'N/A') {
                    byLabel.set(cleanLabel, cleanValue);
                }
            };

            if (source && typeof source === 'object' && !Array.isArray(source)) {
                Object.entries(source).forEach(([label, value]) => {
                    upsert(label, extractTextValue(value) || 'N/A');
                });
            } else {
                const text = extractTextValue(source);
                if (text) {
                    text.split(/[\n|;]+/).map((s) => s.trim()).filter(Boolean).forEach((segment) => {
                        const parts = segment.split(':');
                        if (parts.length < 2) return;
                        const label = parts.shift();
                        const value = parts.join(':').trim();
                        upsert(label, value);
                    });
                }
            }

            const order = ['WA', 'JS', 'TA', 'Peñín', 'WS', 'VM', 'Decanter', 'Jeb Dunnuck'];
            return [...byLabel.entries()]
                .map(([label, value]) => ({ label, value: value || 'N/A' }))
                .sort((a, b) => {
                    const ai = order.indexOf(a.label);
                    const bi = order.indexOf(b.label);
                    if (ai === -1 && bi === -1) return a.label.localeCompare(b.label);
                    if (ai === -1) return 1;
                    if (bi === -1) return -1;
                    return ai - bi;
                });
        }

        function extractCriticsSource(ref) {
            const keys = [
                'card_criticos', 'cardCriticos', 'criticos', 'criticas', 'ratings',
                'Card Críticos', 'card críticos'
            ];
            for (const key of keys) {
                if (!Object.prototype.hasOwnProperty.call(ref || {}, key)) continue;
                const value = ref[key];
                if (value == null) continue;
                return value;
            }
            return null;
        }

        function renderCriticsChips(ref) {
            const entries = parseCriticsEntries(extractCriticsSource(ref));
            if (!entries.length) return '';
            return entries.map((entry) => (
                `<span class="critic-chip">${escapeHtml(entry.label)} ${escapeHtml(entry.score)}</span>`
            )).join('');
        }

        function renderCriticsExpanded(ref) {
            const entries = parseCriticsDetailedEntries(extractCriticsSource(ref));
            if (!entries.length) return '';
            return entries.map((entry) => {
                const isNA = /^n\/?a$/i.test(normalizeWhitespaceText(entry.value));
                return `
                    <div class="critic-row ${isNA ? 'is-na' : 'is-score'}">
                        <span class="critic-name">${escapeHtml(entry.label)}</span>
                        <span class="critic-value">${escapeHtml(entry.value)}</span>
                    </div>
                `;
            }).join('');
        }

        // --- MODAL ---
        const wineModal = document.getElementById('wineModal');
        const editButton = document.getElementById('btnEditWine');
        const adminButton = document.getElementById('adminBtn');
        const logoutButton = document.getElementById('logoutBtn');
        const consumeCavaButton = document.getElementById('btnConsumeCava');
        const consumeBodegaButton = document.getElementById('btnConsumeBodega');
        const consumeQtySelect = document.getElementById('consumeQty');
        const consumeFeedback = document.getElementById('consumeFeedback');
        const syncToast = document.getElementById('syncToast');
        let syncToastTimer = null;

        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    await fetch('/api/auth-logout', { method: 'POST', cache: 'no-store' });
                } catch {}
                clearAuthState();
                window.location.replace('login.html');
            });
        }

        if (adminButton) {
            adminButton.style.display = canOpenReportPage() ? 'inline-flex' : 'none';
            const buttonLabel = currentUserRole === 'user'
                ? (translations[currentLang]?.report || 'Ventas')
                : (translations[currentLang]?.admin || 'Admin');
            adminButton.textContent = buttonLabel;
            adminButton.addEventListener('click', () => {
                window.location.href = 'admin.html';
            });
        }

        const movementLogKey = MOVEMENTS_KEY;

        function getLocalDateKey(dateInput = new Date()) {
            const date = new Date(dateInput);
            if (Number.isNaN(date.getTime())) {
                const fallback = new Date();
                return `${fallback.getFullYear()}-${String(fallback.getMonth() + 1).padStart(2, '0')}-${String(fallback.getDate()).padStart(2, '0')}`;
            }
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getMadridServiceDayKey(dateInput = new Date()) {
            const date = new Date(dateInput);
            const formatter = new Intl.DateTimeFormat('en-GB', {
                timeZone: 'Europe/Madrid',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                hour12: false
            });
            const parts = formatter.formatToParts(date);
            const read = (type) => Number(parts.find((part) => part.type === type)?.value || '0');
            const year = read('year');
            const month = read('month');
            const day = read('day');
            const hour = read('hour');
            const baseUtc = new Date(Date.UTC(year, month - 1, day));
            if (hour < 6) {
                baseUtc.setUTCDate(baseUtc.getUTCDate() - 1);
            }
            return `${baseUtc.getUTCFullYear()}-${String(baseUtc.getUTCMonth() + 1).padStart(2, '0')}-${String(baseUtc.getUTCDate()).padStart(2, '0')}`;
        }

        function readMovementLogStore() {
            return parseJsonObject(localStorage.getItem(movementLogKey));
        }

        function setConsumeFeedback(message) {
            if (!consumeFeedback) return;
            consumeFeedback.textContent = message || '';
        }

        function showSyncToast(message) {
            if (!syncToast) return;
            syncToast.textContent = message || 'Cava Atualizada';
            syncToast.classList.add('show');
            if (syncToastTimer) clearTimeout(syncToastTimer);
            syncToastTimer = window.setTimeout(() => {
                syncToast.classList.remove('show');
            }, 1700);
        }

        function resolveMovementEstablishment() {
            if (EST_KEYS.includes(currentUserScope)) return currentUserScope;
            if (currentFilter !== 'todos') return currentFilter;
            if (EST_KEYS.includes(currentUserEstablishment)) return currentUserEstablishment;
            return null;
        }

        function appendMovementLog(entry) {
            try {
                const today = getLocalDateKey();
                const parsed = readMovementLogStore();
                if (!Array.isArray(parsed[today])) parsed[today] = [];
                parsed[today].push(entry);
                localStorage.setItem(movementLogKey, JSON.stringify(parsed));
                queuePendingMutation({
                    id: createMutationId(),
                    type: 'movement',
                    dateKey: today,
                    payload: entry
                });
                void runRealtimeSyncCycle();
            } catch {
                return;
            }
        }

        function registerConsume(sourceType = 'cava') {
                if (!currentEditPod) return;
                const ref = refs.find(r => r.pod === currentEditPod);
                if (!ref) return;

                const estKey = resolveMovementEstablishment();
                if (!estKey) {
                    setConsumeFeedback(translations[currentLang].consumeNeedFilter || 'Selecione uma planta para registrar retirada.');
                    return;
                }

                if (!ref.establecimientos) ref.establecimientos = {};
                if (!ref.establecimientos[estKey]) ref.establecimientos[estKey] = { pvp: null, unidades: null, localizacion: null };

                const quantity = Number(consumeQtySelect?.value || '1');
                const est = ref.establecimientos[estKey];
                const before = typeof est.unidades === 'number' ? est.unidades : null;

                if (typeof est.unidades === 'number') {
                    const nextValue = Math.max(est.unidades - quantity, 0);
                    est.unidades = nextValue;
                    saveEdit(currentEditPod, `establecimientos.${estKey}.unidades`, nextValue);
                    setConsumeFeedback('');
                } else {
                    setConsumeFeedback('');
                }

                appendMovementLog({
                    at: new Date().toISOString(),
                    user: currentUserName,
                    role: currentUserRole,
                    scope: currentUserScope,
                    source: sourceType === 'bodega' ? 'bodega' : 'cava',
                    establishment: estKey,
                    pod: ref.pod,
                    wine: ref.descripcion || '—',
                    year: ref.ano ?? null,
                    size: ref.formato?.etiqueta || null,
                    qty: quantity,
                    before,
                    after: typeof ref.establecimientos[estKey].unidades === 'number' ? ref.establecimientos[estKey].unidades : null,
                    storageDayKey: getLocalDateKey(),
                    serviceDayKey: getMadridServiceDayKey()
                });

                preProcess();
                updateRefCount();
                openModal(ref);
                showSyncToast(translations[currentLang].consumeToastUpdated || 'Cava Atualizada');
        }

        if (consumeCavaButton) {
            consumeCavaButton.addEventListener('click', () => {
                registerConsume('cava');
            });
        }

        if (consumeBodegaButton) {
            consumeBodegaButton.addEventListener('click', () => {
                registerConsume('bodega');
            });
        }

        function openModal(ref) {
            currentEditPod = ref.pod;
            const badge = getTipoBadge(ref.tipo);

            document.getElementById('modalBadge').className = `badge ${badge.cls}`;
            document.getElementById('modalBadge').textContent = badge.label;
            document.getElementById('modalName').textContent = ref.descripcion || '—';

            // Subtitle: Bodega | Year | Format | POD
            const parts = [ref.bodega, ref.ano, ref.formato?.etiqueta, ref.pod].filter(Boolean);
            document.getElementById('modalSubtitle').textContent = parts.join(' · ') || '—';

            // Grapes
            document.getElementById('modalGrapes').innerHTML = renderGrapeTags(ref.uvas, ref.tipo?.codigo);

            // Detail boxes
            document.getElementById('modalRegion').textContent = fmt(ref.region);
            document.getElementById('modalCountry').textContent = fmt(ref.pais);
            document.getElementById('modalYear').textContent = fmt(ref.ano);
            document.getElementById('modalFormat').textContent = fmt(ref.formato?.etiqueta);

            // Terroir cards
            const terroir = getTerroirInfo(ref.region, ref.pais, ref.uvas);
            document.getElementById('modalClima').textContent = terroir.clima;
            document.getElementById('modalSuelo').textContent = terroir.suelo;

            const cataEl = document.getElementById('modalCata');
            const cataSummary = getDidacticCataSummary(ref);
            if (cataEl) cataEl.textContent = formatCataForDisplay(cataSummary);

            const quickGuideEl = document.getElementById('modalQuickGuide');
            if (quickGuideEl) {
                const pills = getQuickGuidePills(ref, cataSummary);
                quickGuideEl.innerHTML = pills.length
                    ? pills.map((item) => `<span class="guide-pill">${escapeHtml(item)}</span>`).join('')
                    : '';
            }

            const cataPointsEl = document.getElementById('modalCataPoints');
            if (cataPointsEl) {
                const points = extractCataKeyPoints(cataSummary);
                cataPointsEl.innerHTML = points.length
                    ? points.map((item) => `<div class="cata-point">${escapeHtml(item)}</div>`).join('')
                    : '';
            }

            const criticsEl = document.getElementById('modalCritics');
            if (criticsEl) {
                const chipsHtml = renderCriticsChips(ref);
                criticsEl.innerHTML = chipsHtml;
                criticsEl.style.display = chipsHtml ? 'flex' : 'none';
            }
            const criticsExpandedEl = document.getElementById('modalCriticsExpanded');
            if (criticsExpandedEl) {
                const detailedHtml = renderCriticsExpanded(ref);
                criticsExpandedEl.innerHTML = detailedHtml;
                criticsExpandedEl.style.display = detailedHtml ? 'grid' : 'none';
            }

            // Establishment table + mobile compact rows
            const prefixMap = { bodega: 'Bodega', spa: 'Spa', tasca_fina: 'Tasca', victoria: 'Victoria', galeria: 'Galeria' };
            const estRows = EST_KEYS.map((k) => {
                const est = ref.establecimientos?.[k];
                return {
                    key: k,
                    pvp: fmtPrice(est?.pvp),
                    stock: fmt(est?.unidades),
                    location: fmt(formatLocationForUi(k, est?.localizacion).text)
                };
            });

            estRows.forEach((row) => {
                const prefix = prefixMap[row.key];
                if (!prefix) return;
                document.getElementById(`est${prefix}Pvp`).textContent = row.pvp;
                document.getElementById(`est${prefix}Stock`).textContent = row.stock;
                document.getElementById(`est${prefix}Loc`).textContent = row.location;
            });

            const mobileGrid = document.getElementById('estMobileGrid');
            if (mobileGrid) {
                const t = translations[currentLang] || translations.es;
                const pvpLabel = t.pvpLabel || 'PVP';
                const stockLabel = t.stockLabel || 'Stock';
                const locationLabel = t.locationShort || 'Loc.';
                mobileGrid.innerHTML = estRows.map((row) => `
                    <div class="est-mobile-item">
                        <div class="est-mobile-name">${escapeHtml(EST_MOBILE_LABELS[row.key] || EST_LABELS[row.key] || row.key)}</div>
                        <div class="est-mobile-field est-mobile-field--pvp">
                            <span class="est-mobile-field-label">${escapeHtml(pvpLabel)}</span>
                            <span class="est-mobile-field-value is-price">${escapeHtml(row.pvp)}</span>
                        </div>
                        <div class="est-mobile-field est-mobile-field--stock">
                            <span class="est-mobile-field-label">${escapeHtml(stockLabel)}</span>
                            <span class="est-mobile-field-value">${escapeHtml(row.stock)}</span>
                        </div>
                        <div class="est-mobile-field est-mobile-field--location">
                            <span class="est-mobile-field-label">${escapeHtml(locationLabel)}</span>
                            <span class="est-mobile-field-value is-location">${escapeHtml(row.location)}</span>
                        </div>
                    </div>
                `).join('');
            }

            // Reset edit form
            document.getElementById('editForm').classList.remove('visible');
            if (editButton) {
                editButton.style.display = hasEditAccess() ? 'inline-block' : 'none';
            }
            if (consumeQtySelect) consumeQtySelect.value = '1';
            setConsumeFeedback('');

            searchResults.style.display = 'none';
            searchInput.blur();
            wineModal.classList.add('active');
        }

        function closeModal() {
            wineModal.classList.remove('active');
            searchInput.value = '';
        }

        document.getElementById('btnClose').addEventListener('click', closeModal);
        wineModal.addEventListener('click', e => { if (e.target === wineModal) closeModal(); });

        // --- EDIT ---
        document.getElementById('btnEditWine').addEventListener('click', () => {
            if (!hasEditAccess()) return;
            if (!currentEditPod) return;
            const ref = refs.find(r => r.pod === currentEditPod);
            if (!ref) return;

            const editableKeys = getEditableEstablishmentKeys();
            const editableKeySet = new Set(editableKeys);
            EDITABLE_EST_KEYS.forEach((k) => {
                const est = ref.establecimientos?.[k] || {};
                const prefix = EDIT_PREFIX_MAP[k];
                const pvpInput = document.getElementById(`edit${prefix}Pvp`);
                const stockInput = document.getElementById(`edit${prefix}Stock`);
                const locInput = document.getElementById(`edit${prefix}Loc`);
                const canEditScope = editableKeySet.has(k);

                if (pvpInput) {
                    pvpInput.value = est.pvp != null ? est.pvp : '';
                    pvpInput.disabled = !canEditScope;
                }
                if (stockInput) {
                    stockInput.value = est.unidades != null ? est.unidades : '';
                    stockInput.disabled = !canEditScope;
                }
                if (locInput) {
                    const normalizedLoc = normalizeLocationValue(est.localizacion, k) || '';
                    locInput.value = (k === 'victoria' && normalizedLoc)
                        ? (formatLocationForUi('victoria', normalizedLoc).text || '')
                        : normalizedLoc;
                    locInput.disabled = !canEditScope;
                }
            });

            document.getElementById('editForm').classList.add('visible');
            document.getElementById('btnEditWine').style.display = 'none';
        });

        document.getElementById('btnCancelEdit').addEventListener('click', () => {
            document.getElementById('editForm').classList.remove('visible');
            document.getElementById('btnEditWine').style.display = hasEditAccess() ? 'inline-block' : 'none';
        });

        document.getElementById('btnSaveEdit').addEventListener('click', () => {
            if (!hasEditAccess()) return;
            if (!currentEditPod) return;
            const ref = refs.find(r => r.pod === currentEditPod);
            if (!ref) return;
            let hasChanges = false;

            // Save per-establishment fields within the user's allowed scope
            const editableKeys = getEditableEstablishmentKeys();
            editableKeys.forEach(k => {
                if (!ref.establecimientos) ref.establecimientos = {};
                if (!ref.establecimientos[k]) ref.establecimientos[k] = { pvp: null, unidades: null, localizacion: null };
                const est = ref.establecimientos[k];
                const prefix = EDIT_PREFIX_MAP[k];

                const pvpVal = document.getElementById(`edit${prefix}Pvp`).value;
                const pvp = pvpVal !== '' ? Number(pvpVal) : null;
                if (pvp !== est.pvp) {
                    est.pvp = pvp;
                    saveEdit(currentEditPod, `establecimientos.${k}.pvp`, pvp);
                    hasChanges = true;
                }

                const stockVal = document.getElementById(`edit${prefix}Stock`).value;
                const stock = stockVal !== '' ? Number(stockVal) : null;
                if (stock !== est.unidades) {
                    est.unidades = stock;
                    saveEdit(currentEditPod, `establecimientos.${k}.unidades`, stock);
                    hasChanges = true;
                }

                const loc = normalizeLocationValue(document.getElementById(`edit${prefix}Loc`).value, k);
                if (loc !== normalizeLocationValue(est.localizacion, k)) {
                    est.localizacion = loc;
                    saveEdit(currentEditPod, `establecimientos.${k}.localizacion`, loc);
                    hasChanges = true;
                }
            });

            // Recalculate BODEGA price (automatic average)
            if (ref.establecimientos) {
                const prices = ['spa', 'tasca_fina', 'victoria']
                    .map(k => ref.establecimientos[k]?.pvp)
                    .filter(p => p != null);
                const avg = prices.length > 0 ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length) : null;
                if (!ref.establecimientos.bodega) ref.establecimientos.bodega = {};
                if (avg !== ref.establecimientos.bodega.pvp) {
                    ref.establecimientos.bodega.pvp = avg;
                    saveEdit(currentEditPod, 'establecimientos.bodega.pvp', avg);
                    hasChanges = true;
                }
            }

            // Recompute indexes
            preProcess();
            updateRefCount();

            // Refresh modal
            openModal(ref);
            if (hasChanges) {
                showSyncToast(translations[currentLang].consumeToastUpdated || 'Cava Atualizada');
            }
        });

        function isPlainObject(value) {
            return Boolean(value) && typeof value === 'object' && !Array.isArray(value);
        }

        function applyRemoteState(state) {
            if (!isPlainObject(state)) return;
            if (Array.isArray(state.edits)) {
                localStorage.setItem(EDITS_KEY, JSON.stringify(sanitizeEditsForCurrentUi(state.edits)));
            }
            if (isPlainObject(state.movementLog)) {
                localStorage.setItem(MOVEMENTS_KEY, JSON.stringify(state.movementLog));
            }
            rebuildRefsFromLocalSnapshot();
        }

        function mergeRemoteStateWithPending(state, pendingMutations) {
            const mergedEdits = Array.isArray(state?.edits) ? state.edits.map((edit) => ({ ...edit })) : [];
            const mergedMovementLog = isPlainObject(state?.movementLog)
                ? Object.fromEntries(
                    Object.entries(state.movementLog).map(([key, value]) => [key, Array.isArray(value) ? [...value] : []])
                )
                : {};

            if (!Array.isArray(pendingMutations) || pendingMutations.length === 0) {
                return { edits: mergedEdits, movementLog: mergedMovementLog };
            }

            pendingMutations.forEach((mutation) => {
                if (!mutation || typeof mutation !== 'object' || typeof mutation.type !== 'string') return;

                if (mutation.type === 'edit') {
                    const payload = mutation.payload;
                    if (!payload || typeof payload.pod !== 'string' || typeof payload.path !== 'string') return;
                    const nextEdit = {
                        pod: payload.pod,
                        path: payload.path,
                        value: payload.value,
                        updatedAt: payload.updatedAt || new Date().toISOString(),
                        updatedBy: payload.updatedBy || currentUserName
                    };
                    const idx = mergedEdits.findIndex((edit) => edit.pod === nextEdit.pod && edit.path === nextEdit.path);
                    if (idx >= 0) mergedEdits[idx] = nextEdit;
                    else mergedEdits.push(nextEdit);
                    return;
                }

                if (mutation.type === 'movement') {
                    const payload = mutation.payload;
                    if (!payload || typeof payload !== 'object') return;
                    const dateKey = typeof mutation.dateKey === 'string' && mutation.dateKey ? mutation.dateKey : getLocalDateKey(payload.at || new Date());
                    if (!Array.isArray(mergedMovementLog[dateKey])) mergedMovementLog[dateKey] = [];
                    mergedMovementLog[dateKey].push(payload);
                }
            });

            return { edits: mergedEdits, movementLog: mergedMovementLog };
        }

        async function runRealtimeSyncCycle() {
            if (syncInFlight || !baseRefs.length) return;
            if (syncDisabled) return;
            if (!navigator.onLine) return;
            syncInFlight = true;
            let shouldRunAgain = false;
            try {
                const pendingMutations = readPendingMutations();
                const knownRevision = Number(localStorage.getItem(SYNC_REVISION_KEY) || '0');

                const response = await fetch(SYNC_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    cache: 'no-store',
                    body: JSON.stringify({
                        clientId: syncClientId,
                        knownRevision,
                        mutations: pendingMutations
                    })
                });

                if (response.status === 404) {
                    syncDisabled = true;
                    return;
                }
                if (response.status === 401) {
                    clearAuthState();
                    window.location.replace('login.html');
                    return;
                }
                if (!response.ok) return;
                const payload = await response.json();
                if (!payload || payload.ok !== true) return;

                const acknowledgedIds = Array.isArray(payload.acknowledgedMutationIds)
                    ? payload.acknowledgedMutationIds.filter((id) => typeof id === 'string' && id)
                    : [];
                const rejectedIds = Array.isArray(payload.rejectedMutationIds)
                    ? payload.rejectedMutationIds.filter((id) => typeof id === 'string' && id)
                    : [];
                let remainingQueue = pendingMutations;

                if (acknowledgedIds.length > 0 || rejectedIds.length > 0) {
                    const currentQueue = readPendingMutations();
                    const completedSet = new Set([...acknowledgedIds, ...rejectedIds]);
                    remainingQueue = currentQueue.filter((mutation) => {
                        const mutationId = typeof mutation?.id === 'string' ? mutation.id : '';
                        return !completedSet.has(mutationId);
                    });
                    writePendingMutations(remainingQueue);
                    shouldRunAgain = remainingQueue.length > 0;
                }

                const revisionValue = Number(payload.revision);
                if (Number.isFinite(revisionValue) && revisionValue >= 0) {
                    localStorage.setItem(SYNC_REVISION_KEY, String(revisionValue));
                }

                if (isPlainObject(payload.state)) {
                    const shouldApply = acknowledgedIds.length > 0
                        || payload.hasUpdate === true
                        || (Number.isFinite(revisionValue) && revisionValue > knownRevision);
                    if (shouldApply) {
                        const mergedState = mergeRemoteStateWithPending(payload.state, remainingQueue);
                        applyRemoteState(mergedState);
                    }
                }
            } catch {
                return;
            } finally {
                syncInFlight = false;
                if (shouldRunAgain && !syncDisabled) {
                    window.setTimeout(() => {
                        void runRealtimeSyncCycle();
                    }, 120);
                }
            }
        }

        function startRealtimeSync() {
            if (syncTimer) {
                clearInterval(syncTimer);
            }
            void runRealtimeSyncCycle();
            syncTimer = window.setInterval(() => {
                void runRealtimeSyncCycle();
            }, SYNC_INTERVAL_MS);
        }

        window.addEventListener('storage', (event) => {
            if (event.key === EDITS_KEY) {
                rebuildRefsFromLocalSnapshot();
                return;
            }
            if (event.key === MOVEMENTS_KEY) {
                return;
            }
            if (event.key === SYNC_REVISION_KEY) {
                void runRealtimeSyncCycle();
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                void runRealtimeSyncCycle();
            }
        });

        // --- LANGUAGE ---
        function getNextPhrase() {
            if (phraseQueue.length === 0) {
                phraseQueue = [...translations[currentLang].placeholders];
                for (let i = phraseQueue.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [phraseQueue[i], phraseQueue[j]] = [phraseQueue[j], phraseQueue[i]];
                }
                if (phraseQueue[0] === currentPhrase && phraseQueue.length > 1) {
                    phraseQueue.push(phraseQueue.shift());
                }
            }
            return phraseQueue.pop();
        }

        function startTypeWriter() {
            const input = document.getElementById('searchInput');
            if (!input) return;

            if (!currentPhrase) currentPhrase = getNextPhrase();

            if (isDeleting) {
                input.placeholder = currentPhrase.substring(0, charIndex - 1);
                charIndex--;
            } else {
                input.placeholder = currentPhrase.substring(0, charIndex + 1);
                charIndex++;
            }

            let speed = isDeleting ? 20 : 50;

            if (!isDeleting && charIndex === currentPhrase.length) {
                speed = 2000;
                isDeleting = true;
            } else if (isDeleting && charIndex === 0) {
                isDeleting = false;
                currentPhrase = getNextPhrase();
                speed = 500;
            }

            clearTimeout(typeWriterTimeout);
            typeWriterTimeout = setTimeout(startTypeWriter, speed);
        }

        function setLanguage(lang) {
            const safeLang = ['es', 'en', 'pt'].includes(lang) ? lang : 'es';
            currentLang = safeLang;
            const t = translations[safeLang] || translations.es;
            document.documentElement.lang = safeLang;
            document.getElementById('currentLangBtn').textContent = t.btnLabel;

            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (t[key] && el.tagName !== 'INPUT') el.textContent = t[key];
            });

            if (adminButton) {
                adminButton.textContent = currentUserRole === 'user'
                    ? (t.report || 'Ventas')
                    : (t.admin || 'Admin');
            }

            phraseQueue = [];
            currentPhrase = '';
            charIndex = 0;
            isDeleting = false;
            clearTimeout(typeWriterTimeout);
            startTypeWriter();

            // Refresh search results if visible
            triggerSearch();

            // If modal is open, re-render it with the selected language labels/badges.
            if (wineModal.classList.contains('active') && currentEditPod) {
                const liveRef = refs.find((item) => item.pod === currentEditPod);
                if (liveRef) {
                    openModal(liveRef);
                }
            }
        }

        // --- DARK/LIGHT MODE TOGGLE (CANVAS) ---
        const themeToggle = document.getElementById('themeToggle');
        const toggleCanvas = document.getElementById('toggleCanvas');
        const tCtx = toggleCanvas.getContext('2d');
        toggleCanvas.width = 80;
        toggleCanvas.height = 40;

        let isDark = true;
        let toggleProgress = 1;
        const lerp = (a, b, t) => a + (b - a) * t;

        function drawToggle() {
            const w = toggleCanvas.width, h = toggleCanvas.height;
            tCtx.clearRect(0, 0, w, h);

            const r = lerp(96, 30, toggleProgress);
            const g = lerp(165, 27, toggleProgress);
            const b = lerp(250, 75, toggleProgress);
            tCtx.fillStyle = `rgb(${r},${g},${b})`;
            tCtx.beginPath();
            tCtx.roundRect(0, 0, w, h, 20);
            tCtx.fill();

            if (toggleProgress > 0.1) {
                tCtx.fillStyle = `rgba(255,255,255,${toggleProgress})`;
                [{x:20,y:10},{x:40,y:30},{x:15,y:30},{x:50,y:10}].forEach(s => {
                    tCtx.beginPath(); tCtx.arc(s.x, s.y, 1.5, 0, Math.PI*2); tCtx.fill();
                });
            }

            const cloudOp = Math.max(0, 1 - toggleProgress * 2);
            if (cloudOp > 0) {
                tCtx.fillStyle = `rgba(255,255,255,${cloudOp * 0.8})`;
                tCtx.beginPath();
                tCtx.arc(50,30,8,0,Math.PI*2); tCtx.arc(60,35,10,0,Math.PI*2); tCtx.arc(70,30,8,0,Math.PI*2);
                tCtx.fill();
            }

            const cx = lerp(20, w-20, toggleProgress), cy = h/2, rad = 14;
            const ar = lerp(251,226,toggleProgress), ag = lerp(191,232,toggleProgress), ab = lerp(36,240,toggleProgress);
            tCtx.fillStyle = `rgb(${ar},${ag},${ab})`;
            tCtx.shadowBlur = 10;
            tCtx.shadowColor = `rgba(${ar},${ag},${ab},0.5)`;
            tCtx.beginPath(); tCtx.arc(cx, cy, rad, 0, Math.PI*2); tCtx.fill();
            tCtx.shadowBlur = 0;

            if (toggleProgress > 0.1) {
                const maskOff = lerp(rad*2, 6, toggleProgress);
                tCtx.fillStyle = `rgb(${r},${g},${b})`;
                tCtx.beginPath(); tCtx.arc(cx - maskOff, cy - 2, rad, 0, Math.PI*2); tCtx.fill();
            }

            const rayOp = Math.max(0, 1 - toggleProgress * 3);
            if (rayOp > 0) {
                tCtx.strokeStyle = `rgba(251,191,36,${rayOp})`;
                tCtx.lineWidth = 2; tCtx.lineCap = 'round';
                for (let i = 0; i < 6; i++) {
                    const angle = (i * Math.PI * 2) / 6 + (toggleProgress * 2);
                    tCtx.beginPath();
                    tCtx.moveTo(cx + Math.cos(angle)*(rad+3), cy + Math.sin(angle)*(rad+3));
                    tCtx.lineTo(cx + Math.cos(angle)*(rad+7), cy + Math.sin(angle)*(rad+7));
                    tCtx.stroke();
                }
            }

            const target = isDark ? 1 : 0;
            if (Math.abs(toggleProgress - target) > 0.001) {
                toggleProgress += (target - toggleProgress) * 0.1;
                requestAnimationFrame(drawToggle);
            }
        }

        themeToggle.addEventListener('click', () => {
            const scrollX = window.scrollX;
            const scrollY = window.scrollY;
            isDark = !isDark;
            document.body.classList.toggle('light-mode');
            drawToggle();
            requestAnimationFrame(() => {
                window.scrollTo(scrollX, scrollY);
            });
        });

        // --- GOLD PARTICLES ---
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        let particlesArray = [];

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initParticles();
        });

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speedX = Math.random() * 0.5 - 0.25;
                this.speedY = Math.random() * 0.5 - 0.25;
                this.opacity = Math.random() * 0.5 + 0.1;
            }
            update() {
                this.x += this.speedX;
                this.y -= this.speedY;
                if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                if (this.y < 0) this.y = canvas.height;
                if (this.y > canvas.height) this.y = 0;
            }
            draw() {
                ctx.fillStyle = `rgba(212,175,55,${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particlesArray = [];
            const n = Math.round((canvas.width * canvas.height) / 5500 * 2.0);
            for (let i = 0; i < n; i++) particlesArray.push(new Particle());
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particlesArray.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateParticles);
        }

        initParticles();
        animateParticles();
        drawToggle();
        setLanguage('es');

        // --- MOBILE KEYBOARD ---
        const initialVH = window.innerHeight;
        if ('visualViewport' in window) {
            window.visualViewport.addEventListener('resize', () => {
                if (window.visualViewport.height / initialVH < 0.75) {
                    document.body.classList.add('keyboard-open');
                } else {
                    document.body.classList.remove('keyboard-open');
                }
            });
        }

        // Prevent iOS double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', e => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
        }, false);

        // --- PWA ---
        const SW_BUILD_ID = '2026-02-25-b986f476-v3';
        if ('serviceWorker' in navigator) {
            let swRefreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (swRefreshing) return;
                swRefreshing = true;
                window.location.reload();
            });

            navigator.serviceWorker
                .register(`/sw.js?build=${encodeURIComponent(SW_BUILD_ID)}`, { updateViaCache: 'none' })
                .then((registration) => {
                    if (registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (!newWorker) return;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                            }
                        });
                    });
                    registration.update().catch(() => {});
                })
                .catch(() => {});
        }
    </script>
</body>
</html>
