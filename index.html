<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    
    <!-- Build: 2026-02-24-GALICIA-DO -->
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="STOCK Cava">
    <meta name="theme-color" content="#08080b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Carta de vinos premium â€” STOCK Cava Metropolis. Descubre nuestra selecciÃ³n exclusiva de vinos de alta gama.">
    <meta name="keywords" content="vinos, cava, stock cava, carta de vinos, metropolis, vinos premium, bodega">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://stockcava.com/">
    <meta property="og:title" content="STOCK Cava Metropolis">
    <meta property="og:description" content="Carta de vinos premium â€” Descubre nuestra selecciÃ³n exclusiva.">
    <meta property="og:image" content="https://stockcava.com/imgs/icon-512.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://stockcava.com/">
    <meta property="twitter:title" content="STOCK Cava Metropolis">
    <meta property="twitter:description" content="Carta de vinos premium â€” Descubre nuestra selecciÃ³n exclusiva.">
    <meta property="twitter:image" content="https://stockcava.com/imgs/icon-512.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="canonical" href="https://stockcava.com/">
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="imgs/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="imgs/favicon-16x16.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="imgs/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="imgs/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="167x167" href="imgs/apple-touch-icon-ipad.png">
    
    <title>STOCK Cava Metropolis â€” Carta de Vinos Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- PALETA HIGH-CLASS --- */
        :root {
            --bg-color: #08080b;
            --glass-bg: rgba(35, 35, 40, 0.8);
            --glass-border: rgba(212, 175, 55, 0.25);
            --text-main: #FDFBF7;
            --text-muted: #B8B0A0;
            --gold-accent: #D4AF37;
            --gold-light: #F3E5AB;
            --price-bg: rgba(46, 125, 50, 0.15);
            --price-color: #57C25B;
            --minicard-bg: rgba(255, 255, 255, 0.05);
            --field-bg: rgba(255, 255, 255, 0.1);
            --field-border: rgba(255, 255, 255, 0.22);
            --field-border-strong: rgba(255, 255, 255, 0.34);
            --field-focus-ring: rgba(212, 175, 55, 0.28);
            --field-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
            --transition-bounce: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --transition-smooth: all 0.4s ease;
            --ui-entry-duration: 700ms;
            --ui-entry-delay: 120ms;
            --ui-entry-ease: cubic-bezier(0.22, 0.78, 0.28, 1);
        }

        body.light-mode {
            --bg-color: #FDFBF7;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(212, 175, 55, 0.4);
            --text-main: #1A1A1A;
            --text-muted: #666156;
            --gold-accent: #B8860B;
            --gold-light: #D4AF37;
            --price-bg: rgba(46, 125, 50, 0.1);
            --price-color: #2E7D32;
            --minicard-bg: rgba(0, 0, 0, 0.02);
            --field-bg: rgba(244, 239, 228, 0.95);
            --field-border: rgba(131, 99, 24, 0.38);
            --field-border-strong: rgba(131, 99, 24, 0.55);
            --field-focus-ring: rgba(184, 134, 11, 0.26);
            --field-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.72);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scrollbar-gutter: stable both-edges;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            transition: background-color 0.8s ease, color 0.8s ease;
            min-height: 100dvh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 22dvh;
            overflow-x: hidden;
            overflow-y: scroll;
        }

        /* Entrance animation */
        @keyframes fadeSlideUp {
            0% { opacity: 0; transform: translateY(40px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        header { animation: fadeSlideUp 0.8s ease-out both; }
        .search-container { animation: fadeSlideUp 0.8s ease-out 0.15s both; }
        .theme-toggle { animation: fadeSlideUp 0.5s ease-out 0.3s both; }

        /* --- GOLDEN PARTICLES (CANVAS) --- */
        #particleCanvas {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 0;
            pointer-events: none;
        }

        /* --- HEADER --- */
        header {
            margin-top: 0;
            margin-bottom: 2rem;
            text-align: center;
            z-index: 10;
        }

        .title-cava {
            color: var(--gold-accent);
            line-height: 1;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            transition: var(--transition-smooth);
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.8vw;
            margin-bottom: -0.5rem;
        }

        .stock-text {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 7vw;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .cava-text {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            font-weight: 400;
            font-size: 7vw;
        }

        .title-metropolis {
            font-family: 'Montserrat', sans-serif;
            font-size: 10vw;
            letter-spacing: 0.5vw;
            font-weight: 600;
            color: var(--text-main);
            padding: 0 5vw;
            text-shadow:
                0 0 5px rgba(255, 255, 255, 0.6),
                0 0 15px var(--gold-accent),
                0 0 30px rgba(212, 175, 55, 0.4);
        }

        /* --- SEARCH BAR (GLASSMORPHISM) --- */
        .search-container {
            width: 90%;
            max-width: 600px;
            position: relative;
            z-index: 20;
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
        }

        .search-input-wrapper {
            position: relative;
            width: 100%;
        }

        .search-icon {
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px; height: 20px;
            fill: var(--text-muted);
        }

        #searchInput {
            width: 100%;
            padding: 1.2rem 1rem 1.2rem 2rem;
            font-size: 1.3rem;
            font-family: 'Montserrat', sans-serif;
            background: var(--field-bg);
            border: 1px solid var(--field-border);
            border-radius: 30px;
            color: var(--text-main);
            outline: none;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), var(--field-shadow);
            transition: var(--transition-smooth);
        }

        #searchInput:hover {
            border-color: var(--field-border-strong);
        }

        #searchInput:focus {
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 3px var(--field-focus-ring), 0 0 20px rgba(212, 175, 55, 0.18), var(--field-shadow);
        }

        #searchInput:focus-visible {
            outline: none;
        }

        #searchInput::placeholder { color: var(--text-muted); font-weight: 300; }

        .ref-count {
            text-align: center;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            letter-spacing: 1px;
            font-weight: 300;
            order: -1;
        }
        .ref-count span { color: var(--gold-accent); font-weight: 700; }

        /* --- FILTER BAR --- */
        .filter-bar {
            width: 100%;
            margin-top: 0.6rem;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .filter-restaurant-row {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 0.32rem;
            align-items: center;
        }

        .filter-sort-row {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .filter-pill {
            width: 100%;
            height: 38px;
            padding: 0 0.45rem;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-muted);
            font-family: 'Montserrat', sans-serif;
            font-size: clamp(0.56rem, 2.2vw, 0.98rem);
            font-weight: 700;
            letter-spacing: 0.02em;
            line-height: 1.05;
            cursor: pointer;
            transition: all 0.25s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            text-align: center;
        }

        .filter-pill:active { transform: scale(0.95); }

        .filter-pill.active {
            background: var(--gold-accent);
            color: #111;
            border-color: var(--gold-accent);
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
        }

        .sort-toggle {
            height: 38px;
            min-width: 90px;
            padding: 0 0.9rem;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--gold-accent);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.84rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            cursor: pointer;
            transition: all 0.25s ease;
            text-transform: uppercase;
        }
        .sort-toggle:active { transform: scale(0.95); }
        .modal-actions::-webkit-scrollbar,
        .consume-actions::-webkit-scrollbar,
        .edit-actions::-webkit-scrollbar { display: none; }

        /* --- DROPDOWN RESULTS --- */
        #searchResults {
            position: absolute;
            top: 100%;
            left: 0; right: 0;
            background: transparent;
            max-height: 60vh;
            overflow-y: auto;
            display: none;
            z-index: 9999;
        }

        .search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.55rem 1rem;
            margin-bottom: 0.3rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.15s ease, background 0.2s ease;
        }
        .search-item:first-child { margin-top: 2mm; }

        @media (hover: hover) {
            .search-item:hover {
                background: rgba(212, 175, 55, 0.12);
                border-color: var(--gold-accent);
            }
        }
        .search-item:active {
            background: rgba(212, 175, 55, 0.18);
            transform: scale(0.98);
        }

        .item-info { display: flex; flex-direction: column; gap: 0.18rem; flex: 1; min-width: 0; }

        .item-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- GRAPE TAG FAMILIES --- */
        .grape-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.1rem;
        }

        .grape-tag {
            display: inline-block;
            padding: 0.18rem 0.45rem;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            cursor: default;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .grape-tag.iberica-tinta { background: linear-gradient(135deg, #E53935 0%, #D32626 100%); }
        .grape-tag.iberica-tinta.s2 { background: linear-gradient(135deg, #F44336 0%, #E53935 100%); }
        .grape-tag.iberica-tinta.s3 { background: linear-gradient(135deg, #FF6F6F 0%, #F44336 100%); }

        .grape-tag.burgundy { background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%); }
        .grape-tag.burgundy.s2 { background: linear-gradient(135deg, #9333EA 0%, #7C3AED 100%); }
        .grape-tag.burgundy.s3 { background: linear-gradient(135deg, #A855F7 0%, #9333EA 100%); }

        .grape-tag.italiana { background: linear-gradient(135deg, #C23030 0%, #B71C1C 100%); }
        .grape-tag.italiana.s2 { background: linear-gradient(135deg, #D32626 0%, #C23030 100%); }
        .grape-tag.italiana.s3 { background: linear-gradient(135deg, #E53935 0%, #D32626 100%); }

        .grape-tag.aromatico { background: linear-gradient(135deg, #F9A825 0%, #F57F17 100%); }
        .grape-tag.aromatico.s2 { background: linear-gradient(135deg, #FBC02D 0%, #F9A825 100%); }
        .grape-tag.aromatico.s3 { background: linear-gradient(135deg, #FDD835 0%, #FBC02D 100%); }

        .grape-tag.novamundo { background: linear-gradient(135deg, #8B1538 0%, #5F0F1D 100%); }
        .grape-tag.novamundo.s2 { background: linear-gradient(135deg, #A91D3A 0%, #8B1538 100%); }
        .grape-tag.novamundo.s3 { background: linear-gradient(135deg, #C81E4E 0%, #A91D3A 100%); }

        .grape-tag.espumoso { background: linear-gradient(135deg, #EC407A 0%, #D81B60 100%); }
        .grape-tag.espumoso.s2 { background: linear-gradient(135deg, #F06292 0%, #EC407A 100%); }
        .grape-tag.espumoso.s3 { background: linear-gradient(135deg, #F48FB1 0%, #F06292 100%); }

        .badge-row { display: flex; gap: 0.35rem; align-items: center; margin-top: 0.05rem; }

        .badge {
            font-size: 0.58rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 0.18rem 0.45rem;
            border-radius: 4px;
            letter-spacing: 0.8px;
            color: #111;
        }

        .item-region { font-size: 0.72rem; color: var(--text-muted); }

        .item-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.3rem;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .item-price {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            color: var(--price-color);
            font-size: 1.05rem;
            letter-spacing: 0.5px;
        }

        .item-location {
            font-size: 0.75rem;
            color: var(--text-main);
            font-weight: 700;
            letter-spacing: 1.5px;
            font-family: 'Montserrat', monospace;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(180, 135, 25, 0.2));
            border: 1px solid var(--gold-accent);
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            display: inline-block;
            box-shadow: 0 2px 6px rgba(212, 175, 55, 0.15);
            white-space: nowrap;
        }

        .item-pod {
            font-size: 0.55rem;
            color: var(--text-muted);
            font-family: 'Montserrat', monospace;
            opacity: 0.6;
            letter-spacing: 0.5px;
        }

        .item-format {
            font-size: 0.6rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.25s ease, visibility 0s linear 0.25s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transition: opacity 0.25s ease;
        }

        .modal-card {
            width: 90%;
            max-width: 500px;
            background: var(--bg-color);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            position: relative;
            transform: translateY(18px) scale(0.985);
            opacity: 0;
            transition: transform 0.26s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.22s ease;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            max-height: 90dvh;
            overflow-y: auto;
        }

        .modal-overlay.active .modal-card {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .btn-close {
            position: absolute;
            top: 1.5rem; right: 1.5rem;
            background: none; border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        .btn-close:hover { color: var(--gold-accent); transform: scale(1.1); }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            line-height: 1.3;
            color: var(--text-main);
            margin: 1rem 0 0.5rem 0;
            padding-right: 20px;
        }

        .modal-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .modal-grapes {
            margin-bottom: 1rem;
        }
        .modal-grapes .grape-tag {
            font-size: 0.7rem;
            padding: 0.3rem 0.5rem;
        }

        /* Details grid for D.O., Country, Year, Format */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1.2rem;
        }

        .detail-box {
            background: var(--minicard-bg);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 12px;
            padding: 0.8rem;
            text-align: center;
        }

        .detail-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 0.2rem;
        }

        .detail-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            color: var(--text-main);
            font-weight: 600;
        }

        /* Terroir section (Clima & Suelo) */
        .terroir-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1.2rem;
        }

        .terroir-label {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--gold-accent);
            opacity: 0.7;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .terroir-box {
            background: linear-gradient(135deg, rgba(100,180,255,0.04), var(--minicard-bg));
            border: 1px solid rgba(100, 180, 255, 0.12);
            border-radius: 12px;
            padding: 0.8rem;
            text-align: center;
        }

        .terroir-box .detail-value {
            font-size: 0.82rem;
            line-height: 1.42;
            white-space: pre-line;
            text-align: left;
        }

        /* Establishment pricing table */
        .est-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.2rem;
        }

        .est-table th {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gold-accent);
            padding: 0.5rem 0.3rem;
            border-bottom: 1px solid var(--glass-border);
            text-align: center;
        }

        .est-table td {
            font-size: 0.85rem;
            color: var(--text-main);
            padding: 0.4rem 0.3rem;
            text-align: center;
            border-bottom: 1px solid rgba(212, 175, 55, 0.08);
        }

        .est-table .row-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: left;
            font-weight: 600;
        }

        .est-table .pvp-cell {
            font-weight: 900;
            color: var(--price-color);
            font-size: 1rem;
        }

        .est-table .loc-cell {
            font-family: 'Montserrat', monospace;
            font-weight: 700;
            letter-spacing: 1px;
            font-size: 0.8rem;
        }

        /* --- THEME TOGGLE --- */
        .top-actions {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 7px;
            align-items: flex-end;
        }

        .top-left-actions {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 7px;
            align-items: flex-start;
        }

        @keyframes dropToPlace {
            0% { transform: translateY(-26px) scale(0.96); }
            60% { transform: translateY(2px) scale(1.005); }
            100% { transform: translateY(0) scale(1); }
        }

        @keyframes slideFromRight {
            0% { transform: translateX(28px) scale(0.97); }
            70% { transform: translateX(-1px) scale(1.002); }
            100% { transform: translateX(0) scale(1); }
        }

        @keyframes slideFromLeft {
            0% { opacity: 0; transform: translateX(-28px) scale(0.97); }
            70% { opacity: 1; transform: translateX(1px) scale(1.002); }
            100% { opacity: 1; transform: translateX(0) scale(1); }
        }

        @keyframes riseFromBottom {
            0% { transform: translateY(18px) scale(0.965); }
            65% { transform: translateY(-1px) scale(1.002); }
            100% { transform: translateY(0) scale(1); }
        }

        @keyframes dropFromTopCard {
            0% { opacity: 0; transform: translate(-50%, -26px) scale(0.97); }
            70% { opacity: 1; transform: translate(-50%, 1px) scale(1.002); }
            100% { opacity: 1; transform: translate(-50%, 0) scale(1); }
        }

        .theme-toggle {
            width: 60px; height: 30px;
            border-radius: 15px;
            background: transparent;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            overflow: hidden;
            padding: 0;
            transition: all 0.28s ease;
            animation: dropToPlace var(--ui-entry-duration) var(--ui-entry-ease) var(--ui-entry-delay) both;
        }

        .theme-toggle:hover {
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
            transform: scale(1.05);
        }

        #toggleCanvas { width: 100%; height: 100%; display: block; }

        /* --- LANGUAGE SELECTOR --- */
        .lang-container {
            position: relative;
            z-index: 2;
            font-family: 'Montserrat', sans-serif;
            animation: slideFromRight var(--ui-entry-duration) var(--ui-entry-ease) var(--ui-entry-delay) both;
        }

        .app-signature {
            position: fixed;
            left: 50%;
            bottom: max(10px, env(safe-area-inset-bottom));
            transform: translateX(-50%);
            z-index: 1;
            pointer-events: none;
            user-select: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            font-size: clamp(0.62rem, 1.6vw, 0.78rem);
            letter-spacing: 0.16em;
            color: var(--text-muted);
            opacity: 0.24;
            text-transform: lowercase;
            white-space: nowrap;
            text-shadow: 0 0 14px rgba(212, 175, 55, 0.12);
        }

        .session-user-card {
            position: fixed;
            top: max(10px, env(safe-area-inset-top));
            left: 50%;
            transform: translateX(-50%);
            z-index: 110;
            width: max-content;
            min-width: 0;
            max-width: min(88vw, 420px);
            padding: 8px 14px;
            border-radius: 14px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.78rem;
            font-weight: 600;
            letter-spacing: 0.03em;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 16px rgba(0,0,0,0.24);
            pointer-events: none;
            animation: dropFromTopCard var(--ui-entry-duration) var(--ui-entry-ease) var(--ui-entry-delay) both;
        }
        .logout-btn,
        .admin-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            width: 60px;
            height: 30px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.62rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            padding: 0;
            backdrop-filter: blur(10px);
            transition: all 0.28s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1;
            font-family: 'Montserrat', sans-serif;
        }
        .admin-btn {
            animation: riseFromBottom var(--ui-entry-duration) var(--ui-entry-ease) var(--ui-entry-delay) both;
        }
        .logout-btn {
            animation: slideFromLeft var(--ui-entry-duration) var(--ui-entry-ease) var(--ui-entry-delay) both;
        }
        .logout-btn:hover,
        .admin-btn:hover {
            border-color: var(--gold-accent);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
        }

        .lang-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            width: 60px; height: 30px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.68rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center; gap: 4px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .lang-btn:hover {
            border-color: var(--gold-accent);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
        }

        .lang-dropdown {
            position: absolute;
            top: 120%; right: 0;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            overflow: hidden;
            opacity: 0; visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition-smooth);
            backdrop-filter: blur(15px);
            min-width: 100px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .lang-container:hover .lang-dropdown {
            opacity: 1; visibility: visible;
            transform: translateY(0);
        }

        .lang-option {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 20px;
            color: var(--text-main);
            text-decoration: none;
            font-size: 0.9rem;
            transition: background 0.3s;
            cursor: pointer;
        }
        .lang-option:hover { background: rgba(212, 175, 55, 0.1); }

        @media (prefers-reduced-motion: reduce) {
            .theme-toggle,
            .lang-container,
            .admin-btn,
            .logout-btn,
            .session-user-card {
                animation: none !important;
            }
        }

        /* Badge colors */
        .b-tinto { background: #800020; color: #FFF; }
        .b-branco { background: #E5C158; }
        .b-rosado { background: #E08D79; }
        .b-espumoso { background: #D4AF37; }
        .b-generoso { background: #C97B1A; color: #FFF; }
        .b-dulce { background: #8B6914; color: #FFF; }

        /* Edit form */
        .edit-form { display: none; margin-top: 1rem; }
        .edit-form.visible { display: block; }

        .edit-field {
            padding: 0.7rem;
            border-radius: 8px;
            border: 1px solid var(--field-border);
            background: var(--field-bg);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            width: 100%;
            box-shadow: var(--field-shadow);
        }
        .edit-field:hover { border-color: var(--field-border-strong); }
        .edit-field:focus {
            outline: none;
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 3px var(--field-focus-ring), var(--field-shadow);
        }
        .edit-field:focus-visible { outline: none; }

        .edit-section-title {
            font-size: 0.65rem;
            color: var(--gold-accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 0.8rem;
            margin-bottom: 0.3rem;
            font-weight: 700;
        }

        .edit-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .edit-row .edit-field { flex: 1; }

        .edit-actions {
            display: flex;
            gap: 0.6rem;
            justify-content: flex-end;
            margin-top: 0.8rem;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .btn-cancel {
            padding: 0.6rem 0.9rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .btn-save {
            padding: 0.6rem 0.9rem;
            border-radius: 8px;
            border: none;
            background: var(--gold-accent);
            color: #111;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .btn-edit {
            padding: 0.6rem 0.9rem;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-main);
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .modal-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.7rem;
            margin-top: 0.35rem;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .consume-actions {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            flex-wrap: nowrap;
            flex: 0 0 auto;
            min-width: max-content;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .consume-qty {
            height: 36px;
            min-width: 62px;
            border-radius: 10px;
            border: 1px solid var(--field-border);
            background: var(--field-bg);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            padding: 0 8px;
            outline: none;
            cursor: pointer;
            box-shadow: var(--field-shadow);
            transition: var(--transition-smooth);
            flex: 0 0 auto;
        }

        .consume-qty:hover {
            border-color: var(--field-border-strong);
        }

        .consume-qty:focus {
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 3px var(--field-focus-ring), var(--field-shadow);
        }

        .consume-qty:focus-visible {
            outline: none;
        }

        .btn-consume {
            min-width: 78px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid rgba(255, 84, 84, 0.45);
            background: rgba(168, 19, 19, 0.22);
            color: #ff5d5d;
            cursor: pointer;
            font-size: 0.84rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            padding: 0 10px;
            transition: all 0.25s ease;
            box-shadow: 0 4px 14px rgba(120, 10, 10, 0.28);
            flex: 0 0 auto;
        }

        .btn-consume.btn-consume-cava:hover {
            background: rgba(186, 27, 27, 0.36);
            border-color: rgba(255, 111, 111, 0.55);
            box-shadow: 0 6px 18px rgba(120, 10, 10, 0.38);
        }

        .btn-consume.btn-consume-bodega {
            border-color: rgba(240, 178, 42, 0.52);
            background: rgba(181, 116, 15, 0.26);
            color: #f8c04f;
            box-shadow: 0 4px 14px rgba(126, 79, 8, 0.3);
        }

        .btn-consume.btn-consume-bodega:hover {
            background: rgba(201, 133, 20, 0.37);
            border-color: rgba(255, 201, 88, 0.62);
            box-shadow: 0 6px 18px rgba(126, 79, 8, 0.4);
        }

        .consume-feedback {
            margin-top: 0.5rem;
            min-height: 1.1rem;
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .sync-toast {
            position: fixed;
            left: 50%;
            bottom: max(18px, env(safe-area-inset-bottom));
            transform: translate(-50%, 120%);
            z-index: 1300;
            min-width: 200px;
            max-width: min(92vw, 420px);
            padding: 11px 16px;
            border-radius: 12px;
            border: 1px solid rgba(95, 218, 134, 0.5);
            background: rgba(20, 112, 53, 0.95);
            color: #e9fff1;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.84rem;
            font-weight: 700;
            text-align: center;
            letter-spacing: 0.02em;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.32);
            backdrop-filter: blur(8px);
            opacity: 0;
            pointer-events: none;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .sync-toast.show {
            transform: translate(-50%, 0);
            opacity: 1;
        }

        @media (max-width: 600px) {
            .title-cava { gap: 1vw; margin-bottom: -0.3rem; }
            .stock-text { font-size: 7.5vw; letter-spacing: 0.05em; }
            .cava-text { font-size: 7.5vw; }
            .title-metropolis { font-size: 11vw; letter-spacing: 1px; padding: 0 20px; }
            .modal-card { padding: 1.5rem; max-height: 85dvh; }
            .modal-title { font-size: 1.5rem; }
            #searchInput { font-size: 1rem; padding: 1rem 1rem 1rem 2rem; }
            body { padding-top: 18dvh; }
            .top-left-actions { top: 15px; left: 15px; gap: 7px; }
            .top-actions { top: 15px; right: 15px; gap: 7px; }
            .session-user-card { top: max(8px, env(safe-area-inset-top)); }
            .filter-restaurant-row {
                gap: 0.22rem;
            }
            .filter-pill {
                height: 36px;
                border-radius: 16px;
                padding: 0 0.2rem;
                font-size: clamp(0.52rem, 2.2vw, 0.82rem);
                letter-spacing: 0.01em;
            }
            .sort-toggle {
                height: 36px;
                min-width: 80px;
                border-radius: 16px;
                font-size: 0.74rem;
                padding: 0 0.8rem;
            }

            .modal-actions {
                flex-direction: row;
                align-items: center;
                gap: 0.45rem;
            }

            .consume-actions {
                width: auto;
                justify-content: flex-start;
                gap: 0.35rem;
            }

            .btn-edit {
                align-self: auto;
                flex: 0 0 auto;
            }
        }

        @media (max-width: 420px) {
            .filter-restaurant-row {
                gap: 0.18rem;
            }
            .filter-pill {
                height: 34px;
                border-radius: 14px;
                padding: 0 0.15rem;
                font-size: clamp(0.5rem, 2.1vw, 0.74rem);
                letter-spacing: 0;
            }
            .sort-toggle {
                height: 34px;
                min-width: 72px;
                border-radius: 14px;
                padding: 0 0.65rem;
                font-size: 0.68rem;
            }
            .modal-card {
                width: 94%;
                padding: 1.25rem;
            }

            .consume-qty {
                min-width: 58px;
                height: 34px;
                font-size: 0.84rem;
                padding: 0 6px;
            }

            .btn-consume {
                min-width: 72px;
                height: 34px;
                font-size: 0.78rem;
                padding: 0 8px;
                letter-spacing: 0.03em;
            }
        }

        @media (max-width: 360px) {
            .modal-card {
                padding: 1.1rem;
            }

            .consume-actions {
                gap: 0.28rem;
            }

            .consume-qty {
                min-width: 54px;
                font-size: 0.8rem;
            }

            .btn-consume {
                min-width: 67px;
                font-size: 0.74rem;
                padding: 0 7px;
            }
        }

        body.keyboard-open { padding-top: 2dvh; }
        body.keyboard-open header { display: none; }
    </style>
</head>
<body>

    <script>
        (() => {
            try {
                const EST_KEYS = ['bodega', 'spa', 'tasca_fina', 'victoria', 'galeria'];
                const AUTH_KEYS = {
                    sessionFlag: 'cava_login_demo',
                    sessionUser: 'cava_login_user',
                    sessionEstablishment: 'cava_login_establishment',
                    sessionRole: 'cava_login_role',
                    sessionScope: 'cava_login_scope',
                    persistentFlag: 'cava_login_persistent_access',
                    persistentUser: 'cava_login_persistent_user',
                    persistentEstablishment: 'cava_login_persistent_establishment',
                    persistentRole: 'cava_login_persistent_role',
                    persistentScope: 'cava_login_persistent_scope'
                };
                const normalizeUsername = (value) => (value || '').trim().toLowerCase();
                const normalizeEstablishment = (value) => {
                    const normalized = (value || '').trim().toLowerCase();
                    return EST_KEYS.includes(normalized) ? normalized : null;
                };
                const normalizeScope = (value) => {
                    const normalized = (value || '').trim().toLowerCase();
                    return EST_KEYS.includes(normalized) || normalized === 'all' ? normalized : null;
                };
                const normalizeRole = (value) => {
                    const normalized = (value || '').trim().toLowerCase();
                    return ['user', 'admin', 'adminmaster'].includes(normalized) ? normalized : null;
                };
                const clearAuthState = () => {
                    sessionStorage.removeItem(AUTH_KEYS.sessionFlag);
                    sessionStorage.removeItem(AUTH_KEYS.sessionUser);
                    sessionStorage.removeItem(AUTH_KEYS.sessionEstablishment);
                    sessionStorage.removeItem(AUTH_KEYS.sessionRole);
                    sessionStorage.removeItem(AUTH_KEYS.sessionScope);
                    localStorage.removeItem(AUTH_KEYS.persistentFlag);
                    localStorage.removeItem(AUTH_KEYS.persistentUser);
                    localStorage.removeItem(AUTH_KEYS.persistentEstablishment);
                    localStorage.removeItem(AUTH_KEYS.persistentRole);
                    localStorage.removeItem(AUTH_KEYS.persistentScope);
                };
                const hasLocalSession = () => {
                    const sessionUser = String(sessionStorage.getItem(AUTH_KEYS.sessionUser) || '').trim();
                    const sessionFlag = sessionStorage.getItem(AUTH_KEYS.sessionFlag) === 'ok';
                    if (sessionFlag && sessionUser) return true;
                    const persistentFlag = localStorage.getItem(AUTH_KEYS.persistentFlag) === '1';
                    const persistentUser = String(localStorage.getItem(AUTH_KEYS.persistentUser) || '').trim();
                    return persistentFlag && Boolean(persistentUser);
                };

                const xhr = new XMLHttpRequest();
                xhr.open('GET', '/api/auth-session', false);
                xhr.setRequestHeader('Accept', 'application/json');
                xhr.send(null);
                if (xhr.status !== 200) {
                    const unauthorized = xhr.status === 401 || xhr.status === 403;
                    if (unauthorized || !hasLocalSession()) {
                        clearAuthState();
                        window.location.replace('login.html');
                    }
                    return;
                }

                const payload = JSON.parse(xhr.responseText || '{}');
                if (!payload?.ok || !payload?.user) {
                    if (!hasLocalSession()) {
                        clearAuthState();
                        window.location.replace('login.html');
                    }
                    return;
                }

                const user = payload.user;
                const username = String(user.username || '').trim();
                const role = normalizeRole(user.role) || 'user';
                const scope = normalizeScope(user.scope) || 'spa';
                const savedEstablishment = normalizeEstablishment(localStorage.getItem(AUTH_KEYS.persistentEstablishment)) || 'spa';
                const establishment = scope === 'all'
                    ? 'spa'
                    : (EST_KEYS.includes(scope) ? scope : savedEstablishment);

                sessionStorage.setItem(AUTH_KEYS.sessionFlag, 'ok');
                sessionStorage.setItem(AUTH_KEYS.sessionUser, username);
                sessionStorage.setItem(AUTH_KEYS.sessionEstablishment, establishment);
                sessionStorage.setItem(AUTH_KEYS.sessionRole, role);
                sessionStorage.setItem(AUTH_KEYS.sessionScope, scope);

                if (localStorage.getItem(AUTH_KEYS.persistentFlag) === '1') {
                    localStorage.setItem(AUTH_KEYS.persistentUser, username);
                    localStorage.setItem(AUTH_KEYS.persistentEstablishment, establishment);
                    localStorage.setItem(AUTH_KEYS.persistentRole, role);
                    localStorage.setItem(AUTH_KEYS.persistentScope, scope);
                }
            } catch {
                const sessionUser = String(sessionStorage.getItem('cava_login_user') || '').trim();
                const sessionFlag = sessionStorage.getItem('cava_login_demo') === 'ok';
                const persistentFlag = localStorage.getItem('cava_login_persistent_access') === '1';
                const persistentUser = String(localStorage.getItem('cava_login_persistent_user') || '').trim();
                if ((sessionFlag && sessionUser) || (persistentFlag && persistentUser)) {
                    return;
                }
                sessionStorage.removeItem('cava_login_demo');
                sessionStorage.removeItem('cava_login_user');
                sessionStorage.removeItem('cava_login_establishment');
                sessionStorage.removeItem('cava_login_role');
                sessionStorage.removeItem('cava_login_scope');
                localStorage.removeItem('cava_login_persistent_access');
                localStorage.removeItem('cava_login_persistent_user');
                localStorage.removeItem('cava_login_persistent_establishment');
                localStorage.removeItem('cava_login_persistent_role');
                localStorage.removeItem('cava_login_persistent_scope');
                window.location.replace('login.html');
            }
        })();
    </script>

    <canvas id="particleCanvas"></canvas>

    <div class="app-signature" aria-hidden="true">stockcava@2026</div>
    <div class="session-user-card" id="sessionUserCard">--</div>
    <div class="sync-toast" id="syncToast">Cava Atualizada</div>
    <div class="top-left-actions">
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <div class="top-actions">
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle Theme">
            <canvas id="toggleCanvas"></canvas>
        </button>

        <div class="lang-container">
            <button class="lang-btn" id="currentLangBtn">ES</button>
            <div class="lang-dropdown">
                <div class="lang-option" onclick="setLanguage('es')"><span>ðŸ‡ªðŸ‡¸</span> EspaÃ±ol</div>
                <div class="lang-option" onclick="setLanguage('en')"><span>ðŸ‡¬ðŸ‡§</span> English</div>
                <div class="lang-option" onclick="setLanguage('pt')"><span>ðŸ‡§ðŸ‡·</span> PortuguÃªs</div>
            </div>
        </div>

        <button class="admin-btn" id="adminBtn" data-translate="admin">Admin</button>
    </div>

    <header>
        <div class="title-cava">
            <span class="stock-text">STOCK</span>
            <span class="cava-text">Cava</span>
        </div>
        <div class="title-metropolis">METROPOLIS</div>
    </header>

    <div class="search-container">
        <div class="ref-count"><span id="totalRef">0</span> <span data-translate="refs">referencias disponibles</span></div>

        <div class="search-input-wrapper">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="searchInput" placeholder="" autocomplete="off">
        </div>

        <!-- Filter Pills + Sort Toggle -->
        <div class="filter-bar">
            <div class="filter-restaurant-row">
                <button class="filter-pill active" data-filter="bodega">BODEGA -2</button>
                <button class="filter-pill" data-filter="spa">SPA</button>
                <button class="filter-pill" data-filter="tasca_fina">TASCA</button>
                <button class="filter-pill" data-filter="victoria">VICTORIA</button>
                <button class="filter-pill" data-filter="galeria">GALERIA</button>
            </div>
            <div class="filter-sort-row">
                <button class="sort-toggle" id="sortToggle">ABC</button>
            </div>
        </div>

        <div id="searchResults"></div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="wineModal">
        <div class="modal-card">
            <button class="btn-close" id="btnClose">âœ•</button>

            <span class="badge" id="modalBadge">TINTO</span>
            <h2 class="modal-title" id="modalName">â€”</h2>
            <div class="modal-subtitle" id="modalSubtitle">â€”</div>

            <div class="modal-grapes" id="modalGrapes"></div>

            <div class="details-grid">
                <div class="detail-box">
                    <div class="detail-label">D.O. / <span data-translate="region">RegiÃ³n</span></div>
                    <div class="detail-value" id="modalRegion">â€”</div>
                </div>
                <div class="detail-box">
                    <div class="detail-label" data-translate="country">PaÃ­s</div>
                    <div class="detail-value" id="modalCountry">â€”</div>
                </div>
                <div class="detail-box">
                    <div class="detail-label" data-translate="year">AÃ±o</div>
                    <div class="detail-value" id="modalYear">â€”</div>
                </div>
                <div class="detail-box">
                    <div class="detail-label" data-translate="format">Formato</div>
                    <div class="detail-value" id="modalFormat" style="font-size:0.8rem;">â€”</div>
                </div>
            </div>

            <!-- Terroir: Clima & Suelo -->
            <div class="terroir-label">â˜ <span data-translate="terroir">Terroir</span></div>
            <div class="terroir-grid">
                <div class="terroir-box">
                    <div class="detail-label">â˜ <span data-translate="climate">Clima</span></div>
                    <div class="detail-value" id="modalClima">â€”</div>
                </div>
                <div class="terroir-box">
                    <div class="detail-label">â›° <span data-translate="soil">Suelo</span></div>
                    <div class="detail-value" id="modalSuelo">â€”</div>
                </div>
            </div>

            <!-- Establishment Pricing Table -->
            <table class="est-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>BODEGA -2</th>
                        <th>SPA</th>
                        <th>TASCA FINA</th>
                        <th>VICTORIA</th>
                        <th>GALERIA</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label" data-translate="pvpLabel">PVP</td>
                        <td class="pvp-cell" id="estBodegaPvp">â€”</td>
                        <td class="pvp-cell" id="estSpaPvp">â€”</td>
                        <td class="pvp-cell" id="estTascaPvp">â€”</td>
                        <td class="pvp-cell" id="estVictoriaPvp">â€”</td>
                        <td class="pvp-cell" id="estGaleriaPvp">â€”</td>
                    </tr>
                    <tr>
                        <td class="row-label" data-translate="stockLabel">Stock</td>
                        <td id="estBodegaStock">â€”</td>
                        <td id="estSpaStock">â€”</td>
                        <td id="estTascaStock">â€”</td>
                        <td id="estVictoriaStock">â€”</td>
                        <td id="estGaleriaStock">â€”</td>
                    </tr>
                    <tr>
                        <td class="row-label loc-cell" data-translate="locationShort">Ubic.</td>
                        <td class="loc-cell" id="estBodegaLoc">â€”</td>
                        <td class="loc-cell" id="estSpaLoc">â€”</td>
                        <td class="loc-cell" id="estTascaLoc">â€”</td>
                        <td class="loc-cell" id="estVictoriaLoc">â€”</td>
                        <td class="loc-cell" id="estGaleriaLoc">â€”</td>
                    </tr>
                </tbody>
            </table>

            <div class="modal-actions">
                <div class="consume-actions">
                    <select class="consume-qty" id="consumeQty" aria-label="Cantidad">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                    <button class="btn-consume btn-consume-cava" id="btnConsumeCava" aria-label="Registrar salida de cava">Cava</button>
                    <button class="btn-consume btn-consume-bodega" id="btnConsumeBodega" aria-label="Registrar salida de BODEGA -2">BODEGA -2</button>
                </div>

                <button class="btn-edit" id="btnEditWine" data-translate="editBtn">Editar</button>
            </div>

            <div class="consume-feedback" id="consumeFeedback"></div>

            <!-- Edit form -->
            <div class="edit-form" id="editForm">
                <div style="display:flex;flex-direction:column;gap:0.4rem;">
                    <div class="edit-section-title">SPA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editSpaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editSpaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editSpaLoc" type="text" placeholder="0Â·0Â·POS" style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-section-title">TASCA FINA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editTascaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editTascaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editTascaLoc" type="text" placeholder="0Â·0Â·POS" style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-section-title">VICTORIA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editVictoriaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editVictoriaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editVictoriaLoc" type="text" placeholder="0Â·0Â·POS" style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-section-title">GALERIA</div>
                    <div class="edit-row">
                        <input class="edit-field" id="editGaleriaPvp" type="number" placeholder="PVP">
                        <input class="edit-field" id="editGaleriaStock" type="number" placeholder="Stock">
                        <input class="edit-field" id="editGaleriaLoc" type="text" placeholder="0Â·0Â·POS" style="text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                    </div>

                    <div class="edit-actions">
                        <button class="btn-cancel" id="btnCancelEdit" data-translate="cancelBtn">Cancelar</button>
                        <button class="btn-save" id="btnSaveEdit" data-translate="saveBtn">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ==========================================================
           CAVA METROPOLIS â€” Multi-Establishment Wine Management
           ========================================================== */

        const AUTH_KEYS = {
            sessionFlag: 'cava_login_demo',
            sessionUser: 'cava_login_user',
            sessionEstablishment: 'cava_login_establishment',
            sessionRole: 'cava_login_role',
            sessionScope: 'cava_login_scope',
            persistentFlag: 'cava_login_persistent_access',
            persistentUser: 'cava_login_persistent_user',
            persistentEstablishment: 'cava_login_persistent_establishment',
            persistentRole: 'cava_login_persistent_role',
            persistentScope: 'cava_login_persistent_scope'
        };

        // --- CONSTANTS ---
        const EST_KEYS = ['bodega', 'spa', 'tasca_fina', 'victoria', 'galeria'];
        const EDITABLE_EST_KEYS = ['spa', 'tasca_fina', 'victoria', 'galeria'];
        const EDIT_PREFIX_MAP = { spa: 'Spa', tasca_fina: 'Tasca', victoria: 'Victoria', galeria: 'Galeria' };
        const EST_LABELS = { bodega: 'BODEGA -2', spa: 'SPA', tasca_fina: 'TASCA FINA', victoria: 'VICTORIA', galeria: 'GALERIA' };

        const TIPO_MAP = {
            'TO':  { cls: 'b-tinto',    es: 'TINTO',    en: 'RED',       pt: 'TINTO' },
            'BL':  { cls: 'b-branco',   es: 'BLANCO',   en: 'WHITE',     pt: 'BRANCO' },
            'ROS': { cls: 'b-rosado',   es: 'ROSADO',   en: 'ROSÃ‰',      pt: 'ROSADO' },
            'ESP': { cls: 'b-espumoso', es: 'ESPUMOSO', en: 'SPARKLING', pt: 'ESPUMOSO' },
            'GEN': { cls: 'b-generoso', es: 'GENEROSO', en: 'FORTIFIED', pt: 'GENEROSO' },
            'DU':  { cls: 'b-dulce',    es: 'DULCE',    en: 'SWEET',     pt: 'DOCE' }
        };

        const GRAPE_FAMILIES = {
            'Tempranillo': 'iberica-tinta', 'Garnacha': 'iberica-tinta s2', 'Monastrell': 'iberica-tinta s3',
            'Bobal': 'iberica-tinta', 'MencÃ­a': 'iberica-tinta s2', 'CariÃ±ena': 'iberica-tinta s3',
            'Graciano': 'iberica-tinta', 'Carignan': 'iberica-tinta s2', 'Prieto Picudo': 'iberica-tinta s3',
            'Tinta de Toro': 'iberica-tinta', 'Garnacha Tintorera': 'iberica-tinta s2',
            'Pinot Noir': 'burgundy', 'Pinot Meunier': 'burgundy s2', 'Chardonnay': 'burgundy s3',
            'Sauvignon Blanc': 'burgundy', 'AligotÃ©': 'burgundy s2', 'Gamay': 'burgundy s3',
            'Sangiovese': 'italiana', 'Nebbiolo': 'italiana s2', 'Barbera': 'italiana s3',
            'Dolcetto': 'italiana', 'Montepulciano': 'italiana s2', 'Aglianico': 'italiana s3',
            "Nero d'Avola": 'italiana', 'Corvina': 'italiana s2', 'Primitivo': 'italiana s3',
            'Riesling': 'aromatico', 'AlbariÃ±o': 'aromatico s2', 'Verdejo': 'aromatico s3',
            'Moscato': 'aromatico', 'GewÃ¼rztraminer': 'aromatico s2', 'Viognier': 'aromatico s3',
            'Vermentino': 'aromatico', 'Godello': 'aromatico s2', 'Fiano': 'aromatico s3',
            'Greco': 'aromatico', 'Falanghina': 'aromatico s2', 'Malvasia': 'aromatico s3',
            'Furmint': 'aromatico', 'Savagnin': 'aromatico s2', 'Timorasso': 'aromatico s3',
            'Verdicchio': 'aromatico', 'Chenin Blanc': 'aromatico s2', 'GrÃ¼ner Veltliner': 'aromatico s3',
            'Garnacha Blanca': 'aromatico', 'Viura': 'aromatico s2', 'Macabeo': 'aromatico s3',
            'CarmenÃ¨re': 'novamundo', 'Malbec': 'novamundo s2', 'Cabernet Sauvignon': 'novamundo s3',
            'Cabernet Franc': 'novamundo', 'Syrah': 'novamundo s2', 'Shiraz': 'novamundo s3',
            'Petit Verdot': 'novamundo', 'Zinfandel': 'novamundo s2', 'Tannat': 'novamundo s3',
            'Negroamaro': 'novamundo', 'Pinotage': 'novamundo s2', 'Merlot': 'novamundo s3',
            'Touriga Nacional': 'novamundo', 'Tinta Roriz': 'novamundo s2',
            'Prosecco': 'espumoso', 'Lambrusco': 'espumoso s2', 'Cava': 'espumoso s3',
            'Champagne': 'espumoso', 'Xarel.lo': 'espumoso s2', 'Parellada': 'espumoso s3',
            'Glera': 'espumoso',
        };

        // --- STATE ---
        let refs = [];            // Full dataset from JSON
        let baseRefs = [];        // Immutable snapshot from JSON
        let searchIndex = [];     // Pre-computed search strings
        let pvpMedio = {};        // Average PVP per pod
        let subsets = {};         // Indices per establishment
        let currentFilter = 'bodega';
        let currentSort = 'abc';
        let currentEditPod = null;
        let currentLang = 'es';
        let syncTimer = null;
        let syncInFlight = false;
        let syncDisabled = false;
        const EDITS_KEY = 'cava_edits';
        const MOVEMENTS_KEY = 'cava_daily_movements_v1';
        const SYNC_PENDING_KEY = 'cava_sync_pending_v1';
        const SYNC_REVISION_KEY = 'cava_sync_revision_v1';
        const SYNC_CLIENT_KEY = 'cava_sync_client_id_v1';
        const SYNC_INTERVAL_MS = 30000;
        const SYNC_ENDPOINT = '/api/stock-sync';
        let syncClientId = sessionStorage.getItem(SYNC_CLIENT_KEY);
        if (!syncClientId) {
            syncClientId = `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 10)}`;
            sessionStorage.setItem(SYNC_CLIENT_KEY, syncClientId);
        }
        const currentUserName = sessionStorage.getItem(AUTH_KEYS.sessionUser) || localStorage.getItem(AUTH_KEYS.persistentUser) || '';
        const sessionUserCard = document.getElementById('sessionUserCard');
        const normalizeEstablishment = (value) => {
            const normalized = (value || '').trim().toLowerCase();
            return EST_KEYS.includes(normalized) ? normalized : null;
        };
        const normalizeScope = (value) => {
            const normalized = (value || '').trim().toLowerCase();
            return EST_KEYS.includes(normalized) || normalized === 'all' ? normalized : null;
        };
        const normalizeRole = (value) => {
            const normalized = (value || '').trim().toLowerCase();
            return ['user', 'admin', 'adminmaster'].includes(normalized) ? normalized : null;
        };
        const storedRole = normalizeRole(sessionStorage.getItem(AUTH_KEYS.sessionRole))
            || normalizeRole(localStorage.getItem(AUTH_KEYS.persistentRole));
        const storedScope = normalizeScope(sessionStorage.getItem(AUTH_KEYS.sessionScope))
            || normalizeScope(localStorage.getItem(AUTH_KEYS.persistentScope));
        const baseEstablishment = normalizeEstablishment(sessionStorage.getItem(AUTH_KEYS.sessionEstablishment))
            || normalizeEstablishment(localStorage.getItem(AUTH_KEYS.persistentEstablishment))
            || 'spa';
        const currentUserRole = storedRole || 'user';
        const currentUserScope = storedScope || baseEstablishment;
        const currentUserEstablishment = currentUserScope === 'all'
            ? (baseEstablishment || 'spa')
            : (EST_KEYS.includes(currentUserScope) ? currentUserScope : (baseEstablishment || 'spa'));

        if (sessionUserCard) {
            const cardUser = (currentUserName || '').trim() || 'No logado';
            sessionUserCard.textContent = cardUser;
        }

        function hasAdminAccess() {
            return currentUserRole === 'admin' || currentUserRole === 'adminmaster';
        }

        function getEditableEstablishmentKeys() {
            if (currentUserRole === 'adminmaster' || currentUserScope === 'all') {
                return [...EDITABLE_EST_KEYS];
            }
            if (EDITABLE_EST_KEYS.includes(currentUserScope)) {
                return [currentUserScope];
            }
            if (EDITABLE_EST_KEYS.includes(currentUserEstablishment)) {
                return [currentUserEstablishment];
            }
            return [];
        }

        function hasEditAccess() {
            return getEditableEstablishmentKeys().length > 0;
        }

        function canOpenReportPage() {
            return ['user', 'admin', 'adminmaster'].includes(currentUserRole);
        }

        function getEstablishmentFromPath(path) {
            const match = String(path || '').match(/^establecimientos\.(bodega|spa|tasca_fina|victoria|galeria)\./);
            return match ? match[1] : null;
        }

        function normalizeLocationPosToken(rawToken) {
            const token = String(rawToken || '').toUpperCase().replace(/[^A-Z]/g, '');
            if (!token) return null;
            if ('IZQ'.startsWith(token)) return token.length >= 3 ? 'IZQ' : token;
            if ('DER'.startsWith(token)) return token.length >= 3 ? 'DER' : token;
            if ('CEN'.startsWith(token) || token.startsWith('CENT')) return token.length >= 3 ? 'CEN' : token.slice(0, 3);
            if ('EXP'.startsWith(token)) return token.length >= 3 ? 'EXP' : token;
            if ('JAM'.startsWith(token) || token.startsWith('JAMON')) return token.length >= 3 ? 'JAM' : token.slice(0, 3);
            return token.slice(0, 3);
        }

        function normalizeVictoriaDoorToken(rawToken) {
            const token = String(rawToken || '').toUpperCase().replace(/[^A-Z]/g, '');
            if (!token) return null;
            if (token.startsWith('IZQ') || token.startsWith('IZQUI')) return 'IZQ';
            if (token.startsWith('DER') || token.startsWith('DERE')) return 'DER';
            if (token.startsWith('CEN') || token.startsWith('CENT')) return 'CEN';
            return null;
        }

        function normalizeVictoriaLineToken(rawToken) {
            const token = String(rawToken || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (!token) return null;
            const ordMap = { PRIMERA: 1, SEGUNDA: 2, TERCERA: 3, CUARTA: 4, QUINTA: 5 };
            if (ordMap[token]) return `L${ordMap[token]}`;
            const lineMatch = token.match(/^L(?:INEA)?(\d{1,2})$/);
            if (lineMatch) return `L${lineMatch[1]}`;
            if (/^\d{1,2}$/.test(token)) return `L${token}`;
            return null;
        }

        function normalizeVictoriaLocationValue(normalized) {
            const text = String(normalized || '').toUpperCase();
            if (!text) return null;

            const compact = text.match(/^([A-Z0-9]{1,3})\s+(\d{1,2})(?:\s+([A-Z]{2,4}))?(?:\s+(L?\d{1,2}|PRIMERA|SEGUNDA|TERCERA|CUARTA|QUINTA))?$/);
            if (compact) {
                const door = normalizeVictoriaDoorToken(compact[3]);
                const line = normalizeVictoriaLineToken(compact[4]);
                return `${compact[1]}Â·${compact[2]}${door ? `Â·${door}` : ''}${line ? `Â·${line}` : ''}`;
            }

            const cavaMatch = text.match(/\bCAVA\s*([A-Z0-9]{1,3})\b/);
            const baldaMatch = text.match(/\bBALDA\s*(\d{1,2})\b/);
            const doorMatch = normalizeVictoriaDoorToken(text);
            const lineMatchWord = text.match(/\b(PRIMERA|SEGUNDA|TERCERA|CUARTA|QUINTA)\s+LINEA\b/);
            const lineMatchNumber = text.match(/\bLINEA\s*(\d{1,2})\b/);

            const cava = cavaMatch?.[1] || null;
            const balda = baldaMatch?.[1] || null;
            const line = lineMatchWord
                ? normalizeVictoriaLineToken(lineMatchWord[1])
                : (lineMatchNumber ? normalizeVictoriaLineToken(lineMatchNumber[1]) : null);

            if (cava && balda) {
                return `${cava}Â·${balda}${doorMatch ? `Â·${doorMatch}` : ''}${line ? `Â·${line}` : ''}`;
            }

            return null;
        }

        function normalizeLocationValue(value, establishment = null) {
            const raw = value == null ? '' : String(value);
            if (raw.includes('/')) {
                const parts = raw
                    .split('/')
                    .map((segment) => normalizeLocationValue(segment, establishment))
                    .filter(Boolean);
                return parts.length ? parts.join(' / ') : null;
            }
            const normalized = raw
                .toUpperCase()
                .replace(/[â€¢Â·]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            if (!normalized) return null;

            if (establishment === 'victoria') {
                const victoriaNormalized = normalizeVictoriaLocationValue(normalized);
                if (victoriaNormalized) return victoriaNormalized;
            }

            const directCompact = normalized.match(/^(\d{1,2})\s+(\d{1,2})(?:\s+(IZQ|DER|CEN|EXP|JAM))?$/);
            if (directCompact) {
                const pos = directCompact[3] ? `Â·${directCompact[3]}` : '';
                return `${directCompact[1]}Â·${directCompact[2]}${pos}`;
            }

            const spaCompact = normalized.match(/^(\d{1,2})([A-Z])([A-Z])$/);
            if (spaCompact) {
                return `${spaCompact[1]}Â·${spaCompact[2]}Â·${spaCompact[3]}`;
            }

            const spaTwoToken = normalized.match(/^(\d{1,2})\s+([A-Z]{2})$/);
            if (spaTwoToken) {
                return `${spaTwoToken[1]}Â·${spaTwoToken[2][0]}Â·${spaTwoToken[2][1]}`;
            }

            const compactTokens = normalized.match(/^([A-Z0-9]{1,2})\s+([A-Z0-9]{1,2})(?:\s+([A-Z]{1,10}))?$/);
            if (compactTokens) {
                const posToken = normalizeLocationPosToken(compactTokens[3] || '');
                return `${compactTokens[1]}Â·${compactTokens[2]}${posToken ? `Â·${posToken}` : ''}`;
            }

            const cavaMatch = normalized.match(/\bCAVA\s*[-:]?\s*(\d{1,2})\b/);
            const baldaMatch = normalized.match(/\bBALDA\s*[-:]?\s*(\d{1,2})\b/);

            let pos = null;
            if (/\bIZQ\b/.test(normalized)) pos = 'IZQ';
            else if (/\bDER\b/.test(normalized)) pos = 'DER';
            else if (/\bCEN\b/.test(normalized)) pos = 'CEN';
            else if (/\bEXP\b/.test(normalized)) pos = 'EXP';
            else if (/\bJAMONES\b|\bJAMON\b|\bJAM\b/.test(normalized)) pos = 'JAM';

            const cavaNum = cavaMatch?.[1] || null;
            const baldaNum = baldaMatch?.[1] || null;
            if (cavaNum && baldaNum) {
                if (!pos) {
                    const afterBalda = normalized.replace(/^.*\bBALDA\s*[-:]?\s*\d{1,2}\b/, '').trim();
                    if (afterBalda) {
                        const rawPosToken = afterBalda.split(' ')[0].replace(/[^A-Z0-9]/g, '');
                        pos = normalizeLocationPosToken(rawPosToken) || rawPosToken.slice(0, 3) || null;
                    }
                }
                return `${cavaNum}Â·${baldaNum}${pos ? `Â·${pos}` : ''}`;
            }

            return normalized;
        }

        function formatLocationForUi(establishment, value) {
            const normalized = normalizeLocationValue(value, establishment);
            if (!normalized) return { compact: null, detail: null, text: null };
            if (establishment !== 'victoria') return { compact: normalized, detail: null, text: normalized };

            const parts = normalized.split('Â·').map((p) => p.trim()).filter(Boolean);
            if (parts.length < 2) return { compact: normalized, detail: null, text: normalized };
            const compact = `${parts[0]}Â·${parts[1]}`;

            const detailParts = [];
            for (const token of parts.slice(2)) {
                if (token === 'IZQ') detailParts.push('PUERTA IZQ');
                else if (token === 'DER') detailParts.push('PUERTA DER');
                else if (token === 'CEN') detailParts.push('PUERTA CEN');
                else if (/^L\d{1,2}$/.test(token)) detailParts.push(`${token.slice(1)}Âª LINEA`);
                else detailParts.push(token);
            }
            const detail = detailParts.length ? detailParts.join(' Â· ') : null;
            return { compact, detail, text: detail ? `${compact} (${detail})` : compact };
        }

        function formatLocationInputValue(rawValue, options = {}) {
            const preserveTrailingSeparator = options && options.preserveTrailingSeparator === true;
            const establishment = options && options.establishment ? options.establishment : null;
            const raw = rawValue == null ? '' : String(rawValue);
            const hasTrailingSeparator = /[Â·â€¢\s]$/.test(raw);
            const verboseNormalized = normalizeLocationValue(raw, establishment);
            if (/^[A-Z0-9]{1,2}Â·[A-Z0-9]{1,2}(?:Â·[A-Z]{1,3})?(?:Â·L\d{1,2})?$/.test(verboseNormalized || '')) {
                if (preserveTrailingSeparator && hasTrailingSeparator) {
                    const parts = String(verboseNormalized).split('Â·');
                    if (parts.length === 1) return `${parts[0]}Â·`;
                    if (parts.length === 2) return `${parts[0]}Â·${parts[1]}Â·`;
                    if (parts.length === 3 && establishment === 'victoria') return `${parts[0]}Â·${parts[1]}Â·${parts[2]}Â·`;
                }
                return verboseNormalized;
            }

            const normalized = raw
                .toUpperCase()
                .replace(/[â€¢Â·.,;:/\\_-]/g, ' ')
                .replace(/[^A-Z0-9\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            if (!normalized) return '';

            let tokens = normalized.split(' ');
            if (establishment === 'victoria') {
                if (tokens[0] === 'CAVA' && tokens[1]) tokens = tokens.slice(1);
                if (tokens[1] === 'BALDA' && tokens[2]) tokens.splice(1, 1);
            }
            if (tokens.length === 1 && /^\d{2}$/.test(tokens[0])) {
                tokens = [tokens[0][0], tokens[0][1]];
            }

            const part1 = (tokens[0] || '').replace(/[^A-Z0-9]/g, '').slice(0, establishment === 'victoria' ? 1 : 2);
            const part2 = (tokens[1] || '').replace(/[^A-Z0-9]/g, '').slice(0, 2);
            const part3Raw = tokens.length > 2 ? tokens[2] : '';
            const part4Raw = tokens.length > 3 ? tokens[3] : '';

            const part3 = establishment === 'victoria'
                ? (normalizeVictoriaDoorToken(part3Raw) || String(part3Raw || '').replace(/[^A-Z]/g, '').slice(0, 3) || null)
                : normalizeLocationPosToken(tokens.length > 2 ? tokens.slice(2).join('') : '');
            const part4 = establishment === 'victoria'
                ? normalizeVictoriaLineToken(part4Raw)
                : null;

            if (!part1) return '';
            if (!part2) return preserveTrailingSeparator && hasTrailingSeparator ? `${part1}Â·` : part1;
            if (!part3) return `${part1}Â·${part2}${preserveTrailingSeparator && hasTrailingSeparator ? 'Â·' : ''}`;
            if (!part4) {
                if (establishment === 'victoria') {
                    return `${part1}Â·${part2}Â·${part3}${preserveTrailingSeparator && hasTrailingSeparator ? 'Â·' : ''}`;
                }
                return `${part1}Â·${part2}Â·${part3}`;
            }
            return `${part1}Â·${part2}Â·${part3}Â·${part4}`;
        }

        function setupLocationInputsMask() {
            const fieldMap = {
                editSpaLoc: 'spa',
                editTascaLoc: 'tasca_fina',
                editVictoriaLoc: 'victoria',
                editGaleriaLoc: 'galeria'
            };
            Object.entries(fieldMap).forEach(([id, establishment]) => {
                const input = document.getElementById(id);
                if (!input || input.dataset.locationMaskBound === '1') return;
                input.dataset.locationMaskBound = '1';
                input.setAttribute('maxlength', establishment === 'victoria' ? '16' : '10');
                input.setAttribute('autocapitalize', 'characters');
                input.setAttribute('spellcheck', 'false');

                input.addEventListener('keydown', (event) => {
                    if (event.key !== ' ') return;
                    event.preventDefault();
                    const withVirtualSpace = `${input.value || ''} `;
                    const formatted = formatLocationInputValue(withVirtualSpace, { preserveTrailingSeparator: true, establishment });
                    input.value = formatted;
                    const caret = input.value.length;
                    input.setSelectionRange(caret, caret);
                });

                input.addEventListener('beforeinput', (event) => {
                    if (event.inputType !== 'insertText') return;
                    if (event.data !== ' ' && event.data !== '\u00A0') return;
                    event.preventDefault();
                    const withVirtualSpace = `${input.value || ''} `;
                    const formatted = formatLocationInputValue(withVirtualSpace, { preserveTrailingSeparator: true, establishment });
                    input.value = formatted;
                    const caret = input.value.length;
                    input.setSelectionRange(caret, caret);
                });

                input.addEventListener('input', () => {
                    const formatted = formatLocationInputValue(input.value, { preserveTrailingSeparator: true, establishment });
                    if (input.value !== formatted) input.value = formatted;
                });

                input.addEventListener('blur', () => {
                    const normalized = normalizeLocationValue(input.value, establishment) || '';
                    input.value = normalized;
                });
            });
        }

        function clearAuthState() {
            sessionStorage.removeItem(AUTH_KEYS.sessionFlag);
            sessionStorage.removeItem(AUTH_KEYS.sessionUser);
            sessionStorage.removeItem(AUTH_KEYS.sessionEstablishment);
            sessionStorage.removeItem(AUTH_KEYS.sessionRole);
            sessionStorage.removeItem(AUTH_KEYS.sessionScope);
            localStorage.removeItem(AUTH_KEYS.persistentFlag);
            localStorage.removeItem(AUTH_KEYS.persistentUser);
            localStorage.removeItem(AUTH_KEYS.persistentEstablishment);
            localStorage.removeItem(AUTH_KEYS.persistentRole);
            localStorage.removeItem(AUTH_KEYS.persistentScope);
        }

        setupLocationInputsMask();

        // Typewriter state
        let typeWriterTimeout, charIndex = 0, isDeleting = false, currentPhrase = '', phraseQueue = [];

        // --- TRANSLATIONS ---
        const translations = {
            es: {
                placeholders: [
                    "Â¿Hoy tinto o blanco?",
                    "Â¿Algo para maridar?",
                    "Busca por uva o regiÃ³n",
                    "Â¿Rioja o Ribera?",
                    "Â¿Una copa mÃ¡s?",
                    "Burbuja para celebrar",
                    "Â¿Fruta, madera o mineral?",
                    "Â¿Ligero o con cuerpo?",
                    "Â¿QuÃ© abrimos hoy?",
                    "Sugerencia del sumiller",
                    "Tu vino ideal estÃ¡ aquÃ­",
                    "Prueba algo nuevo"
                ],
                refs: "referencias disponibles", region: "RegiÃ³n", country: "PaÃ­s",
                year: "AÃ±o", format: "Formato", climate: "Clima", soil: "Suelo", terroir: "Terroir", admin: "Admin", report: "Ventas",
                pvpLabel: "PVP", stockLabel: "Stock", locationShort: "Ubic.", editBtn: "Editar", cancelBtn: "Cancelar", saveBtn: "Salvar",
                consumeNeedFilter: "Selecciona SPA/TASCA/VICTORIA para registrar salida.", consumeDone: "Salida registrada.", consumeNoStock: "Sin stock numÃ©rico para descontar, pero salida anotada.", consumeToastUpdated: "Cava actualizada", btnLabel: "ðŸ‡ªðŸ‡¸ ES"
            },
            en: {
                placeholders: [
                    "Red or white today?",
                    "Need a food pairing?",
                    "Search grape or region",
                    "Rioja or Ribera?",
                    "One more glass?",
                    "Bubbles for today",
                    "Fruit, oak or mineral?",
                    "Light or full-bodied?",
                    "What shall we open?",
                    "Sommelier picks",
                    "Your next wine is here",
                    "Try something new"
                ],
                refs: "references available", region: "Region", country: "Country",
                year: "Year", format: "Format", climate: "Climate", soil: "Soil", terroir: "Terroir", admin: "Admin", report: "Sales",
                pvpLabel: "PVP", stockLabel: "Stock", locationShort: "Loc.", editBtn: "Edit", cancelBtn: "Cancel", saveBtn: "Save",
                consumeNeedFilter: "Select SPA/TASCA/VICTORIA to register output.", consumeDone: "Output registered.", consumeNoStock: "No numeric stock to decrement, but output was logged.", consumeToastUpdated: "Cellar updated", btnLabel: "ðŸ‡¬ðŸ‡§ EN"
            },
            pt: {
                placeholders: [
                    "Tinto ou branco hoje?",
                    "Quer algo para harmonizar?",
                    "Busque uva ou regiÃ£o",
                    "Rioja ou Ribera?",
                    "Mais uma taÃ§a?",
                    "Bolhas para celebrar",
                    "Fruta, madeira ou mineral?",
                    "Leve ou encorpado?",
                    "O que abrimos hoje?",
                    "Dica do sommelier",
                    "Seu prÃ³ximo vinho estÃ¡ aqui",
                    "Prove algo novo"
                ],
                refs: "referÃªncias disponÃ­veis", region: "RegiÃ£o", country: "PaÃ­s",
                year: "Ano", format: "Formato", climate: "Clima", soil: "Solo", terroir: "Terroir", admin: "Admin", report: "Vendas",
                pvpLabel: "PVP", stockLabel: "Estoque", locationShort: "Local", editBtn: "Editar", cancelBtn: "Cancelar", saveBtn: "Salvar",
                consumeNeedFilter: "Selecione SPA/TASCA/VICTORIA para registrar retirada.", consumeDone: "Retirada registrada.", consumeNoStock: "Sem estoque numÃ©rico para baixar, mas a retirada foi anotada.", consumeToastUpdated: "Cava Atualizada", btnLabel: "ðŸ‡§ðŸ‡· PT"
            }
        };

        // --- UTILITY ---
        function removeAccents(str) {
            return String(str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function fmt(val) {
            return val != null ? val : 'â€”';
        }

        function fmtPrice(val) {
            return val != null ? val + 'â‚¬' : 'â€”';
        }

        function normalizeToken(value) {
            return removeAccents(String(value || '').trim().toLowerCase());
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function extractTextValue(value) {
            if (typeof value === 'string') return value.trim();
            if (typeof value === 'number') return String(value);
            if (Array.isArray(value)) {
                for (const item of value) {
                    const found = extractTextValue(item);
                    if (found) return found;
                }
                return '';
            }
            if (value && typeof value === 'object') {
                const preferredKeys = ['nome', 'name', 'grape', 'variety', 'uva', 'label', 'value', 'text'];
                for (const key of preferredKeys) {
                    if (Object.prototype.hasOwnProperty.call(value, key)) {
                        const found = extractTextValue(value[key]);
                        if (found) return found;
                    }
                }
                for (const candidate of Object.values(value)) {
                    const found = extractTextValue(candidate);
                    if (found) return found;
                }
            }
            return '';
        }

        function normalizeGrapeItem(raw) {
            const nome = extractTextValue(raw);
            if (!nome || nome === '[object Object]') return null;
            const pctNumber = Number(raw && typeof raw === 'object' ? (raw.pct ?? raw.percent ?? raw.porcentaje) : NaN);
            return {
                nome,
                pct: Number.isFinite(pctNumber) ? pctNumber : null
            };
        }

        function extractGrapeItems(uvasArr) {
            if (!Array.isArray(uvasArr)) return [];
            return uvasArr.map(normalizeGrapeItem).filter(Boolean);
        }

        function getGrapeSearchTokens(uvasArr) {
            return extractGrapeItems(uvasArr).map((item) => item.nome);
        }

        function getTipoSearchTokens(tipo) {
            const code = String(tipo?.codigo || '').trim().toUpperCase();
            const name = String(tipo?.nombre || '').trim();
            const byCode = {
                TO: ['tinto', 'red', 'rouge'],
                BL: ['blanco', 'white', 'branco'],
                ROS: ['rosado', 'rose', 'rosÃ©'],
                ESP: ['espumoso', 'sparkling', 'espumante', 'cava', 'champagne'],
                GEN: ['generoso', 'fortified', 'jerez', 'sherry'],
                DU: ['dulce', 'sweet', 'doce', 'dessert']
            };
            const extra = byCode[code] || [];
            return [code, name, ...extra].filter(Boolean);
        }

        const GRAPE_FAMILY_NORMALIZED = Object.fromEntries(
            Object.entries(GRAPE_FAMILIES).map(([name, family]) => [normalizeToken(name), family])
        );

        function getGrapeColor(name) {
            const direct = GRAPE_FAMILIES[name];
            if (direct) return direct;
            return GRAPE_FAMILY_NORMALIZED[normalizeToken(name)] || 'burgundy s3';
        }

        const GRAPE_PRIMARY_PALETTE = {
            tempranillo: ['#64061f', '#9d1237'],
            garnacha: ['#7a0d2a', '#b41e45'],
            monastrell: ['#4f0818', '#7a1431'],
            bobal: ['#5e0a22', '#902045'],
            mencia: ['#6d1734', '#a52951'],
            pinotnoir: ['#702133', '#ab3d59'],
            syrah: ['#420817', '#6f1530'],
            shiraz: ['#4a0b1b', '#7b1a39'],
            nebbiolo: ['#8c2d2d', '#bf4f48'],
            sangiovese: ['#6e1119', '#a61f2c'],
            barbera: ['#5f1322', '#92304a'],
            riesling: ['#b39d2f', '#ddc85f'],
            albarino: ['#c79d29', '#efd06a'],
            verdejo: ['#5f8f27', '#8ebf46'],
            godello: ['#a89945', '#d2c36f'],
            chardonnay: ['#b2983d', '#dbc26d'],
            sauvignonblanc: ['#6f9b34', '#9fca5b'],
            gewurztraminer: ['#b17f38', '#d9a565'],
            viognier: ['#bf9a3f', '#e5bf70'],
            glera: ['#d8b85b', '#f0d787'],
            'xarel.lo': ['#c39e45', '#dfbe73'],
            xarello: ['#c39e45', '#dfbe73'],
            parellada: ['#d2b467', '#ead28f'],
            macabeo: ['#c6a44a', '#e2c676'],
            champagne: ['#dac27a', '#efddb0'],
            prosecco: ['#e0c16f', '#f2db9f']
        };

        const WINE_TYPE_PALETTE = {
            TO: ['#6a1329', '#932542'],
            BL: ['#bda660', '#d9c37f'],
            ROS: ['#b64d67', '#d77793'],
            ESP: ['#d5b66a', '#ecd69a'],
            GEN: ['#a76e34', '#c78c48'],
            DU: ['#6f375f', '#965083']
        };

        function pickGrapePalette(name, tipoCode, isPrimary, index) {
            const key = normalizeToken(name).replace(/\s+/g, '').replace(/[^a-z0-9.]/g, '');
            const primary = GRAPE_PRIMARY_PALETTE[key];
            if (primary) return primary;
            const typeBase = WINE_TYPE_PALETTE[String(tipoCode || '').toUpperCase()] || WINE_TYPE_PALETTE.TO;
            if (isPrimary) return typeBase;
            const shift = Math.min(index, 3) * 9;
            return [lightenHex(typeBase[0], shift), lightenHex(typeBase[1], shift + 6)];
        }

        function lightenHex(hex, amount) {
            const value = String(hex || '').replace('#', '');
            if (!/^[0-9a-fA-F]{6}$/.test(value)) return hex;
            const toChannel = (start) => {
                const channel = parseInt(value.slice(start, start + 2), 16);
                return Math.max(0, Math.min(255, channel + amount));
            };
            const r = toChannel(0).toString(16).padStart(2, '0');
            const g = toChannel(2).toString(16).padStart(2, '0');
            const b = toChannel(4).toString(16).padStart(2, '0');
            return `#${r}${g}${b}`;
        }

        function renderGrapeTags(uvasArr, tipoCode = '') {
            const processedUvas = extractGrapeItems(uvasArr);
            if (!processedUvas.length) return '';

            processedUvas.sort((a, b) => {
                const pctA = Number.isFinite(Number(a.pct)) ? Number(a.pct) : -1;
                const pctB = Number.isFinite(Number(b.pct)) ? Number(b.pct) : -1;
                return pctB - pctA;
            });

            return '<div class="grape-tags">' +
                processedUvas.map((g, index) => {
                    const label = g.nome;
                    const [start, end] = pickGrapePalette(g.nome, tipoCode, index === 0, index);
                    const ribColor = lightenHex(start, 30);
                    const shadowColor = lightenHex(end, -35);
                    const style = `background:linear-gradient(135deg, ${start} 0%, ${end} 100%);border:1px solid ${ribColor};box-shadow:0 0 0 1px rgba(255,255,255,0.09) inset,0 2px 9px ${shadowColor};`;
                    return `<span class="grape-tag ${getGrapeColor(g.nome)}" style="${style}">${escapeHtml(label)}</span>`;
                }).join('') +
                '</div>';
        }

        function getTipoBadge(tipo) {
            const code = tipo?.codigo || '';
            const info = TIPO_MAP[code] || TIPO_MAP['TO'];
            return { cls: info.cls, label: info[currentLang] || info.es };
        }

        function initCatalogData(data) {
            if (!Array.isArray(data)) return false;
            baseRefs = data.filter((r) => r.pod && r.descripcion && !r.descripcion.startsWith('#'));
            refs = JSON.parse(JSON.stringify(baseRefs));
            applyLocalEdits();
            preProcess();
            updateRefCount();
            startRealtimeSync();
            console.log(`âœ“ Loaded ${refs.length} references (filtered ${data.length - baseRefs.length} incomplete)`);
            return true;
        }

        function loadCatalogFromStaticFile() {
            return fetch('/data/bodega_webapp.json', { cache: 'no-store' })
                .then((r) => {
                    if (!r.ok) throw new Error(`catalog_static_failed_${r.status}`);
                    return r.json();
                });
        }

        // --- DATA LOADING ---
        fetch('/api/wines', { cache: 'no-store' })
            .then((r) => {
                if (r.status === 401) {
                    clearAuthState();
                    window.location.replace('login.html');
                    return null;
                }
                if (!r.ok) {
                    if (r.status === 404 || r.status === 405 || r.status === 501 || r.status >= 500) {
                        return loadCatalogFromStaticFile();
                    }
                    throw new Error(`catalog_request_failed_${r.status}`);
                }
                return r.json();
            })
            .then((data) => {
                if (data === null) return;
                if (initCatalogData(data)) return;
                return loadCatalogFromStaticFile().then((fallbackData) => {
                    initCatalogData(fallbackData);
                });
            })
            .catch((err) => {
                console.error('Error loading data:', err);
                loadCatalogFromStaticFile()
                    .then((fallbackData) => {
                        if (!initCatalogData(fallbackData)) {
                            baseRefs = [];
                            refs = [];
                        }
                    })
                    .catch((fallbackErr) => {
                        console.error('Error loading fallback catalog:', fallbackErr);
                        baseRefs = [];
                        refs = [];
                    });
            });

        // --- LOCAL EDIT PERSISTENCE ---
        function parseJsonArray(rawValue) {
            if (!rawValue) return [];
            try {
                const parsed = JSON.parse(rawValue);
                return Array.isArray(parsed) ? parsed : [];
            } catch {
                return [];
            }
        }

        function parseJsonObject(rawValue) {
            if (!rawValue) return {};
            try {
                const parsed = JSON.parse(rawValue);
                if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) return {};
                return parsed;
            } catch {
                return {};
            }
        }

        function createMutationId() {
            return `${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
        }

        function readPendingMutations() {
            return parseJsonArray(localStorage.getItem(SYNC_PENDING_KEY));
        }

        function writePendingMutations(list) {
            localStorage.setItem(SYNC_PENDING_KEY, JSON.stringify(Array.isArray(list) ? list : []));
        }

        function isSupportedEditPath(path) {
            const root = String(path || '').split('.')[0];
            const blockedRoots = new Set(['descripcion', 'region', 'uvas']);
            return root && !blockedRoots.has(root);
        }

        function sanitizeEditsForCurrentUi(editList) {
            if (!Array.isArray(editList)) return [];
            return editList.filter((edit) => edit && edit.pod && edit.path && isSupportedEditPath(edit.path));
        }

        function queuePendingMutation(mutation) {
            const queue = readPendingMutations();
            if (mutation.type === 'edit' && mutation.payload?.pod && mutation.payload?.path) {
                const filtered = queue.filter((item) => {
                    if (item.type !== 'edit') return true;
                    if (!item.payload) return true;
                    return !(item.payload.pod === mutation.payload.pod && item.payload.path === mutation.payload.path);
                });
                filtered.push(mutation);
                if (filtered.length > 2000) filtered.splice(0, filtered.length - 2000);
                writePendingMutations(filtered);
                return;
            }
            queue.push(mutation);
            if (queue.length > 2000) queue.splice(0, queue.length - 2000);
            writePendingMutations(queue);
        }

        function readStoredEdits() {
            const rawEdits = parseJsonArray(localStorage.getItem(EDITS_KEY))
                .filter((edit) => edit && edit.pod && edit.path);
            const sanitized = sanitizeEditsForCurrentUi(rawEdits);
            if (sanitized.length !== rawEdits.length) {
                localStorage.setItem(EDITS_KEY, JSON.stringify(sanitized));
            }
            return sanitized;
        }

        function applyEditsToRefs(editList) {
            editList.forEach((edit) => {
                const ref = refs.find((item) => item.pod === edit.pod);
                if (!ref) return;
                const establishment = getEstablishmentFromPath(edit.path);
                const nextValue = String(edit.path || '').endsWith('.localizacion')
                    ? normalizeLocationValue(edit.value, establishment)
                    : edit.value;
                setNestedValue(ref, edit.path, nextValue);
            });
        }

        function applyLocalEdits() {
            const edits = readStoredEdits();
            applyEditsToRefs(edits);
            if (edits.length) console.log(`âœ“ Applied ${edits.length} local edits`);
        }

        function rebuildRefsFromLocalSnapshot() {
            if (!baseRefs.length) return;
            refs = JSON.parse(JSON.stringify(baseRefs));
            applyLocalEdits();
            preProcess();
            updateRefCount();

            if (typeof triggerSearch === 'function') {
                triggerSearch();
            }

            const modal = document.getElementById('wineModal');
            if (modal && modal.classList.contains('active') && currentEditPod && typeof openModal === 'function') {
                const liveRef = refs.find((item) => item.pod === currentEditPod);
                if (liveRef) {
                    openModal(liveRef);
                }
            }
        }

        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            let cur = obj;
            for (let i = 0; i < keys.length - 1; i++) {
                if (!cur[keys[i]]) cur[keys[i]] = {};
                cur = cur[keys[i]];
            }
            cur[keys[keys.length - 1]] = value;
        }

        function saveEdit(pod, path, value) {
            const edits = readStoredEdits();
            const editPayload = {
                pod,
                path,
                value,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUserName
            };
            const idx = edits.findIndex((entry) => entry.pod === pod && entry.path === path);
            if (idx >= 0) edits[idx] = editPayload;
            else edits.push(editPayload);
            localStorage.setItem(EDITS_KEY, JSON.stringify(edits));

            queuePendingMutation({
                id: createMutationId(),
                type: 'edit',
                payload: editPayload
            });
            void runRealtimeSyncCycle();
        }

        // --- PRE-PROCESSING ---
        function preProcess() {
            searchIndex = [];
            pvpMedio = {};
            subsets = { todos: new Set(), bodega: new Set(), spa: new Set(), tasca_fina: new Set(), victoria: new Set(), galeria: new Set() };

            refs.forEach((ref, i) => {
                // Build searchable string (nome, uva, regiÃ£o, tipo, etc.)
                const grapeTokens = getGrapeSearchTokens(ref.uvas);
                const tipoTokens = getTipoSearchTokens(ref.tipo);
                const parts = [
                    ref.descripcion, ref.region, ref.pais, ref.bodega,
                    ...tipoTokens,
                    ...grapeTokens,
                    ref.formato?.etiqueta,
                    ref.ano ? String(ref.ano) : '',
                    ref.pod
                ].filter(Boolean).join(' ');

                searchIndex.push({ idx: i, str: removeAccents(parts.toLowerCase()) });
                subsets.todos.add(i);

                // Compute average PVP across visible establishments
                let prices = [];
                EST_KEYS.forEach(k => {
                    const est = ref.establecimientos?.[k];
                    if (est && est.pvp != null) {
                        prices.push(est.pvp);
                        subsets[k].add(i);
                    }
                });
                pvpMedio[ref.pod] = prices.length > 0
                    ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length)
                    : null;
            });
        }

        function updateRefCount() {
            let count = refs.length;
            if (currentFilter !== 'todos') {
                count = subsets[currentFilter]?.size || 0;
            }
            document.getElementById('totalRef').textContent = count;
        }

        // --- FILTER & SORT ---
        document.querySelectorAll('.filter-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.filter-pill.active').classList.remove('active');
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                updateRefCount();
                triggerSearch();
            });
        });

        document.getElementById('sortToggle').addEventListener('click', function() {
            currentSort = currentSort === 'abc' ? 'pvp' : 'abc';
            this.textContent = currentSort.toUpperCase();
            triggerSearch();
        });

        // --- SEARCH ---
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');

        let debounceTimer;
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => triggerSearch(), 150);
        });

        function triggerSearch() {
            const query = removeAccents(searchInput.value.toLowerCase().trim());
            searchResults.innerHTML = '';

            if (!query) {
                searchResults.style.display = 'none';
                return;
            }

            // Filter by search query
            let results = searchIndex.filter(item => item.str.includes(query));

            // Apply establishment filter
            if (currentFilter !== 'todos') {
                results = results.filter(item => subsets[currentFilter].has(item.idx));
            }

            // Apply sort
            if (currentSort === 'abc') {
                results.sort((a, b) => (refs[a.idx].descripcion || '').localeCompare(refs[b.idx].descripcion || ''));
            } else {
                results.sort((a, b) => {
                    const pa = getDisplayPrice(refs[a.idx]);
                    const pb = getDisplayPrice(refs[b.idx]);
                    return (pa ?? Infinity) - (pb ?? Infinity);
                });
            }

            if (results.length > 0) {
                results.forEach(item => {
                    const ref = refs[item.idx];
                    const el = document.createElement('div');
                    el.className = 'search-item';

                    const badge = getTipoBadge(ref.tipo);
                    const price = getDisplayPrice(ref);
                    const loc = getDisplayLocation(ref);
                    const formatLabel = ref.formato?.etiqueta && ref.formato.etiqueta !== 'Botella (75cl)'
                        ? ref.formato.etiqueta : '';

                    el.innerHTML = `
                        <div class="item-info">
                            <div class="item-title">${ref.descripcion || 'â€”'}</div>
                            ${renderGrapeTags(ref.uvas, ref.tipo?.codigo)}
                            <div class="badge-row">
                                <span class="badge ${badge.cls}">${badge.label}</span>
                                <span class="item-region">${fmt(ref.region)}</span>
                                <span class="item-pod">${ref.pod}</span>
                                ${formatLabel ? `<span class="item-format">${formatLabel}</span>` : ''}
                            </div>
                        </div>
                        <div class="item-right">
                            <div class="item-price">${currentFilter === 'todos' ? 'APROX. ' : ''}${fmtPrice(price)}</div>
                            ${loc ? `<div class="item-location">${loc}</div>` : ''}
                        </div>
                    `;

                    el.addEventListener('click', () => openModal(ref));
                    searchResults.appendChild(el);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        }

        function getDisplayPrice(ref) {
            if (currentFilter !== 'todos') {
                return ref.establecimientos?.[currentFilter]?.pvp ?? null;
            }
            return pvpMedio[ref.pod] ?? null;
        }

        function getDisplayLocation(ref) {
            if (currentFilter !== 'todos') {
                return formatLocationForUi(currentFilter, ref.establecimientos?.[currentFilter]?.localizacion).text;
            }
            return null; // No location in TODOS mode (varies by establishment)
        }

        // --- TERROIR LOOKUP ---
        function getTerroirInfoLegacy(region, pais) {
            const r = (region || '').toLowerCase();
            const p = (pais || '').toLowerCase();
            // â”€â”€ ESPAÃ‘A â”€â”€
            if (r.includes('ribera del duero')) return { clima: 'Continental extremo', suelo: 'Caliza y arcilla' };
            if (r.includes('rioja alta')) return { clima: 'MediterrÃ¡neo-atlÃ¡ntico', suelo: 'Arcilla y caliza' };
            if (r.includes('rioja alavesa')) return { clima: 'AtlÃ¡ntico-mediterrÃ¡neo', suelo: 'Arcilla caliza' };
            if (r.includes('rioja baja') || r.includes('rioja oriental')) return { clima: 'MediterrÃ¡neo cÃ¡lido', suelo: 'Arcillo-ferroso' };
            if (r.includes('rioja')) return { clima: 'MediterrÃ¡neo-atlÃ¡ntico', suelo: 'Arcilla, caliza y arena' };
            if (r.includes('priorat') || r.includes('priorato')) return { clima: 'MediterrÃ¡neo seco', suelo: 'Llicorella (pizarra)' };
            if (r.includes('rÃ­as baixas')) return { clima: 'OceÃ¡nico hÃºmedo', suelo: 'GranÃ­tico' };
            if (r.includes('ribeira sacra')) return { clima: 'OceÃ¡nico-continental', suelo: 'Pizarra y granito' };
            if (r.includes('valdeorras')) return { clima: 'OceÃ¡nico-continental', suelo: 'Pizarra y arcilla' };
            if (r.includes('rueda')) return { clima: 'Continental seco', suelo: 'Arenas y limos' };
            if (r.includes('toro')) return { clima: 'Continental extremo', suelo: 'Arenas finas' };
            if (r.includes('bierzo')) return { clima: 'OceÃ¡nico-continental', suelo: 'Pizarra y arcilla' };
            if (r.includes('galicia')) return { clima: 'OceÃ¡nico hÃºmedo', suelo: 'GranÃ­tico y pizarroso' };
            if (r.includes('madrid') || r.includes('gredos')) return { clima: 'Continental de montaÃ±a', suelo: 'GranÃ­tico' };
            if (r.includes('jerez') || r.includes('sherry') || r.includes('manzanilla') || r.includes('sanlÃºcar')) return { clima: 'MediterrÃ¡neo cÃ¡lido', suelo: 'Albariza (caliza)' };
            if (r.includes('penedÃ¨s') || r.includes('penedes')) return { clima: 'MediterrÃ¡neo', suelo: 'Caliza y arenas' };
            if (r.includes('somontano')) return { clima: 'Continental mediterrÃ¡neo', suelo: 'Caliza y arcilla' };
            if (r.includes('navarra')) return { clima: 'Continental-mediterrÃ¡neo', suelo: 'Caliza y arcilla' };
            if (r.includes('aragÃ³n') || r.includes('aragon') || r.includes('campo de borja') || r.includes('cariÃ±ena') || r.includes('calatayud')) return { clima: 'Continental mediterrÃ¡neo', suelo: 'Caliza y arcilla' };
            if (r.includes('la mancha') || r.includes('valdepeÃ±as') || r.includes('castilla-la mancha')) return { clima: 'Continental extremo', suelo: 'Arcilla y caliza' };
            if (r.includes('jumilla') || r.includes('yecla') || r.includes('alicante') || r.includes('murcia')) return { clima: 'MediterrÃ¡neo semiÃ¡rido', suelo: 'Caliza y arcilla' };
            if (r.includes('comunidad valenciana') || r.includes('utiel') || r.includes('valencia')) return { clima: 'MediterrÃ¡neo', suelo: 'Caliza y arcilla' };
            if (r.includes('montsant') || r.includes('terra alta')) return { clima: 'MediterrÃ¡neo seco', suelo: 'Caliza y arcilla' };
            if (r.includes('empordÃ ')) return { clima: 'MediterrÃ¡neo ventoso', suelo: 'Granito y pizarra' };
            if (r.includes('cataluÃ±a') || r.includes('cataluna') || r.includes('catalunya')) return { clima: 'MediterrÃ¡neo', suelo: 'Caliza y arcilla' };
            if (r.includes('txakoli') || r.includes('getariako') || r.includes('bizkaiko')) return { clima: 'OceÃ¡nico-atlÃ¡ntico', suelo: 'Caliza y arenisca' };
            if (r.includes('paÃ­s vasco') || r.includes('pais vasco') || r.includes('euskadi')) return { clima: 'OceÃ¡nico-atlÃ¡ntico', suelo: 'Caliza y arenisca' };
            if (r.includes('canarias') || r.includes('lanzarote') || r.includes('tenerife') || r.includes('gran canaria') || r.includes('la palma')) return { clima: 'Subtropical oceÃ¡nico', suelo: 'VolcÃ¡nico (lapilli/picÃ³n)' };
            if (r.includes('baleares') || r.includes('mallorca') || r.includes('binissalem')) return { clima: 'MediterrÃ¡neo', suelo: 'Caliza y arcilla roja' };
            if (r.includes('extremadura') || r.includes('ribera del guadiana')) return { clima: 'MediterrÃ¡neo continental', suelo: 'Arcilla y granito' };
            if (r.includes('castilla y leÃ³n') || r.includes('castilla leon')) return { clima: 'Continental', suelo: 'Caliza, arcilla y arena' };
            if (r.includes('andaluc') || r.includes('mÃ¡laga') || r.includes('condado de huelva')) return { clima: 'MediterrÃ¡neo cÃ¡lido', suelo: 'Caliza y arcilla' };
            if (r.includes('cava')) return { clima: 'MediterrÃ¡neo', suelo: 'Caliza y arenas' };
            // â”€â”€ FRANCIA â”€â”€
            if (r.includes('burdeos') || r.includes('bordeaux') || r.includes('mÃ©doc') || r.includes('medoc') || r.includes('pomerol') || r.includes('saint-Ã©milion') || r.includes('saint-emilion') || r.includes('graves') || r.includes('sauternes') || r.includes('pessac')) return { clima: 'OceÃ¡nico templado', suelo: 'Gravas y arcilla' };
            if (r.includes('borgoÃ±a') || r.includes('bourgogne') || r.includes('burgundy') || r.includes('chablis') || r.includes('gevrey') || r.includes('chambolle') || r.includes('vosne') || r.includes('nuits-saint') || r.includes('pommard') || r.includes('puligny') || r.includes('meursault') || r.includes('montrachet') || r.includes('beaune') || r.includes('santenay') || r.includes('mÃ¢con') || r.includes('macon') || r.includes('pouilly-fuissÃ©') || r.includes('chassagne')) return { clima: 'Continental', suelo: 'Caliza y marga' };
            if (r.includes('champagne') || r.includes('reims') || r.includes('Ã©pernay') || r.includes('epernay')) return { clima: 'OceÃ¡nico frÃ­o', suelo: 'Creta y caliza' };
            if (r.includes('alsace') || r.includes('alsacia')) return { clima: 'Continental semiÃ¡rido', suelo: 'Granito, caliza y pizarra' };
            if (r.includes('cÃ´te-rÃ´tie') || r.includes('cote rotie') || r.includes('condrieu') || r.includes('hermitage') || r.includes('crozes') || r.includes('saint-joseph') || r.includes('cornas') || r.includes('saint-pÃ©ray')) return { clima: 'Continental-mediterrÃ¡neo', suelo: 'Granito y gneis' };
            if (r.includes('chÃ¢teauneuf') || r.includes('chateauneuf') || r.includes('gigondas') || r.includes('vacqueyras') || r.includes('tavel') || r.includes('lirac')) return { clima: 'MediterrÃ¡neo cÃ¡lido', suelo: 'Cantos rodados (galets)' };
            if (r.includes('rÃ³dano') || r.includes('rodano') || r.includes('rhÃ´ne') || r.includes('rhone')) return { clima: 'MediterrÃ¡neo-continental', suelo: 'Granito, caliza y galets' };
            if (r.includes('loira') || r.includes('loire') || r.includes('pouilly-fumÃ©') || r.includes('sancerre') || r.includes('chinon') || r.includes('vouvray') || r.includes('bourgueil') || r.includes('saumur') || r.includes('anjou') || r.includes('muscadet')) return { clima: 'OceÃ¡nico', suelo: 'SÃ­lex, tuffeau y granito' };
            if (r.includes('provence') || r.includes('provenza') || r.includes('bandol')) return { clima: 'MediterrÃ¡neo', suelo: 'Caliza y esquisto' };
            if (r.includes('languedoc') || r.includes('lenguadoc') || r.includes('roussillon') || r.includes('fitou') || r.includes('corbiÃ¨res') || r.includes('minervois')) return { clima: 'MediterrÃ¡neo cÃ¡lido', suelo: 'Caliza, pizarra y gneis' };
            if (r.includes('beaujolais') || r.includes('moulin-Ã -vent') || r.includes('fleurie') || r.includes('morgon')) return { clima: 'Continental-templado', suelo: 'Granito y arcilla' };
            if (r.includes('jura')) return { clima: 'Continental frÃ­o', suelo: 'Marga y caliza azul' };
            if (r.includes('savoie') || r.includes('saboya')) return { clima: 'Alpino-continental', suelo: 'Caliza y morrena glaciar' };
            if (r.includes('gascogne') || r.includes('gascuÃ±a') || r.includes('juranÃ§on') || r.includes('iroulÃ©guy')) return { clima: 'OceÃ¡nico-pirenaico', suelo: 'Arcilla, caliza y gravas' };
            // â”€â”€ ITALIA â”€â”€
            if (r.includes('piamonte') || r.includes('piemonte') || r.includes('piedmont') || r.includes('barolo') || r.includes('barbaresco') || r.includes('barbera') || r.includes('dolcetto') || r.includes('langhe') || r.includes('monferrato') || r.includes('asti')) return { clima: 'Continental-mediterrÃ¡neo', suelo: 'Marga calcÃ¡rea (tufo)' };
            if (r.includes('toscana') || r.includes('tuscany') || r.includes('chianti') || r.includes('brunello') || r.includes('montalcino') || r.includes('montepulciano') || r.includes('maremma') || r.includes('bolgheri')) return { clima: 'MediterrÃ¡neo continental', suelo: 'Caliza, arcilla y galestro' };
            if (r.includes('vÃ©neto') || r.includes('veneto') || r.includes('amarone') || r.includes('valpolicella') || r.includes('soave') || r.includes('prosecco')) return { clima: 'Continental-mediterrÃ¡neo', suelo: 'Caliza y arcilla' };
            if (r.includes('friuli') || r.includes('friaul')) return { clima: 'Continental', suelo: 'Ponca (marga y arenisca)' };
            if (r.includes('etna') || r.includes('sicilia') || r.includes('sicily')) return { clima: 'MediterrÃ¡neo cÃ¡lido', suelo: 'VolcÃ¡nico (basalto) / Caliza' };
            if (r.includes('alto adige') || r.includes('sÃ¼dtirol') || r.includes('trentino')) return { clima: 'Alpino-mediterrÃ¡neo', suelo: 'Caliza, pizarra y pÃ³rfido' };
            if (r.includes('campania')) return { clima: 'MediterrÃ¡neo', suelo: 'VolcÃ¡nico y caliza' };
            if (r.includes('puglia') || r.includes('apulia')) return { clima: 'MediterrÃ¡neo Ã¡rido', suelo: 'Caliza y arcilla roja' };
            if (r.includes('umbria') || r.includes('umbrÃ­a')) return { clima: 'MediterrÃ¡neo continental', suelo: 'Arcilla y tiza' };
            if (r.includes('abruzzo') || r.includes('abruzos')) return { clima: 'MediterrÃ¡neo-continental', suelo: 'Arcilla y caliza' };
            if (r.includes('lombardia') || r.includes('lombardÃ­a') || r.includes('franciacorta')) return { clima: 'Continental', suelo: 'Morrena glaciar y arcilla' };
            // â”€â”€ PORTUGAL â”€â”€
            if (r.includes('douro') || r.includes('oporto')) return { clima: 'Continental seco', suelo: 'Xisto (pizarra)' };
            if (r.includes('alentejo')) return { clima: 'MediterrÃ¡neo Ã¡rido', suelo: 'Granito y esquisto' };
            if (r.includes('vinho verde') || r.includes('minho')) return { clima: 'OceÃ¡nico hÃºmedo', suelo: 'GranÃ­tico' };
            if (r.includes('dÃ£o') || r.includes('dao')) return { clima: 'Continental', suelo: 'Granito y pizarroso' };
            if (r.includes('bairrada')) return { clima: 'OceÃ¡nico', suelo: 'Arcilla y caliza' };
            if (r.includes('madeira') || r.includes('madera')) return { clima: 'OceÃ¡nico subtropical', suelo: 'VolcÃ¡nico (basalto)' };
            if (r.includes('azores') || r.includes('aÃ§ores')) return { clima: 'OceÃ¡nico subtropical', suelo: 'VolcÃ¡nico (basalto)' };
            if (r.includes('norte') || r.includes('centro') || r.includes('tejo') || r.includes('lisboa')) return { clima: 'MediterrÃ¡neo-atlÃ¡ntico', suelo: 'Arcilla, granito y caliza' };
            // â”€â”€ ALEMANIA / AUSTRIA â”€â”€
            if (r.includes('mosel') || r.includes('moselle')) return { clima: 'Continental frÃ­o', suelo: 'Pizarra azul (devÃ³nica)' };
            if (r.includes('rheingau') || r.includes('rheinhessen') || r.includes('hesse') || r.includes('nahe') || r.includes('ahr') || r.includes('renania') || r.includes('pfalz') || r.includes('palatinado') || r.includes('wÃ¼rttemberg') || r.includes('franken') || r.includes('franconia')) return { clima: 'Continental frÃ­o', suelo: 'Pizarra, cuarzo y caliza' };
            if (r.includes('wachau') || r.includes('kamptal') || r.includes('kremstal') || r.includes('burgenland') || p.includes('austria') || p.includes('Ã¶sterreich')) return { clima: 'Continental-panÃ³nico', suelo: 'Loess, gneis y pizarra' };
            if (p.includes('alemania') || p.includes('germany') || p.includes('deutschland')) return { clima: 'Continental frÃ­o', suelo: 'Pizarra y caliza' };
            // â”€â”€ HUNGRÃA / OTROS EUROPEOS â”€â”€
            if (r.includes('tokaj') || r.includes('tokay') || r.includes('hegyalja') || p.includes('hungrÃ­a') || p.includes('hungria') || p.includes('hungary')) return { clima: 'Continental panÃ³nico', suelo: 'Arcilla volcÃ¡nica y caliza' };
            if (p.includes('georgia') || r.includes('kakheti')) return { clima: 'Continental cÃ¡lido', suelo: 'Arcilla y suelo aluvial' };
            if (p.includes('grecia') || p.includes('greece')) return { clima: 'MediterrÃ¡neo', suelo: 'Caliza y arcilla' };
            // â”€â”€ AMÃ‰RICAS â”€â”€
            if (r.includes('napa') || r.includes('sonoma') || r.includes('paso robles') || r.includes('santa barbara') || r.includes('california')) return { clima: 'MediterrÃ¡neo', suelo: 'Variable (volcÃ¡nico, arcilla)' };
            if (r.includes('willamette') || r.includes('oregÃ³n') || r.includes('oregon')) return { clima: 'OceÃ¡nico templado', suelo: 'Arcilla volcÃ¡nica (Jory)' };
            if (r.includes('washington') || r.includes('columbia valley') || r.includes('walla walla')) return { clima: 'Continental semiÃ¡rido', suelo: 'Limo eÃ³lico y basalto' };
            if (r.includes('mendoza') || r.includes('lujÃ¡n de cuyo') || r.includes('maipÃº') || r.includes('valle de uco')) return { clima: 'Continental Ã¡rido', suelo: 'Aluvial y arenoso' };
            if (r.includes('salta') || r.includes('cafayate') || r.includes('patagonia') || r.includes('neuquÃ©n') || r.includes('rÃ­o negro')) return { clima: 'Continental de altitud', suelo: 'Arenoso y pedregoso' };
            if (r.includes('maipo') || r.includes('colchagua') || r.includes('casablanca') || r.includes('aconcagua') || r.includes('cachapoal') || r.includes('itata') || p.includes('chile')) return { clima: 'MediterrÃ¡neo', suelo: 'Aluvial y arcillo-granÃ­tico' };
            // â”€â”€ AUSTRALIA / NZ / SUDÃFRICA â”€â”€
            if (r.includes('barossa') || r.includes('mclaren vale') || r.includes('coonawarra') || r.includes('eden valley') || r.includes('south australia') || r.includes('australia meridional')) return { clima: 'MediterrÃ¡neo', suelo: 'Terra rossa y arcilla' };
            if (r.includes('yarra') || r.includes('mornington') || r.includes('margaret river') || p.includes('australia')) return { clima: 'OceÃ¡nico-mediterrÃ¡neo', suelo: 'Arcilla y arenisca' };
            if (r.includes('marlborough') || r.includes('central otago') || r.includes('hawke') || r.includes('isla norte') || r.includes('isla sur') || r.includes('auckland') || p.includes('nueva zelanda') || p.includes('new zealand')) return { clima: 'OceÃ¡nico frÃ­o', suelo: 'Gravas, limo y arcilla' };
            if (r.includes('stellenbosch') || r.includes('franschhoek') || r.includes('hemel') || r.includes('swartland') || r.includes('cape') || r.includes('western cape') || r.includes('coastal') || p.includes('sudÃ¡frica') || p.includes('south africa')) return { clima: 'MediterrÃ¡neo', suelo: 'Granito y esquisto' };
            return { clima: 'â€”', suelo: 'â€”' };
        }

        const REGION_TERRIOR_PRECISE = {
            'abruzzo': { clima: 'MediterrÃ¡neo con influencia de Apeninos y AdriÃ¡tico; veranos cÃ¡lidos e inviernos suaves.', suelo: 'Arcillo-calcÃ¡reo, marga y focos volcÃ¡nicos.' },
            'alentejo': { clima: 'MediterrÃ¡neo continental muy cÃ¡lido y seco; noches relativamente frescas.', suelo: 'Xisto, arcilla, mÃ¡rmol, granito y caliza.' },
            'alsacia': { clima: 'Continental seco por efecto de sombra de lluvia de los Vosgos.', suelo: 'Granito, caliza, marga, pizarra, arenisca y suelos volcÃ¡nicos.' },
            'aragon': { clima: 'Continental extremo con viento Cierzo y baja pluviometrÃ­a.', suelo: 'Caliza, arcilla, pedregoso y aluvial del valle del Ebro.' },
            'atacama': { clima: 'DesÃ©rtico hiperÃ¡rido con gran amplitud tÃ©rmica.', suelo: 'CalcÃ¡reo salino, arenoso y muy mineral.' },
            'auckland': { clima: 'MarÃ­timo templado cÃ¡lido y hÃºmedo.', suelo: 'VolcÃ¡nico-arcilloso y arcillas densas.' },
            'azores': { clima: 'OceÃ¡nico subtropical hÃºmedo, ventoso y estable.', suelo: 'Basalto y ceniza volcÃ¡nica, muy pobre en materia orgÃ¡nica.' },
            'baleares': { clima: 'MediterrÃ¡neo subtropical con fuerte influencia marÃ­tima.', suelo: 'Caliza y arcilla de baja fertilidad.' },
            'beaujolais': { clima: 'Semicontinental con influencia mediterrÃ¡nea.', suelo: 'Granito en el norte; arcilla, arenisca y caliza en el sur.' },
            'bierzo': { clima: 'TransiciÃ³n atlÃ¡ntico-continental, hÃºmedo y fresco.', suelo: 'Pizarra, arcilla, cuarzo y arena.' },
            'bizkaiko txakolina': { clima: 'AtlÃ¡ntico muy hÃºmedo con veranos suaves.', suelo: 'Caliza, marga y arcillas Ã¡cidas de poca profundidad.' },
            'borgona': { clima: 'Continental con variaciones por ladera y exposiciÃ³n.', suelo: 'Caliza y marga con fÃ³siles marinos.' },
            'burdeos': { clima: 'OceÃ¡nico templado con clara influencia atlÃ¡ntica.', suelo: 'Gravas en margen izquierda; arcilla-caliza en margen derecha.' },
            'california': { clima: 'MediterrÃ¡neo con fuerte modulaciÃ³n marÃ­tima.', suelo: 'Muy diverso: volcÃ¡nico, aluvial, arcilloso y calcÃ¡reo.' },
            'campania': { clima: 'MediterrÃ¡neo cÃ¡lido con brisas marinas.', suelo: 'VolcÃ¡nico, toba, arcilla y aluvial.' },
            'canarias': { clima: 'Subtropical con alisios y gran variaciÃ³n por altitud.', suelo: 'VolcÃ¡nico (basalto, ceniza y lapilli).' },
            'cape south coast': { clima: 'MarÃ­timo fresco por influencia de dos ocÃ©anos.', suelo: 'Granito descompuesto, esquisto y arcilla.' },
            'castilla y leon': { clima: 'Continental extremo con elevada amplitud tÃ©rmica.', suelo: 'Caliza, arcilla, arena y cantos rodados.' },
            'castilla-la mancha': { clima: 'Continental Ã¡rido extremo con insolaciÃ³n muy alta.', suelo: 'Arcillo-arenoso calcÃ¡reo y pedregoso.' },
            'cava': { clima: 'MediterrÃ¡neo con gradiente tÃ©rmico por altitud.', suelo: 'Caliza, arcilla y arena bien drenada.' },
            'central coast': { clima: 'MarÃ­timo fresco con niebla y viento del PacÃ­fico.', suelo: 'CalcÃ¡reo, aluvial y arcilloso.' },
            'centro': { clima: 'Mixto: mÃ¡s fresco en montaÃ±a y mÃ¡s cÃ¡lido en llanura.', suelo: 'Granito, xisto y arcillas.' },
            'champagne': { clima: 'FrÃ­o continental-oceÃ¡nico con maduraciÃ³n lenta.', suelo: 'Giz (chalk), marga y caliza.' },
            'coastal region': { clima: 'MediterrÃ¡neo con importante influencia oceÃ¡nica.', suelo: 'Granito antiguo, arcilla y esquisto.' },
            'comunidad valenciana': { clima: 'MediterrÃ¡neo en costa y mÃ¡s continental en interior.', suelo: 'Arcilla, caliza y arena.' },
            'conca de barbera': { clima: 'MediterrÃ¡neo continental con noches frescas.', suelo: 'Caliza oscura, arcilla y terrazas fluviales.' },
            'conca del riu anoia': { clima: 'MediterrÃ¡neo con componente continental.', suelo: 'Caliza fosilizada de antiguo lecho marino.' },
            'costers del segre': { clima: 'Continental semiÃ¡rido con alta amplitud tÃ©rmica.', suelo: 'Arenoso-calcÃ¡reo.' },
            'douro': { clima: 'Continental extremo con veranos muy cÃ¡lidos y secos.', suelo: 'Xisto dominante y granito perifÃ©rico.' },
            'extremadura': { clima: 'MediterrÃ¡neo continental con veranos calurosos.', suelo: 'Arcillo-calcÃ¡reo, aluvial arenoso y pedregoso.' },
            'franschhoek': { clima: 'MediterrÃ¡neo cÃ¡lido moderado por montaÃ±a.', suelo: 'Granito descompuesto y arcilla.' },
            'friuli-venezia-giulia': { clima: 'Continental-alpino con influencia adriÃ¡tica.', suelo: 'Grava, caliza y depÃ³sitos aluviales.' },
            'getariako txakolina': { clima: 'AtlÃ¡ntico muy hÃºmedo y fresco.', suelo: 'Arcillo-calcÃ¡reo en laderas costeras.' },
            'hemel-en-aarde': { clima: 'MarÃ­timo fresco con gran influencia oceÃ¡nica.', suelo: 'Esquisto y arcilla.' },
            'hesse': { clima: 'Continental templado.', suelo: 'Loess, caliza y arcilla.' },
            'isla norte': { clima: 'MarÃ­timo templado cÃ¡lido.', suelo: 'VolcÃ¡nico y arcilloso.' },
            'isla sur': { clima: 'MarÃ­timo fresco a continental frÃ­o.', suelo: 'Esquisto, grava y aluvial.' },
            'jerez': { clima: 'MediterrÃ¡neo cÃ¡lido y soleado.', suelo: 'Albariza calcÃ¡rea de alta retenciÃ³n hÃ­drica.' },
            'jura': { clima: 'Continental fresco.', suelo: 'Marga y caliza con presencia de esquisto.' },
            'languedoc-roussillon': { clima: 'MediterrÃ¡neo cÃ¡lido y seco.', suelo: 'Arcilla, caliza y gravas.' },
            'loira': { clima: 'OceÃ¡nico en oeste y mÃ¡s continental en este.', suelo: 'SÃ­lex, toba calcÃ¡rea y arcilla.' },
            'madrid': { clima: 'Continental mediterrÃ¡neo de altitud con noches frescas.', suelo: 'GranÃ­tico y calcÃ¡reo.' },
            'manzanilla': { clima: 'MediterrÃ¡neo mÃ¡s hÃºmedo por influencia marina.', suelo: 'Albariza calcÃ¡rea.' },
            'mendoza': { clima: 'DesÃ©rtico de altitud con noches muy frÃ­as.', suelo: 'Aluvial pedregoso.' },
            'montilla-moriles': { clima: 'Continental cÃ¡lido extremo.', suelo: 'Albariza calcÃ¡rea.' },
            'montsant': { clima: 'MediterrÃ¡neo seco.', suelo: 'Pizarra (llicorella), caliza y arcilla.' },
            'mosela': { clima: 'Continental frÃ­o.', suelo: 'Pizarra en laderas pronunciadas.' },
            'murcia': { clima: 'MediterrÃ¡neo continental cÃ¡lido.', suelo: 'CalcÃ¡reo pedregoso.' },
            'malaga': { clima: 'MediterrÃ¡neo cÃ¡lido.', suelo: 'Caliza y arcilla.' },
            'navarra': { clima: 'Continental mediterrÃ¡neo.', suelo: 'Caliza, arcilla y gravas.' },
            'norte': { clima: 'AtlÃ¡ntico fresco y hÃºmedo.', suelo: 'GranÃ­tico.' },
            'oregon': { clima: 'MarÃ­timo fresco de influencia pacÃ­fica.', suelo: 'VolcÃ¡nico (Jory), aluvial y sedimentario.' },
            'patagonia': { clima: 'Continental frÃ­o y seco.', suelo: 'Aluvial y pedregoso.' },
            'penedes': { clima: 'MediterrÃ¡neo escalonado por altitud.', suelo: 'CalcÃ¡reo y arcilloso.' },
            'piamonte': { clima: 'Continental con nieblas otoÃ±ales.', suelo: 'Marga calcÃ¡rea.' },
            'priorat': { clima: 'MediterrÃ¡neo seco y de fuerte estrÃ©s hÃ­drico.', suelo: 'Llicorella (pizarra roja y negra).' },
            'provenza': { clima: 'MediterrÃ¡neo soleado con influencia del Mistral.', suelo: 'Caliza, arcilla y gravas.' },
            'puglia': { clima: 'MediterrÃ¡neo cÃ¡lido.', suelo: 'Caliza y terra rossa.' },
            'renania-palatinado': { clima: 'Continental templado.', suelo: 'Pizarra, loess y caliza.' },
            'ribeira sacra': { clima: 'AtlÃ¡ntico fresco con componente continental.', suelo: 'Pizarra en bancales.' },
            'ribeiro': { clima: 'AtlÃ¡ntico hÃºmedo.', suelo: 'Granito y arcilla.' },
            'ribera del duero': { clima: 'Continental extremo con alta oscilaciÃ³n tÃ©rmica.', suelo: 'Caliza, arcilla y arena.' },
            'rioja': { clima: 'Continental con influencias atlÃ¡ntica y mediterrÃ¡nea.', suelo: 'Arcillo-calcÃ¡reo, arcillo-ferroso y aluvial.' },
            'rioja alavesa': { clima: 'MÃ¡s atlÃ¡ntico y fresco que Rioja Oriental.', suelo: 'Arcillo-calcÃ¡reo.' },
            'rueda': { clima: 'Continental.', suelo: 'Cascajoso (pedregoso) y arenas calcÃ¡reas.' },
            'rias baixas': { clima: 'AtlÃ¡ntico hÃºmedo y templado.', suelo: 'GranÃ­tico, arenoso y Ã¡cido.' },
            'rodano': { clima: 'Continental en norte y mediterrÃ¡neo en sur.', suelo: 'Granito (norte) y galets/cantos rodados (sur).' },
            'sicilia': { clima: 'MediterrÃ¡neo; mÃ¡s fresco en altitud del Etna.', suelo: 'VolcÃ¡nico en Etna y calcÃ¡reo en zonas bajas.' },
            'somontano': { clima: 'Continental de altitud.', suelo: 'Caliza y gravas.' },
            'south australia': { clima: 'MediterrÃ¡neo variable segÃºn subzona.', suelo: 'Terra rossa, caliza y arcilla roja.' },
            'stellenbosch': { clima: 'MediterrÃ¡neo cÃ¡lido moderado por brisa oceÃ¡nica.', suelo: 'Granito antiguo descompuesto y arcilla.' },
            'tokaji-hegyalja': { clima: 'Continental con nieblas favorables a botrytis.', suelo: 'VolcÃ¡nico, loess y arcilla.' },
            'toro': { clima: 'Continental cÃ¡lido.', suelo: 'Arenoso con base calcÃ¡rea.' },
            'toscana': { clima: 'MediterrÃ¡neo.', suelo: 'Galestro (arcilla esquistosa) y albarese (caliza).' },
            'traiguen': { clima: 'Fresco y hÃºmedo del sur chileno.', suelo: 'VolcÃ¡nico y aluvial.' },
            'trentino-alto adige': { clima: 'Alpino continental con gran amplitud tÃ©rmica.', suelo: 'Grava, caliza y origen volcÃ¡nico.' },
            'valdeorras': { clima: 'AtlÃ¡ntico de transiciÃ³n.', suelo: 'Pizarra dominante.' },
            'valle central': { clima: 'MediterrÃ¡neo clÃ¡sico.', suelo: 'Aluvial y gravas.' },
            'valle de maipo': { clima: 'MediterrÃ¡neo con influencia andina.', suelo: 'Grava aluvial de origen andino.' },
            'victoria': { clima: 'Variable; de fresco a templado-cÃ¡lido segÃºn subzona.', suelo: 'Terra rossa, volcÃ¡nico y aluvial.' },
            'veneto': { clima: 'Variable entre alpino y mediterrÃ¡neo.', suelo: 'VolcÃ¡nico, aluvial y calcÃ¡reo.' },
            'western cape': { clima: 'MediterrÃ¡neo con brisas oceÃ¡nicas.', suelo: 'Granito, esquisto y arcilla.' }
        };

        const GRAPE_TERRIOR_PROFILE = {
            tempranillo: { clima: 'madura bien en continental con amplitud tÃ©rmica.', suelo: 'destaca en arcillo-calcÃ¡reo y aluvial pedregoso.' },
            garnacha: { clima: 'tolera calor y sequÃ­a mediterrÃ¡nea.', suelo: 'rinde mejor en pizarra, canto rodado y caliza pobre.' },
            monastrell: { clima: 'requiere calor y maduraciÃ³n larga.', suelo: 'encaja en calcÃ¡reo pedregoso de baja fertilidad.' },
            bobal: { clima: 'resiste clima continental seco.', suelo: 'funciona en arcilla calcÃ¡rea con grava.' },
            mencia: { clima: 'expresa frescura en atlÃ¡ntico-continental.', suelo: 'gana finura en pizarra y granito.' },
            pinotnoir: { clima: 'prefiere zonas frescas y maduraciÃ³n lenta.', suelo: 'brilla en caliza/marga y suelos de buen drenaje.' },
            syrah: { clima: 'equilibrio ideal entre calor diurno y noches frescas.', suelo: 'granito, esquisto y cantos rodados aumentan complejidad.' },
            shiraz: { clima: 'admite climas cÃ¡lidos manteniendo especia.', suelo: 'arcilla roja y terra rossa aportan potencia.' },
            nebbiolo: { clima: 'necesita continental fresco con otoÃ±o largo.', suelo: 'marga calcÃ¡rea para tanino noble.' },
            sangiovese: { clima: 'mediterrÃ¡neo con amplitud tÃ©rmica moderada.', suelo: 'galestro y albarese afinan acidez y estructura.' },
            barbera: { clima: 'adapta bien a continental templado.', suelo: 'marga y arcilla conservan su acidez natural.' },
            riesling: { clima: 'excelente en climas frÃ­os a frescos.', suelo: 'pizarra, granito o caliza elevan mineralidad.' },
            albarino: { clima: 'atlÃ¡ntico hÃºmedo y fresco.', suelo: 'granito arenoso mejora perfil salino y cÃ­trico.' },
            verdejo: { clima: 'continental con noches frescas.', suelo: 'cascajoso-calcÃ¡reo favorece tensiÃ³n y aromas herbales.' },
            godello: { clima: 'atlÃ¡ntico de transiciÃ³n.', suelo: 'pizarra y suelos pobres aumentan textura mineral.' },
            chardonnay: { clima: 'muy sensible al mesoclima; ideal en fresco-templado.', suelo: 'caliza y marga definen precisiÃ³n y longitud.' },
            sauvignonblanc: { clima: 'mejor en climas frescos con buena ventilaciÃ³n.', suelo: 'sÃ­lex, caliza y granito acentÃºan verticalidad.' },
            viognier: { clima: 'prefiere cÃ¡lido moderado sin exceso tÃ©rmico.', suelo: 'granito y arcilla drenada preservan perfume.' },
            xarello: { clima: 'mediterrÃ¡neo con amplitud tÃ©rmica moderada.', suelo: 'caliza aporta estructura y acidez estable.' },
            macabeo: { clima: 'mediterrÃ¡neo templado.', suelo: 'caliza y arcilla ligera mantienen frescura.' },
            parellada: { clima: 'mejor en cotas altas y frescas.', suelo: 'calcÃ¡reo pobre para tensiÃ³n Ã¡cida.' },
            glera: { clima: 'templado-fresco con influencia montaÃ±osa.', suelo: 'margas y arcillas livianas favorecen delicadeza.' },
            furmint: { clima: 'continental con niebla otoÃ±al.', suelo: 'volcÃ¡nico y loess sostienen acidez y longevidad.' },
            harslevelu: { clima: 'continental con botrytis controlada.', suelo: 'volcÃ¡nico y arcilloso para concentraciÃ³n aromÃ¡tica.' },
            cabernetsauvignon: { clima: 'mejor en templado-cÃ¡lido de ciclo largo.', suelo: 'grava/cascajo para drenaje y maduraciÃ³n fenÃ³lica.' },
            cabernetfranc: { clima: 'funciona muy bien en fresco-templado.', suelo: 'caliza y arcilla para tanino fino y perfume.' },
            merlot: { clima: 'maduraciÃ³n precoz en templado.', suelo: 'arcilla y caliza favorecen textura redonda.' },
            graciano: { clima: 'requiere insolaciÃ³n alta con noches frescas.', suelo: 'arcillo-calcÃ¡reo para color y acidez.' },
            carinena: { clima: 'tolera sequÃ­a y calor.', suelo: 'pizarra y caliza pobre generan concentraciÃ³n.' },
            touriganacional: { clima: 'continental cÃ¡lido con buen contraste tÃ©rmico.', suelo: 'xisto potencia estructura y aromaticidad floral.' },
            tourigafranca: { clima: 'adaptada a calor seco.', suelo: 'xisto y pendientes bien drenadas.' },
            cheninblanc: { clima: 'muy versÃ¡til, destaca en fresco a templado.', suelo: 'esquisto y caliza elevan tensiÃ³n y guarda.' },
            semillon: { clima: 'oceÃ¡nico templado.', suelo: 'gravas y arcillas para volumen y textura cerosa.' },
            malbec: { clima: 'Ã³ptimo en altura con noches frÃ­as.', suelo: 'aluvial pedregoso para concentraciÃ³n con frescura.' },
            carmenere: { clima: 'templado-cÃ¡lido con otoÃ±o largo.', suelo: 'aluvial y arcilla drenada para madurez completa.' },
            nerellomascalese: { clima: 'mediterrÃ¡neo de altitud.', suelo: 'volcÃ¡nico para perfil ferrosomineral.' },
            aglianico: { clima: 'prefiere maduraciÃ³n lenta en zonas elevadas.', suelo: 'volcÃ¡nico y calcÃ¡reo para tanino y acidez.' }
        };

        const GRAPE_FAMILY_TERRIOR_PROFILE = {
            'iberica-tinta': { clima: 'suele rendir mejor con dÃ­as cÃ¡lidos y noches frescas.', suelo: 'prefiere caliza, arcilla pobre o pizarra de buen drenaje.' },
            'burgundy': { clima: 'normalmente necesita clima fresco o templado fresco.', suelo: 'caliza, marga o suelos pedregosos bien drenados elevan precisiÃ³n.' },
            'italiana': { clima: 'se expresa bien en mediterrÃ¡neo con contraste tÃ©rmico.', suelo: 'marga, caliza y suelos volcÃ¡nicos moderan estructura.' },
            'aromatico': { clima: 'requiere conservar acidez y fragancia en zonas frescas.', suelo: 'granito, pizarra o calcÃ¡reo ligero aportan tensiÃ³n aromÃ¡tica.' },
            'novamundo': { clima: 'admite mayor insolaciÃ³n sin perder equilibrio si hay ventilaciÃ³n.', suelo: 'aluvial, grava y arcilla drenada ayudan a madurez fenÃ³lica.' },
            'espumoso': { clima: 'busca maduraciÃ³n lenta para retener acidez.', suelo: 'calcÃ¡reo y margoso favorecen finura y persistencia.' }
        };

        const GRAPE_KEY_ALIASES = {
            aragonez: 'tempranillo',
            tintadetoro: 'tempranillo',
            viura: 'macabeo',
            rolle: 'vermentino',
            gouveio: 'godello',
            mourvedre: 'monastrell',
            shiraz: 'syrah',
            ploussard: 'poulsard',
            xarello: 'xarello',
            xarelolo: 'xarello',
            sargamuskotaly: 'moscatel'
        };

        function canonicalRegionKey(value) {
            return normalizeToken(value).replace(/\s+/g, ' ').trim();
        }

        function canonicalGrapeKey(value) {
            const normalized = normalizeToken(value).replace(/[^a-z0-9]/g, '');
            return GRAPE_KEY_ALIASES[normalized] || normalized;
        }

        function getPredominantGrape(uvasArr) {
            const grapes = extractGrapeItems(uvasArr);
            if (!grapes.length) return null;
            let best = grapes[0];
            let bestPct = Number.isFinite(Number(best.pct)) ? Number(best.pct) : -1;
            for (let i = 1; i < grapes.length; i++) {
                const candidate = grapes[i];
                const candidatePct = Number.isFinite(Number(candidate.pct)) ? Number(candidate.pct) : -1;
                if (candidatePct > bestPct) {
                    best = candidate;
                    bestPct = candidatePct;
                }
            }
            return best;
        }

        function getPreciseRegionTerroir(region) {
            const key = canonicalRegionKey(region);
            if (!key) return null;
            if (REGION_TERRIOR_PRECISE[key]) return REGION_TERRIOR_PRECISE[key];
            const fuzzyMatch = Object.keys(REGION_TERRIOR_PRECISE).find((known) => key.includes(known) || known.includes(key));
            return fuzzyMatch ? REGION_TERRIOR_PRECISE[fuzzyMatch] : null;
        }

        function getGrapeTerroirProfile(grapeName) {
            const key = canonicalGrapeKey(grapeName);
            if (!key) return null;
            if (GRAPE_TERRIOR_PROFILE[key]) return GRAPE_TERRIOR_PROFILE[key];
            const familyClass = String(getGrapeColor(grapeName || '') || '').split(' ')[0];
            return GRAPE_FAMILY_TERRIOR_PROFILE[familyClass] || null;
        }

        function mergeTerroirText(base, extra) {
            const parts = [];
            if (base && base !== 'â€”') parts.push(base);
            if (extra) parts.push(extra);
            if (!parts.length) return 'â€”';
            return parts
                .flatMap((part) => String(part)
                    .split(/\s*[;Â·]\s*/)
                    .map((chunk) => chunk.trim())
                    .filter(Boolean))
                .map((chunk) => `Â· ${chunk}`)
                .join('\n');
        }

        function getTerroirInfo(region, pais, uvasArr) {
            const regionBase = getPreciseRegionTerroir(region) || getTerroirInfoLegacy(region, pais);
            const dominant = getPredominantGrape(uvasArr);
            if (!dominant || !dominant.nome) {
                return regionBase;
            }
            const grapeProfile = getGrapeTerroirProfile(dominant.nome);
            if (!grapeProfile) {
                return regionBase;
            }
            return {
                clima: mergeTerroirText(regionBase.clima, `Uva dominante (${dominant.nome}): ${grapeProfile.clima}`),
                suelo: mergeTerroirText(regionBase.suelo, `Afinidad de ${dominant.nome}: ${grapeProfile.suelo}`)
            };
        }

        // --- MODAL ---
        const wineModal = document.getElementById('wineModal');
        const editButton = document.getElementById('btnEditWine');
        const adminButton = document.getElementById('adminBtn');
        const logoutButton = document.getElementById('logoutBtn');
        const consumeCavaButton = document.getElementById('btnConsumeCava');
        const consumeBodegaButton = document.getElementById('btnConsumeBodega');
        const consumeQtySelect = document.getElementById('consumeQty');
        const consumeFeedback = document.getElementById('consumeFeedback');
        const syncToast = document.getElementById('syncToast');
        let syncToastTimer = null;

        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    await fetch('/api/auth-logout', { method: 'POST', cache: 'no-store' });
                } catch {}
                clearAuthState();
                window.location.replace('login.html');
            });
        }

        if (adminButton) {
            adminButton.style.display = canOpenReportPage() ? 'inline-flex' : 'none';
            const buttonLabel = currentUserRole === 'user'
                ? (translations[currentLang]?.report || 'Ventas')
                : (translations[currentLang]?.admin || 'Admin');
            adminButton.textContent = buttonLabel;
            adminButton.addEventListener('click', () => {
                window.location.href = 'admin.html';
            });
        }

        const movementLogKey = MOVEMENTS_KEY;

        function getLocalDateKey(dateInput = new Date()) {
            const date = new Date(dateInput);
            if (Number.isNaN(date.getTime())) {
                const fallback = new Date();
                return `${fallback.getFullYear()}-${String(fallback.getMonth() + 1).padStart(2, '0')}-${String(fallback.getDate()).padStart(2, '0')}`;
            }
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getMadridServiceDayKey(dateInput = new Date()) {
            const date = new Date(dateInput);
            const formatter = new Intl.DateTimeFormat('en-GB', {
                timeZone: 'Europe/Madrid',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                hour12: false
            });
            const parts = formatter.formatToParts(date);
            const read = (type) => Number(parts.find((part) => part.type === type)?.value || '0');
            const year = read('year');
            const month = read('month');
            const day = read('day');
            const hour = read('hour');
            const baseUtc = new Date(Date.UTC(year, month - 1, day));
            if (hour < 6) {
                baseUtc.setUTCDate(baseUtc.getUTCDate() - 1);
            }
            return `${baseUtc.getUTCFullYear()}-${String(baseUtc.getUTCMonth() + 1).padStart(2, '0')}-${String(baseUtc.getUTCDate()).padStart(2, '0')}`;
        }

        function readMovementLogStore() {
            return parseJsonObject(localStorage.getItem(movementLogKey));
        }

        function setConsumeFeedback(message) {
            if (!consumeFeedback) return;
            consumeFeedback.textContent = message || '';
        }

        function showSyncToast(message) {
            if (!syncToast) return;
            syncToast.textContent = message || 'Cava Atualizada';
            syncToast.classList.add('show');
            if (syncToastTimer) clearTimeout(syncToastTimer);
            syncToastTimer = window.setTimeout(() => {
                syncToast.classList.remove('show');
            }, 1700);
        }

        function resolveMovementEstablishment() {
            if (EST_KEYS.includes(currentUserScope)) return currentUserScope;
            if (currentFilter !== 'todos') return currentFilter;
            if (EST_KEYS.includes(currentUserEstablishment)) return currentUserEstablishment;
            return null;
        }

        function appendMovementLog(entry) {
            try {
                const today = getLocalDateKey();
                const parsed = readMovementLogStore();
                if (!Array.isArray(parsed[today])) parsed[today] = [];
                parsed[today].push(entry);
                localStorage.setItem(movementLogKey, JSON.stringify(parsed));
                queuePendingMutation({
                    id: createMutationId(),
                    type: 'movement',
                    dateKey: today,
                    payload: entry
                });
                void runRealtimeSyncCycle();
            } catch {
                return;
            }
        }

        function registerConsume(sourceType = 'cava') {
                if (!currentEditPod) return;
                const ref = refs.find(r => r.pod === currentEditPod);
                if (!ref) return;

                const estKey = resolveMovementEstablishment();
                if (!estKey) {
                    setConsumeFeedback(translations[currentLang].consumeNeedFilter || 'Selecione uma planta para registrar retirada.');
                    return;
                }

                if (!ref.establecimientos) ref.establecimientos = {};
                if (!ref.establecimientos[estKey]) ref.establecimientos[estKey] = { pvp: null, unidades: null, localizacion: null };

                const quantity = Number(consumeQtySelect?.value || '1');
                const est = ref.establecimientos[estKey];
                const before = typeof est.unidades === 'number' ? est.unidades : null;

                if (typeof est.unidades === 'number') {
                    const nextValue = Math.max(est.unidades - quantity, 0);
                    est.unidades = nextValue;
                    saveEdit(currentEditPod, `establecimientos.${estKey}.unidades`, nextValue);
                    setConsumeFeedback('');
                } else {
                    setConsumeFeedback('');
                }

                appendMovementLog({
                    at: new Date().toISOString(),
                    user: currentUserName,
                    role: currentUserRole,
                    scope: currentUserScope,
                    source: sourceType === 'bodega' ? 'bodega' : 'cava',
                    establishment: estKey,
                    pod: ref.pod,
                    wine: ref.descripcion || 'â€”',
                    year: ref.ano ?? null,
                    size: ref.formato?.etiqueta || null,
                    qty: quantity,
                    before,
                    after: typeof ref.establecimientos[estKey].unidades === 'number' ? ref.establecimientos[estKey].unidades : null,
                    storageDayKey: getLocalDateKey(),
                    serviceDayKey: getMadridServiceDayKey()
                });

                preProcess();
                updateRefCount();
                openModal(ref);
                showSyncToast(translations[currentLang].consumeToastUpdated || 'Cava Atualizada');
        }

        if (consumeCavaButton) {
            consumeCavaButton.addEventListener('click', () => {
                registerConsume('cava');
            });
        }

        if (consumeBodegaButton) {
            consumeBodegaButton.addEventListener('click', () => {
                registerConsume('bodega');
            });
        }

        function openModal(ref) {
            currentEditPod = ref.pod;
            const badge = getTipoBadge(ref.tipo);

            document.getElementById('modalBadge').className = `badge ${badge.cls}`;
            document.getElementById('modalBadge').textContent = badge.label;
            document.getElementById('modalName').textContent = ref.descripcion || 'â€”';

            // Subtitle: Bodega | Year | Format | POD
            const parts = [ref.bodega, ref.ano, ref.formato?.etiqueta, ref.pod].filter(Boolean);
            document.getElementById('modalSubtitle').textContent = parts.join(' Â· ') || 'â€”';

            // Grapes
            document.getElementById('modalGrapes').innerHTML = renderGrapeTags(ref.uvas, ref.tipo?.codigo);

            // Detail boxes
            document.getElementById('modalRegion').textContent = fmt(ref.region);
            document.getElementById('modalCountry').textContent = fmt(ref.pais);
            document.getElementById('modalYear').textContent = fmt(ref.ano);
            document.getElementById('modalFormat').textContent = fmt(ref.formato?.etiqueta);

            // Terroir cards
            const terroir = getTerroirInfo(ref.region, ref.pais, ref.uvas);
            document.getElementById('modalClima').textContent = terroir.clima;
            document.getElementById('modalSuelo').textContent = terroir.suelo;

            // Establishment table
            const prefixMap = { bodega: 'Bodega', spa: 'Spa', tasca_fina: 'Tasca', victoria: 'Victoria', galeria: 'Galeria' };
            EST_KEYS.forEach(k => {
                const est = ref.establecimientos?.[k];
                const prefix = prefixMap[k];
                if (!prefix) return;
                document.getElementById(`est${prefix}Pvp`).textContent = fmtPrice(est?.pvp);
                document.getElementById(`est${prefix}Stock`).textContent = fmt(est?.unidades);
                document.getElementById(`est${prefix}Loc`).textContent = fmt(formatLocationForUi(k, est?.localizacion).text);
            });

            // Reset edit form
            document.getElementById('editForm').classList.remove('visible');
            if (editButton) {
                editButton.style.display = hasEditAccess() ? 'inline-block' : 'none';
            }
            if (consumeQtySelect) consumeQtySelect.value = '1';
            setConsumeFeedback('');

            searchResults.style.display = 'none';
            searchInput.blur();
            wineModal.classList.add('active');
        }

        function closeModal() {
            wineModal.classList.remove('active');
            searchInput.value = '';
        }

        document.getElementById('btnClose').addEventListener('click', closeModal);
        wineModal.addEventListener('click', e => { if (e.target === wineModal) closeModal(); });

        // --- EDIT ---
        document.getElementById('btnEditWine').addEventListener('click', () => {
            if (!hasEditAccess()) return;
            if (!currentEditPod) return;
            const ref = refs.find(r => r.pod === currentEditPod);
            if (!ref) return;

            const editableKeys = getEditableEstablishmentKeys();
            const editableKeySet = new Set(editableKeys);
            EDITABLE_EST_KEYS.forEach((k) => {
                const est = ref.establecimientos?.[k] || {};
                const prefix = EDIT_PREFIX_MAP[k];
                const pvpInput = document.getElementById(`edit${prefix}Pvp`);
                const stockInput = document.getElementById(`edit${prefix}Stock`);
                const locInput = document.getElementById(`edit${prefix}Loc`);
                const canEditScope = editableKeySet.has(k);

                if (pvpInput) {
                    pvpInput.value = est.pvp != null ? est.pvp : '';
                    pvpInput.disabled = !canEditScope;
                }
                if (stockInput) {
                    stockInput.value = est.unidades != null ? est.unidades : '';
                    stockInput.disabled = !canEditScope;
                }
                if (locInput) {
                    locInput.value = normalizeLocationValue(est.localizacion, k) || '';
                    locInput.disabled = !canEditScope;
                }
            });

            document.getElementById('editForm').classList.add('visible');
            document.getElementById('btnEditWine').style.display = 'none';
        });

        document.getElementById('btnCancelEdit').addEventListener('click', () => {
            document.getElementById('editForm').classList.remove('visible');
            document.getElementById('btnEditWine').style.display = hasEditAccess() ? 'inline-block' : 'none';
        });

        document.getElementById('btnSaveEdit').addEventListener('click', () => {
            if (!hasEditAccess()) return;
            if (!currentEditPod) return;
            const ref = refs.find(r => r.pod === currentEditPod);
            if (!ref) return;
            let hasChanges = false;

            // Save per-establishment fields within the user's allowed scope
            const editableKeys = getEditableEstablishmentKeys();
            editableKeys.forEach(k => {
                if (!ref.establecimientos) ref.establecimientos = {};
                if (!ref.establecimientos[k]) ref.establecimientos[k] = { pvp: null, unidades: null, localizacion: null };
                const est = ref.establecimientos[k];
                const prefix = EDIT_PREFIX_MAP[k];

                const pvpVal = document.getElementById(`edit${prefix}Pvp`).value;
                const pvp = pvpVal !== '' ? Number(pvpVal) : null;
                if (pvp !== est.pvp) {
                    est.pvp = pvp;
                    saveEdit(currentEditPod, `establecimientos.${k}.pvp`, pvp);
                    hasChanges = true;
                }

                const stockVal = document.getElementById(`edit${prefix}Stock`).value;
                const stock = stockVal !== '' ? Number(stockVal) : null;
                if (stock !== est.unidades) {
                    est.unidades = stock;
                    saveEdit(currentEditPod, `establecimientos.${k}.unidades`, stock);
                    hasChanges = true;
                }

                const loc = normalizeLocationValue(document.getElementById(`edit${prefix}Loc`).value, k);
                if (loc !== normalizeLocationValue(est.localizacion, k)) {
                    est.localizacion = loc;
                    saveEdit(currentEditPod, `establecimientos.${k}.localizacion`, loc);
                    hasChanges = true;
                }
            });

            // Recalculate BODEGA price (automatic average)
            if (ref.establecimientos) {
                const prices = ['spa', 'tasca_fina', 'victoria']
                    .map(k => ref.establecimientos[k]?.pvp)
                    .filter(p => p != null);
                const avg = prices.length > 0 ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length) : null;
                if (!ref.establecimientos.bodega) ref.establecimientos.bodega = {};
                if (avg !== ref.establecimientos.bodega.pvp) {
                    ref.establecimientos.bodega.pvp = avg;
                    saveEdit(currentEditPod, 'establecimientos.bodega.pvp', avg);
                    hasChanges = true;
                }
            }

            // Recompute indexes
            preProcess();
            updateRefCount();

            // Refresh modal
            openModal(ref);
            if (hasChanges) {
                showSyncToast(translations[currentLang].consumeToastUpdated || 'Cava Atualizada');
            }
        });

        function isPlainObject(value) {
            return Boolean(value) && typeof value === 'object' && !Array.isArray(value);
        }

        function applyRemoteState(state) {
            if (!isPlainObject(state)) return;
            if (Array.isArray(state.edits)) {
                localStorage.setItem(EDITS_KEY, JSON.stringify(sanitizeEditsForCurrentUi(state.edits)));
            }
            if (isPlainObject(state.movementLog)) {
                localStorage.setItem(MOVEMENTS_KEY, JSON.stringify(state.movementLog));
            }
            rebuildRefsFromLocalSnapshot();
        }

        function mergeRemoteStateWithPending(state, pendingMutations) {
            const mergedEdits = Array.isArray(state?.edits) ? state.edits.map((edit) => ({ ...edit })) : [];
            const mergedMovementLog = isPlainObject(state?.movementLog)
                ? Object.fromEntries(
                    Object.entries(state.movementLog).map(([key, value]) => [key, Array.isArray(value) ? [...value] : []])
                )
                : {};

            if (!Array.isArray(pendingMutations) || pendingMutations.length === 0) {
                return { edits: mergedEdits, movementLog: mergedMovementLog };
            }

            pendingMutations.forEach((mutation) => {
                if (!mutation || typeof mutation !== 'object' || typeof mutation.type !== 'string') return;

                if (mutation.type === 'edit') {
                    const payload = mutation.payload;
                    if (!payload || typeof payload.pod !== 'string' || typeof payload.path !== 'string') return;
                    const nextEdit = {
                        pod: payload.pod,
                        path: payload.path,
                        value: payload.value,
                        updatedAt: payload.updatedAt || new Date().toISOString(),
                        updatedBy: payload.updatedBy || currentUserName
                    };
                    const idx = mergedEdits.findIndex((edit) => edit.pod === nextEdit.pod && edit.path === nextEdit.path);
                    if (idx >= 0) mergedEdits[idx] = nextEdit;
                    else mergedEdits.push(nextEdit);
                    return;
                }

                if (mutation.type === 'movement') {
                    const payload = mutation.payload;
                    if (!payload || typeof payload !== 'object') return;
                    const dateKey = typeof mutation.dateKey === 'string' && mutation.dateKey ? mutation.dateKey : getLocalDateKey(payload.at || new Date());
                    if (!Array.isArray(mergedMovementLog[dateKey])) mergedMovementLog[dateKey] = [];
                    mergedMovementLog[dateKey].push(payload);
                }
            });

            return { edits: mergedEdits, movementLog: mergedMovementLog };
        }

        async function runRealtimeSyncCycle() {
            if (syncInFlight || !baseRefs.length) return;
            if (syncDisabled) return;
            if (!navigator.onLine) return;
            syncInFlight = true;
            let shouldRunAgain = false;
            try {
                const pendingMutations = readPendingMutations();
                const knownRevision = Number(localStorage.getItem(SYNC_REVISION_KEY) || '0');

                const response = await fetch(SYNC_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    cache: 'no-store',
                    body: JSON.stringify({
                        clientId: syncClientId,
                        knownRevision,
                        mutations: pendingMutations
                    })
                });

                if (response.status === 404) {
                    syncDisabled = true;
                    return;
                }
                if (response.status === 401) {
                    clearAuthState();
                    window.location.replace('login.html');
                    return;
                }
                if (!response.ok) return;
                const payload = await response.json();
                if (!payload || payload.ok !== true) return;

                const acknowledgedIds = Array.isArray(payload.acknowledgedMutationIds)
                    ? payload.acknowledgedMutationIds.filter((id) => typeof id === 'string' && id)
                    : [];
                const rejectedIds = Array.isArray(payload.rejectedMutationIds)
                    ? payload.rejectedMutationIds.filter((id) => typeof id === 'string' && id)
                    : [];
                let remainingQueue = pendingMutations;

                if (acknowledgedIds.length > 0 || rejectedIds.length > 0) {
                    const currentQueue = readPendingMutations();
                    const completedSet = new Set([...acknowledgedIds, ...rejectedIds]);
                    remainingQueue = currentQueue.filter((mutation) => {
                        const mutationId = typeof mutation?.id === 'string' ? mutation.id : '';
                        return !completedSet.has(mutationId);
                    });
                    writePendingMutations(remainingQueue);
                    shouldRunAgain = remainingQueue.length > 0;
                }

                const revisionValue = Number(payload.revision);
                if (Number.isFinite(revisionValue) && revisionValue >= 0) {
                    localStorage.setItem(SYNC_REVISION_KEY, String(revisionValue));
                }

                if (isPlainObject(payload.state)) {
                    const shouldApply = acknowledgedIds.length > 0
                        || payload.hasUpdate === true
                        || (Number.isFinite(revisionValue) && revisionValue > knownRevision);
                    if (shouldApply) {
                        const mergedState = mergeRemoteStateWithPending(payload.state, remainingQueue);
                        applyRemoteState(mergedState);
                    }
                }
            } catch {
                return;
            } finally {
                syncInFlight = false;
                if (shouldRunAgain && !syncDisabled) {
                    window.setTimeout(() => {
                        void runRealtimeSyncCycle();
                    }, 120);
                }
            }
        }

        function startRealtimeSync() {
            if (syncTimer) {
                clearInterval(syncTimer);
            }
            void runRealtimeSyncCycle();
            syncTimer = window.setInterval(() => {
                void runRealtimeSyncCycle();
            }, SYNC_INTERVAL_MS);
        }

        window.addEventListener('storage', (event) => {
            if (event.key === EDITS_KEY) {
                rebuildRefsFromLocalSnapshot();
                return;
            }
            if (event.key === MOVEMENTS_KEY) {
                return;
            }
            if (event.key === SYNC_REVISION_KEY) {
                void runRealtimeSyncCycle();
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                void runRealtimeSyncCycle();
            }
        });

        // --- LANGUAGE ---
        function getNextPhrase() {
            if (phraseQueue.length === 0) {
                phraseQueue = [...translations[currentLang].placeholders];
                for (let i = phraseQueue.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [phraseQueue[i], phraseQueue[j]] = [phraseQueue[j], phraseQueue[i]];
                }
                if (phraseQueue[0] === currentPhrase && phraseQueue.length > 1) {
                    phraseQueue.push(phraseQueue.shift());
                }
            }
            return phraseQueue.pop();
        }

        function startTypeWriter() {
            const input = document.getElementById('searchInput');
            if (!input) return;

            if (!currentPhrase) currentPhrase = getNextPhrase();

            if (isDeleting) {
                input.placeholder = currentPhrase.substring(0, charIndex - 1);
                charIndex--;
            } else {
                input.placeholder = currentPhrase.substring(0, charIndex + 1);
                charIndex++;
            }

            let speed = isDeleting ? 20 : 50;

            if (!isDeleting && charIndex === currentPhrase.length) {
                speed = 2000;
                isDeleting = true;
            } else if (isDeleting && charIndex === 0) {
                isDeleting = false;
                currentPhrase = getNextPhrase();
                speed = 500;
            }

            clearTimeout(typeWriterTimeout);
            typeWriterTimeout = setTimeout(startTypeWriter, speed);
        }

        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            document.getElementById('currentLangBtn').textContent = t.btnLabel;

            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (t[key] && el.tagName !== 'INPUT') el.textContent = t[key];
            });

            if (adminButton) {
                adminButton.textContent = currentUserRole === 'user'
                    ? (t.report || 'Ventas')
                    : (t.admin || 'Admin');
            }

            phraseQueue = [];
            currentPhrase = '';
            charIndex = 0;
            isDeleting = false;
            clearTimeout(typeWriterTimeout);
            startTypeWriter();

            // Refresh search results if visible
            triggerSearch();

            // If modal is open, re-render it with the selected language labels/badges.
            if (wineModal.classList.contains('active') && currentEditPod) {
                const liveRef = refs.find((item) => item.pod === currentEditPod);
                if (liveRef) {
                    openModal(liveRef);
                }
            }
        }

        // --- DARK/LIGHT MODE TOGGLE (CANVAS) ---
        const themeToggle = document.getElementById('themeToggle');
        const toggleCanvas = document.getElementById('toggleCanvas');
        const tCtx = toggleCanvas.getContext('2d');
        toggleCanvas.width = 80;
        toggleCanvas.height = 40;

        let isDark = true;
        let toggleProgress = 1;
        const lerp = (a, b, t) => a + (b - a) * t;

        function drawToggle() {
            const w = toggleCanvas.width, h = toggleCanvas.height;
            tCtx.clearRect(0, 0, w, h);

            const r = lerp(96, 30, toggleProgress);
            const g = lerp(165, 27, toggleProgress);
            const b = lerp(250, 75, toggleProgress);
            tCtx.fillStyle = `rgb(${r},${g},${b})`;
            tCtx.beginPath();
            tCtx.roundRect(0, 0, w, h, 20);
            tCtx.fill();

            if (toggleProgress > 0.1) {
                tCtx.fillStyle = `rgba(255,255,255,${toggleProgress})`;
                [{x:20,y:10},{x:40,y:30},{x:15,y:30},{x:50,y:10}].forEach(s => {
                    tCtx.beginPath(); tCtx.arc(s.x, s.y, 1.5, 0, Math.PI*2); tCtx.fill();
                });
            }

            const cloudOp = Math.max(0, 1 - toggleProgress * 2);
            if (cloudOp > 0) {
                tCtx.fillStyle = `rgba(255,255,255,${cloudOp * 0.8})`;
                tCtx.beginPath();
                tCtx.arc(50,30,8,0,Math.PI*2); tCtx.arc(60,35,10,0,Math.PI*2); tCtx.arc(70,30,8,0,Math.PI*2);
                tCtx.fill();
            }

            const cx = lerp(20, w-20, toggleProgress), cy = h/2, rad = 14;
            const ar = lerp(251,226,toggleProgress), ag = lerp(191,232,toggleProgress), ab = lerp(36,240,toggleProgress);
            tCtx.fillStyle = `rgb(${ar},${ag},${ab})`;
            tCtx.shadowBlur = 10;
            tCtx.shadowColor = `rgba(${ar},${ag},${ab},0.5)`;
            tCtx.beginPath(); tCtx.arc(cx, cy, rad, 0, Math.PI*2); tCtx.fill();
            tCtx.shadowBlur = 0;

            if (toggleProgress > 0.1) {
                const maskOff = lerp(rad*2, 6, toggleProgress);
                tCtx.fillStyle = `rgb(${r},${g},${b})`;
                tCtx.beginPath(); tCtx.arc(cx - maskOff, cy - 2, rad, 0, Math.PI*2); tCtx.fill();
            }

            const rayOp = Math.max(0, 1 - toggleProgress * 3);
            if (rayOp > 0) {
                tCtx.strokeStyle = `rgba(251,191,36,${rayOp})`;
                tCtx.lineWidth = 2; tCtx.lineCap = 'round';
                for (let i = 0; i < 6; i++) {
                    const angle = (i * Math.PI * 2) / 6 + (toggleProgress * 2);
                    tCtx.beginPath();
                    tCtx.moveTo(cx + Math.cos(angle)*(rad+3), cy + Math.sin(angle)*(rad+3));
                    tCtx.lineTo(cx + Math.cos(angle)*(rad+7), cy + Math.sin(angle)*(rad+7));
                    tCtx.stroke();
                }
            }

            const target = isDark ? 1 : 0;
            if (Math.abs(toggleProgress - target) > 0.001) {
                toggleProgress += (target - toggleProgress) * 0.1;
                requestAnimationFrame(drawToggle);
            }
        }

        themeToggle.addEventListener('click', () => {
            const scrollX = window.scrollX;
            const scrollY = window.scrollY;
            isDark = !isDark;
            document.body.classList.toggle('light-mode');
            drawToggle();
            requestAnimationFrame(() => {
                window.scrollTo(scrollX, scrollY);
            });
        });

        // --- GOLD PARTICLES ---
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        let particlesArray = [];

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initParticles();
        });

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speedX = Math.random() * 0.5 - 0.25;
                this.speedY = Math.random() * 0.5 - 0.25;
                this.opacity = Math.random() * 0.5 + 0.1;
            }
            update() {
                this.x += this.speedX;
                this.y -= this.speedY;
                if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                if (this.y < 0) this.y = canvas.height;
                if (this.y > canvas.height) this.y = 0;
            }
            draw() {
                ctx.fillStyle = `rgba(212,175,55,${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particlesArray = [];
            const n = Math.round((canvas.width * canvas.height) / 5500 * 2.0);
            for (let i = 0; i < n; i++) particlesArray.push(new Particle());
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particlesArray.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateParticles);
        }

        initParticles();
        animateParticles();
        drawToggle();
        startTypeWriter();

        // --- MOBILE KEYBOARD ---
        const initialVH = window.innerHeight;
        if ('visualViewport' in window) {
            window.visualViewport.addEventListener('resize', () => {
                if (window.visualViewport.height / initialVH < 0.75) {
                    document.body.classList.add('keyboard-open');
                } else {
                    document.body.classList.remove('keyboard-open');
                }
            });
        }

        // Prevent iOS double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', e => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
        }, false);

        // --- PWA ---
        const SW_BUILD_ID = '2026-02-25-b986f476-v3';
        if ('serviceWorker' in navigator) {
            let swRefreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (swRefreshing) return;
                swRefreshing = true;
                window.location.reload();
            });

            navigator.serviceWorker
                .register(`/sw.js?build=${encodeURIComponent(SW_BUILD_ID)}`, { updateViaCache: 'none' })
                .then((registration) => {
                    if (registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (!newWorker) return;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                            }
                        });
                    });
                    registration.update().catch(() => {});
                })
                .catch(() => {});
        }
    </script>
</body>
</html>
